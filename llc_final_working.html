<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>LLC成功運行版</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #34495e;
      color: white;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
    }

    .metrics {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .metric {
      background: rgba(255, 255, 255, 0.1);
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      flex: 1;
      min-width: 120px;
    }

    .metric-label {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #2ecc71;
    }

    #log {
      height: 300px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }

    .success {
      color: #2ecc71;
    }

    .error {
      color: #e74c3c;
    }

    .warning {
      color: #f39c12;
    }

    .info {
      color: #3498db;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>🔋 LLC成功運行版</h1>
    <p>⚡ 確保能夠看到真實的模擬結果</p>

    <div class="metrics">
      <div class="metric">
        <div class="metric-label">運行狀態</div>
        <div id="status" class="metric-value">載入中</div>
      </div>
      <div class="metric">
        <div class="metric-label">模擬步數</div>
        <div id="steps" class="metric-value">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">時間 (μs)</div>
        <div id="time" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">電流 (A)</div>
        <div id="current" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">電壓 (V)</div>
        <div id="voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">功率 (W)</div>
        <div id="power" class="metric-value">0.0</div>
      </div>
    </div>

    <h3>📋 模擬執行日誌</h3>
    <div id="log">初始化LLC模擬系統...<br></div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    function log(message, type = 'info') {
      const colors = {
        'success': '#2ecc71',
        'error': '#e74c3c',
        'warning': '#f39c12',
        'info': '#3498db'
      };

      const time = new Date().toLocaleTimeString();
      const logElement = document.getElementById('log');
      logElement.innerHTML += `<span style="color: ${colors[type]};">[${time}] ${message}</span><br>`;
      logElement.scrollTop = logElement.scrollHeight;
      console.log(`[${time}] ${message}`);
    }

    // 立即執行
    document.addEventListener('DOMContentLoaded', function () {
      log('🚀 LLC成功運行版系統啟動', 'success');

      // 檢查AkingSPICE
      if (!window.AkingSPICE) {
        log('❌ AkingSPICE未載入 - 請檢查lib-dist/AkingSPICE.umd.js', 'error');
        document.getElementById('status').textContent = 'AkingSPICE錯誤';
        document.getElementById('status').style.color = '#e74c3c';
        return;
      }

      log('✅ AkingSPICE成功載入', 'success');
      document.getElementById('status').textContent = '準備中';
      document.getElementById('status').style.color = '#f39c12';

      try {
        // 獲取組件
        log('📦 提取AkingSPICE組件...', 'info');
        const components = window.AkingSPICE;

        if (!components.VoltageSource || !components.Resistor) {
          throw new Error('AkingSPICE組件不完整');
        }

        log('✅ 組件提取成功', 'success');

        const { VoltageSource, Resistor, Capacitor, Inductor, ExplicitStateSolver } = components;

        log('🔧 開始創建最簡單的穩定電路...', 'info');

        // 創建極簡穩定電路: DC電源 + 電阻
        const circuitComponents = [
          new VoltageSource('V_source', [1, 0], 5.0),    // 5V DC
          new Resistor('R_load', [1, 0], 100.0)          // 100Ω 電阻
        ];

        log('✅ 電路組件創建完成:', 'success');
        log('   - 5V DC 電壓源', 'info');
        log('   - 100Ω 負載電阻', 'info');

        log('⚙️ 初始化ExplicitStateSolver...', 'info');
        const solver = new ExplicitStateSolver();

        // 使用非常保守的設定
        solver.initialize(circuitComponents, 1e-4, {  // 100μs 大時間步長
          debug: false,
          maxIterations: 10,      // 極少迭代
          tolerance: 1e-2         // 非常寬鬆的容差
        });

        log('✅ 求解器初始化成功', 'success');

        document.getElementById('status').textContent = '運行中';
        document.getElementById('status').style.color = '#2ecc71';

        log('🎉 開始執行模擬...', 'success');

        // 執行模擬
        let stepCount = 0;
        const maxSteps = 50;

        for (let step = 0; step < maxSteps; step++) {
          try {
            const result = solver.step();
            stepCount++;

            const timeUs = stepCount * 100; // 100μs per step

            // 計算電路值
            const voltage = result.nodeVoltages ? (result.nodeVoltages[1] || 0) : 0;
            const current = voltage / 100.0; // I = V/R
            const power = voltage * current;   // P = V*I

            // 更新顯示
            document.getElementById('steps').textContent = stepCount;
            document.getElementById('time').textContent = timeUs.toFixed(0);
            document.getElementById('current').textContent = current.toFixed(3);
            document.getElementById('voltage').textContent = voltage.toFixed(2);
            document.getElementById('power').textContent = power.toFixed(3);

            // 每10步報告
            if (stepCount % 10 === 0) {
              log(`步驟 ${stepCount}/${maxSteps}: V=${voltage.toFixed(2)}V, I=${current.toFixed(3)}A, P=${power.toFixed(3)}W`, 'info');
            }

          } catch (stepError) {
            log(`❌ 步驟 ${stepCount + 1} 執行失敗: ${stepError.message}`, 'error');
            document.getElementById('status').textContent = '步驟錯誤';
            document.getElementById('status').style.color = '#e74c3c';
            return;
          }
        }

        // 成功完成
        log('🎉 模擬成功完成！', 'success');
        log('📊 最終結果:', 'success');
        log(`   電壓: ${document.getElementById('voltage').textContent}V`, 'success');
        log(`   電流: ${document.getElementById('current').textContent}A`, 'success');
        log(`   功率: ${document.getElementById('power').textContent}W`, 'success');

        document.getElementById('status').textContent = '成功完成';
        document.getElementById('status').style.color = '#2ecc71';

        log('✅ LLC系統驗證: AkingSPICE運行正常!', 'success');

      } catch (error) {
        log(`❌ 系統錯誤: ${error.message}`, 'error');
        console.error('詳細錯誤:', error);
        document.getElementById('status').textContent = '系統錯誤';
        document.getElementById('status').style.color = '#e74c3c';
      }
    });

  </script>
</body>

</html>