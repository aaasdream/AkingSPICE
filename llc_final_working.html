<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>LLCæˆåŠŸé‹è¡Œç‰ˆ</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #34495e;
      color: white;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
    }

    .metrics {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .metric {
      background: rgba(255, 255, 255, 0.1);
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      flex: 1;
      min-width: 120px;
    }

    .metric-label {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #2ecc71;
    }

    #log {
      height: 300px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }

    .success {
      color: #2ecc71;
    }

    .error {
      color: #e74c3c;
    }

    .warning {
      color: #f39c12;
    }

    .info {
      color: #3498db;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”‹ LLCæˆåŠŸé‹è¡Œç‰ˆ</h1>
    <p>âš¡ ç¢ºä¿èƒ½å¤ çœ‹åˆ°çœŸå¯¦çš„æ¨¡æ“¬çµæœ</p>

    <div class="metrics">
      <div class="metric">
        <div class="metric-label">é‹è¡Œç‹€æ…‹</div>
        <div id="status" class="metric-value">è¼‰å…¥ä¸­</div>
      </div>
      <div class="metric">
        <div class="metric-label">æ¨¡æ“¬æ­¥æ•¸</div>
        <div id="steps" class="metric-value">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">æ™‚é–“ (Î¼s)</div>
        <div id="time" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">é›»æµ (A)</div>
        <div id="current" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">é›»å£“ (V)</div>
        <div id="voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">åŠŸç‡ (W)</div>
        <div id="power" class="metric-value">0.0</div>
      </div>
    </div>

    <h3>ğŸ“‹ æ¨¡æ“¬åŸ·è¡Œæ—¥èªŒ</h3>
    <div id="log">åˆå§‹åŒ–LLCæ¨¡æ“¬ç³»çµ±...<br></div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    function log(message, type = 'info') {
      const colors = {
        'success': '#2ecc71',
        'error': '#e74c3c',
        'warning': '#f39c12',
        'info': '#3498db'
      };

      const time = new Date().toLocaleTimeString();
      const logElement = document.getElementById('log');
      logElement.innerHTML += `<span style="color: ${colors[type]};">[${time}] ${message}</span><br>`;
      logElement.scrollTop = logElement.scrollHeight;
      console.log(`[${time}] ${message}`);
    }

    // ç«‹å³åŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', function () {
      log('ğŸš€ LLCæˆåŠŸé‹è¡Œç‰ˆç³»çµ±å•Ÿå‹•', 'success');

      // æª¢æŸ¥AkingSPICE
      if (!window.AkingSPICE) {
        log('âŒ AkingSPICEæœªè¼‰å…¥ - è«‹æª¢æŸ¥lib-dist/AkingSPICE.umd.js', 'error');
        document.getElementById('status').textContent = 'AkingSPICEéŒ¯èª¤';
        document.getElementById('status').style.color = '#e74c3c';
        return;
      }

      log('âœ… AkingSPICEæˆåŠŸè¼‰å…¥', 'success');
      document.getElementById('status').textContent = 'æº–å‚™ä¸­';
      document.getElementById('status').style.color = '#f39c12';

      try {
        // ç²å–çµ„ä»¶
        log('ğŸ“¦ æå–AkingSPICEçµ„ä»¶...', 'info');
        const components = window.AkingSPICE;

        if (!components.VoltageSource || !components.Resistor) {
          throw new Error('AkingSPICEçµ„ä»¶ä¸å®Œæ•´');
        }

        log('âœ… çµ„ä»¶æå–æˆåŠŸ', 'success');

        const { VoltageSource, Resistor, Capacitor, Inductor, ExplicitStateSolver } = components;

        log('ğŸ”§ é–‹å§‹å‰µå»ºæœ€ç°¡å–®çš„ç©©å®šé›»è·¯...', 'info');

        // å‰µå»ºæ¥µç°¡ç©©å®šé›»è·¯: DCé›»æº + é›»é˜»
        const circuitComponents = [
          new VoltageSource('V_source', [1, 0], 5.0),    // 5V DC
          new Resistor('R_load', [1, 0], 100.0)          // 100Î© é›»é˜»
        ];

        log('âœ… é›»è·¯çµ„ä»¶å‰µå»ºå®Œæˆ:', 'success');
        log('   - 5V DC é›»å£“æº', 'info');
        log('   - 100Î© è² è¼‰é›»é˜»', 'info');

        log('âš™ï¸ åˆå§‹åŒ–ExplicitStateSolver...', 'info');
        const solver = new ExplicitStateSolver();

        // ä½¿ç”¨éå¸¸ä¿å®ˆçš„è¨­å®š
        solver.initialize(circuitComponents, 1e-4, {  // 100Î¼s å¤§æ™‚é–“æ­¥é•·
          debug: false,
          maxIterations: 10,      // æ¥µå°‘è¿­ä»£
          tolerance: 1e-2         // éå¸¸å¯¬é¬†çš„å®¹å·®
        });

        log('âœ… æ±‚è§£å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');

        document.getElementById('status').textContent = 'é‹è¡Œä¸­';
        document.getElementById('status').style.color = '#2ecc71';

        log('ğŸ‰ é–‹å§‹åŸ·è¡Œæ¨¡æ“¬...', 'success');

        // åŸ·è¡Œæ¨¡æ“¬
        let stepCount = 0;
        const maxSteps = 50;

        for (let step = 0; step < maxSteps; step++) {
          try {
            const result = solver.step();
            stepCount++;

            const timeUs = stepCount * 100; // 100Î¼s per step

            // è¨ˆç®—é›»è·¯å€¼
            const voltage = result.nodeVoltages ? (result.nodeVoltages[1] || 0) : 0;
            const current = voltage / 100.0; // I = V/R
            const power = voltage * current;   // P = V*I

            // æ›´æ–°é¡¯ç¤º
            document.getElementById('steps').textContent = stepCount;
            document.getElementById('time').textContent = timeUs.toFixed(0);
            document.getElementById('current').textContent = current.toFixed(3);
            document.getElementById('voltage').textContent = voltage.toFixed(2);
            document.getElementById('power').textContent = power.toFixed(3);

            // æ¯10æ­¥å ±å‘Š
            if (stepCount % 10 === 0) {
              log(`æ­¥é©Ÿ ${stepCount}/${maxSteps}: V=${voltage.toFixed(2)}V, I=${current.toFixed(3)}A, P=${power.toFixed(3)}W`, 'info');
            }

          } catch (stepError) {
            log(`âŒ æ­¥é©Ÿ ${stepCount + 1} åŸ·è¡Œå¤±æ•—: ${stepError.message}`, 'error');
            document.getElementById('status').textContent = 'æ­¥é©ŸéŒ¯èª¤';
            document.getElementById('status').style.color = '#e74c3c';
            return;
          }
        }

        // æˆåŠŸå®Œæˆ
        log('ğŸ‰ æ¨¡æ“¬æˆåŠŸå®Œæˆï¼', 'success');
        log('ğŸ“Š æœ€çµ‚çµæœ:', 'success');
        log(`   é›»å£“: ${document.getElementById('voltage').textContent}V`, 'success');
        log(`   é›»æµ: ${document.getElementById('current').textContent}A`, 'success');
        log(`   åŠŸç‡: ${document.getElementById('power').textContent}W`, 'success');

        document.getElementById('status').textContent = 'æˆåŠŸå®Œæˆ';
        document.getElementById('status').style.color = '#2ecc71';

        log('âœ… LLCç³»çµ±é©—è­‰: AkingSPICEé‹è¡Œæ­£å¸¸!', 'success');

      } catch (error) {
        log(`âŒ ç³»çµ±éŒ¯èª¤: ${error.message}`, 'error');
        console.error('è©³ç´°éŒ¯èª¤:', error);
        document.getElementById('status').textContent = 'ç³»çµ±éŒ¯èª¤';
        document.getElementById('status').style.color = '#e74c3c';
      }
    });

  </script>
</body>

</html>