<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>çœŸå¯¦AkingSPICE LLCè½‰æ›å™¨</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #2c3e50;
      color: white;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
    }

    .metrics {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .metric {
      background: rgba(255, 255, 255, 0.1);
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      flex: 1;
      min-width: 120px;
    }

    .metric-label {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #27ae60;
    }

    #waveform {
      width: 100%;
      height: 300px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid #555;
      border-radius: 5px;
      margin: 20px 0;
    }

    #log {
      height: 250px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }

    .success {
      color: #27ae60;
    }

    .error {
      color: #e74c3c;
    }

    .warning {
      color: #f39c12;
    }

    .info {
      color: #3498db;
    }

    .controls {
      margin: 20px 0;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #2980b9;
    }

    button:disabled {
      background: #7f8c8d;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>âš¡ çœŸå¯¦AkingSPICE LLCè½‰æ›å™¨</h1>
    <p>ğŸ¯ ä½¿ç”¨AkingSPICEå¯¦ç¾LLCè«§æŒ¯è½‰æ›å™¨ - åŒ…å«æ§åˆ¶ã€æ³¢å½¢ã€å–æ¨£</p>

    <div class="controls">
      <button id="startBtn">ğŸš€ å•Ÿå‹•LLC</button>
      <button id="stopBtn" disabled>â¹ï¸ åœæ­¢</button>
      <button id="resetBtn">ğŸ”„ é‡ç½®</button>
    </div>

    <div class="metrics">
      <div class="metric">
        <div class="metric-label">ç³»çµ±ç‹€æ…‹</div>
        <div id="status" class="metric-value">å¾…æ©Ÿ</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å…¥é›»å£“</div>
        <div id="vin" class="metric-value">0V</div>
      </div>
      <div class="metric">
        <div class="metric-label">è«§æŒ¯é›»å£“</div>
        <div id="vres" class="metric-value">0V</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å‡ºé›»å£“</div>
        <div id="vout" class="metric-value">0V</div>
      </div>
      <div class="metric">
        <div class="metric-label">è«§æŒ¯é »ç‡</div>
        <div id="freq" class="metric-value">0Hz</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å‡ºåŠŸç‡</div>
        <div id="power" class="metric-value">0W</div>
      </div>
    </div>

    <h3>ğŸ“Š LLCé›»å£“æ³¢å½¢</h3>
    <canvas id="waveform"></canvas>

    <h3>ğŸ“‹ LLCæ§åˆ¶èˆ‡ç›£æ§æ—¥èªŒ</h3>
    <div id="log">ç­‰å¾…LLCç³»çµ±å•Ÿå‹•...<br></div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    let llcSystem = null;
    let isRunning = false;
    let animationFrame = null;
    let voltageHistory = [];

    function log(message, type = 'info') {
      const colors = {
        'success': '#27ae60',
        'error': '#e74c3c',
        'warning': '#f39c12',
        'info': '#3498db'
      };

      const time = new Date().toLocaleTimeString();
      const logElement = document.getElementById('log');
      logElement.innerHTML += `<span style="color: ${colors[type]};">[${time}] ${message}</span><br>`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    function updateMetrics(vin, vres, vout, freq, power) {
      document.getElementById('vin').textContent = vin.toFixed(1) + 'V';
      document.getElementById('vres').textContent = vres.toFixed(1) + 'V';
      document.getElementById('vout').textContent = vout.toFixed(1) + 'V';
      document.getElementById('freq').textContent = freq.toFixed(0) + 'Hz';
      document.getElementById('power').textContent = power.toFixed(1) + 'W';
    }

    function drawWaveform() {
      const canvas = document.getElementById('waveform');
      const ctx = canvas.getContext('2d');

      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (voltageHistory.length < 2) return;

      // ç¹ªè£½èƒŒæ™¯ç¶²æ ¼
      ctx.strokeStyle = '#34495e';
      ctx.lineWidth = 1;

      // å‚ç›´ç·š
      for (let i = 0; i <= 10; i++) {
        const x = (i / 10) * canvas.width;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }

      // æ°´å¹³ç·š
      for (let i = 0; i <= 6; i++) {
        const y = (i / 6) * canvas.height;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }

      // ç¹ªè£½æ³¢å½¢
      const maxVoltage = 20; // Â±20Vç¯„åœ

      // è¼¸å…¥é›»å£“ (ç¶ è‰²)
      ctx.strokeStyle = '#27ae60';
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i = 0; i < voltageHistory.length; i++) {
        const x = (i / (voltageHistory.length - 1)) * canvas.width;
        const y = canvas.height / 2 - (voltageHistory[i].vin / maxVoltage) * (canvas.height / 2);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // è«§æŒ¯é›»å£“ (è—è‰²)
      ctx.strokeStyle = '#3498db';
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i = 0; i < voltageHistory.length; i++) {
        const x = (i / (voltageHistory.length - 1)) * canvas.width;
        const y = canvas.height / 2 - (voltageHistory[i].vres / maxVoltage) * (canvas.height / 2);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // è¼¸å‡ºé›»å£“ (é»ƒè‰²)
      ctx.strokeStyle = '#f39c12';
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i = 0; i < voltageHistory.length; i++) {
        const x = (i / (voltageHistory.length - 1)) * canvas.width;
        const y = canvas.height / 2 - (voltageHistory[i].vout / maxVoltage) * (canvas.height / 2);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();

      // ç¹ªè£½æ¨™ç±¤
      ctx.fillStyle = '#ecf0f1';
      ctx.font = '12px Arial';
      ctx.fillText('è¼¸å…¥é›»å£“ (ç¶ )', 10, 20);
      ctx.fillText('è«§æŒ¯é›»å£“ (è—)', 10, 35);
      ctx.fillText('è¼¸å‡ºé›»å£“ (é»ƒ)', 10, 50);
      ctx.fillText('+20V', 10, 20);
      ctx.fillText('0V', 10, canvas.height / 2);
      ctx.fillText('-20V', 10, canvas.height - 10);
    }

    class LLCSystem {
      constructor() {
        this.solver = null;
        this.time = 0;
        this.stepCount = 0;

        // LLCåƒæ•¸
        this.Vin = 24.0;          // 24Vè¼¸å…¥
        this.Lr = 5e-3;           // 5mH è«§æŒ¯é›»æ„Ÿ
        this.Cr = 2e-6;           // 2Î¼F è«§æŒ¯é›»å®¹  
        this.Lm = 20e-3;          // 20mH æ¿€ç£é›»æ„Ÿ
        this.Rload = 10.0;        // 10Î© è² è¼‰

        // è¨ˆç®—è«§æŒ¯é »ç‡
        this.fr = 1 / (2 * Math.PI * Math.sqrt(this.Lr * this.Cr));

        log(`ğŸ“Š LLCè¨­è¨ˆåƒæ•¸:`, 'info');
        log(`  è¼¸å…¥é›»å£“: ${this.Vin}V`, 'info');
        log(`  è«§æŒ¯é›»æ„Ÿ: ${(this.Lr * 1000).toFixed(1)}mH`, 'info');
        log(`  è«§æŒ¯é›»å®¹: ${(this.Cr * 1e6).toFixed(1)}Î¼F`, 'info');
        log(`  ç†è«–è«§æŒ¯é »ç‡: ${(this.fr / 1000).toFixed(1)}kHz`, 'success');
      }

      async initialize() {
        if (!window.AkingSPICE) {
          throw new Error('AkingSPICEæœªè¼‰å…¥');
        }

        const { VoltageSource, Resistor, Capacitor, Inductor, ExplicitStateSolver } = window.AkingSPICE;

        log('ğŸ”§ å‰µå»ºLLCé›»è·¯æ‹“æ¨¸...', 'info');

        // å‰µå»ºLLCé›»è·¯ (ç°¡åŒ–ç‚ºåŸºæœ¬RLC + è² è¼‰)
        const components = [
          // è¼¸å…¥ç›´æµé›»æº
          new VoltageSource('Vin', [1, 0], this.Vin),

          // è«§æŒ¯é›»è·¯
          new Inductor('Lr', [1, 2], this.Lr),      // è«§æŒ¯é›»æ„Ÿ
          new Capacitor('Cr', [2, 3], this.Cr),     // è«§æŒ¯é›»å®¹

          // æ¿€ç£é›»æ„Ÿ + è² è¼‰ (ç°¡åŒ–è®Šå£“å™¨)
          new Inductor('Lm', [3, 4], this.Lm),      // æ¿€ç£é›»æ„Ÿ
          new Resistor('Rload', [4, 0], this.Rload)  // è² è¼‰é›»é˜»
        ];

        log('âœ… LLCçµ„ä»¶å‰µå»ºå®Œæˆ', 'success');
        log(`   - ç¯€é»1: è¼¸å…¥æ­£æ¥µ (${this.Vin}V)`, 'info');
        log(`   - ç¯€é»2: è«§æŒ¯é›»æ„Ÿè¼¸å‡º`, 'info');
        log(`   - ç¯€é»3: è«§æŒ¯é›»å®¹è¼¸å‡º`, 'info');
        log(`   - ç¯€é»4: æ¿€ç£é›»æ„Ÿè¼¸å‡º`, 'info');
        log(`   - ç¯€é»0: åœ°ç·š (0V)`, 'info');

        // å‰µå»ºæ±‚è§£å™¨
        this.solver = new ExplicitStateSolver();

        // ä½¿ç”¨ä¿å®ˆçš„åƒæ•¸
        const dt = 1e-4;  // 100Î¼s æ™‚é–“æ­¥é•·
        const solverOptions = {
          maxIterations: 50,
          tolerance: 1e-3,
          debug: false
        };

        log(`âš™ï¸ åˆå§‹åŒ–æ±‚è§£å™¨: dt=${dt * 1e6}Î¼s, tol=${solverOptions.tolerance}`, 'info');

        this.solver.initialize(components, dt, solverOptions);

        log('âœ… LLCç³»çµ±åˆå§‹åŒ–å®Œæˆ', 'success');

        this.time = 0;
        this.stepCount = 0;
        voltageHistory = [];

        // è¨ˆç®—å¹¶é¡¯ç¤ºåˆå§‹ç‹€æ…‹
        updateMetrics(this.Vin, 0, 0, this.fr, 0);
      }

      step() {
        if (!this.solver) return null;

        const result = this.solver.step();
        this.stepCount++;
        this.time = this.stepCount * 1e-4; // 100Î¼s per step

        // æå–é›»å£“
        const v1 = result.nodeVoltages[1] || 0;  // è¼¸å…¥ç¯€é»
        const v2 = result.nodeVoltages[2] || 0;  // è«§æŒ¯é›»æ„Ÿå¾Œ
        const v3 = result.nodeVoltages[3] || 0;  // è«§æŒ¯é›»å®¹å¾Œ
        const v4 = result.nodeVoltages[4] || 0;  // è¼¸å‡ºç¯€é»

        // è¨ˆç®—åŠŸç‡
        const iload = v4 / this.Rload;
        const power = v4 * iload;

        // æ›´æ–°é¡¯ç¤º
        updateMetrics(v1, v3, v4, this.fr, power);

        // è¨˜éŒ„æ³¢å½¢
        voltageHistory.push({
          vin: v1,
          vres: v3,
          vout: v4,
          time: this.time
        });

        // é™åˆ¶æ­·å²è¨˜éŒ„é•·åº¦
        if (voltageHistory.length > 200) {
          voltageHistory.shift();
        }

        // æ¯100æ­¥å ±å‘Šä¸€æ¬¡
        if (this.stepCount % 100 === 0) {
          log(`âš¡ æ­¥é©Ÿ ${this.stepCount}: V1=${v1.toFixed(2)}V, V3=${v3.toFixed(2)}V, V4=${v4.toFixed(2)}V, P=${power.toFixed(2)}W`, 'info');
        }

        return { v1, v2, v3, v4, power, time: this.time };
      }
    }

    async function startLLC() {
      if (isRunning) return;

      log('ğŸš€ å•Ÿå‹•LLCè½‰æ›å™¨ç³»çµ±', 'success');
      document.getElementById('status').textContent = 'å•Ÿå‹•ä¸­';
      document.getElementById('startBtn').disabled = true;

      try {
        llcSystem = new LLCSystem();
        await llcSystem.initialize();

        isRunning = true;
        document.getElementById('status').textContent = 'é‹è¡Œä¸­';
        document.getElementById('stopBtn').disabled = false;

        log('âœ… LLCç³»çµ±é‹è¡Œä¸­...', 'success');

        // é–‹å§‹æ¨¡æ“¬å¾ªç’°
        function simulationLoop() {
          if (!isRunning) return;

          try {
            llcSystem.step();
            drawWaveform();

            animationFrame = requestAnimationFrame(simulationLoop);
          } catch (error) {
            log(`âŒ æ¨¡æ“¬éŒ¯èª¤: ${error.message}`, 'error');
            stopLLC();
          }
        }

        simulationLoop();

      } catch (error) {
        log(`âŒ LLCå•Ÿå‹•å¤±æ•—: ${error.message}`, 'error');
        document.getElementById('status').textContent = 'éŒ¯èª¤';
        document.getElementById('startBtn').disabled = false;
      }
    }

    function stopLLC() {
      if (!isRunning) return;

      isRunning = false;
      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
      }

      document.getElementById('status').textContent = 'å·²åœæ­¢';
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;

      log('â¹ï¸ LLCç³»çµ±å·²åœæ­¢', 'warning');
    }

    function resetLLC() {
      stopLLC();

      llcSystem = null;
      voltageHistory = [];

      updateMetrics(0, 0, 0, 0, 0);

      const canvas = document.getElementById('waveform');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      document.getElementById('status').textContent = 'å¾…æ©Ÿ';

      log('ğŸ”„ LLCç³»çµ±å·²é‡ç½®', 'info');
    }

    // äº‹ä»¶è™•ç†
    document.addEventListener('DOMContentLoaded', function () {
      log('ğŸ¯ çœŸå¯¦AkingSPICE LLCè½‰æ›å™¨è¼‰å…¥å®Œæˆ', 'success');
      log('è‡ªå‹•å•Ÿå‹•LLCæ¨¡æ“¬...', 'info');

      document.getElementById('startBtn').addEventListener('click', startLLC);
      document.getElementById('stopBtn').addEventListener('click', stopLLC);
      document.getElementById('resetBtn').addEventListener('click', resetLLC);

      // åˆå§‹åŒ–é¡¯ç¤º
      updateMetrics(0, 0, 0, 0, 0);

      // è‡ªå‹•å•Ÿå‹• (å»¶é²1ç§’)
      setTimeout(() => {
        startLLC();
      }, 1000);
    });

  </script>
</body>

</html>