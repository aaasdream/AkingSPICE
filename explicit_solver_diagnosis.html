<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>ExplicitStateSolveråŸºç¤è¨ºæ–·</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #2c3e50;
      color: white;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
    }

    #log {
      height: 500px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }

    .success {
      color: #27ae60;
    }

    .error {
      color: #e74c3c;
    }

    .warning {
      color: #f39c12;
    }

    .info {
      color: #3498db;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ” ExplicitStateSolveråŸºç¤è¨ºæ–·</h1>
    <p>æ·±å…¥è¨ºæ–·ExplicitStateSolverçš„æ¯å€‹æ­¥é©Ÿ</p>

    <div id="log">é–‹å§‹ExplicitStateSolveråŸºç¤è¨ºæ–·...<br></div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    function log(message, type = 'info') {
      const colors = {
        'success': '#27ae60',
        'error': '#e74c3c',
        'warning': '#f39c12',
        'info': '#3498db'
      };

      const time = new Date().toLocaleTimeString();
      const logElement = document.getElementById('log');
      logElement.innerHTML += `<span style="color: ${colors[type]};">[${time}] ${message}</span><br>`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', function () {
      log('ğŸ” é–‹å§‹ExplicitStateSolveråŸºç¤è¨ºæ–·', 'success');

      if (!window.AkingSPICE) {
        log('âŒ AkingSPICEæœªè¼‰å…¥', 'error');
        return;
      }

      const { VoltageSource, Resistor, ExplicitStateSolver } = window.AkingSPICE;

      try {
        log('ğŸ“¦ å‰µå»ºæœ€åŸºæœ¬çš„é›»è·¯: 5Vé›»æº + 10Î©é›»é˜»', 'info');

        const v1 = new VoltageSource('V1', [1, 0], 5.0);
        const r1 = new Resistor('R1', [1, 0], 10.0);

        log(`VoltageSource: name=${v1.name}, nodes=[${v1.nodes}], value=${v1.value}V`, 'info');
        log(`Resistor: name=${r1.name}, nodes=[${r1.nodes}], value=${r1.value}Î©`, 'info');

        const components = [v1, r1];

        log('âš™ï¸ å‰µå»ºExplicitStateSolver...', 'info');
        const solver = new ExplicitStateSolver();

        log('ğŸ”§ å˜—è©¦åˆå§‹åŒ–æ±‚è§£å™¨...', 'info');

        // ä½¿ç”¨æœ€å¯¬é¬†çš„åƒæ•¸
        const initResult = solver.initialize(components, 1e-2, {  // 10mså¤§æ™‚é–“æ­¥é•·
          debug: true,
          maxIterations: 10,
          tolerance: 1e-1,         // 10%å®¹å·®
          solverMaxIterations: 20,
          solverTolerance: 1e-1
        });

        log('âœ… æ±‚è§£å™¨åˆå§‹åŒ–å®Œæˆ', 'success');
        log(`åˆå§‹åŒ–çµæœ: ${JSON.stringify(initResult)}`, 'info');

        // æª¢æŸ¥æ±‚è§£å™¨å…§éƒ¨ç‹€æ…‹
        log('ğŸ” æª¢æŸ¥æ±‚è§£å™¨å…§éƒ¨ç‹€æ…‹:', 'info');

        if (solver.circuitData) {
          log(`  ç¯€é»æ•¸: ${solver.circuitData.nodeCount}`, 'info');
          log(`  çµ„ä»¶æ•¸: ${solver.circuitData.componentCount}`, 'info');
          log(`  ç‹€æ…‹è®Šé‡æ•¸: ${solver.circuitData.stateCount}`, 'info');
        }

        if (solver.gMatrix) {
          log(`  GçŸ©é™£å¤§å°: ${solver.gMatrix.rows}x${solver.gMatrix.cols}`, 'info');

          // æ‰“å°GçŸ©é™£å…§å®¹ (å¦‚æœä¸å¤ªå¤§)
          if (solver.gMatrix.rows <= 5) {
            log('  GçŸ©é™£å…§å®¹:', 'info');
            for (let i = 0; i < solver.gMatrix.rows; i++) {
              let row = '    [';
              for (let j = 0; j < solver.gMatrix.cols; j++) {
                row += solver.gMatrix.get(i, j).toFixed(3);
                if (j < solver.gMatrix.cols - 1) row += ', ';
              }
              row += ']';
              log(row, 'info');
            }
          }
        }

        log('âš¡ åŸ·è¡Œç¬¬ä¸€å€‹æ±‚è§£æ­¥é©Ÿ...', 'info');

        const result = solver.step();

        log('âœ… ç¬¬ä¸€æ­¥åŸ·è¡ŒæˆåŠŸ', 'success');
        log(`çµæœé¡å‹: ${typeof result}`, 'info');
        log(`çµæœkeys: ${Object.keys(result)}`, 'info');

        if (result.nodeVoltages) {
          log('ğŸ“Š ç¯€é»é›»å£“:', 'success');
          for (const node in result.nodeVoltages) {
            log(`  ç¯€é» ${node}: ${result.nodeVoltages[node]}V`, 'success');
          }

          // æ‰‹å‹•é©—è­‰ - 5Vé›»æºï¼Œ10Î©é›»é˜»ï¼Œæ‡‰è©²æœ‰0.5Aé›»æµ
          const v_node1 = result.nodeVoltages[1] || 0;
          const expected_current = 5.0 / 10.0; // 0.5A
          const calculated_current = v_node1 / 10.0;

          log('ğŸ§® ç†è«–è¨ˆç®—é©—è­‰:', 'info');
          log(`  ç†è«–é›»æµ: ${expected_current}A`, 'info');
          log(`  è¨ˆç®—é›»æµ: ${calculated_current}A`, 'info');
          log(`  é›»å£“æ˜¯å¦åˆç†: ${Math.abs(v_node1) > 1e-6 ? 'æ˜¯' : 'å¦'}`, v_node1 > 1e-6 ? 'success' : 'error');

        } else {
          log('âŒ çµæœä¸­æ²’æœ‰nodeVoltages', 'error');
        }

        if (result.componentStates) {
          log('ğŸ”— çµ„ä»¶ç‹€æ…‹:', 'info');
          for (const comp in result.componentStates) {
            log(`  ${comp}: ${JSON.stringify(result.componentStates[comp])}`, 'info');
          }
        }

        // å˜—è©¦åŸ·è¡Œå¤šæ­¥
        log('ğŸ”„ å˜—è©¦åŸ·è¡Œ5å€‹é¡å¤–æ­¥é©Ÿ...', 'info');
        for (let step = 2; step <= 6; step++) {
          try {
            const stepResult = solver.step();
            const v1_step = stepResult.nodeVoltages[1] || 0;
            log(`  æ­¥é©Ÿ ${step}: V1=${v1_step.toFixed(6)}V`, 'info');
          } catch (stepError) {
            log(`  æ­¥é©Ÿ ${step} å¤±æ•—: ${stepError.message}`, 'error');
            break;
          }
        }

        log('ğŸ‰ ExplicitStateSolveråŸºç¤è¨ºæ–·å®Œæˆ', 'success');

      } catch (error) {
        log(`âŒ è¨ºæ–·éç¨‹éŒ¯èª¤: ${error.message}`, 'error');
        console.error('å®Œæ•´éŒ¯èª¤:', error);

        if (error.stack) {
          const stackLines = error.stack.split('\n').slice(0, 5);
          log('éŒ¯èª¤å †ç–Š (å‰5è¡Œ):', 'error');
          stackLines.forEach(line => {
            log(`  ${line}`, 'error');
          });
        }
      }
    });

  </script>
</body>

</html>