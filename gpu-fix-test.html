<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸš€ AkingSPICE GPU ä¿®å¾©æ¸¬è©¦</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .results {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 8px;
            margin: 8px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ AkingSPICE GPU ä¿®å¾©æ¸¬è©¦</h1>
        
        <button onclick="testGPUFix()">ğŸ”§ æ¸¬è©¦ GPU ä¿®å¾©</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…é™¤çµæœ</button>
        
        <div class="results" id="results">ç­‰å¾…æ¸¬è©¦...</div>
    </div>

    <!-- è¼‰å…¥ä¿®å¾©å¾Œçš„ AkingSPICE åº« -->
    <script src="./lib-dist/AkingSPICE.umd.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const element = document.getElementById('results');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            element.appendChild(statusDiv);
            element.scrollTop = element.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testGPUFix() {
            clearResults();
            log('ğŸš€ é–‹å§‹ GPU ä¿®å¾©æ¸¬è©¦...', 'info');
            
            try {
                // 1. æª¢æŸ¥ AkingSPICE åº«
                if (typeof AkingSPICE === 'undefined') {
                    throw new Error('AkingSPICE åº«æœªè¼‰å…¥');
                }
                log('âœ… AkingSPICE åº«è¼‰å…¥æˆåŠŸ', 'success');
                
                // 2. æª¢æŸ¥ WebGPU æ”¯æ´
                if (!navigator.gpu) {
                    throw new Error('ç€è¦½å™¨ä¸æ”¯æ´ WebGPU API');
                }
                log('âœ… ç€è¦½å™¨æ”¯æ´ WebGPU', 'success');
                
                // 3. è«‹æ±‚ WebGPU é©é…å™¨å’Œè¨­å‚™
                log('ğŸ” è«‹æ±‚ WebGPU é©é…å™¨...', 'info');
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    throw new Error('ç„¡æ³•å–å¾— WebGPU é©é…å™¨');
                }
                log('âœ… WebGPU é©é…å™¨å–å¾—æˆåŠŸ', 'success');
                
                log('ğŸ” è«‹æ±‚ WebGPU è¨­å‚™...', 'info');
                const device = await adapter.requestDevice();
                log('âœ… WebGPU è¨­å‚™å–å¾—æˆåŠŸ', 'success');
                
                // 4. æª¢æŸ¥ GPU æ±‚è§£å™¨é¡
                if (!AkingSPICE.GPUExplicitStateSolver) {
                    throw new Error('GPUExplicitStateSolver ä¸å¯ç”¨');
                }
                log('âœ… GPUExplicitStateSolver é¡å¯ç”¨', 'success');
                
                // 5. å‰µå»ºæ¸¬è©¦é›»è·¯
                log('ğŸ”§ å‰µå»ºæ¸¬è©¦é›»è·¯...', 'info');
                const components = [
                    new AkingSPICE.VoltageSource('V1', ['vin', 'gnd'], 5.0),
                    new AkingSPICE.Resistor('R1', ['vin', 'vout'], 10),
                    new AkingSPICE.Capacitor('C1', ['vout', 'gnd'], 1e-6)
                ];
                log('âœ… æ¸¬è©¦é›»è·¯å‰µå»ºæˆåŠŸ', 'success');
                
                // 6. å‰µå»º GPU æ±‚è§£å™¨å¯¦ä¾‹ï¼ˆä½¿ç”¨æ–°çš„ APIï¼‰
                log('ğŸš€ å‰µå»º GPU æ±‚è§£å™¨å¯¦ä¾‹...', 'info');
                const gpuSolver = new AkingSPICE.GPUExplicitStateSolver({
                    debug: true,
                    timeStep: 10e-9,
                    webGPUDevice: device,      // å‚³å…¥ WebGPU è¨­å‚™
                    webGPUAdapter: adapter     // å‚³å…¥ WebGPU é©é…å™¨
                });
                log('âœ… GPU æ±‚è§£å™¨å¯¦ä¾‹å‰µå»ºæˆåŠŸ', 'success');
                
                // 7. åˆå§‹åŒ– GPU æ±‚è§£å™¨
                log('âš™ï¸ åˆå§‹åŒ– GPU æ±‚è§£å™¨...', 'info');
                await gpuSolver.initialize(components, 10e-9);
                log('ğŸ‰ GPU æ±‚è§£å™¨åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                
                // 8. åŸ·è¡Œå¹¾æ­¥æ¸¬è©¦
                log('ğŸ”„ åŸ·è¡Œæ¸¬è©¦æ­¥é©Ÿ...', 'info');
                for (let i = 0; i < 5; i++) {
                    const result = await gpuSolver.step();
                    log(`æ­¥é©Ÿ ${i + 1}: é›»å®¹é›»å£“ = ${result.stateVariables?.get('C1')?.toFixed(6) || 'N/A'} V`, 'info');
                }
                
                log('ğŸŠ GPU ä¿®å¾©æ¸¬è©¦å®Œå…¨æˆåŠŸï¼', 'success');
                log('ğŸ’¡ ç¾åœ¨å¯ä»¥ä½¿ç”¨å®Œæ•´çš„ CPU vs GPU æ€§èƒ½æ¸¬è©¦äº†', 'success');
                
            } catch (error) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                console.error('è©³ç´°éŒ¯èª¤:', error);
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œè‡ªå‹•é‹è¡Œæ¸¬è©¦
        window.addEventListener('load', () => {
            setTimeout(testGPUFix, 1000);
        });
    </script>
</body>
</html>