<!DOCTYPE html>
<html>
<head>
    <title>🧪 最簡單的求解器測試</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .test-box { background: white; padding: 20px; margin: 10px; border-radius: 10px; }
        .log { background: #f8f9fa; padding: 10px; font-family: monospace; white-space: pre; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>🧪 最簡單的求解器測試</h1>
    
    <div class="test-box">
        <h3>測試1: 純電阻電路 (最簡單)</h3>
        <button onclick="testResistorOnly()">測試純電阻電路</button>
        <div id="resistor-log" class="log"></div>
    </div>
    
    <div class="test-box">
        <h3>測試2: RC電路診斷</h3>
        <button onclick="testRCCircuit()">測試RC電路</button>
        <div id="rc-log" class="log"></div>
    </div>
    
    <div class="test-box">
        <h3>測試3: 求解器方法檢查</h3>
        <button onclick="inspectSolvers()">檢查求解器方法</button>
        <div id="method-log" class="log"></div>
    </div>

    <script src="./lib-dist/AkingSPICE.umd.js"></script>
    <script>
        function log(message, target) {
            const element = document.getElementById(target);
            element.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
        }

        // 測試1: 最簡單的純電阻電路
        async function testResistorOnly() {
            const target = 'resistor-log';
            document.getElementById(target).textContent = '';
            
            try {
                log('開始純電阻電路測試...', target);
                
                const { VoltageSource, Resistor, ExplicitStateSolver } = AkingSPICE;
                
                // 最簡單的電路：5V → 1kΩ → GND
                const components = [
                    new VoltageSource('V1', ['in', 'gnd'], 5.0),
                    new Resistor('R1', ['in', 'out'], 1000),
                    new Resistor('R2', ['out', 'gnd'], 1000)  // 分壓器，應該得到2.5V
                ];
                
                log('電路：5V → 1kΩ → 1kΩ → GND (預期輸出: 2.5V)', target);
                
                const solver = new ExplicitStateSolver({ debug: true });
                
                log('初始化求解器...', target);
                await solver.initialize(components, 1e-6); // 1μs步長
                
                log('執行10步模擬...', target);
                for (let i = 0; i < 10; i++) {
                    const result = await solver.step();
                    log(`步驟 ${i}: ${JSON.stringify(result)}`, target);
                    
                    if (result && result.nodeVoltages) {
                        const vout = result.nodeVoltages['out'] || 0;
                        log(`  輸出電壓: ${vout.toFixed(3)}V`, target);
                    }
                }
                
                log('✅ 純電阻電路測試完成', target);
                
            } catch (error) {
                log(`❌ 錯誤: ${error.message}`, target);
                log(`錯誤堆疊: ${error.stack}`, target);
            }
        }

        // 測試2: RC電路診斷
        async function testRCCircuit() {
            const target = 'rc-log';
            document.getElementById(target).textContent = '';
            
            try {
                log('開始RC電路測試...', target);
                
                const { VoltageSource, Resistor, Capacitor, ExplicitStateSolver } = AkingSPICE;
                
                // RC電路：5V → 1kΩ → 1μF
                const components = [
                    new VoltageSource('V1', ['in', 'gnd'], 5.0),
                    new Resistor('R1', ['in', 'out'], 1000),
                    new Capacitor('C1', ['out', 'gnd'], 1e-6, { ic: 0 })  // 初始電壓0V
                ];
                
                log('電路：5V → 1kΩ → 1μF (RC時間常數 = 1ms)', target);
                
                const solver = new ExplicitStateSolver({ debug: false });
                
                log('初始化求解器...', target);
                await solver.initialize(components, 1e-6); // 1μs步長
                
                log('執行1000步模擬 (模擬1ms)...', target);
                const results = [];
                
                for (let i = 0; i < 1000; i++) {
                    const result = await solver.step();
                    
                    if (result) {
                        let voltage = 0;
                        if (result.nodeVoltages && result.nodeVoltages['out']) {
                            voltage = result.nodeVoltages['out'];
                        } else if (result.stateVector && result.stateVector.length > 0) {
                            voltage = result.stateVector[0];  // 電容電壓
                        }
                        
                        results.push(voltage);
                        
                        if (i % 100 === 0) {
                            log(`步驟 ${i}: 電壓 = ${voltage.toFixed(4)}V`, target);
                        }
                    }
                }
                
                if (results.length > 0) {
                    const finalVoltage = results[results.length - 1];
                    log(`最終電壓: ${finalVoltage.toFixed(4)}V (預期: ~3.16V, 1-1/e ≈ 63%)`, target);
                    log(`✅ RC電路測試完成，共 ${results.length} 個數據點`, target);
                } else {
                    log('❌ 沒有獲得任何有效數據', target);
                }
                
            } catch (error) {
                log(`❌ 錯誤: ${error.message}`, target);
                log(`錯誤堆疊: ${error.stack}`, target);
            }
        }

        // 測試3: 檢查求解器方法
        async function inspectSolvers() {
            const target = 'method-log';
            document.getElementById(target).textContent = '';
            
            try {
                log('檢查 AkingSPICE 可用類別...', target);
                log(`AkingSPICE 物件: ${Object.keys(AkingSPICE).join(', ')}`, target);
                
                // 檢查 CPU 求解器
                if (AkingSPICE.ExplicitStateSolver) {
                    log('\n=== CPU 求解器 (ExplicitStateSolver) ===', target);
                    const cpuSolver = new AkingSPICE.ExplicitStateSolver();
                    const cpuMethods = Object.getOwnPropertyNames(Object.getPrototypeOf(cpuSolver));
                    log(`CPU 方法: ${cpuMethods.join(', ')}`, target);
                    
                    // 測試基本功能
                    log('測試 CPU 求解器基本功能...', target);
                    const { VoltageSource, Resistor } = AkingSPICE;
                    const testComponents = [
                        new VoltageSource('V1', ['in', 'gnd'], 1.0),
                        new Resistor('R1', ['in', 'gnd'], 1000)
                    ];
                    
                    await cpuSolver.initialize(testComponents, 1e-6);
                    const cpuResult = await cpuSolver.step();
                    log(`CPU 測試結果: ${JSON.stringify(cpuResult)}`, target);
                } else {
                    log('❌ ExplicitStateSolver 不可用', target);
                }
                
                // 檢查 GPU 求解器
                if (AkingSPICE.GPUExplicitStateSolver) {
                    log('\n=== GPU 求解器 (GPUExplicitStateSolver) ===', target);
                    try {
                        const gpuSolver = new AkingSPICE.GPUExplicitStateSolver();
                        const gpuMethods = Object.getOwnPropertyNames(Object.getPrototypeOf(gpuSolver));
                        log(`GPU 方法: ${gpuMethods.join(', ')}`, target);
                        
                        // 測試基本功能
                        log('測試 GPU 求解器基本功能...', target);
                        const { VoltageSource, Resistor } = AkingSPICE;
                        const testComponents = [
                            new VoltageSource('V1', ['in', 'gnd'], 1.0),
                            new Resistor('R1', ['in', 'gnd'], 1000)
                        ];
                        
                        await gpuSolver.initialize(testComponents, 1e-6);
                        
                        // 嘗試不同的方法
                        if (gpuSolver.step) {
                            log('使用 step() 方法...', target);
                            const gpuResult1 = await gpuSolver.step();
                            log(`GPU step() 結果: ${JSON.stringify(gpuResult1)}`, target);
                        }
                        
                        if (gpuSolver.solveTimeStep) {
                            log('使用 solveTimeStep() 方法...', target);
                            const gpuResult2 = await gpuSolver.solveTimeStep();
                            log(`GPU solveTimeStep() 結果: ${JSON.stringify(gpuResult2)}`, target);
                        }
                        
                    } catch (gpuError) {
                        log(`❌ GPU 求解器錯誤: ${gpuError.message}`, target);
                    }
                } else {
                    log('❌ GPUExplicitStateSolver 不可用', target);
                }
                
                log('\n✅ 求解器檢查完成', target);
                
            } catch (error) {
                log(`❌ 檢查過程錯誤: ${error.message}`, target);
            }
        }
    </script>
</body>
</html>