<!DOCTYPE html>
<html>
<head>
    <title>ğŸ§ª æœ€ç°¡å–®çš„æ±‚è§£å™¨æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .test-box { background: white; padding: 20px; margin: 10px; border-radius: 10px; }
        .log { background: #f8f9fa; padding: 10px; font-family: monospace; white-space: pre; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª æœ€ç°¡å–®çš„æ±‚è§£å™¨æ¸¬è©¦</h1>
    
    <div class="test-box">
        <h3>æ¸¬è©¦1: ç´”é›»é˜»é›»è·¯ (æœ€ç°¡å–®)</h3>
        <button onclick="testResistorOnly()">æ¸¬è©¦ç´”é›»é˜»é›»è·¯</button>
        <div id="resistor-log" class="log"></div>
    </div>
    
    <div class="test-box">
        <h3>æ¸¬è©¦2: RCé›»è·¯è¨ºæ–·</h3>
        <button onclick="testRCCircuit()">æ¸¬è©¦RCé›»è·¯</button>
        <div id="rc-log" class="log"></div>
    </div>
    
    <div class="test-box">
        <h3>æ¸¬è©¦3: æ±‚è§£å™¨æ–¹æ³•æª¢æŸ¥</h3>
        <button onclick="inspectSolvers()">æª¢æŸ¥æ±‚è§£å™¨æ–¹æ³•</button>
        <div id="method-log" class="log"></div>
    </div>

    <script src="./lib-dist/AkingSPICE.umd.js"></script>
    <script>
        function log(message, target) {
            const element = document.getElementById(target);
            element.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
        }

        // æ¸¬è©¦1: æœ€ç°¡å–®çš„ç´”é›»é˜»é›»è·¯
        async function testResistorOnly() {
            const target = 'resistor-log';
            document.getElementById(target).textContent = '';
            
            try {
                log('é–‹å§‹ç´”é›»é˜»é›»è·¯æ¸¬è©¦...', target);
                
                const { VoltageSource, Resistor, ExplicitStateSolver } = AkingSPICE;
                
                // æœ€ç°¡å–®çš„é›»è·¯ï¼š5V â†’ 1kÎ© â†’ GND
                const components = [
                    new VoltageSource('V1', ['in', 'gnd'], 5.0),
                    new Resistor('R1', ['in', 'out'], 1000),
                    new Resistor('R2', ['out', 'gnd'], 1000)  // åˆ†å£“å™¨ï¼Œæ‡‰è©²å¾—åˆ°2.5V
                ];
                
                log('é›»è·¯ï¼š5V â†’ 1kÎ© â†’ 1kÎ© â†’ GND (é æœŸè¼¸å‡º: 2.5V)', target);
                
                const solver = new ExplicitStateSolver({ debug: true });
                
                log('åˆå§‹åŒ–æ±‚è§£å™¨...', target);
                await solver.initialize(components, 1e-6); // 1Î¼sæ­¥é•·
                
                log('åŸ·è¡Œ10æ­¥æ¨¡æ“¬...', target);
                for (let i = 0; i < 10; i++) {
                    const result = await solver.step();
                    log(`æ­¥é©Ÿ ${i}: ${JSON.stringify(result)}`, target);
                    
                    if (result && result.nodeVoltages) {
                        const vout = result.nodeVoltages['out'] || 0;
                        log(`  è¼¸å‡ºé›»å£“: ${vout.toFixed(3)}V`, target);
                    }
                }
                
                log('âœ… ç´”é›»é˜»é›»è·¯æ¸¬è©¦å®Œæˆ', target);
                
            } catch (error) {
                log(`âŒ éŒ¯èª¤: ${error.message}`, target);
                log(`éŒ¯èª¤å †ç–Š: ${error.stack}`, target);
            }
        }

        // æ¸¬è©¦2: RCé›»è·¯è¨ºæ–·
        async function testRCCircuit() {
            const target = 'rc-log';
            document.getElementById(target).textContent = '';
            
            try {
                log('é–‹å§‹RCé›»è·¯æ¸¬è©¦...', target);
                
                const { VoltageSource, Resistor, Capacitor, ExplicitStateSolver } = AkingSPICE;
                
                // RCé›»è·¯ï¼š5V â†’ 1kÎ© â†’ 1Î¼F
                const components = [
                    new VoltageSource('V1', ['in', 'gnd'], 5.0),
                    new Resistor('R1', ['in', 'out'], 1000),
                    new Capacitor('C1', ['out', 'gnd'], 1e-6, { ic: 0 })  // åˆå§‹é›»å£“0V
                ];
                
                log('é›»è·¯ï¼š5V â†’ 1kÎ© â†’ 1Î¼F (RCæ™‚é–“å¸¸æ•¸ = 1ms)', target);
                
                const solver = new ExplicitStateSolver({ debug: false });
                
                log('åˆå§‹åŒ–æ±‚è§£å™¨...', target);
                await solver.initialize(components, 1e-6); // 1Î¼sæ­¥é•·
                
                log('åŸ·è¡Œ1000æ­¥æ¨¡æ“¬ (æ¨¡æ“¬1ms)...', target);
                const results = [];
                
                for (let i = 0; i < 1000; i++) {
                    const result = await solver.step();
                    
                    if (result) {
                        let voltage = 0;
                        if (result.nodeVoltages && result.nodeVoltages['out']) {
                            voltage = result.nodeVoltages['out'];
                        } else if (result.stateVector && result.stateVector.length > 0) {
                            voltage = result.stateVector[0];  // é›»å®¹é›»å£“
                        }
                        
                        results.push(voltage);
                        
                        if (i % 100 === 0) {
                            log(`æ­¥é©Ÿ ${i}: é›»å£“ = ${voltage.toFixed(4)}V`, target);
                        }
                    }
                }
                
                if (results.length > 0) {
                    const finalVoltage = results[results.length - 1];
                    log(`æœ€çµ‚é›»å£“: ${finalVoltage.toFixed(4)}V (é æœŸ: ~3.16V, 1-1/e â‰ˆ 63%)`, target);
                    log(`âœ… RCé›»è·¯æ¸¬è©¦å®Œæˆï¼Œå…± ${results.length} å€‹æ•¸æ“šé»`, target);
                } else {
                    log('âŒ æ²’æœ‰ç²å¾—ä»»ä½•æœ‰æ•ˆæ•¸æ“š', target);
                }
                
            } catch (error) {
                log(`âŒ éŒ¯èª¤: ${error.message}`, target);
                log(`éŒ¯èª¤å †ç–Š: ${error.stack}`, target);
            }
        }

        // æ¸¬è©¦3: æª¢æŸ¥æ±‚è§£å™¨æ–¹æ³•
        async function inspectSolvers() {
            const target = 'method-log';
            document.getElementById(target).textContent = '';
            
            try {
                log('æª¢æŸ¥ AkingSPICE å¯ç”¨é¡åˆ¥...', target);
                log(`AkingSPICE ç‰©ä»¶: ${Object.keys(AkingSPICE).join(', ')}`, target);
                
                // æª¢æŸ¥ CPU æ±‚è§£å™¨
                if (AkingSPICE.ExplicitStateSolver) {
                    log('\n=== CPU æ±‚è§£å™¨ (ExplicitStateSolver) ===', target);
                    const cpuSolver = new AkingSPICE.ExplicitStateSolver();
                    const cpuMethods = Object.getOwnPropertyNames(Object.getPrototypeOf(cpuSolver));
                    log(`CPU æ–¹æ³•: ${cpuMethods.join(', ')}`, target);
                    
                    // æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
                    log('æ¸¬è©¦ CPU æ±‚è§£å™¨åŸºæœ¬åŠŸèƒ½...', target);
                    const { VoltageSource, Resistor } = AkingSPICE;
                    const testComponents = [
                        new VoltageSource('V1', ['in', 'gnd'], 1.0),
                        new Resistor('R1', ['in', 'gnd'], 1000)
                    ];
                    
                    await cpuSolver.initialize(testComponents, 1e-6);
                    const cpuResult = await cpuSolver.step();
                    log(`CPU æ¸¬è©¦çµæœ: ${JSON.stringify(cpuResult)}`, target);
                } else {
                    log('âŒ ExplicitStateSolver ä¸å¯ç”¨', target);
                }
                
                // æª¢æŸ¥ GPU æ±‚è§£å™¨
                if (AkingSPICE.GPUExplicitStateSolver) {
                    log('\n=== GPU æ±‚è§£å™¨ (GPUExplicitStateSolver) ===', target);
                    try {
                        const gpuSolver = new AkingSPICE.GPUExplicitStateSolver();
                        const gpuMethods = Object.getOwnPropertyNames(Object.getPrototypeOf(gpuSolver));
                        log(`GPU æ–¹æ³•: ${gpuMethods.join(', ')}`, target);
                        
                        // æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
                        log('æ¸¬è©¦ GPU æ±‚è§£å™¨åŸºæœ¬åŠŸèƒ½...', target);
                        const { VoltageSource, Resistor } = AkingSPICE;
                        const testComponents = [
                            new VoltageSource('V1', ['in', 'gnd'], 1.0),
                            new Resistor('R1', ['in', 'gnd'], 1000)
                        ];
                        
                        await gpuSolver.initialize(testComponents, 1e-6);
                        
                        // å˜—è©¦ä¸åŒçš„æ–¹æ³•
                        if (gpuSolver.step) {
                            log('ä½¿ç”¨ step() æ–¹æ³•...', target);
                            const gpuResult1 = await gpuSolver.step();
                            log(`GPU step() çµæœ: ${JSON.stringify(gpuResult1)}`, target);
                        }
                        
                        if (gpuSolver.solveTimeStep) {
                            log('ä½¿ç”¨ solveTimeStep() æ–¹æ³•...', target);
                            const gpuResult2 = await gpuSolver.solveTimeStep();
                            log(`GPU solveTimeStep() çµæœ: ${JSON.stringify(gpuResult2)}`, target);
                        }
                        
                    } catch (gpuError) {
                        log(`âŒ GPU æ±‚è§£å™¨éŒ¯èª¤: ${gpuError.message}`, target);
                    }
                } else {
                    log('âŒ GPUExplicitStateSolver ä¸å¯ç”¨', target);
                }
                
                log('\nâœ… æ±‚è§£å™¨æª¢æŸ¥å®Œæˆ', target);
                
            } catch (error) {
                log(`âŒ æª¢æŸ¥éç¨‹éŒ¯èª¤: ${error.message}`, target);
            }
        }
    </script>
</body>
</html>