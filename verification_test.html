<!DOCTYPE html>
<html>
<head>
    <title>AkingSPICE修復驗證</title>
</head>
<body>
    <h1>AkingSPICE修復驗證測試</h1>
    <div id="output"></div>

    <script src="lib-dist/AkingSPICE.umd.js"></script>
    <script>
        let output = document.getElementById('output');

        function log(message) {
            console.log(message);
            output.innerHTML += message + '<br>';
        }

        async function runTests() {
            try {
                log('🧪 開始AkingSPICE修復驗證...');
                
                if (!window.AkingSPICE) {
                    log('❌ AkingSPICE未加載');
                    return;
                }
                
                const { VoltageSource, Resistor, Capacitor, ExplicitStateSolver } = window.AkingSPICE;
                
                // 測試 1: 基本歐姆定律 (5V + 10Ω)
                log('\n📊 測試 1: 基本歐姆定律 (5V電壓源 + 10Ω電阻)');
                
                const v1 = new VoltageSource('V1', ['vin', 'gnd'], 5.0);
                const r1 = new Resistor('R1', ['vin', 'gnd'], 10);
                
                const solver1 = new ExplicitStateSolver([v1, r1]);
                solver1.step(1e-6);
                
                const result1 = solver1.getNodeVoltages();
                const vinVoltage = result1.vin || 0;
                const error1 = Math.abs(vinVoltage - 5.0);
                
                log(`  結果: V(vin) = ${vinVoltage.toFixed(6)}V (期望: 5.000000V)`);
                log(`  誤差: ${error1.toExponential(3)}V`);
                
                if (error1 < 0.01) {
                    log('  ✅ 測試1通過 - 基本歐姆定律正確');
                } else {
                    log('  ❌ 測試1失敗 - 基本電阻計算有問題');
                }
                
                // 測試 2: RC電路充電
                log('\n📊 測試 2: RC充電電路 (5V, 1kΩ, 1µF)');
                
                const v2 = new VoltageSource('V1', ['vin', 'gnd'], 5.0);
                const r2 = new Resistor('R1', ['vin', 'node1'], 1000);
                const c2 = new Capacitor('C1', ['node1', 'gnd'], 1e-6);
                
                const solver2 = new ExplicitStateSolver([v2, r2, c2]);
                
                // 執行5步充電過程
                let previousVc = 0;
                for (let i = 0; i < 5; i++) {
                    solver2.step(1e-6);
                    
                    const result2 = solver2.getNodeVoltages();
                    const stateVars = solver2.getStateVariables();
                    
                    const t = solver2.currentTime;
                    const Vc = stateVars.C1 || 0;
                    const Vnode1 = result2.node1 || 0;
                    
                    // 理論值: Vc(t) = 5 * (1 - exp(-t/τ)), τ = RC = 1ms
                    const tau = 1000 * 1e-6; // 1ms
                    const theoretical = 5 * (1 - Math.exp(-t / tau));
                    const error2 = Math.abs(Vc - theoretical);
                    
                    log(`  t=${(t*1e6).toFixed(1)}µs: Vc=${Vc.toFixed(6)}V, Vnode1=${Vnode1.toFixed(6)}V`);
                    log(`    理論Vc=${theoretical.toFixed(6)}V, 誤差=${error2.toExponential(3)}V`);
                    
                    // 檢查物理合理性
                    if (Vc > previousVc && Vc <= 5.0) {
                        log(`    ✅ 電容電壓單調遞增且合理`);
                    } else {
                        log(`    ❌ 電容電壓變化異常`);
                    }
                    
                    previousVc = Vc;
                }
                
                // 測試 3: 數值穩定性檢查
                log('\n📊 測試 3: 數值穩定性檢查');
                
                const finalVc = solver2.getStateVariables().C1 || 0;
                if (finalVc > 0 && finalVc < 5 && !isNaN(finalVc) && isFinite(finalVc)) {
                    log(`  ✅ 數值穩定 - 最終Vc=${finalVc.toFixed(6)}V`);
                } else {
                    log(`  ❌ 數值不穩定 - Vc=${finalVc}`);
                }
                
                log('\n🎯 總結:');
                if (error1 < 0.01 && finalVc > 0 && finalVc < 5) {
                    log('✅ 核心修復成功 - AkingSPICE基本功能正常');
                    log('🚀 可以進行LLC電路模擬');
                } else {
                    log('❌ 仍有問題需要進一步修復');
                    log(`   - 基本歐姆定律誤差: ${error1.toExponential(3)}`);
                    log(`   - RC電路最終狀態: Vc=${finalVc}`);
                }
                
            } catch (error) {
                log('❌ 測試過程錯誤: ' + error.message);
                console.error(error);
            }
        }

        // 頁面加載完成後自動運行測試
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>