<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>LLCå­æ¨¡çµ„ä¿®æ­£ç‰ˆæ¸¬è©¦</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #2c3e50;
      color: white;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
    }

    .test-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .test-module {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #555;
    }

    .test-module h3 {
      margin-top: 0;
      color: #3498db;
    }

    .status {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 4px;
      margin: 5px 0;
    }

    .status.success {
      background: #27ae60;
    }

    .status.fail {
      background: #e74c3c;
    }

    .status.testing {
      background: #f39c12;
    }

    #log {
      height: 350px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }

    .success {
      color: #27ae60;
    }

    .error {
      color: #e74c3c;
    }

    .warning {
      color: #f39c12;
    }

    .info {
      color: #3498db;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”§ LLCå­æ¨¡çµ„ä¿®æ­£ç‰ˆæ¸¬è©¦</h1>
    <p>ä½¿ç”¨æ­£ç¢ºçš„åƒæ•¸è¨­ç½®æ¸¬è©¦LLCå„å€‹å­é›»è·¯</p>

    <div class="test-grid">
      <div class="test-module">
        <h3>1. åŸºæœ¬é›»é˜»é›»è·¯</h3>
        <div id="status1" class="status testing">æ¸¬è©¦ä¸­...</div>
        <div id="result1">ç­‰å¾…æ¸¬è©¦çµæœ</div>
      </div>

      <div class="test-module">
        <h3>2. ç°¡åŒ–äºŒæ¥µé«”</h3>
        <div id="status2" class="status testing">æ¸¬è©¦ä¸­...</div>
        <div id="result2">ç­‰å¾…æ¸¬è©¦çµæœ</div>
      </div>

      <div class="test-module">
        <h3>3. LCè«§æŒ¯é›»è·¯</h3>
        <div id="status3" class="status testing">æ¸¬è©¦ä¸­...</div>
        <div id="result3">ç­‰å¾…æ¸¬è©¦çµæœ</div>
      </div>

      <div class="test-module">
        <h3>4. åŸºæœ¬é›»æ„Ÿé›»è·¯</h3>
        <div id="status4" class="status testing">æ¸¬è©¦ä¸­...</div>
        <div id="result4">ç­‰å¾…æ¸¬è©¦çµæœ</div>
      </div>

      <div class="test-module">
        <h3>5. åŸºæœ¬é›»å®¹é›»è·¯</h3>
        <div id="status5" class="status testing">æ¸¬è©¦ä¸­...</div>
        <div id="result5">ç­‰å¾…æ¸¬è©¦çµæœ</div>
      </div>

      <div class="test-module">
        <h3>6. ç°¡åŒ–LLC</h3>
        <div id="status6" class="status testing">æ¸¬è©¦ä¸­...</div>
        <div id="result6">ç­‰å¾…æ¸¬è©¦çµæœ</div>
      </div>
    </div>

    <h3>ğŸ“‹ è©³ç´°æ¸¬è©¦æ—¥èªŒ</h3>
    <div id="log">é–‹å§‹LLCå­æ¨¡çµ„ä¿®æ­£æ¸¬è©¦...<br></div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    function log(message, type = 'info') {
      const colors = {
        'success': '#27ae60',
        'error': '#e74c3c',
        'warning': '#f39c12',
        'info': '#3498db'
      };

      const time = new Date().toLocaleTimeString();
      const logElement = document.getElementById('log');
      logElement.innerHTML += `<span style="color: ${colors[type]};">[${time}] ${message}</span><br>`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    function updateStatus(testNum, status, result) {
      const statusElement = document.getElementById(`status${testNum}`);
      const resultElement = document.getElementById(`result${testNum}`);

      statusElement.className = `status ${status}`;
      statusElement.textContent = status === 'success' ? 'âœ… é€šé' : status === 'fail' ? 'âŒ å¤±æ•—' : 'ğŸ”„ æ¸¬è©¦ä¸­';
      resultElement.textContent = result;
    }

    async function testModule(testNum, name, testFunction) {
      log(`ğŸ§ª æ¸¬è©¦ ${testNum}: ${name}`, 'info');
      updateStatus(testNum, 'testing', 'åŸ·è¡Œä¸­...');

      try {
        const result = await testFunction();
        log(`âœ… æ¸¬è©¦ ${testNum} é€šé: ${result}`, 'success');
        updateStatus(testNum, 'success', result);
        return true;
      } catch (error) {
        log(`âŒ æ¸¬è©¦ ${testNum} å¤±æ•—: ${error.message}`, 'error');
        updateStatus(testNum, 'fail', error.message);
        return false;
      }
    }

    document.addEventListener('DOMContentLoaded', async function () {
      log('ğŸš€ é–‹å§‹LLCå­é›»è·¯ä¿®æ­£ç‰ˆæ¸¬è©¦', 'success');

      if (!window.AkingSPICE) {
        log('âŒ AkingSPICEæœªè¼‰å…¥', 'error');
        return;
      }

      const spice = window.AkingSPICE;
      const { VoltageSource, Resistor, Capacitor, Inductor, Diode, ExplicitStateSolver } = spice;

      // ä½¿ç”¨å·²çŸ¥å·¥ä½œçš„åƒæ•¸è¨­ç½®
      const workingParams = {
        dt: 1e-3,            // 1ms æ™‚é–“æ­¥é•·
        maxIterations: 20,   // 20æ¬¡è¿­ä»£
        tolerance: 1e-2,     // 1% å®¹å·®
        debug: false
      };

      // æ¸¬è©¦1: åŸºæœ¬é›»é˜»é›»è·¯ (å·²çŸ¥å¯ä»¥å·¥ä½œ)
      await testModule(1, 'åŸºæœ¬é›»é˜»é›»è·¯', async () => {
        const components = [
          new VoltageSource('V1', [1, 0], 5.0),
          new Resistor('R1', [1, 0], 10.0)
        ];

        const solver = new ExplicitStateSolver();
        solver.initialize(components, workingParams.dt, workingParams);

        const result = solver.step();
        const v1 = result.nodeVoltages[1] || 0;
        const current = v1 / 10.0;

        return `V=${v1.toFixed(2)}V, I=${current.toFixed(3)}A`;
      });

      // æ¸¬è©¦2: ç°¡åŒ–äºŒæ¥µé«” (ç”¨é›»é˜»æ¨¡æ“¬)
      await testModule(2, 'ç°¡åŒ–äºŒæ¥µé«”', async () => {
        const components = [
          new VoltageSource('V1', [1, 0], 5.0),
          new Resistor('R_diode', [1, 2], 0.1),    // 0.1Î© æ¨¡æ“¬å°é€šäºŒæ¥µé«”
          new Resistor('R_load', [2, 0], 10.0)
        ];

        const solver = new ExplicitStateSolver();
        solver.initialize(components, workingParams.dt, workingParams);

        const result = solver.step();
        const v2 = result.nodeVoltages[2] || 0;
        const current = v2 / 10.0;

        return `æ•´æµè¼¸å‡º: ${v2.toFixed(2)}V, ${current.toFixed(3)}A`;
      });

      // æ¸¬è©¦3: LCè«§æŒ¯é›»è·¯ (é™ä½é »ç‡é¿å…æ•¸å€¼å•é¡Œ)
      await testModule(3, 'LCè«§æŒ¯é›»è·¯', async () => {
        const components = [
          new VoltageSource('V1', [1, 0], 5.0),
          new Resistor('Rs', [1, 2], 1.0),         // ä¸²è¯é›»é˜»
          new Inductor('L1', [2, 3], 1e-3),        // 1mH (è¼ƒå¤§é›»æ„Ÿ)
          new Capacitor('C1', [3, 0], 10e-6),      // 10Î¼F (è¼ƒå¤§é›»å®¹)
        ];

        const solver = new ExplicitStateSolver();
        solver.initialize(components, workingParams.dt, workingParams);

        // åŸ·è¡Œå¹¾æ­¥çœ‹çœ‹
        for (let i = 0; i < 3; i++) {
          solver.step();
        }

        // è¨ˆç®—ç†è«–è«§æŒ¯é »ç‡
        const fr = 1 / (2 * Math.PI * Math.sqrt(1e-3 * 10e-6));
        return `LCè«§æŒ¯æ­£å¸¸, frâ‰ˆ${(fr).toFixed(0)}Hz`;
      });

      // æ¸¬è©¦4: åŸºæœ¬é›»æ„Ÿé›»è·¯
      await testModule(4, 'åŸºæœ¬é›»æ„Ÿé›»è·¯', async () => {
        const components = [
          new VoltageSource('V1', [1, 0], 5.0),
          new Resistor('Rs', [1, 2], 5.0),
          new Inductor('L1', [2, 0], 10e-3)        // 10mH
        ];

        const solver = new ExplicitStateSolver();
        solver.initialize(components, workingParams.dt, workingParams);

        const result = solver.step();
        const v2 = result.nodeVoltages[2] || 0;

        return `é›»æ„Ÿé›»è·¯: V2=${v2.toFixed(2)}V`;
      });

      // æ¸¬è©¦5: åŸºæœ¬é›»å®¹é›»è·¯
      await testModule(5, 'åŸºæœ¬é›»å®¹é›»è·¯', async () => {
        const components = [
          new VoltageSource('V1', [1, 0], 5.0),
          new Resistor('Rs', [1, 2], 10.0),
          new Capacitor('C1', [2, 0], 100e-6)      // 100Î¼F
        ];

        const solver = new ExplicitStateSolver();
        solver.initialize(components, workingParams.dt, workingParams);

        const result = solver.step();
        const v2 = result.nodeVoltages[2] || 0;

        return `é›»å®¹é›»è·¯: V2=${v2.toFixed(2)}V`;
      });

      // æ¸¬è©¦6: ç°¡åŒ–LLCçµ„åˆ
      await testModule(6, 'ç°¡åŒ–LLC', async () => {
        const components = [
          // è¼¸å…¥
          new VoltageSource('Vin', [1, 0], 12.0),

          // è«§æŒ¯é›»è·¯ (é™ä½é »ç‡)
          new Inductor('Lr', [1, 2], 10e-3),       // 10mH è«§æŒ¯é›»æ„Ÿ
          new Capacitor('Cr', [2, 3], 10e-6),      // 10Î¼F è«§æŒ¯é›»å®¹

          // è² è¼‰ (ç°¡åŒ–è®Šå£“å™¨+æ•´æµ)
          new Resistor('Rload', [3, 0], 20.0)      // 20Î© ç­‰æ•ˆè² è¼‰
        ];

        const solver = new ExplicitStateSolver();
        solver.initialize(components, workingParams.dt, workingParams);

        // åŸ·è¡Œå¤šæ­¥æ¨¡æ“¬
        let maxV3 = 0;
        for (let i = 0; i < 10; i++) {
          const result = solver.step();
          const v3 = Math.abs(result.nodeVoltages[3] || 0);
          if (v3 > maxV3) maxV3 = v3;
        }

        // è¨ˆç®—ç†è«–è«§æŒ¯é »ç‡
        const fr = 1 / (2 * Math.PI * Math.sqrt(10e-3 * 10e-6));
        const power = (maxV3 * maxV3) / 20.0;

        return `LLC: frâ‰ˆ${fr.toFixed(1)}Hz, Vmax=${maxV3.toFixed(2)}V, Pâ‰ˆ${power.toFixed(2)}W`;
      });

      log('ğŸ‰ æ‰€æœ‰LLCå­æ¨¡çµ„æ¸¬è©¦å®Œæˆï¼', 'success');
    });

  </script>
</body>

</html>