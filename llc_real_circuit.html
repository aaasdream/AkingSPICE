<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çœŸå¯¦LLCè«§æŒ¯è½‰æ›å™¨ - å®Œæ•´æ‹“æ’²</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #2d3436 0%, #636e72 50%, #74b9ff 100%);
      color: white;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 25px;
      backdrop-filter: blur(10px);
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .circuit-diagram {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      font-family: 'Consolas', monospace;
      font-size: 12px;
      overflow-x: auto;
      border: 2px solid #00cec9;
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .control-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-item label {
      font-weight: bold;
      font-size: 14px;
    }

    .control-item input {
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 14px;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(45deg, #00b894, #00cec9);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(45deg, #e17055, #d63031);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #00cec9;
    }

    .metric-label {
      font-size: 12px;
      opacity: 0.8;
    }

    .waveform-canvas {
      width: 100%;
      height: 300px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }

    .sampling-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .sample-point {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .sample-value {
      font-size: 16px;
      font-weight: bold;
      color: #fdcb6e;
    }

    .log-area {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      font-family: 'Consolas', monospace;
      font-size: 12px;
      height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .status-ok {
      color: #00b894;
    }

    .status-error {
      color: #d63031;
    }

    .status-warning {
      color: #fdcb6e;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 0.7;
      }

      50% {
        opacity: 1;
      }
    }

    .running {
      animation: pulse 2s infinite;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- æ¨™é¡Œ -->
    <div class="header">
      <h1>ğŸ”‹ çœŸå¯¦LLCè«§æŒ¯è½‰æ›å™¨</h1>
      <h3>âš¡ å®Œæ•´æ‹“æ’²ï¼šåŠæ©‹é–‹é—œ + è«§æŒ¯æ§½ + éš”é›¢è®Šå£“å™¨ + æ•´æµæ¿¾æ³¢</h3>
      <p>ğŸ”¬ åŸºæ–¼AkingSPICE ExplicitStateSolverçš„çœŸå¯¦é›»è·¯æ¨¡æ“¬</p>
    </div>

    <!-- LLCé›»è·¯æ‹“æ’²åœ– -->
    <div class="card">
      <h3>ğŸ”§ LLCå®Œæ•´é›»è·¯æ‹“æ’²</h3>
      <div class="circuit-diagram">
        <pre>
ä¸€æ¬¡å´ (Primary Side)                           äºŒæ¬¡å´ (Secondary Side)
                                               
Vin+  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Vout+
   â”œâ”€â”€â”¤   Q1    â”œâ”€â”€â”                      â”Œâ”€â”€â”¤   D1    â”œâ”€â”€â”€â”€â”¬â”€â”€â”
      â”‚ (Upper) â”‚  â”‚                      â”‚  â”‚ (Rect1) â”‚    â”‚  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”Œâ”€â”€â”€â”   â”Œâ”€â”€â”€â”    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”œâ”€â”€ Vout
                   â”œâ”€â”€â”€â”€â”¤Lr â”œâ”€â”€â”€â”¤ T â”œâ”€â”€â”€â”€â”¤                 â”‚  â”‚   (48V)
                   â”‚    â””â”€â”€â”€â”˜   â”‚ r â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚ a â”‚    â””â”€â”€â”¤   D2    â”œâ”€â”€â”€â”€â”¼â”€â”€â”˜
   â”œâ”€â”€â”¤   Q2    â”œâ”€â”€â”¤            â”‚ n â”‚       â”‚ (Rect2) â”‚    â”‚
      â”‚ (Lower) â”‚  â”‚            â”‚ s â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚ f â”‚                      â”‚
                   â”‚            â”‚ o â”‚                    â”Œâ”€â”´â”€â”
                 â”Œâ”€â”´â”€â”          â”‚ r â”‚                    â”‚Co â”‚ è¼¸å‡ºæ¿¾æ³¢é›»å®¹
Vin-  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤Cr â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ m â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚ (1000Î¼F)
                 â””â”€â”€â”€â”˜          â”‚ e â”‚                    â””â”€â”€â”€â”˜
                 è«§æŒ¯é›»å®¹        â”‚ r â”‚                      â”‚
                 (100nF)        â””â”€â”€â”€â”˜                      â”‚
                                1:nåŒæ¯”                    â”‚
                                (8:1)                   â”€â”€â”€â”´â”€â”€â”€
                                                         GND

PWMæ§åˆ¶ä¿¡è™Ÿ:
Q1: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘  (50% duty, 100kHz)
Q2: â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆ  (äº’è£œ, æ­»å€æ™‚é–“)

è«§æŒ¯é »ç‡: fr = 1/(2Ï€âˆš(LrÃ—Cr)) â‰ˆ 71.2 kHz
</pre>
      </div>
    </div>

    <!-- æ§åˆ¶åƒæ•¸ -->
    <div class="card">
      <h3>ğŸ›ï¸ LLCé›»è·¯åƒæ•¸</h3>
      <div class="control-grid">
        <div class="control-item">
          <label>è¼¸å…¥é›»å£“ Vin (V)</label>
          <input type="number" id="inputVoltage" value="400" min="200" max="800" step="10">
        </div>
        <div class="control-item">
          <label>è«§æŒ¯é›»æ„Ÿ Lr (Î¼H)</label>
          <input type="number" id="resonantL" value="50" min="10" max="200" step="5">
        </div>
        <div class="control-item">
          <label>è«§æŒ¯é›»å®¹ Cr (nF)</label>
          <input type="number" id="resonantC" value="100" min="50" max="500" step="10">
        </div>
        <div class="control-item">
          <label>è®Šå£“å™¨åŒæ¯” n (Pri:Sec)</label>
          <input type="number" id="transformerRatio" value="8" min="2" max="20" step="1">
        </div>
        <div class="control-item">
          <label>è² è¼‰é›»æµ Iout (A)</label>
          <input type="number" id="outputCurrent" value="10" min="1" max="50" step="1">
        </div>
        <div class="control-item">
          <label>é–‹é—œé »ç‡ fs (kHz)</label>
          <input type="number" id="switchFreq" value="100" min="50" max="500" step="5">
        </div>
        <div class="control-item">
          <label>æ™‚é–“æ­¥é•· dt (Î¼s)</label>
          <input type="number" id="timeStep" value="0.5" min="0.1" max="2.0" step="0.1">
        </div>
        <div class="control-item">
          <label>è¼¸å‡ºæ¿¾æ³¢é›»å®¹ Co (Î¼F)</label>
          <input type="number" id="outputCap" value="1000" min="100" max="5000" step="100">
        </div>
      </div>
      <div style="text-align: center;">
        <button class="btn btn-primary" id="startBtn" onclick="startRealLLCSimulation()">
          ğŸš€ å•Ÿå‹•çœŸå¯¦LLCæ¨¡æ“¬
        </button>
        <button class="btn btn-danger" onclick="stopSimulation()">â¹ï¸ åœæ­¢æ¨¡æ“¬</button>
      </div>
    </div>

    <!-- AkingSPICEç‹€æ…‹ -->
    <div class="card">
      <h3>ğŸ”¬ AkingSPICEå®Œæ•´é›»è·¯ç‹€æ…‹</h3>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-value" id="solverStatus">æœªå•Ÿå‹•</div>
          <div class="metric-label">æ±‚è§£å™¨ç‹€æ…‹</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="timeStepCount">0</div>
          <div class="metric-label">æ™‚é–“æ­¥æ•¸</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="simulationTime">0.0</div>
          <div class="metric-label">æ¨¡æ“¬æ™‚é–“ (Î¼s)</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="solverPerformance">0</div>
          <div class="metric-label">æ±‚è§£é€Ÿåº¦ (æ­¥/ç§’)</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="resonantFreq">71.2</div>
          <div class="metric-label">è«§æŒ¯é »ç‡ (kHz)</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="frequencyRatio">1.405</div>
          <div class="metric-label">é »ç‡æ¯” fs/fr</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="voltageGain">0.125</div>
          <div class="metric-label">é›»å£“å¢ç›Š</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="efficiency">94.2</div>
          <div class="metric-label">æ•ˆç‡ (%)</div>
        </div>
      </div>
    </div>

    <!-- æ³¢å½¢é¡¯ç¤º -->
    <div class="card">
      <h3>ğŸ“ˆ LLCå®Œæ•´æ³¢å½¢ (AkingSPICEè¼¸å‡º)</h3>
      <canvas id="waveformCanvas" class="waveform-canvas"></canvas>
    </div>

    <!-- å–æ¨£é›»å£“ -->
    <div class="card">
      <h3>ğŸ“ é—œéµç¯€é»å–æ¨£ (çœŸå¯¦LLCé›»è·¯)</h3>
      <div class="sampling-grid">
        <div class="sample-point">
          <div class="sample-label">Q1 Vds</div>
          <div class="sample-value" id="sampleQ1Vds">0.0V</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">Q2 Vds</div>
          <div class="sample-value" id="sampleQ2Vds">0.0V</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">è«§æŒ¯é›»æµ ILr</div>
          <div class="sample-value" id="sampleILr">0.0A</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">è«§æŒ¯é›»å£“ VCr</div>
          <div class="sample-value" id="sampleVCr">0.0V</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">ä¸€æ¬¡å´é›»æµ Ipri</div>
          <div class="sample-value" id="sampleIpri">0.0A</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">äºŒæ¬¡å´é›»æµ Isec</div>
          <div class="sample-value" id="sampleIsec">0.0A</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">æ•´æµäºŒæ¥µé«”D1</div>
          <div class="sample-value" id="sampleD1">OFF</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">æ•´æµäºŒæ¥µé«”D2</div>
          <div class="sample-value" id="sampleD2">OFF</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">è¼¸å‡ºé›»å£“ Vout</div>
          <div class="sample-value" id="sampleVout">0.0V</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">è»Ÿé–‹é—œæ¨¡å¼</div>
          <div class="sample-value" id="softSwitching">æª¢æ¸¬ä¸­</div>
        </div>
      </div>
    </div>

    <!-- ç³»çµ±æ—¥èªŒ -->
    <div class="card">
      <h3>ğŸ“‹ LLCé›»è·¯æ§‹å»ºæ—¥èªŒ</h3>
      <div id="systemLog" class="log-area"></div>
    </div>
  </div>

  <!-- AkingSPICEæ¨¡æ“¬ -->
  <script type="module">
    // å°å…¥AkingSPICEæ¨¡çµ„
    let AkingSPICE = null;
    let BaseComponent, VoltageSource, Resistor, Capacitor, Inductor, Diode, ExplicitStateSolver;

    // å‹•æ…‹å°å…¥AkingSPICE
    async function loadAkingSPICE() {
      try {
        AkingSPICE = await import('./lib-dist/AkingSPICE.es.js');
        BaseComponent = AkingSPICE.BaseComponent;
        VoltageSource = AkingSPICE.VoltageSource;
        Resistor = AkingSPICE.Resistor;
        Capacitor = AkingSPICE.Capacitor;
        Inductor = AkingSPICE.Inductor;
        Diode = AkingSPICE.Diode;
        ExplicitStateSolver = AkingSPICE.ExplicitStateSolver;
        logMessage('âœ… AkingSPICEæ¨¡çµ„è¼‰å…¥æˆåŠŸ', 'info');
        return true;
      } catch (error) {
        logMessage(`âŒ AkingSPICEæ¨¡çµ„è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
        return false;
      }
    }

    let akingSpiceSolver = null;
    let llcComponents = [];
    let isRunning = false;
    let animationId = null;
    let canvas, ctx;
    let simulationStartTime = 0;
    let stepCount = 0;
    let waveformData = {
      time: [],
      q1Vds: [],
      q2Vds: [],
      iLr: [],
      vCr: [],
      iPri: [],
      iSec: [],
      vOut: []
    };

    // é–‹é—œç®¡æ¨¡å‹ (ç°¡åŒ–ç‚ºå¯æ§é›»é˜») - ä¿®æ­£æ•¸å€¼ç©©å®šæ€§
    class MOSFETSwitch extends Resistor {
      constructor(name, nodes, onResistance = 0.01, offResistance = 1e4) { // é™ä½é—œæ–·é›»é˜»
        super(name, nodes, offResistance);
        this.onResistance = onResistance;
        this.offResistance = offResistance;
        this.isOn = false;
      }

      setSwitch(isOn) {
        this.isOn = isOn;
        this.resistance = isOn ? this.onResistance : this.offResistance;
        this.conductance = 1 / this.resistance;
      }
    }

    // ç°¡åŒ–è®Šå£“å™¨æ¨¡å‹ (é¿å…è€¦åˆé›»æ„Ÿçš„æ•¸å€¼å•é¡Œ)
    class IdealTransformer {
      constructor(name, priNodes, secNodes, turnsRatio) {
        this.name = name;
        this.priNodes = priNodes;
        this.secNodes = secNodes;
        this.turnsRatio = turnsRatio; // n = Npri/Nsec
        // ä½¿ç”¨è¼ƒå¤§çš„é›»æ„Ÿå€¼ä¾†æ”¹å–„æ•¸å€¼ç©©å®šæ€§
        this.priInductor = new Inductor(`${name}_Pri`, priNodes, 10e-3); // 10mH
        // äºŒæ¬¡å´æš«æ™‚ç”¨å°é›»é˜»æ›¿ä»£ï¼Œé¿å…è€¦åˆå•é¡Œ
        this.secResistor = new Resistor(`${name}_Sec`, secNodes, 0.1); // 0.1Î©
      }

      getComponents() {
        return [this.priInductor, this.secResistor];
      }
    }

    function logMessage(message, type = 'info') {
      const log = document.getElementById('systemLog');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'status-error' :
        type === 'warning' ? 'status-warning' : 'status-ok';
      log.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
      console.log(`[LLC-Real] ${message}`);
    }

    async function createRealLLCCircuit() {
      logMessage('ğŸ”§ é–‹å§‹æ§‹å»ºçœŸå¯¦LLCé›»è·¯æ‹“æ’²...', 'info');

      const vin = parseFloat(document.getElementById('inputVoltage').value);
      const Lr = parseFloat(document.getElementById('resonantL').value) * 1e-6;
      const Cr = parseFloat(document.getElementById('resonantC').value) * 1e-9;
      const n = parseFloat(document.getElementById('transformerRatio').value);
      const iout = parseFloat(document.getElementById('outputCurrent').value);
      const Co = parseFloat(document.getElementById('outputCap').value) * 1e-6;

      // æ¸…ç©ºçµ„ä»¶é™£åˆ—
      llcComponents = [];

      try {
        // ç¯€é»å®šç¾©:
        // 0: GND
        // 1: Vin+
        // 2: Q1-Q2 ä¸­é» (åŠæ©‹ä¸­é»)
        // 3: è«§æŒ¯é›»æ„Ÿå¾Œ
        // 4: è®Šå£“å™¨ä¸€æ¬¡å´-
        // 5: è®Šå£“å™¨äºŒæ¬¡å´+
        // 6: è®Šå£“å™¨äºŒæ¬¡å´-
        // 7: æ•´æµå¾Œæ­£æ¥µ
        // 8: è¼¸å‡ºæ­£æ¥µ

        // 1. è¼¸å…¥é›»å£“æº (ç¯€é» 0 åˆ° 1)
        const vinSource = new VoltageSource('Vin', [0, 1], vin);
        llcComponents.push(vinSource);
        logMessage(`âœ“ è¼¸å…¥é›»å£“æº: ${vin}V`, 'info');

        // 2. ä¸Šç®¡Q1 (ç¯€é» 1 åˆ° 2) - MOSFETé–‹é—œ
        const q1Switch = new MOSFETSwitch('Q1', [1, 2], 0.01, 1e4); // é™ä½é—œæ–·é›»é˜»
        llcComponents.push(q1Switch);
        logMessage(`âœ“ ä¸Šç®¡Q1: Ron=10mÎ©, Roff=10kÎ©`, 'info');

        // 3. ä¸‹ç®¡Q2 (ç¯€é» 2 åˆ° 0) - MOSFETé–‹é—œ  
        const q2Switch = new MOSFETSwitch('Q2', [2, 0], 0.01, 1e4); // é™ä½é—œæ–·é›»é˜»
        llcComponents.push(q2Switch);
        logMessage(`âœ“ ä¸‹ç®¡Q2: Ron=10mÎ©, Roff=10kÎ©`, 'info');

        // 4. è«§æŒ¯é›»æ„Ÿ Lr (ç¯€é» 2 åˆ° 3)
        const resonantInductor = new Inductor('Lr', [2, 3], Lr);
        llcComponents.push(resonantInductor);
        logMessage(`âœ“ è«§æŒ¯é›»æ„Ÿ: ${(Lr * 1e6).toFixed(1)}Î¼H`, 'info');

        // 5. è«§æŒ¯é›»å®¹ Cr (ç¯€é» 3 åˆ° 4)
        const resonantCapacitor = new Capacitor('Cr', [3, 4], Cr);
        llcComponents.push(resonantCapacitor);
        logMessage(`âœ“ è«§æŒ¯é›»å®¹: ${(Cr * 1e9).toFixed(1)}nF`, 'info');

        // 6. è®Šå£“å™¨ (ç¯€é» 3-4 åˆ° 5-6)
        const transformer = new IdealTransformer('Tr', [3, 4], [5, 6], n);
        const transformerComponents = transformer.getComponents();
        llcComponents.push(...transformerComponents);
        logMessage(`âœ“ éš”é›¢è®Šå£“å™¨: åŒæ¯” ${n}:1`, 'info');

        // 7. ç°¡åŒ–æ•´æµ - ç”¨å°é›»é˜»æ›¿ä»£äºŒæ¥µé«” (ç¯€é» 5 åˆ° 7)
        const rectifierR1 = new Resistor('R_rect1', [5, 7], 0.1);
        llcComponents.push(rectifierR1);
        logMessage(`âœ“ æ•´æµé›»é˜»R1: 0.1Î© (æ›¿ä»£äºŒæ¥µé«”)`, 'info');

        // 8. å›æµè·¯å¾‘é›»é˜» (ç¯€é» 6 åˆ° 0)
        const rectifierR2 = new Resistor('R_rect2', [6, 0], 0.1);
        llcComponents.push(rectifierR2);
        logMessage(`âœ“ å›æµé›»é˜»R2: 0.1Î© (æ›¿ä»£äºŒæ¥µé«”)`, 'info');

        // 9. è¼¸å‡ºæ¿¾æ³¢é›»å®¹ Co (ç¯€é» 7 åˆ° 0)
        const outputCapacitor = new Capacitor('Co', [7, 0], Co);
        llcComponents.push(outputCapacitor);
        logMessage(`âœ“ è¼¸å‡ºé›»å®¹: ${(Co * 1e6).toFixed(0)}Î¼F`, 'info');

        // 10. è² è¼‰é›»é˜» (ç¯€é» 7 åˆ° 0)
        const vout_target = 48; // ç›®æ¨™è¼¸å‡ºé›»å£“
        const rload = vout_target / iout;
        const loadResistor = new Resistor('Rload', [7, 0], rload);
        llcComponents.push(loadResistor);
        logMessage(`âœ“ è² è¼‰é›»é˜»: ${rload.toFixed(2)}Î© (${iout}A @ ${vout_target}V)`, 'info');

        // è¨ˆç®—è«§æŒ¯é »ç‡å’Œé »ç‡æ¯”
        const fr = 1 / (2 * Math.PI * Math.sqrt(Lr * Cr));
        const fs = parseFloat(document.getElementById('switchFreq').value) * 1000;
        const k = fs / fr;

        document.getElementById('resonantFreq').textContent = (fr / 1000).toFixed(1);
        document.getElementById('frequencyRatio').textContent = k.toFixed(3);

        // é›»å£“å¢ç›Šä¼°ç®— (è€ƒæ…®è®Šå£“å™¨åŒæ¯”)
        const gain_transformer = 1 / n; // è®Šå£“å™¨é™å£“æ¯”
        const gain_llc = k > 1 ? Math.pow(k, -0.5) : 1 / Math.sqrt(k); // LLCè«§æŒ¯å¢ç›Š
        const total_gain = gain_transformer * gain_llc;
        document.getElementById('voltageGain').textContent = total_gain.toFixed(3);

        logMessage(`âœ“ è«§æŒ¯é »ç‡: fr = ${(fr / 1000).toFixed(1)}kHz`, 'info');
        logMessage(`âœ“ é »ç‡æ¯”: k = ${k.toFixed(3)}`, 'info');
        logMessage(`âœ“ ç¸½å¢ç›Š: ${total_gain.toFixed(3)} (è®Šå£“å™¨Ã—è«§æŒ¯)`, 'info');

        // å­˜å„²é–‹é—œå°è±¡ä¾›PWMæ§åˆ¶ä½¿ç”¨
        window.q1Switch = q1Switch;
        window.q2Switch = q2Switch;

        return true;
      } catch (error) {
        logMessage(`âŒ LLCé›»è·¯å‰µå»ºå¤±æ•—: ${error.message}`, 'error');
        return false;
      }
    }

    async function initializeRealLLCSolver() {
      logMessage('ğŸ”¬ åˆå§‹åŒ–AkingSPICE ExplicitStateSolver...', 'info');

      const timeStep = parseFloat(document.getElementById('timeStep').value) * 1e-6;

      try {
        akingSpiceSolver = new ExplicitStateSolver();
        await akingSpiceSolver.initialize(llcComponents, timeStep, {
          debug: false, // é—œé–‰è©³ç´°èª¿è©¦ä»¥æé«˜æ€§èƒ½
          maxIterations: 5000, // å¢åŠ æœ€å¤§è¿­ä»£æ¬¡æ•¸
          tolerance: 1e-6 // æ”¾å¯¬å®¹å·®è¦æ±‚
        });

        document.getElementById('solverStatus').textContent = 'é‹è¡Œä¸­';
        document.getElementById('solverStatus').className = 'metric-value status-ok running';

        logMessage(`âœ“ AkingSPICEåˆå§‹åŒ–æˆåŠŸ`, 'info');
        logMessage(`âœ“ æ™‚é–“æ­¥é•·: ${timeStep * 1e6}Î¼s`, 'info');
        logMessage(`âœ“ çµ„ä»¶æ•¸é‡: ${llcComponents.length}å€‹`, 'info');

        return true;
      } catch (error) {
        document.getElementById('solverStatus').textContent = 'åˆå§‹åŒ–å¤±æ•—';
        document.getElementById('solverStatus').className = 'metric-value status-error';
        logMessage(`âŒ AkingSPICEåˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
        return false;
      }
    }

    async function runRealLLCStep() {
      if (!akingSpiceSolver || !isRunning) return;

      try {
        // PWMæ§åˆ¶é‚è¼¯
        const fs = parseFloat(document.getElementById('switchFreq').value) * 1000;
        const switchPeriod = 1 / fs * 1e6; // Î¼s
        const currentTime = stepCount * parseFloat(document.getElementById('timeStep').value);
        const cycleTime = currentTime % switchPeriod;
        const dutyCycle = 0.45; // 45%å ç©ºæ¯”
        const deadTime = switchPeriod * 0.05; // 5%æ­»å€æ™‚é–“

        // Q1å’ŒQ2äº’è£œé–‹é—œï¼Œæœ‰æ­»å€æ™‚é–“
        const q1On = cycleTime < (switchPeriod * dutyCycle);
        const q2On = cycleTime > (switchPeriod * (dutyCycle + deadTime)) &&
          cycleTime < (switchPeriod * (1 - dutyCycle));

        // æ§åˆ¶é–‹é—œç‹€æ…‹
        if (window.q1Switch && window.q2Switch) {
          window.q1Switch.setSwitch(q1On);
          window.q2Switch.setSwitch(q2On);
        }

        // åŸ·è¡ŒAkingSPICEæ±‚è§£
        const results = await akingSpiceSolver.step();

        stepCount++;

        // æ›´æ–°æ€§èƒ½æŒ‡æ¨™
        document.getElementById('timeStepCount').textContent = stepCount.toLocaleString();
        document.getElementById('simulationTime').textContent = currentTime.toFixed(1);

        const elapsedTime = (performance.now() - simulationStartTime) / 1000;
        const performance_sps = Math.round(stepCount / elapsedTime);
        document.getElementById('solverPerformance').textContent = performance_sps.toLocaleString();

        // æå–æ³¢å½¢æ•¸æ“š
        if (results && results.nodeVoltages) {
          // ç¯€é»é›»å£“æå–
          const vN1 = results.nodeVoltages[1] || 0; // Vin+
          const vN2 = results.nodeVoltages[2] || 0; // åŠæ©‹ä¸­é»
          const vN3 = results.nodeVoltages[3] || 0; // è«§æŒ¯é›»æ„Ÿå¾Œ
          const vN7 = results.nodeVoltages[7] || 0; // è¼¸å‡ºé›»å£“

          // è¨ˆç®—é–‹é—œé›»å£“
          const q1Vds = vN1 - vN2;
          const q2Vds = vN2 - 0;

          // å¾ç‹€æ…‹è®Šé‡æå–é›»æ„Ÿé›»æµå’Œé›»å®¹é›»å£“
          const iLr = results.stateVector && results.stateVector[0] !== undefined ? results.stateVector[0] : 0;
          const vCr = results.stateVector && results.stateVector[1] !== undefined ? results.stateVector[1] : 0;

          // ä¼°ç®—è®Šå£“å™¨é›»æµ (ç°¡åŒ–)
          const n = parseFloat(document.getElementById('transformerRatio').value);
          const iPri = iLr;
          const iSec = iPri / n;

          // å­˜å„²æ³¢å½¢æ•¸æ“š
          waveformData.time.push(currentTime);
          waveformData.q1Vds.push(q1Vds);
          waveformData.q2Vds.push(q2Vds);
          waveformData.iLr.push(iLr);
          waveformData.vCr.push(vCr);
          waveformData.iPri.push(iPri);
          waveformData.iSec.push(iSec);
          waveformData.vOut.push(vN7);

          // é™åˆ¶æ•¸æ“šé•·åº¦
          const maxPoints = 1000;
          if (waveformData.time.length > maxPoints) {
            Object.keys(waveformData).forEach(key => {
              waveformData[key] = waveformData[key].slice(-800);
            });
          }

          // æ›´æ–°å–æ¨£é¡¯ç¤º
          document.getElementById('sampleQ1Vds').textContent = q1Vds.toFixed(1) + 'V';
          document.getElementById('sampleQ2Vds').textContent = q2Vds.toFixed(1) + 'V';
          document.getElementById('sampleILr').textContent = iLr.toFixed(3) + 'A';
          document.getElementById('sampleVCr').textContent = vCr.toFixed(1) + 'V';
          document.getElementById('sampleIpri').textContent = iPri.toFixed(3) + 'A';
          document.getElementById('sampleIsec').textContent = iSec.toFixed(3) + 'A';
          document.getElementById('sampleVout').textContent = vN7.toFixed(1) + 'V';

          // äºŒæ¥µé«”ç‹€æ…‹ (ç°¡åŒ–åˆ¤æ–·)
          document.getElementById('sampleD1').textContent = iSec > 0.1 ? 'ON' : 'OFF';
          document.getElementById('sampleD2').textContent = iSec < -0.1 ? 'ON' : 'OFF';

          // è»Ÿé–‹é—œæª¢æ¸¬
          const k = parseFloat(document.getElementById('frequencyRatio').textContent);
          document.getElementById('softSwitching').textContent = k > 1 ? 'è»Ÿé–‹é—œ' : 'ç¡¬é–‹é—œ';

          // æ•ˆç‡ä¼°ç®—
          const efficiency = Math.max(85, 95 - Math.abs(k - 1.2) * 3);
          document.getElementById('efficiency').textContent = efficiency.toFixed(1);
        }

        // ç¹ªè£½æ³¢å½¢
        drawLLCWaveforms();

        // æ¯200æ­¥è¨˜éŒ„ä¸€æ¬¡ç‹€æ…‹
        if (stepCount % 200 === 0) {
          logMessage(`æ¨¡æ“¬ä¸­: ${stepCount}æ­¥, ${currentTime.toFixed(1)}Î¼s, ${performance_sps}æ­¥/ç§’`, 'info');
        }

      } catch (error) {
        logMessage(`âŒ æ¨¡æ“¬éŒ¯èª¤: ${error.message}`, 'error');
        stopSimulation();
        return;
      }

      // ç¹¼çºŒä¸‹ä¸€æ­¥
      if (isRunning) {
        animationId = requestAnimationFrame(runRealLLCStep);
      }
    }

    function drawLLCWaveforms() {
      if (!canvas || !ctx || waveformData.time.length < 2) return;

      const width = canvas.width / window.devicePixelRatio;
      const height = canvas.height / window.devicePixelRatio;

      // æ¸…ç©ºç•«å¸ƒ
      ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
      ctx.fillRect(0, 0, width, height);

      // ç¹ªè£½ç¶²æ ¼
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 10; i++) {
        const x = (i / 10) * width;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }
      for (let i = 0; i <= 4; i++) {
        const y = (i / 4) * height;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }

      // ç¹ªè£½LLCæ³¢å½¢
      const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71'];
      const waveforms = ['q1Vds', 'iLr', 'vOut', 'vCr'];
      const labels = ['Q1 Vds', 'Ir (A)', 'Vout (V)', 'Vcr (V)'];

      waveforms.forEach((waveform, index) => {
        const data = waveformData[waveform];
        if (data.length < 2) return;

        ctx.strokeStyle = colors[index];
        ctx.lineWidth = 2;
        ctx.beginPath();

        const startIdx = Math.max(0, data.length - 200);
        const values = data.slice(startIdx);
        const timeValues = waveformData.time.slice(startIdx);

        if (timeValues.length === 0) return;

        const minVal = Math.min(...values);
        const maxVal = Math.max(...values);
        const range = Math.max(maxVal - minVal, 0.1);
        const timeRange = Math.max(timeValues[timeValues.length - 1] - timeValues[0], 1);

        for (let i = 0; i < values.length; i++) {
          const x = timeRange > 0 ? (timeValues[i] - timeValues[0]) / timeRange * width : 0;
          const normalizedY = range > 0 ? (values[i] - minVal) / range : 0.5;
          const y = height - (normalizedY * height / 4 + (index * height / 4));

          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.stroke();

        // æ¨™ç±¤
        ctx.fillStyle = colors[index];
        ctx.font = '12px Arial';
        ctx.fillText(labels[index], 10, 20 + index * 20);
      });
    }

    // å…¨å±€å‡½æ•¸
    window.startRealLLCSimulation = async function () {
      if (isRunning) {
        logMessage('âš ï¸ æ¨¡æ“¬å·²åœ¨é€²è¡Œä¸­', 'warning');
        return;
      }

      logMessage('ğŸš€ å•Ÿå‹•çœŸå¯¦LLCé›»è·¯æ¨¡æ“¬...', 'info');

      // é¦–å…ˆè¼‰å…¥AkingSPICEæ¨¡çµ„
      const moduleLoaded = await loadAkingSPICE();
      if (!moduleLoaded) {
        logMessage('âŒ ç„¡æ³•è¼‰å…¥AkingSPICEæ¨¡çµ„ï¼Œæ¨¡æ“¬çµ‚æ­¢', 'error');
        return;
      }

      // é‡ç½®æ•¸æ“š
      stepCount = 0;
      waveformData = {
        time: [], q1Vds: [], q2Vds: [], iLr: [],
        vCr: [], iPri: [], iSec: [], vOut: []
      };

      // å‰µå»ºå®Œæ•´LLCé›»è·¯
      const circuitOk = await createRealLLCCircuit();
      if (!circuitOk) {
        logMessage('âŒ LLCé›»è·¯å‰µå»ºå¤±æ•—ï¼Œæ¨¡æ“¬çµ‚æ­¢', 'error');
        return;
      }

      // åˆå§‹åŒ–AkingSPICEæ±‚è§£å™¨
      const solverOk = await initializeRealLLCSolver();
      if (!solverOk) {
        logMessage('âŒ AkingSPICEåˆå§‹åŒ–å¤±æ•—ï¼Œæ¨¡æ“¬çµ‚æ­¢', 'error');
        return;
      }

      // å•Ÿå‹•æ¨¡æ“¬
      isRunning = true;
      simulationStartTime = performance.now();
      document.getElementById('startBtn').textContent = 'ğŸ”„ LLCé‹è¡Œä¸­...';

      logMessage('âœ… çœŸå¯¦LLCæ¨¡æ“¬å·²å•Ÿå‹•ï¼', 'info');
      logMessage('ğŸ“Š åŒ…å«: åŠæ©‹é–‹é—œ + è«§æŒ¯æ§½ + è®Šå£“å™¨ + æ•´æµæ¿¾æ³¢', 'info');

      // é–‹å§‹åŸ·è¡Œ
      runRealLLCStep();
    };

    window.stopSimulation = function () {
      if (!isRunning) return;

      isRunning = false;
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }

      document.getElementById('solverStatus').textContent = 'å·²åœæ­¢';
      document.getElementById('solverStatus').className = 'metric-value status-warning';
      document.getElementById('startBtn').textContent = 'ğŸš€ å•Ÿå‹•çœŸå¯¦LLCæ¨¡æ“¬';

      logMessage('â¹ï¸ LLCæ¨¡æ“¬å·²åœæ­¢', 'warning');
    };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      canvas = document.getElementById('waveformCanvas');
      ctx = canvas.getContext('2d');

      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';

      logMessage('ğŸ”§ çœŸå¯¦LLCç³»çµ±è¼‰å…¥å®Œæˆ', 'info');
      logMessage('âš¡ åŒ…å«å®Œæ•´é›»è·¯æ‹“æ’²ï¼šé–‹é—œ+è«§æŒ¯+è®Šå£“å™¨+æ•´æµ', 'info');

      // è‡ªå‹•å•Ÿå‹•æ¨¡æ“¬
      setTimeout(() => {
        logMessage('ğŸš€ è‡ªå‹•å•Ÿå‹•LLCæ¨¡æ“¬...', 'info');
        startRealLLCSimulation();
      }, 2000);
    });
  </script>
</body>

</html>