<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>🔬 AkingSPICE 基礎電路測試 - CPU vs GPU</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            margin: 0; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px);
            color: white; 
            padding: 20px; 
            text-align: center; 
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .test-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            height: 300px;
            margin-top: 15px;
        }
        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        button:disabled {
            background: #aaa;
            cursor: not-allowed;
            transform: none;
        }
        .log {
            background: rgba(248,249,250,0.8);
            border-radius: 8px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .status.success { background: rgba(16, 185, 129, 0.1); color: #059669; }
        .status.error { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
        .status.info { background: rgba(59, 130, 246, 0.1); color: #2563eb; }
        .performance {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .perf-item {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0,0,0,0.05);
        }
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>🔬 AkingSPICE 基礎電路測試</h1>
        <p>CPU vs GPU 性能對比 • 從最簡單的電路開始驗證</p>
    </div>

    <div style="background: rgba(255,255,255,0.95); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
        <h3>🧪 測試參數設定</h3>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; align-items: center;">
            <div>
                <label>電路類型:</label>
                <select id="circuitType">
                    <option value="rc">RC 充電電路</option>
                    <option value="rlc">RLC 振蕩電路</option>
                    <option value="divider">電壓分壓器</option>
                    <option value="llc">簡化 LLC</option>
                </select>
            </div>
            <div>
                <label>模擬時間:</label>
                <input type="number" id="simTime" value="1" step="0.1" min="0.1" max="10">
                <span>ms</span>
            </div>
            <div>
                <label>時間步長:</label>
                <select id="timeStep">
                    <option value="1e-6">1μs</option>
                    <option value="100e-9">100ns</option>
                    <option value="10e-9" selected>10ns</option>
                    <option value="1e-9">1ns</option>
                </select>
            </div>
            <div>
                <button id="runTestBtn">🚀 執行測試</button>
            </div>
        </div>
    </div>

    <div class="test-grid">
        <div class="test-panel">
            <h3>💻 CPU 求解器測試</h3>
            <div id="cpuStatus" class="status info">等待測試...</div>
            <button id="cpuBtn" disabled>測試 CPU 求解器</button>
            <div class="performance">
                <div class="perf-item">
                    <div>執行時間</div>
                    <div id="cpuTime">-</div>
                </div>
                <div class="perf-item">
                    <div>性能 (步/秒)</div>
                    <div id="cpuPerf">-</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="cpuChart"></canvas>
            </div>
            <div id="cpuLog" class="log"></div>
        </div>

        <div class="test-panel">
            <h3>🚀 GPU 求解器測試</h3>
            <div id="gpuStatus" class="status info">等待測試...</div>
            <button id="gpuBtn" disabled>測試 GPU 求解器</button>
            <div class="performance">
                <div class="perf-item">
                    <div>執行時間</div>
                    <div id="gpuTime">-</div>
                </div>
                <div class="perf-item">
                    <div>性能 (步/秒)</div>
                    <div id="gpuPerf">-</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="gpuChart"></canvas>
            </div>
            <div id="gpuLog" class="log"></div>
        </div>
    </div>

    <div class="test-panel">
        <h3>📊 性能對比結果</h3>
        <div id="comparisonResult" class="log">等待測試完成...</div>
    </div>
</div>

<script src="./lib-dist/AkingSPICE.umd.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    let cpuSolver = null;
    let gpuSolver = null;
    let cpuChart = null;
    let gpuChart = null;
    let isReady = false;

    // 日誌函數
    function log(message, type = 'info', target = 'both') {
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `[${timestamp}] ${message}\n`;
        
        if (target === 'cpu' || target === 'both') {
            document.getElementById('cpuLog').textContent += logMessage;
            document.getElementById('cpuLog').scrollTop = document.getElementById('cpuLog').scrollHeight;
        }
        if (target === 'gpu' || target === 'both') {
            document.getElementById('gpuLog').textContent += logMessage;
            document.getElementById('gpuLog').scrollTop = document.getElementById('gpuLog').scrollHeight;
        }
        console.log(`[${target.toUpperCase()}] ${message}`);
    }

    function updateStatus(message, type, target) {
        const statusEl = document.getElementById(`${target}Status`);
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
    }

    // 初始化圖表
    function initChart(canvasId) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    x: { title: { display: true, text: '時間 (ms)' } },
                    y: { title: { display: true, text: '電壓 (V)' } }
                }
            }
        });
    }

    // 創建測試電路
    function createTestCircuit() {
        const circuitType = document.getElementById('circuitType').value;
        const { VoltageSource, Resistor, Capacitor, Inductor } = AkingSPICE;
        
        log(`創建 ${circuitType} 測試電路...`);
        
        switch (circuitType) {
            case 'rc':
                return {
                    components: [
                        new VoltageSource('V1', ['vin', 'gnd'], 5.0),
                        new Resistor('R1', ['vin', 'vout'], 1000),
                        new Capacitor('C1', ['vout', 'gnd'], 1e-6, { ic: 0 })
                    ],
                    expectedFinalVoltage: 5.0,
                    outputNode: 'vout',
                    description: 'RC充電電路 (5V → 1kΩ → 1μF)'
                };
                
            case 'rlc':
                return {
                    components: [
                        new VoltageSource('V1', ['vin', 'gnd'], 10.0),
                        new Resistor('R1', ['vin', 'n1'], 100),
                        new Inductor('L1', ['n1', 'vout'], 1e-3),
                        new Capacitor('C1', ['vout', 'gnd'], 1e-6, { ic: 0 })
                    ],
                    expectedFinalVoltage: 10.0,
                    outputNode: 'vout',
                    description: 'RLC電路 (10V → 100Ω → 1mH → 1μF)'
                };
                
            case 'divider':
                return {
                    components: [
                        new VoltageSource('V1', ['vin', 'gnd'], 12.0),
                        new Resistor('R1', ['vin', 'vout'], 1000),
                        new Resistor('R2', ['vout', 'gnd'], 2000),
                        new Capacitor('C1', ['vout', 'gnd'], 10e-6, { ic: 0 })
                    ],
                    expectedFinalVoltage: 8.0, // 12V * 2kΩ/(1kΩ+2kΩ) = 8V
                    outputNode: 'vout',
                    description: '電壓分壓器 (12V → 1kΩ/2kΩ分壓 → 8V)'
                };
                
            case 'llc':
                return {
                    components: [
                        new VoltageSource('V1', ['vin', 'gnd'], 24.0),
                        new Inductor('L1', ['vin', 'n1'], 10e-6),     // 10μH
                        new Capacitor('C1', ['n1', 'n2'], 100e-9),    // 100nF  
                        new Inductor('L2', ['n2', 'gnd'], 50e-6),     // 50μH 磁化電感
                        new Resistor('R1', ['n1', 'vout'], 10),       // 整流等效
                        new Capacitor('C2', ['vout', 'gnd'], 100e-6, { ic: 0 }) // 輸出濾波
                    ],
                    expectedFinalVoltage: 20.0,
                    outputNode: 'vout',
                    description: '簡化LLC轉換器'
                };
        }
    }

    // 執行單個求解器測試
    async function runSolverTest(solver, solverName) {
        const target = solverName.toLowerCase();
        
        try {
            updateStatus('🔄 初始化中...', 'info', target);
            log(`開始 ${solverName} 求解器測試`, 'info', target);
            
            const circuit = createTestCircuit();
            const simTime = parseFloat(document.getElementById('simTime').value) * 1e-3;
            const timeStep = parseFloat(document.getElementById('timeStep').value);
            const totalSteps = Math.floor(simTime / timeStep);
            
            log(`電路: ${circuit.description}`, 'info', target);
            log(`參數: 時間=${simTime*1000}ms, 步長=${timeStep*1e9}ns, 總步數=${totalSteps}`, 'info', target);
            
            // 初始化求解器
            updateStatus('🔧 初始化求解器...', 'info', target);
            const startInit = performance.now();
            await solver.initialize(circuit.components, timeStep);
            const initTime = performance.now() - startInit;
            log(`求解器初始化完成，耗時: ${initTime.toFixed(1)}ms`, 'info', target);
            
            // 執行模擬
            updateStatus('⚡ 執行模擬...', 'info', target);
            const results = [];
            const startSim = performance.now();
            
            for (let i = 0; i < totalSteps; i++) {
                try {
                    const stepResult = await solver.step();
                    
                    if (stepResult) {
                        const time = i * timeStep;
                        let voltage = 0;
                        
                        if (stepResult.nodeVoltages) {
                            voltage = stepResult.nodeVoltages[circuit.outputNode] || 0;
                        } else if (stepResult.stateVector && stepResult.stateVector.length > 0) {
                            voltage = stepResult.stateVector[0] || 0;
                        }
                        
                        results.push({ time: time * 1000, voltage: voltage }); // 時間轉ms
                        
                        if (i % Math.floor(totalSteps/10) === 0) {
                            updateStatus(`⚡ 模擬進度: ${Math.round(i/totalSteps*100)}%`, 'info', target);
                        }
                    }
                } catch (stepError) {
                    if (i % 1000 === 0) {
                        log(`步驟 ${i} 錯誤: ${stepError.message}`, 'error', target);
                    }
                }
            }
            
            const simTime_actual = performance.now() - startSim;
            const performance_rate = totalSteps / simTime_actual * 1000;
            
            // 更新性能顯示
            document.getElementById(`${target}Time`).textContent = `${simTime_actual.toFixed(1)}ms`;
            document.getElementById(`${target}Perf`).textContent = `${performance_rate.toFixed(0)} 步/秒`;
            
            // 分析結果
            if (results.length > 0) {
                const finalVoltage = results[results.length - 1].voltage;
                const error = Math.abs(finalVoltage - circuit.expectedFinalVoltage);
                const errorPercent = (error / circuit.expectedFinalVoltage * 100).toFixed(2);
                
                log(`✅ 模擬完成! 數據點: ${results.length}`, 'info', target);
                log(`📊 最終電壓: ${finalVoltage.toFixed(3)}V (預期: ${circuit.expectedFinalVoltage}V)`, 'info', target);
                log(`📊 誤差: ${error.toFixed(3)}V (${errorPercent}%)`, 'info', target);
                log(`⚡ 性能: ${performance_rate.toFixed(0)} 步/秒`, 'info', target);
                
                // 繪製圖表
                const chart = target === 'cpu' ? cpuChart : gpuChart;
                chart.data = {
                    labels: results.map(r => r.time.toFixed(3)),
                    datasets: [{
                        label: `${solverName} 輸出電壓`,
                        data: results.map(r => r.voltage),
                        borderColor: target === 'cpu' ? '#2563eb' : '#059669',
                        backgroundColor: target === 'cpu' ? 'rgba(37,99,235,0.1)' : 'rgba(5,150,105,0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }, {
                        label: '預期電壓',
                        data: results.map(() => circuit.expectedFinalVoltage),
                        borderColor: '#dc2626',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                };
                chart.update();
                
                updateStatus(`✅ 測試完成! 性能: ${performance_rate.toFixed(0)} 步/秒`, 'success', target);
                
                return {
                    solverName,
                    performance: performance_rate,
                    simTime: simTime_actual,
                    finalVoltage,
                    expectedVoltage: circuit.expectedFinalVoltage,
                    error: error,
                    errorPercent: parseFloat(errorPercent),
                    dataPoints: results.length
                };
                
            } else {
                throw new Error('沒有產生任何有效數據');
            }
            
        } catch (error) {
            log(`❌ 測試失敗: ${error.message}`, 'error', target);
            updateStatus(`❌ 測試失敗: ${error.message}`, 'error', target);
            throw error;
        }
    }

    // 比較結果
    function compareResults(cpuResult, gpuResult) {
        const comparison = document.getElementById('comparisonResult');
        
        if (cpuResult && gpuResult) {
            const speedup = gpuResult.performance / cpuResult.performance;
            const voltageMatch = Math.abs(cpuResult.finalVoltage - gpuResult.finalVoltage) < 0.01;
            
            comparison.textContent = `
📊 性能對比結果:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💻 CPU 求解器:
   ⏱️  執行時間: ${cpuResult.simTime.toFixed(1)}ms
   ⚡ 性能: ${cpuResult.performance.toFixed(0)} 步/秒
   📈 最終電壓: ${cpuResult.finalVoltage.toFixed(3)}V
   📊 誤差: ${cpuResult.errorPercent.toFixed(2)}%

🚀 GPU 求解器:
   ⏱️  執行時間: ${gpuResult.simTime.toFixed(1)}ms  
   ⚡ 性能: ${gpuResult.performance.toFixed(0)} 步/秒
   📈 最終電壓: ${gpuResult.finalVoltage.toFixed(3)}V
   📊 誤差: ${gpuResult.errorPercent.toFixed(2)}%

🏆 對比結果:
   🚀 GPU 加速比: ${speedup.toFixed(2)}x ${speedup > 1 ? '(GPU更快)' : '(CPU更快)'}
   ✅ 電壓一致性: ${voltageMatch ? '✓ 一致' : '✗ 不一致'}
   📊 電壓差異: ${Math.abs(cpuResult.finalVoltage - gpuResult.finalVoltage).toFixed(4)}V

${speedup > 2 ? '🎉 GPU顯著加速!' : speedup > 1 ? '✅ GPU略有優勢' : '⚠️ GPU性能問題'}
${voltageMatch ? '✅ 數值結果正確' : '❌ 數值結果有差異'}
`;
        } else if (cpuResult) {
            comparison.textContent = `只有CPU測試結果:\n性能: ${cpuResult.performance.toFixed(0)} 步/秒\n電壓: ${cpuResult.finalVoltage.toFixed(3)}V`;
        } else if (gpuResult) {
            comparison.textContent = `只有GPU測試結果:\n性能: ${gpuResult.performance.toFixed(0)} 步/秒\n電壓: ${gpuResult.finalVoltage.toFixed(3)}V`;
        }
    }

    // 初始化系統
    async function initialize() {
        try {
            log('檢查 AkingSPICE 庫...');
            
            if (typeof AkingSPICE === 'undefined') {
                throw new Error('AkingSPICE 庫未載入');
            }
            
            log('✅ AkingSPICE 庫載入成功');
            log(`可用組件: ${Object.keys(AkingSPICE).join(', ')}`);
            
            // 初始化 CPU 求解器
            if (AkingSPICE.ExplicitStateSolver) {
                cpuSolver = new AkingSPICE.ExplicitStateSolver({ debug: false });
                log('✅ CPU 求解器創建成功');
                document.getElementById('cpuBtn').disabled = false;
            } else {
                log('❌ ExplicitStateSolver 不可用');
            }
            
            // 初始化 GPU 求解器
            if (AkingSPICE.GPUExplicitStateSolver) {
                try {
                    gpuSolver = new AkingSPICE.GPUExplicitStateSolver({ debug: false });
                    log('✅ GPU 求解器創建成功');
                    document.getElementById('gpuBtn').disabled = false;
                } catch (gpuError) {
                    log(`❌ GPU 求解器創建失敗: ${gpuError.message}`);
                }
            } else {
                log('❌ GPUExplicitStateSolver 不可用');
            }
            
            // 初始化圖表
            cpuChart = initChart('cpuChart');
            gpuChart = initChart('gpuChart');
            
            document.getElementById('runTestBtn').disabled = false;
            isReady = true;
            log('✅ 系統初始化完成');
            
        } catch (error) {
            log(`❌ 初始化失敗: ${error.message}`);
        }
    }

    // 事件處理
    document.getElementById('cpuBtn').addEventListener('click', async () => {
        if (cpuSolver) {
            document.getElementById('cpuBtn').disabled = true;
            try {
                const result = await runSolverTest(cpuSolver, 'CPU');
                window.lastCpuResult = result;
                if (window.lastGpuResult) {
                    compareResults(result, window.lastGpuResult);
                }
            } finally {
                document.getElementById('cpuBtn').disabled = false;
            }
        }
    });

    document.getElementById('gpuBtn').addEventListener('click', async () => {
        if (gpuSolver) {
            document.getElementById('gpuBtn').disabled = true;
            try {
                const result = await runSolverTest(gpuSolver, 'GPU');
                window.lastGpuResult = result;
                if (window.lastCpuResult) {
                    compareResults(window.lastCpuResult, result);
                }
            } finally {
                document.getElementById('gpuBtn').disabled = false;
            }
        }
    });

    document.getElementById('runTestBtn').addEventListener('click', async () => {
        if (!isReady) return;
        
        document.getElementById('runTestBtn').disabled = true;
        
        try {
            // 清空之前的結果
            document.getElementById('cpuLog').textContent = '';
            document.getElementById('gpuLog').textContent = '';
            window.lastCpuResult = null;
            window.lastGpuResult = null;
            
            // 依序測試
            if (cpuSolver) {
                log('開始CPU測試...', 'info', 'cpu');
                const cpuResult = await runSolverTest(cpuSolver, 'CPU');
                window.lastCpuResult = cpuResult;
            }
            
            if (gpuSolver) {
                log('開始GPU測試...', 'info', 'gpu');
                const gpuResult = await runSolverTest(gpuSolver, 'GPU');
                window.lastGpuResult = gpuResult;
            }
            
            // 比較結果
            if (window.lastCpuResult || window.lastGpuResult) {
                compareResults(window.lastCpuResult, window.lastGpuResult);
            }
            
        } catch (error) {
            log(`測試過程發生錯誤: ${error.message}`);
        } finally {
            document.getElementById('runTestBtn').disabled = false;
        }
    });

    // 啟動初始化
    await initialize();
});
</script>

</body>
</html>