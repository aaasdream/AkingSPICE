<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>AkingSPICEæœ€åŸºæœ¬æ¸¬è©¦</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #2c3e50;
      color: white;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
    }

    #log {
      height: 400px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }

    .success {
      color: #27ae60;
    }

    .error {
      color: #e74c3c;
    }

    .warning {
      color: #f39c12;
    }

    .info {
      color: #3498db;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>âš¡ AkingSPICEæœ€åŸºæœ¬æ¸¬è©¦</h1>
    <p>å¾æœ€ç°¡å–®çš„é›»è·¯é–‹å§‹é€æ­¥æ¸¬è©¦</p>

    <div id="log">é–‹å§‹æœ€åŸºæœ¬çš„AkingSPICEæ¸¬è©¦...<br></div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    function log(message, type = 'info') {
      const colors = {
        'success': '#27ae60',
        'error': '#e74c3c',
        'warning': '#f39c12',
        'info': '#3498db'
      };

      const time = new Date().toLocaleTimeString();
      const logElement = document.getElementById('log');
      logElement.innerHTML += `<span style="color: ${colors[type]};">[${time}] ${message}</span><br>`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', function () {
      log('âš¡ é–‹å§‹AkingSPICEæœ€åŸºæœ¬æ¸¬è©¦', 'success');

      if (!window.AkingSPICE) {
        log('âŒ AkingSPICEæœªè¼‰å…¥', 'error');
        return;
      }

      const spice = window.AkingSPICE;
      const { VoltageSource, Resistor, ExplicitStateSolver } = spice;

      // æ¸¬è©¦1: åªæœ‰é›»å£“æº (æ‡‰è©²å¤±æ•—ï¼Œå› ç‚ºæ²’æœ‰å®Œæ•´å›è·¯)
      try {
        log('ğŸ§ª æ¸¬è©¦1: åªæœ‰é›»å£“æº (ç„¡å›è·¯)', 'info');
        const onlyVoltage = [
          new VoltageSource('V1', [1, 0], 5.0)
        ];

        const solver1 = new ExplicitStateSolver();
        solver1.initialize(onlyVoltage, 1e-3);
        log('âš ï¸ æ¸¬è©¦1æ„å¤–é€šé (åªæœ‰é›»å£“æº)', 'warning');
      } catch (e1) {
        log(`âœ… æ¸¬è©¦1æ­£ç¢ºå¤±æ•—: ${e1.message}`, 'success');
      }

      // æ¸¬è©¦2: é›»å£“æº + é›»é˜» (æœ€ç°¡å–®çš„å®Œæ•´é›»è·¯)
      try {
        log('ğŸ§ª æ¸¬è©¦2: V + R (æœ€ç°¡å–®å®Œæ•´é›»è·¯)', 'info');
        const vr_circuit = [
          new VoltageSource('V1', [1, 0], 5.0),
          new Resistor('R1', [1, 0], 10.0)
        ];

        log('å‰µå»ºé›»è·¯çµ„ä»¶...', 'info');
        const solver2 = new ExplicitStateSolver();

        log('åˆå§‹åŒ–æ±‚è§£å™¨ (å¯¬é¬†åƒæ•¸)...', 'info');
        solver2.initialize(vr_circuit, 1e-3, {
          maxIterations: 20,   // åªå…è¨±20æ¬¡è¿­ä»£
          tolerance: 1e-2,     // éå¸¸å¯¬é¬†çš„å®¹å·® 1%
          debug: true
        });

        log('âœ… æ¸¬è©¦2åˆå§‹åŒ–æˆåŠŸ', 'success');

        // åŸ·è¡Œä¸€æ­¥
        log('åŸ·è¡Œæ±‚è§£æ­¥é©Ÿ...', 'info');
        const result2 = solver2.step();

        log(`âœ… æ¸¬è©¦2åŸ·è¡ŒæˆåŠŸ: nodeVoltages = ${JSON.stringify(result2.nodeVoltages)}`, 'success');

        // é©—è­‰çµæœ (5Vé›»æºï¼Œ10Î©é›»é˜»ï¼Œæ‡‰è©²æœ‰0.5Aé›»æµ)
        const v1 = result2.nodeVoltages[1] || 0;
        const current = v1 / 10.0;
        log(`è¨ˆç®—: V1=${v1.toFixed(3)}V, I=${current.toFixed(3)}A`, 'info');

      } catch (e2) {
        log(`âŒ æ¸¬è©¦2å¤±æ•—: ${e2.message}`, 'error');

        // å¦‚æœåŸºæœ¬é›»è·¯éƒ½å¤±æ•—ï¼Œå˜—è©¦æ›´å¯¬é¬†çš„åƒæ•¸
        try {
          log('ğŸ”§ å˜—è©¦æ¥µå¯¬é¬†åƒæ•¸...', 'warning');
          const vr_circuit2 = [
            new VoltageSource('V1', [1, 0], 1.0),  // é™ä½åˆ°1V
            new Resistor('R1', [1, 0], 1000.0)     // å¢åŠ åˆ°1kÎ©
          ];

          const solver3 = new ExplicitStateSolver();
          solver3.initialize(vr_circuit2, 1e-2, {   // 10mså¤§æ™‚é–“æ­¥é•·
            maxIterations: 5,     // åªå…è¨±5æ¬¡è¿­ä»£
            tolerance: 1e-1,      // 10%å®¹å·®
            debug: true
          });

          const result3 = solver3.step();
          log(`âœ… æ¥µå¯¬é¬†åƒæ•¸æˆåŠŸ: ${JSON.stringify(result3.nodeVoltages)}`, 'success');

        } catch (e3) {
          log(`âŒ é€£æ¥µå¯¬é¬†åƒæ•¸éƒ½å¤±æ•—: ${e3.message}`, 'error');
        }
      }

      // æ¸¬è©¦3: æª¢æŸ¥çµ„ä»¶å…§éƒ¨ç‹€æ…‹
      try {
        log('ğŸ§ª æ¸¬è©¦3: æª¢æŸ¥çµ„ä»¶å…§éƒ¨ç‹€æ…‹', 'info');

        const v_test = new VoltageSource('V1', [1, 0], 5.0);
        const r_test = new Resistor('R1', [1, 0], 10.0);

        log(`VoltageSource: name=${v_test.name}, nodes=${JSON.stringify(v_test.nodes)}, voltage=${v_test.voltage}`, 'info');
        log(`Resistor: name=${r_test.name}, nodes=${JSON.stringify(r_test.nodes)}, resistance=${r_test.resistance}`, 'info');

        // æª¢æŸ¥æ˜¯å¦æœ‰stampæ–¹æ³•
        if (typeof v_test.stamp === 'function') {
          log('âœ… VoltageSourceæœ‰stampæ–¹æ³•', 'success');
        } else {
          log('âŒ VoltageSourceæ²’æœ‰stampæ–¹æ³•', 'error');
        }

        if (typeof r_test.stamp === 'function') {
          log('âœ… Resistoræœ‰stampæ–¹æ³•', 'success');
        } else {
          log('âŒ Resistoræ²’æœ‰stampæ–¹æ³•', 'error');
        }

      } catch (e3) {
        log(`âŒ æ¸¬è©¦3å¤±æ•—: ${e3.message}`, 'error');
      }

      // æ¸¬è©¦4: æ‰‹å‹•å‰µå»ºæœ€ç°¡å–®çš„çŸ©é™£
      try {
        log('ğŸ§ª æ¸¬è©¦4: æ‰‹å‹•çŸ©é™£æ¸¬è©¦', 'info');

        // å‰µå»ºä¸€å€‹2x2çŸ©é™£ [2 1; 1 2] x = [3; 4]
        // è§£æ‡‰è©²æ˜¯ x = [2/3; 4/3]

        if (spice.Matrix) {
          const Matrix = spice.Matrix;
          const mat = new Matrix(2, 2);
          mat.set(0, 0, 2.0);
          mat.set(0, 1, 1.0);
          mat.set(1, 0, 1.0);
          mat.set(1, 1, 2.0);

          const b = new Float64Array([3.0, 4.0]);

          log('å‰µå»º2x2æ¸¬è©¦çŸ©é™£', 'info');
          log(`Matrix[0,0]=${mat.get(0, 0)}, Matrix[0,1]=${mat.get(0, 1)}`, 'info');
          log(`Matrix[1,0]=${mat.get(1, 0)}, Matrix[1,1]=${mat.get(1, 1)}`, 'info');

          // ç›´æ¥æ‰‹ç®—é©—è­‰
          const x_manual = [(3 * 2 - 1 * 4) / (2 * 2 - 1 * 1), (4 * 2 - 3 * 1) / (2 * 2 - 1 * 1)];
          log(`æ‰‹ç®—è§£: x=[${x_manual[0].toFixed(3)}, ${x_manual[1].toFixed(3)}]`, 'success');

        } else {
          log('âŒ æ‰¾ä¸åˆ°Matrixé¡', 'error');
        }

      } catch (e4) {
        log(`âŒ æ¸¬è©¦4å¤±æ•—: ${e4.message}`, 'error');
      }

      log('ğŸ åŸºæœ¬æ¸¬è©¦å®Œæˆ', 'success');
    });

  </script>
</body>

</html>