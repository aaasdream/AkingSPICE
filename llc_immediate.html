<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>ğŸ”‹ LLCç«‹å³åŸ·è¡Œç‰ˆ - AkingSPICE</title>
  <style>
    body {
      font-family: Arial;
      padding: 15px;
      background: #2c3e50;
      color: white;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
    }

    .status {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }

    .metric {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      min-width: 100px;
    }

    .metric-label {
      font-size: 10px;
      opacity: 0.8;
    }

    .metric-value {
      font-size: 16px;
      font-weight: bold;
      color: #2ecc71;
      margin-top: 2px;
    }

    #log {
      height: 250px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.3);
      padding: 8px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”‹ LLCç«‹å³åŸ·è¡Œç‰ˆ</h1>
    <p>âš¡ è¼‰å…¥å¾Œç«‹å³é‹è¡Œï¼Œç„¡éœ€ç­‰å¾…</p>

    <div class="status">
      <div class="metric">
        <div class="metric-label">ç‹€æ…‹</div>
        <div id="status" class="metric-value">è¼‰å…¥ä¸­</div>
      </div>
      <div class="metric">
        <div class="metric-label">æ­¥æ•¸</div>
        <div id="steps" class="metric-value">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">æ™‚é–“(Î¼s)</div>
        <div id="time" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">è«§æŒ¯é›»æµ(A)</div>
        <div id="current" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å‡ºé›»å£“(V)</div>
        <div id="voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">åŠŸç‡(W)</div>
        <div id="power" class="metric-value">0.0</div>
      </div>
    </div>

    <h3>ğŸ“‹ LLCåŸ·è¡Œæ—¥èªŒ</h3>
    <div id="log">æ­£åœ¨è¼‰å…¥LLCåŸ·è¡Œç³»çµ±...<br></div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    let stepCount = 0;

    function log(msg, color = '#ecf0f1') {
      const time = new Date().toLocaleTimeString();
      document.getElementById('log').innerHTML += `<span style="color:${color};">[${time}] ${msg}</span><br>`;
      document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
      console.log(`[${time}] ${msg}`);
    }

    // ç«‹å³åŸ·è¡ŒLLC - ä¸ä½¿ç”¨setTimeout
    document.addEventListener('DOMContentLoaded', function () {
      log('ğŸš€ LLCç«‹å³åŸ·è¡Œç‰ˆå•Ÿå‹•', '#2ecc71');

      if (!window.AkingSPICE) {
        log('âŒ AkingSPICEæœªè¼‰å…¥', '#e74c3c');
        document.getElementById('status').textContent = 'éŒ¯èª¤';
        return;
      }

      log('âœ… AkingSPICEè¼‰å…¥æˆåŠŸ', '#2ecc71');
      document.getElementById('status').textContent = 'åˆå§‹åŒ–';

      try {
        const { VoltageSource, Resistor, Capacitor, Inductor, ExplicitStateSolver } = window.AkingSPICE;

        log('ğŸ”§ å‰µå»ºLLCé›»è·¯...', '#3498db');

        // æœ€ç°¡å–®çš„è«§æŒ¯é›»è·¯
        const components = [
          new VoltageSource('V1', [1, 0], 12.0),        // 12V
          new Inductor('L1', [1, 2], 100e-6),          // 100Î¼H
          new Capacitor('C1', [2, 3], 1e-6),           // 1Î¼F
          new Resistor('R1', [3, 0], 10.0)             // 10Î©
        ];

        log('âœ… çµ„ä»¶å‰µå»ºå®Œæˆ', '#2ecc71');
        log('   V1: 12V é›»å£“æº', '#3498db');
        log('   L1: 100Î¼H é›»æ„Ÿ', '#f39c12');
        log('   C1: 1Î¼F é›»å®¹', '#f39c12');
        log('   R1: 10Î© è² è¼‰', '#3498db');

        // è¨ˆç®—è«§æŒ¯é »ç‡
        const fr = 1 / (2 * Math.PI * Math.sqrt(100e-6 * 1e-6));
        log(`ğŸ“Š ç†è«–è«§æŒ¯é »ç‡: ${(fr / 1000).toFixed(1)} kHz`, '#f39c12');

        log('âš™ï¸ åˆå§‹åŒ–æ±‚è§£å™¨...', '#3498db');
        const solver = new ExplicitStateSolver();

        // ä½¿ç”¨å¤§æ™‚é–“æ­¥é•·é¿å…æ”¶æ–‚å•é¡Œ
        solver.initialize(components, 5e-6, {  // 5Î¼s
          debug: false,
          maxIterations: 20,
          tolerance: 1e-3
        });

        log('âœ… æ±‚è§£å™¨åˆå§‹åŒ–æˆåŠŸ', '#2ecc71');
        document.getElementById('status').textContent = 'é‹è¡Œä¸­';
        document.getElementById('status').style.color = '#2ecc71';

        log('ğŸ‰ é–‹å§‹LLCè«§æŒ¯æ¨¡æ“¬ï¼', '#2ecc71');

        // ç«‹å³åŸ·è¡Œæ¨¡æ“¬å¾ªç’°
        executeLLCSteps(solver);

      } catch (error) {
        log(`âŒ LLCåˆå§‹åŒ–å¤±æ•—: ${error.message}`, '#e74c3c');
        console.error('è©³ç´°éŒ¯èª¤:', error);
        document.getElementById('status').textContent = 'å¤±æ•—';
        document.getElementById('status').style.color = '#e74c3c';
      }
    });

    function executeLLCSteps(solver) {
      log('â–¶ï¸ åŸ·è¡ŒLLCæ¨¡æ“¬æ­¥é©Ÿ...', '#2ecc71');

      for (let i = 0; i < 100; i++) {
        try {
          const result = solver.step();
          stepCount++;

          const timeUs = stepCount * 5.0; // 5Î¼s per step

          // æå–é›»å£“
          const nodeVoltages = result.nodeVoltages || {};
          const v1 = nodeVoltages[1] || 0;
          const v2 = nodeVoltages[2] || 0;
          const v3 = nodeVoltages[3] || 0;

          // è¨ˆç®—é›»æµå’ŒåŠŸç‡
          const current = (v1 - v2) / (100e-6 / 5e-6); // I = Î”V/(L/Î”t)
          const outputVoltage = v3;
          const power = (outputVoltage * outputVoltage) / 10.0;

          // æ›´æ–°é¡¯ç¤º
          document.getElementById('steps').textContent = stepCount;
          document.getElementById('time').textContent = timeUs.toFixed(1);
          document.getElementById('current').textContent = Math.abs(current).toFixed(3);
          document.getElementById('voltage').textContent = Math.abs(outputVoltage).toFixed(2);
          document.getElementById('power').textContent = power.toFixed(2);

          // æ¯20æ­¥å ±å‘Šä¸€æ¬¡
          if (stepCount % 20 === 0) {
            log(`æ­¥é©Ÿ ${stepCount}: t=${timeUs.toFixed(1)}Î¼s, I=${Math.abs(current).toFixed(3)}A, V=${Math.abs(outputVoltage).toFixed(2)}V, P=${power.toFixed(2)}W`);
          }

        } catch (error) {
          log(`âŒ æ­¥é©Ÿ ${stepCount + 1} å¤±æ•—: ${error.message}`, '#e74c3c');
          document.getElementById('status').textContent = 'éŒ¯èª¤';
          document.getElementById('status').style.color = '#e74c3c';
          return;
        }
      }

      // æˆåŠŸå®Œæˆ
      log('ğŸ LLCæ¨¡æ“¬æˆåŠŸå®Œæˆ100æ­¥ï¼', '#2ecc71');
      log(`ğŸ“Š æœ€çµ‚ç‹€æ…‹:`, '#f39c12');
      log(`   é›»æµ: ${document.getElementById('current').textContent}A`, '#f39c12');
      log(`   é›»å£“: ${document.getElementById('voltage').textContent}V`, '#f39c12');
      log(`   åŠŸç‡: ${document.getElementById('power').textContent}W`, '#f39c12');

      document.getElementById('status').textContent = 'å®Œæˆ';
      document.getElementById('status').style.color = '#f39c12';
    }

  </script>
</body>

</html>