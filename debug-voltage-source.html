<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ” AkingSPICE æ·±åº¦èª¿è©¦ - é›»å£“æºå•é¡Œè¨ºæ–·</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f0f0f0;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
        }
        button:hover:not(:disabled) { background: #b91c1c; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
        }
        .debug-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            height: 350px;
            background: #fafafa;
            border-radius: 8px;
            padding: 10px;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px 0;
        }
        .status.error { background: #fee; color: #c00; }
        .status.success { background: #efe; color: #060; }
        .status.warning { background: #ffe; color: #960; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ” AkingSPICE æ·±åº¦èª¿è©¦ - é›»å£“æºå•é¡Œè¨ºæ–·</h1>
        <p>è©³ç´°åˆ†æç‚ºä»€éº¼æ‰€æœ‰ç¯€é»é›»å£“éƒ½æ˜¯ 0V</p>
    </div>

    <div class="controls">
        <button id="debugBtn">ğŸ” æ·±åº¦èª¿è©¦</button>
        <button id="testVSourceBtn">âš¡ æ¸¬è©¦é›»å£“æº</button>
        <button id="matrixBtn">ğŸ“Š æŸ¥çœ‹ç³»çµ±çŸ©é™£</button>
        <button id="clearBtn">æ¸…é™¤</button>
        <span style="color: #666;">| ç›®æ¨™: æ‰¾å‡ºé›»å£“æºå¤±æ•ˆåŸå› </span>
    </div>

    <div class="log" id="debugLog">æº–å‚™é€²è¡Œæ·±åº¦èª¿è©¦...</div>
</div>

<div class="debug-section">
    <div class="container">
        <h3>ğŸ§® ç³»çµ±ç‹€æ…‹åˆ†æ</h3>
        <div id="systemStatus">ç­‰å¾…åˆ†æ...</div>
        <div class="chart-container">
            <canvas id="voltageChart"></canvas>
        </div>
    </div>
    
    <div class="container">
        <h3>âš¡ é›»è·¯å…ƒä»¶è¨ºæ–·</h3>
        <div id="componentStatus">ç­‰å¾…è¨ºæ–·...</div>
        <div class="chart-container">
            <canvas id="currentChart"></canvas>
        </div>
    </div>
</div>

<script src="./lib-dist/AkingSPICE.umd.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let voltageChart = null;
    let currentChart = null;
    
    // åˆå§‹åŒ–åœ–è¡¨
    function initCharts() {
        const voltageCtx = document.getElementById('voltageChart').getContext('2d');
        voltageChart = new Chart(voltageCtx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { title: { display: true, text: 'ç¯€é»é›»å£“åˆ†æ' } },
                scales: {
                    x: { title: { display: true, text: 'æ™‚é–“ (ms)' } },
                    y: { title: { display: true, text: 'é›»å£“ (V)' } }
                }
            }
        });
        
        const currentCtx = document.getElementById('currentChart').getContext('2d');
        currentChart = new Chart(currentCtx, {
            type: 'line',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { title: { display: true, text: 'å…ƒä»¶é›»æµåˆ†æ' } },
                scales: {
                    x: { title: { display: true, text: 'æ™‚é–“ (ms)' } },
                    y: { title: { display: true, text: 'é›»æµ (A)' } }
                }
            }
        });
    }

    function log(message, type = 'info') {
        const debugLog = document.getElementById('debugLog');
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
            error: '#ff4444',
            success: '#44ff44', 
            warning: '#ffff44',
            info: '#44ffff',
            debug: '#ff44ff'
        };
        const color = colors[type] || '#00ff00';
        debugLog.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
        debugLog.scrollTop = debugLog.scrollHeight;
    }

    function updateStatus(containerId, content, type = 'info') {
        const container = document.getElementById(containerId);
        container.innerHTML = `<div class="status ${type}">${content}</div>`;
    }

    async function deepDebugAnalysis() {
        try {
            log('ğŸ” é–‹å§‹æ·±åº¦èª¿è©¦åˆ†æ...', 'info');
            
            // æª¢æŸ¥åº«
            if (typeof AkingSPICE === 'undefined') {
                throw new Error('AkingSPICE åº«æœªè¼‰å…¥');
            }
            log('âœ… AkingSPICE åº«è¼‰å…¥æˆåŠŸ', 'success');
            
            // åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„é¡
            log('ğŸ“‹ å¯ç”¨é¡å‹:', 'debug');
            for (const key in AkingSPICE) {
                log(`   ${key}: ${typeof AkingSPICE[key]}`, 'debug');
            }
            
            // å‰µå»ºæ±‚è§£å™¨
            const solver = new AkingSPICE.ExplicitStateSolver();
            log('âœ… ExplicitStateSolver å‰µå»ºæˆåŠŸ', 'success');
            
            // æª¢æŸ¥æ±‚è§£å™¨æ–¹æ³•
            log('ğŸ“‹ æ±‚è§£å™¨æ–¹æ³•:', 'debug');
            for (const method of ['initialize', 'step', 'reset', 'getState']) {
                log(`   ${method}: ${typeof solver[method]}`, 'debug');
            }
            
            // å‰µå»ºæ¸¬è©¦é›»è·¯
            const { VoltageSource, Resistor, Capacitor } = AkingSPICE;
            
            log('ğŸ”§ å‰µå»ºæ¸¬è©¦çµ„ä»¶...', 'info');
            
            // æ¸¬è©¦ä¸åŒçš„é›»å£“æºå‰µå»ºæ–¹å¼
            let vsource = null;
            try {
                vsource = new VoltageSource('V1', ['1', '0'], 12);
                log(`âœ… é›»å£“æºå‰µå»ºæˆåŠŸ: ${vsource.constructor.name}`, 'success');
                log(`   ç¯€é»: ${vsource.nodes ? vsource.nodes.join(', ') : 'æœªçŸ¥'}`, 'debug');
                log(`   é›»å£“å€¼: ${vsource.voltage || vsource.value || 'æœªçŸ¥'}V`, 'debug');
            } catch (e) {
                log(`âŒ é›»å£“æºå‰µå»ºå¤±æ•—: ${e.message}`, 'error');
                return;
            }
            
            let resistor = null;
            try {
                resistor = new Resistor('R1', ['1', '2'], 1000);
                log(`âœ… é›»é˜»å‰µå»ºæˆåŠŸ: ${resistor.constructor.name}`, 'success');
                log(`   é˜»å€¼: ${resistor.resistance || resistor.value || 'æœªçŸ¥'}Î©`, 'debug');
            } catch (e) {
                log(`âŒ é›»é˜»å‰µå»ºå¤±æ•—: ${e.message}`, 'error');
                return;
            }
            
            let capacitor = null;
            try {
                capacitor = new Capacitor('C1', ['2', '0'], 1e-6, { ic: 0 });
                log(`âœ… é›»å®¹å‰µå»ºæˆåŠŸ: ${capacitor.constructor.name}`, 'success');
                log(`   å®¹å€¼: ${capacitor.capacitance || capacitor.value || 'æœªçŸ¥'}F`, 'debug');
            } catch (e) {
                log(`âŒ é›»å®¹å‰µå»ºå¤±æ•—: ${e.message}`, 'error');
                return;
            }
            
            const components = [vsource, resistor, capacitor];
            log('ğŸ“¦ æ‰€æœ‰çµ„ä»¶å‰µå»ºå®Œæˆ', 'success');
            
            // æª¢æŸ¥çµ„ä»¶å…§éƒ¨çµæ§‹
            log('ğŸ” çµ„ä»¶å…§éƒ¨çµæ§‹åˆ†æ:', 'debug');
            components.forEach((comp, i) => {
                log(`   çµ„ä»¶ ${i}: ${comp.constructor.name}`, 'debug');
                for (const key in comp) {
                    if (typeof comp[key] !== 'function') {
                        log(`     ${key}: ${comp[key]}`, 'debug');
                    }
                }
            });
            
            // å˜—è©¦åˆå§‹åŒ–
            const timeStep = 10e-6;
            log(`ğŸš€ å˜—è©¦åˆå§‹åŒ–æ±‚è§£å™¨ (timeStep=${timeStep*1e6}Âµs)...`, 'info');
            
            try {
                await solver.initialize(components, timeStep, {
                    debug: true,  // é–‹å•Ÿèª¿è©¦æ¨¡å¼
                    integrationMethod: 'forward_euler'
                });
                log('âœ… æ±‚è§£å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
            } catch (initError) {
                log(`âŒ åˆå§‹åŒ–å¤±æ•—: ${initError.message}`, 'error');
                log(`   å †ç–Š: ${initError.stack}`, 'debug');
                return;
            }
            
            // æª¢æŸ¥åˆå§‹ç‹€æ…‹
            try {
                if (typeof solver.getState === 'function') {
                    const state = solver.getState();
                    log('ğŸ” åˆå§‹ç‹€æ…‹æª¢æŸ¥:', 'info');
                    if (state && state.nodeVoltages) {
                        for (const [node, voltage] of Object.entries(state.nodeVoltages)) {
                            log(`   ç¯€é» ${node}: ${voltage}V`, 'debug');
                        }
                    } else {
                        log('   âš ï¸  ç„¡æ³•ç²å–åˆå§‹ç¯€é»é›»å£“', 'warning');
                    }
                } else {
                    log('   âš ï¸  æ±‚è§£å™¨æ²’æœ‰ getState æ–¹æ³•', 'warning');
                }
            } catch (stateError) {
                log(`   âš ï¸  ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${stateError.message}`, 'warning');
            }
            
            // å˜—è©¦å–®æ­¥åŸ·è¡Œ
            log('âš¡ åŸ·è¡Œç¬¬ä¸€æ­¥...', 'info');
            try {
                const result = solver.step({});
                log('âœ… ç¬¬ä¸€æ­¥åŸ·è¡ŒæˆåŠŸ', 'success');
                
                if (result && result.nodeVoltages) {
                    log('ğŸ“Š ç¬¬ä¸€æ­¥çµæœ:', 'info');
                    for (const [node, voltage] of Object.entries(result.nodeVoltages)) {
                        log(`   ç¯€é» ${node}: ${voltage}V`, 'debug');
                    }
                    
                    if (Math.max(...Object.values(result.nodeVoltages)) === 0) {
                        log('âŒ é—œéµå•é¡Œ: æ‰€æœ‰ç¯€é»é›»å£“éƒ½æ˜¯ 0V!', 'error');
                        log('   å¯èƒ½åŸå› :', 'warning');
                        log('   1. é›»å£“æºæœªæ­£ç¢ºæ·»åŠ åˆ°ç³»çµ±çŸ©é™£', 'warning');
                        log('   2. ç¯€é»ç·¨è™Ÿæ˜ å°„éŒ¯èª¤', 'warning');  
                        log('   3. åˆå§‹æ¢ä»¶è¨­ç½®å•é¡Œ', 'warning');
                        log('   4. æ±‚è§£å™¨å…§éƒ¨ç®—æ³•éŒ¯èª¤', 'warning');
                    }
                } else {
                    log('âŒ ç¬¬ä¸€æ­¥æ²’æœ‰è¿”å›æœ‰æ•ˆçµæœ', 'error');
                }
            } catch (stepError) {
                log(`âŒ ç¬¬ä¸€æ­¥åŸ·è¡Œå¤±æ•—: ${stepError.message}`, 'error');
                log(`   å †ç–Š: ${stepError.stack}`, 'debug');
            }
            
            updateStatus('systemStatus', 'æ·±åº¦åˆ†æå®Œæˆï¼Œç™¼ç¾é›»å£“æºå¯èƒ½æœªæ­£ç¢ºå·¥ä½œ', 'error');
            updateStatus('componentStatus', 'æ‰€æœ‰çµ„ä»¶å‰µå»ºæˆåŠŸï¼Œä½†ç³»çµ±çŸ©é™£å¯èƒ½æœ‰å•é¡Œ', 'warning');
            
        } catch (error) {
            log(`âŒ æ·±åº¦èª¿è©¦å¤±æ•—: ${error.message}`, 'error');
            log(`   å †ç–Š: ${error.stack}`, 'debug');
        }
    }

    async function testVoltageSource() {
        try {
            log('âš¡ æ¸¬è©¦é›»å£“æºç¨ç«‹åŠŸèƒ½...', 'info');
            
            const { VoltageSource } = AkingSPICE;
            
            // å˜—è©¦ä¸åŒçš„åƒæ•¸çµ„åˆ
            const testCases = [
                { nodes: ['1', '0'], voltage: 12 },
                { nodes: [1, 0], voltage: 12 },
                { nodes: ['pos', 'gnd'], voltage: 12 },
                { nodes: ['a', 'b'], voltage: 5 }
            ];
            
            for (let i = 0; i < testCases.length; i++) {
                const testCase = testCases[i];
                try {
                    const vs = new VoltageSource(`V${i+1}`, testCase.nodes, testCase.voltage);
                    log(`âœ… æ¸¬è©¦ ${i+1}: ç¯€é»=${JSON.stringify(testCase.nodes)}, é›»å£“=${testCase.voltage}V`, 'success');
                    
                    // æª¢æŸ¥å…§éƒ¨å±¬æ€§
                    for (const key in vs) {
                        if (typeof vs[key] !== 'function' && key !== 'constructor') {
                            log(`     ${key}: ${vs[key]}`, 'debug');
                        }
                    }
                } catch (e) {
                    log(`âŒ æ¸¬è©¦ ${i+1} å¤±æ•—: ${e.message}`, 'error');
                }
            }
            
        } catch (error) {
            log(`âŒ é›»å£“æºæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
        }
    }

    function clearLog() {
        document.getElementById('debugLog').innerHTML = 'æº–å‚™é€²è¡Œæ·±åº¦èª¿è©¦...';
        updateStatus('systemStatus', 'ç­‰å¾…åˆ†æ...', 'info');
        updateStatus('componentStatus', 'ç­‰å¾…è¨ºæ–·...', 'info');
    }

    // åˆå§‹åŒ–
    initCharts();
    
    // äº‹ä»¶ç›£è½å™¨
    document.getElementById('debugBtn').addEventListener('click', deepDebugAnalysis);
    document.getElementById('testVSourceBtn').addEventListener('click', testVoltageSource);
    document.getElementById('clearBtn').addEventListener('click', clearLog);
});
</script>

</body>
</html>