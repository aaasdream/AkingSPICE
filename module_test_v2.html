<!DOCTYPE html>
<html>

<head>
  <title>模組結構測試 V2</title>
</head>

<body>
  <h1>AkingSPICE模組結構測試 V2</h1>
  <div id="log"></div>

  <script type="module">
    function log(msg) {
      console.log(msg);
      document.getElementById('log').innerHTML += '<p>' + new Date().toLocaleTimeString() + ': ' + msg + '</p>';
    }

    log('開始模組結構測試...');

    try {
      const module = await import('./lib-dist/AkingSPICE.es.js');
      log('✅ 模組載入成功');

      // 檢查可用的組件
      log('可用組件: ' + Object.keys(module).join(', '));

      // 嘗試直接訪問VoltageSource
      if (module.VoltageSource) {
        log('✅ 找到VoltageSource組件');
        try {
          const vs = new module.VoltageSource('V1', [1, 0], 5.0);
          log('✅ 成功創建電壓源: ' + vs.name + ', 值: ' + vs.value + 'V');
        } catch (err) {
          log('❌ 創建電壓源失敗: ' + err.message);
        }
      } else {
        log('❌ 沒有找到VoltageSource');
      }

      // 嘗試訪問ExplicitStateSolver
      if (module.ExplicitStateSolver) {
        log('✅ 找到ExplicitStateSolver');
        try {
          const solver = new module.ExplicitStateSolver();
          log('✅ 成功創建求解器');

          // 嘗試運行一個簡單的電路
          const components = [];
          if (module.VoltageSource && module.Resistor && module.Capacitor) {
            components.push(new module.VoltageSource('V1', [1, 0], 5.0));
            components.push(new module.Resistor('R1', [1, 2], 1000));
            components.push(new module.Capacitor('C1', [2, 0], 1e-6));

            log('✅ 創建了' + components.length + '個組件');

            // 嘗試初始化求解器
            try {
              await solver.initialize(components, 1e-6);
              log('✅ 求解器初始化成功');

              // 運行幾個步驟
              for (let i = 0; i < 3; i++) {
                const result = solver.step();
                const vOut = result.nodeVoltages[2] || 0;
                log(`步驟 ${i + 1}: V_out = ${vOut.toFixed(3)}V`);
              }
              log('🎉 完整測試成功！');

            } catch (err) {
              log('❌ 求解器初始化失敗: ' + err.message);
            }
          } else {
            log('❌ 缺少必要的組件類');
          }
        } catch (err) {
          log('❌ 創建求解器失敗: ' + err.message);
        }
      } else {
        log('❌ 沒有找到ExplicitStateSolver');
      }

    } catch (error) {
      log('❌ 測試失敗: ' + error.message);
      console.error('詳細錯誤:', error);
    }
  </script>
</body>

</html>