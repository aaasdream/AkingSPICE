<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”‹ LLCè«§æŒ¯è®Šå£“å™¨ - AkingSPICE</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #1a252f 0%, #2e4057 50%, #1a252f 100%);
      color: white;
    }

    .container {
      max-width: 1500px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 25px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .circuit-diagram {
      background: rgba(0, 0, 0, 0.4);
      padding: 25px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.4;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }

    .metric {
      background: rgba(255, 255, 255, 0.1);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .metric-label {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #2ecc71;
    }

    .btn {
      padding: 10px 20px;
      margin: 6px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .btn-primary {
      background: #27ae60;
      color: white;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-info {
      background: #3498db;
      color: white;
    }

    #waveformCanvas {
      width: 100%;
      height: 400px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      display: block;
      margin: 10px 0;
    }

    #log {
      height: 320px;
      overflow-y: auto;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      background: rgba(0, 0, 0, 0.4);
      margin-top: 20px;
    }

    .primary-side {
      color: #3498db;
      font-weight: bold;
    }

    .secondary-side {
      color: #e74c3c;
      font-weight: bold;
    }

    .resonant {
      color: #f39c12;
      font-weight: bold;
    }

    .transformer {
      color: #9b59b6;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”‹ LLCè«§æŒ¯è®Šå£“å™¨ - AkingSPICE</h1>
    <p>âš¡ å®Œæ•´LLCæ‹“æ’²ï¼šåŸé‚Šè«§æŒ¯æ§½ â†’ è®Šå£“å™¨ â†’ å‰¯é‚Šæ•´æµ â†’ è¼¸å‡ºæ¿¾æ³¢</p>

    <div class="circuit-diagram">
      <h3>ğŸ“ LLCè«§æŒ¯è®Šå£“å™¨å®Œæ•´é›»è·¯æ‹“æ’²</h3>
      <pre>
<span class="primary-side">ã€åŸé‚Š Primary Sideã€‘</span>                <span class="transformer">ã€è®Šå£“å™¨ã€‘</span>               <span class="secondary-side">ã€å‰¯é‚Š Secondary Sideã€‘</span>
    
  Vin(400V)      Lr(è«§æŒ¯é›»æ„Ÿ)     Cr(è«§æŒ¯é›»å®¹)      â”Œâ”€â”€â”€â”€â”€â”€â”          D1(æ•´æµäºŒæ¥µç®¡)
     +  â”€â”€â”€â”€LLLLLâ”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€ Vo+
                               â”‚       â”‚  T1  â”‚                    â”‚
                         Lm(å‹µç£é›»æ„Ÿ)  â”‚      â”‚                    â”‚
                         LLLLL        â”‚      â”‚                    â”‚ Co(æ¿¾æ³¢é›»å®¹)
                               â”‚       â”‚      â”‚                    â”‚ â”¤â”œ
     -  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€ Vo-
                                         â””â”€â”€â”€â”€â”€â”€â”˜              â”‚
                                                               â”‚
                                                           D2(çºŒæµäºŒæ¥µç®¡)
                                                              â”¤â”œ
                                                               â”‚
                                                              â”€â”€â”€
    
<span class="resonant">è«§æŒ¯é »ç‡:</span> fr = 1/(2Ï€âˆš(LrÂ·Cr)) â‰ˆ 159.2 kHz
<span class="transformer">è®Šå£“æ¯”:</span> n = Np/Ns = 10:1 (400V â†’ 40V)
<span class="secondary-side">æ•´æµæ¨¡å¼:</span> ä¸­å¿ƒæŠ½é ­å…¨æ³¢æ•´æµ + åŒæ­¥æ•´æµ
    </pre>
    </div>

    <div style="text-align: center; margin: 20px 0;">
      <button class="btn btn-primary" onclick="startLLCTransformer()">ğŸš€ å•Ÿå‹•LLCè®Šå£“å™¨</button>
      <button class="btn btn-danger" onclick="stopLLC()">â¹ï¸ åœæ­¢æ¨¡æ“¬</button>
      <button class="btn btn-info" onclick="resetLLC()">ğŸ”„ é‡ç½®é›»è·¯</button>
      <button class="btn btn-info" onclick="clearLog()">ğŸ§¹ æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <h3>ğŸ“Š LLCè®Šå£“å™¨åƒæ•¸ç›£æ§</h3>
    <div class="status-grid">
      <div class="metric">
        <div class="metric-label">æ¨¡æ“¬ç‹€æ…‹</div>
        <div id="status" class="metric-value">æº–å‚™</div>
      </div>
      <div class="metric">
        <div class="metric-label">æ­¥æ•¸</div>
        <div id="steps" class="metric-value">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">æ™‚é–“(Î¼s)</div>
        <div id="time" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="primary-side">åŸé‚Šé›»æµ(A)</span></div>
        <div id="primary-current" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="resonant">è«§æŒ¯é›»å£“(V)</span></div>
        <div id="resonant-voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="transformer">è®Šå£“å™¨é›»å£“(V)</span></div>
        <div id="transformer-voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="secondary-side">å‰¯é‚Šé›»æµ(A)</span></div>
        <div id="secondary-current" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="secondary-side">è¼¸å‡ºé›»å£“(V)</span></div>
        <div id="output-voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">è«§æŒ¯é »ç‡(kHz)</div>
        <div id="resonant-freq" class="metric-value">159.2</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å‡ºåŠŸç‡(W)</div>
        <div id="output-power" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">æ•ˆç‡(%)</div>
        <div id="efficiency" class="metric-value">0.0</div>
      </div>
    </div>

    <h3>ğŸ“ˆ LLCè®Šå£“å™¨æ³¢å½¢</h3>
    <canvas id="waveformCanvas" width="1200" height="400"></canvas>

    <h3>ğŸ“‹ LLCè®Šå£“å™¨æ¨¡æ“¬æ—¥èªŒ</h3>
    <div id="log">[LLCè«§æŒ¯è®Šå£“å™¨æº–å‚™å°±ç·’ - åŒ…å«è®Šå£“å™¨çš„å®Œæ•´æ‹“æ’²]</div>
  </div>

  <!-- è¼‰å…¥AkingSPICE -->
  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    // LLCè®Šå£“å™¨å…¨å±€è®Šæ•¸
    let isRunning = false;
    let solver = null;
    let stepCount = 0;
    let startTime = 0;

    // æ³¢å½¢æ•¸æ“š
    let timeData = [];
    let primaryCurrentData = [];
    let resonantVoltageData = [];
    let transformerVoltageData = [];
    let secondaryCurrentData = [];
    let outputVoltageData = [];

    // LLCè®Šå£“å™¨åƒæ•¸
    const LLC_TRANSFORMER_PARAMS = {
      // è¼¸å…¥åƒæ•¸
      Vin: 400,              // è¼¸å…¥é›»å£“ 400V DC

      // åŸé‚Šè«§æŒ¯åƒæ•¸
      Lr: 50e-6,            // è«§æŒ¯é›»æ„Ÿ 50Î¼H
      Cr: 100e-9,           // è«§æŒ¯é›»å®¹ 100nF  
      Lm: 200e-6,           // å‹µç£é›»æ„Ÿ 200Î¼H

      // è®Šå£“å™¨åƒæ•¸
      turnsRatio: 10,       // è®Šå£“æ¯” Np:Ns = 10:1
      Lp: 500e-6,          // åŸé‚Šé›»æ„Ÿ 500Î¼H
      Ls: 5e-6,            // å‰¯é‚Šé›»æ„Ÿ 5Î¼H (Ls = Lp/nÂ²)

      // å‰¯é‚Šåƒæ•¸
      Co: 100e-6,          // è¼¸å‡ºæ¿¾æ³¢é›»å®¹ 100Î¼F
      Rload: 2.0,          // è² è¼‰é›»é˜» 2Î© (ç›®æ¨™è¼¸å‡º40V/20A)

      // æ¨¡æ“¬åƒæ•¸
      fsw: 100e3,          // é–‹é—œé »ç‡ 100kHz
      dt: 20e-9            // æ™‚é–“æ­¥é•· 20ns
    };

    // è¨ˆç®—è«§æŒ¯é »ç‡
    const fr = 1 / (2 * Math.PI * Math.sqrt(LLC_TRANSFORMER_PARAMS.Lr * LLC_TRANSFORMER_PARAMS.Cr));
    document.getElementById('resonant-freq').textContent = (fr / 1000).toFixed(1);

    let canvas, ctx;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
      log('ğŸš€ LLCè«§æŒ¯è®Šå£“å™¨ç³»çµ±å•Ÿå‹•', 'success');

      canvas = document.getElementById('waveformCanvas');
      ctx = canvas.getContext('2d');

      if (window.AkingSPICE) {
        log('âœ… AkingSPICE è¼‰å…¥æˆåŠŸ', 'success');
        log('ğŸ“Š LLCè®Šå£“å™¨åƒæ•¸é…ç½®:', 'info');
        log(`   ğŸ”µ åŸé‚Š: Vin=${LLC_TRANSFORMER_PARAMS.Vin}V, Lr=${LLC_TRANSFORMER_PARAMS.Lr * 1e6}Î¼H, Cr=${LLC_TRANSFORMER_PARAMS.Cr * 1e9}nF`, 'info');
        log(`   ğŸŸ£ è®Šå£“å™¨: è®Šå£“æ¯”=${LLC_TRANSFORMER_PARAMS.turnsRatio}:1 (${LLC_TRANSFORMER_PARAMS.Vin}Vâ†’${LLC_TRANSFORMER_PARAMS.Vin / LLC_TRANSFORMER_PARAMS.turnsRatio}V)`, 'info');
        log(`   ğŸ”´ å‰¯é‚Š: Co=${LLC_TRANSFORMER_PARAMS.Co * 1e6}Î¼F, Rload=${LLC_TRANSFORMER_PARAMS.Rload}Î©`, 'info');
        log(`   âš¡ è«§æŒ¯é »ç‡: ${(fr / 1000).toFixed(1)}kHz`, 'warning');
        log('ğŸ¯ é»æ“Š"å•Ÿå‹•LLCè®Šå£“å™¨"é–‹å§‹å®Œæ•´æ¨¡æ“¬...', 'info');

        // ç«‹å³è‡ªå‹•å•Ÿå‹•
        log('ğŸ”„ è‡ªå‹•å•Ÿå‹•LLCè®Šå£“å™¨æ¨¡æ“¬...', 'success');
        setTimeout(startLLCTransformer, 200);
      } else {
        log('âŒ AkingSPICE è¼‰å…¥å¤±æ•—', 'error');
      }
    });

    // æ—¥èªŒå‡½æ•¸
    function log(msg, type = 'info') {
      const colors = { info: '#ecf0f1', error: '#e74c3c', success: '#2ecc71', warning: '#f39c12' };
      const time = new Date().toLocaleTimeString();

      console.log(`[${time}] ${msg}`);
      const logDiv = document.getElementById('log');
      logDiv.innerHTML += `<div style="color:${colors[type]}; margin:2px 0;">[${time}] ${msg}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // æ¸…é™¤æ—¥èªŒ
    window.clearLog = function () {
      document.getElementById('log').innerHTML = '[æ—¥èªŒå·²æ¸…é™¤]';
      log('ğŸ§¹ LLCè®Šå£“å™¨æ—¥èªŒå·²æ¸…é™¤', 'info');
    };

    // é–‹å§‹LLCè®Šå£“å™¨æ¨¡æ“¬
    window.startLLCTransformer = function () {
      if (isRunning) {
        log('âš ï¸ LLCè®Šå£“å™¨æ¨¡æ“¬å·²åœ¨é‹è¡Œä¸­', 'warning');
        return;
      }

      try {
        log('ğŸš€ å•Ÿå‹•LLCè«§æŒ¯è®Šå£“å™¨æ¨¡æ“¬...', 'success');
        document.getElementById('status').textContent = 'å•Ÿå‹•ä¸­';
        document.getElementById('status').style.color = '#f39c12';

        const { VoltageSource, Inductor, Capacitor, Resistor, MultiWindingTransformer, Diode, ExplicitStateSolver } = window.AkingSPICE;

        log('ğŸ”§ å‰µå»ºLLCè®Šå£“å™¨é›»è·¯çµ„ä»¶...', 'info');

        // LLCè®Šå£“å™¨å®Œæ•´é›»è·¯æ‹“æ’²
        // ç¯€é»åˆ†é…ï¼š
        // 0: æ¥åœ° (GND)
        // 1: è¼¸å…¥æ­£æ¥µ (Vin+)
        // 2: è«§æŒ¯é›»æ„Ÿå¾Œ (Lrè¼¸å‡ºï¼Œè®Šå£“å™¨åŸé‚Šè¼¸å…¥)
        // 3: è«§æŒ¯é›»å®¹å¾Œ (Crè¼¸å‡º)
        // 4: è®Šå£“å™¨åŸé‚Šåº•ç«¯
        // 5: è®Šå£“å™¨å‰¯é‚Šé ‚ç«¯
        // 6: è®Šå£“å™¨å‰¯é‚Šä¸­å¿ƒæŠ½é ­
        // 7: è®Šå£“å™¨å‰¯é‚Šåº•ç«¯  
        // 8: æ•´æµå¾Œç¯€é»
        // 9: è¼¸å‡ºç¯€é»

        const components = [
          // åŸé‚Šé›»è·¯
          new VoltageSource('Vin', [1, 0], LLC_TRANSFORMER_PARAMS.Vin),        // 400Vè¼¸å…¥
          new Inductor('Lr', [1, 2], LLC_TRANSFORMER_PARAMS.Lr),              // è«§æŒ¯é›»æ„Ÿ 50Î¼H
          new Capacitor('Cr', [2, 3], LLC_TRANSFORMER_PARAMS.Cr),             // è«§æŒ¯é›»å®¹ 100nF
          new Inductor('Lm', [2, 4], LLC_TRANSFORMER_PARAMS.Lm),              // å‹µç£é›»æ„Ÿ 200Î¼H

          // è®Šå£“å™¨ (ä½¿ç”¨è€¦åˆé›»æ„Ÿè¿‘ä¼¼)
          new Inductor('Lp', [2, 4], LLC_TRANSFORMER_PARAMS.Lp),              // åŸé‚Šé›»æ„Ÿ 500Î¼H  
          new Inductor('Ls1', [5, 6], LLC_TRANSFORMER_PARAMS.Ls),             // å‰¯é‚Šé›»æ„Ÿä¸ŠåŠéƒ¨ 5Î¼H
          new Inductor('Ls2', [6, 7], LLC_TRANSFORMER_PARAMS.Ls),             // å‰¯é‚Šé›»æ„Ÿä¸‹åŠéƒ¨ 5Î¼H

          // å‰¯é‚Šæ•´æµé›»è·¯ (ä½¿ç”¨é›»é˜»è¿‘ä¼¼äºŒæ¥µç®¡)
          new Resistor('D1', [5, 8], 0.1),                                    // æ•´æµäºŒæ¥µç®¡1 (0.1Î©å°é€šé›»é˜»)
          new Resistor('D2', [7, 8], 0.1),                                    // æ•´æµäºŒæ¥µç®¡2 (0.1Î©å°é€šé›»é˜»)

          // è¼¸å‡ºæ¿¾æ³¢
          new Capacitor('Co', [8, 6], LLC_TRANSFORMER_PARAMS.Co),             // è¼¸å‡ºé›»å®¹ 100Î¼F
          new Resistor('Rload', [8, 6], LLC_TRANSFORMER_PARAMS.Rload),        // è² è¼‰é›»é˜» 2Î©

          // æ¥åœ°é€£æ¥
          new Resistor('Rgnd1', [4, 0], 1e-6),                               // åŸé‚Šæ¥åœ° (å°é›»é˜»)
          new Resistor('Rgnd2', [6, 0], 1e-6)                                // å‰¯é‚Šä¸­å¿ƒæŠ½é ­æ¥åœ°
        ];

        log(`âœ… LLCè®Šå£“å™¨é›»è·¯å‰µå»ºå®Œæˆ: ${components.length} å€‹çµ„ä»¶`, 'success');

        // åˆ†é¡é¡¯ç¤ºçµ„ä»¶
        log('ğŸ”µ åŸé‚Šçµ„ä»¶:', 'info');
        log(`   - è¼¸å…¥é›»æº: ${LLC_TRANSFORMER_PARAMS.Vin}V`, 'info');
        log(`   - è«§æŒ¯é›»æ„Ÿ Lr: ${LLC_TRANSFORMER_PARAMS.Lr * 1e6}Î¼H`, 'warning');
        log(`   - è«§æŒ¯é›»å®¹ Cr: ${LLC_TRANSFORMER_PARAMS.Cr * 1e9}nF`, 'warning');
        log(`   - å‹µç£é›»æ„Ÿ Lm: ${LLC_TRANSFORMER_PARAMS.Lm * 1e6}Î¼H`, 'info');

        log('ğŸŸ£ è®Šå£“å™¨çµ„ä»¶:', 'info');
        log(`   - åŸé‚Šé›»æ„Ÿ: ${LLC_TRANSFORMER_PARAMS.Lp * 1e6}Î¼H`, 'info');
        log(`   - å‰¯é‚Šé›»æ„Ÿ: 2Ã—${LLC_TRANSFORMER_PARAMS.Ls * 1e6}Î¼H (ä¸­å¿ƒæŠ½é ­)`, 'info');
        log(`   - è®Šå£“æ¯”: ${LLC_TRANSFORMER_PARAMS.turnsRatio}:1`, 'warning');

        log('ğŸ”´ å‰¯é‚Šçµ„ä»¶:', 'info');
        log(`   - æ•´æµäºŒæ¥µç®¡: 2å€‹ (0.1Î©)`, 'info');
        log(`   - æ¿¾æ³¢é›»å®¹: ${LLC_TRANSFORMER_PARAMS.Co * 1e6}Î¼F`, 'info');
        log(`   - è² è¼‰é›»é˜»: ${LLC_TRANSFORMER_PARAMS.Rload}Î©`, 'info');

        // åˆå§‹åŒ–æ±‚è§£å™¨
        log('âš™ï¸ åˆå§‹åŒ–LLCè®Šå£“å™¨æ±‚è§£å™¨...', 'info');
        solver = new ExplicitStateSolver();

        solver.initialize(components, LLC_TRANSFORMER_PARAMS.dt, {
          debug: false,
          maxIterations: 200,
          tolerance: 1e-7,
          integrationMethod: 'forward_euler'
        });

        log('âœ… LLCè®Šå£“å™¨æ±‚è§£å™¨åˆå§‹åŒ–å®Œæˆ', 'success');

        // é–‹å§‹æ¨¡æ“¬
        isRunning = true;
        stepCount = 0;
        startTime = performance.now();

        // æ¸…ç©ºæ³¢å½¢æ•¸æ“š
        timeData = [];
        primaryCurrentData = [];
        resonantVoltageData = [];
        transformerVoltageData = [];
        secondaryCurrentData = [];
        outputVoltageData = [];

        document.getElementById('status').textContent = 'é‹è¡Œä¸­';
        document.getElementById('status').style.color = '#2ecc71';

        log('ğŸ‰ LLCè®Šå£“å™¨æ¨¡æ“¬é–‹å§‹é‹è¡Œï¼', 'success');
        log('ğŸ“Š ç›£æ§è®Šå£“å™¨å„ç´šé›»å£“é›»æµ...', 'info');

        // å•Ÿå‹•æ¨¡æ“¬å¾ªç’°
        runLLCTransformerLoop();

      } catch (error) {
        log(`âŒ LLCè®Šå£“å™¨å•Ÿå‹•å¤±æ•—: ${error.message}`, 'error');
        console.error('LLCè®Šå£“å™¨éŒ¯èª¤è©³æƒ…:', error);
        document.getElementById('status').textContent = 'éŒ¯èª¤';
        document.getElementById('status').style.color = '#e74c3c';
      }
    };

    // LLCè®Šå£“å™¨æ¨¡æ“¬å¾ªç’°
    function runLLCTransformerLoop() {
      if (!isRunning || !solver) return;

      try {
        // åŸ·è¡ŒLLCè®Šå£“å™¨æ¨¡æ“¬æ­¥é©Ÿ
        const result = solver.step();
        stepCount++;

        // è¨ˆç®—æ™‚é–“
        const currentTime = stepCount * LLC_TRANSFORMER_PARAMS.dt;
        const timeUs = currentTime * 1e6;

        // æå–è®Šå£“å™¨å„ç´šé›»å£“
        const nodeVoltages = result.nodeVoltages || {};
        const v1 = nodeVoltages[1] || 0;    // è¼¸å…¥é›»å£“
        const v2 = nodeVoltages[2] || 0;    // è«§æŒ¯é›»æ„Ÿå¾Œ
        const v3 = nodeVoltages[3] || 0;    // è«§æŒ¯é›»å®¹å¾Œ
        const v4 = nodeVoltages[4] || 0;    // åŸé‚Šåº•ç«¯
        const v5 = nodeVoltages[5] || 0;    // å‰¯é‚Šé ‚ç«¯
        const v6 = nodeVoltages[6] || 0;    // å‰¯é‚Šä¸­å¿ƒæŠ½é ­
        const v7 = nodeVoltages[7] || 0;    // å‰¯é‚Šåº•ç«¯
        const v8 = nodeVoltages[8] || 0;    // æ•´æµå¾Œ

        // è¨ˆç®—LLCè®Šå£“å™¨ç‰¹å¾µé‡
        const primaryCurrent = (v1 - v2) / (LLC_TRANSFORMER_PARAMS.Lr / LLC_TRANSFORMER_PARAMS.dt);
        const resonantVoltage = v2 - v3;
        const transformerPrimaryVoltage = v2 - v4;
        const transformerSecondaryVoltage = (v5 - v6) + (v6 - v7);  // å…¨å‰¯é‚Šé›»å£“
        const secondaryCurrent = (v8 - v6) / LLC_TRANSFORMER_PARAMS.Rload;
        const outputVoltage = v8 - v6;
        const outputPower = outputVoltage * secondaryCurrent;
        const inputPower = LLC_TRANSFORMER_PARAMS.Vin * Math.abs(primaryCurrent);
        const efficiency = inputPower > 0 ? (outputPower / inputPower) * 100 : 0;

        // æ›´æ–°é¡¯ç¤º
        document.getElementById('steps').textContent = stepCount;
        document.getElementById('time').textContent = timeUs.toFixed(2);
        document.getElementById('primary-current').textContent = Math.abs(primaryCurrent).toFixed(3);
        document.getElementById('resonant-voltage').textContent = Math.abs(resonantVoltage).toFixed(2);
        document.getElementById('transformer-voltage').textContent = Math.abs(transformerPrimaryVoltage).toFixed(2);
        document.getElementById('secondary-current').textContent = Math.abs(secondaryCurrent).toFixed(3);
        document.getElementById('output-voltage').textContent = Math.abs(outputVoltage).toFixed(2);
        document.getElementById('output-power').textContent = outputPower.toFixed(2);
        document.getElementById('efficiency').textContent = Math.min(100, Math.max(0, efficiency)).toFixed(1);

        // è¨˜éŒ„æ³¢å½¢æ•¸æ“š
        if (stepCount % 10 === 0) {
          timeData.push(timeUs);
          primaryCurrentData.push(primaryCurrent);
          resonantVoltageData.push(resonantVoltage);
          transformerVoltageData.push(transformerPrimaryVoltage);
          secondaryCurrentData.push(secondaryCurrent);
          outputVoltageData.push(outputVoltage);

          // ä¿æŒæ•¸æ“šé•·åº¦
          if (timeData.length > 800) {
            timeData.shift();
            primaryCurrentData.shift();
            resonantVoltageData.shift();
            transformerVoltageData.shift();
            secondaryCurrentData.shift();
            outputVoltageData.shift();
          }
        }

        // æ¯200æ­¥è¼¸å‡ºLLCè®Šå£“å™¨ç‹€æ…‹
        if (stepCount % 200 === 0) {
          log(`LLCæ­¥é©Ÿ ${stepCount}: t=${timeUs.toFixed(2)}Î¼s`);
          log(`  ğŸ”µ åŸé‚Š - é›»æµ:${Math.abs(primaryCurrent).toFixed(3)}A, è«§æŒ¯é›»å£“:${Math.abs(resonantVoltage).toFixed(2)}V`);
          log(`  ğŸŸ£ è®Šå£“å™¨ - åŸé‚Š:${Math.abs(transformerPrimaryVoltage).toFixed(2)}V, å‰¯é‚Š:${Math.abs(transformerSecondaryVoltage).toFixed(2)}V`);
          log(`  ğŸ”´ å‰¯é‚Š - é›»æµ:${Math.abs(secondaryCurrent).toFixed(3)}A, è¼¸å‡º:${Math.abs(outputVoltage).toFixed(2)}V, åŠŸç‡:${outputPower.toFixed(2)}W`);

          // æ›´æ–°LLCè®Šå£“å™¨æ³¢å½¢
          updateLLCTransformerWaveform();
        }

        // é™åˆ¶é‹è¡Œæ­¥æ•¸
        if (stepCount < 8000) {
          Promise.resolve().then(runLLCTransformerLoop);
        } else {
          log('ğŸ LLCè®Šå£“å™¨æ¨¡æ“¬å®Œæˆï¼ˆ8000æ­¥ï¼‰', 'success');
          stopLLC();
        }

      } catch (error) {
        log(`âŒ LLCè®Šå£“å™¨æ¨¡æ“¬æ­¥é©ŸéŒ¯èª¤: ${error.message}`, 'error');
        console.error('LLCè®Šå£“å™¨è©³ç´°éŒ¯èª¤:', error);
        stopLLC();
      }
    }

    // æ›´æ–°LLCè®Šå£“å™¨æ³¢å½¢åœ–
    function updateLLCTransformerWaveform() {
      if (!ctx || timeData.length < 2) return;

      const width = canvas.width;
      const height = canvas.height;

      // æ¸…é™¤ç•«å¸ƒ
      ctx.clearRect(0, 0, width, height);

      // èƒŒæ™¯ç¶²æ ¼
      drawGrid();

      // ç¹ªè£½LLCè®Šå£“å™¨æ³¢å½¢ (5å€‹å­åœ–)
      const plotHeight = height / 5;

      // 1. åŸé‚Šé›»æµ
      drawWaveform(primaryCurrentData, 0, plotHeight, '#3498db', 'åŸé‚Šé›»æµ (A)', 0);

      // 2. è«§æŒ¯é›»å£“  
      drawWaveform(resonantVoltageData, plotHeight, plotHeight, '#f39c12', 'è«§æŒ¯é›»å£“ (V)', 1);

      // 3. è®Šå£“å™¨é›»å£“
      drawWaveform(transformerVoltageData, plotHeight * 2, plotHeight, '#9b59b6', 'è®Šå£“å™¨é›»å£“ (V)', 2);

      // 4. å‰¯é‚Šé›»æµ
      drawWaveform(secondaryCurrentData, plotHeight * 3, plotHeight, '#e74c3c', 'å‰¯é‚Šé›»æµ (A)', 3);

      // 5. è¼¸å‡ºé›»å£“
      drawWaveform(outputVoltageData, plotHeight * 4, plotHeight, '#2ecc71', 'è¼¸å‡ºé›»å£“ (V)', 4);
    }

    function drawGrid() {
      const width = canvas.width;
      const height = canvas.height;

      ctx.strokeStyle = 'rgba(255,255,255,0.1)';
      ctx.lineWidth = 1;

      // å‚ç›´ç·š
      for (let i = 0; i <= 12; i++) {
        const x = (width / 12) * i;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }

      // æ°´å¹³ç·š (å°æ‡‰5å€‹å­åœ–)
      for (let i = 0; i <= 5; i++) {
        const y = (height / 5) * i;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }
    }

    function drawWaveform(data, yOffset, plotHeight, color, label, plotIndex) {
      if (data.length < 2) return;

      const width = canvas.width;
      const minVal = Math.min(...data);
      const maxVal = Math.max(...data);
      const range = Math.abs(maxVal - minVal) || 1;
      const center = (maxVal + minVal) / 2;

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();

      for (let i = 0; i < data.length; i++) {
        const x = (i / (data.length - 1)) * width;
        const y = yOffset + plotHeight / 2 - ((data[i] - center) / range) * plotHeight * 0.8;

        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }

      ctx.stroke();

      // æ·»åŠ æ¨™ç±¤
      ctx.fillStyle = color;
      ctx.font = '12px Arial';
      ctx.fillText(`${label}: ${minVal.toFixed(2)} ~ ${maxVal.toFixed(2)}`, 10, yOffset + 20);

      // æ·»åŠ é›¶ç·š
      const zeroY = yOffset + plotHeight / 2 - ((0 - center) / range) * plotHeight * 0.8;
      ctx.strokeStyle = 'rgba(255,255,255,0.3)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, zeroY);
      ctx.lineTo(width, zeroY);
      ctx.stroke();
    }

    // åœæ­¢LLCè®Šå£“å™¨
    window.stopLLC = function () {
      if (!isRunning) return;

      isRunning = false;
      document.getElementById('status').textContent = 'å·²åœæ­¢';
      document.getElementById('status').style.color = '#e74c3c';

      const elapsed = (performance.now() - startTime) / 1000;
      const avgSpeed = stepCount / elapsed;

      log(`â¹ï¸ LLCè®Šå£“å™¨æ¨¡æ“¬å·²åœæ­¢`, 'warning');
      log(`ğŸ“Š è®Šå£“å™¨çµ±è¨ˆ: ${stepCount} æ­¥, ç”¨æ™‚ ${elapsed.toFixed(2)}ç§’, å¹³å‡ ${avgSpeed.toFixed(0)} æ­¥/ç§’`, 'info');
      log(`ğŸ¯ æœ€çµ‚è¼¸å‡º: ${document.getElementById('output-voltage').textContent}V, ${document.getElementById('output-power').textContent}W`, 'success');
      log(`âš¡ è®Šå£“å™¨æ•ˆç‡: ${document.getElementById('efficiency').textContent}%`, 'warning');
    };

    // é‡ç½®LLCè®Šå£“å™¨
    window.resetLLC = function () {
      stopLLC();
      stepCount = 0;
      timeData = [];
      primaryCurrentData = [];
      resonantVoltageData = [];
      transformerVoltageData = [];
      secondaryCurrentData = [];
      outputVoltageData = [];

      // é‡ç½®é¡¯ç¤º
      ['steps', 'time', 'primary-current', 'resonant-voltage', 'transformer-voltage',
        'secondary-current', 'output-voltage', 'output-power', 'efficiency'].forEach(id => {
          document.getElementById(id).textContent = id === 'steps' ? '0' : '0.0';
        });

      document.getElementById('status').textContent = 'æº–å‚™';
      document.getElementById('status').style.color = '#2ecc71';

      if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);

      log('ğŸ”„ LLCè®Šå£“å™¨é›»è·¯å·²é‡ç½®', 'info');
    };

  </script>
</body>

</html>