<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔋 LLC諧振變壓器 - AkingSPICE</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #1a252f 0%, #2e4057 50%, #1a252f 100%);
      color: white;
    }

    .container {
      max-width: 1500px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 25px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .circuit-diagram {
      background: rgba(0, 0, 0, 0.4);
      padding: 25px;
      border-radius: 10px;
      text-align: center;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.4;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }

    .metric {
      background: rgba(255, 255, 255, 0.1);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }

    .metric-label {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #2ecc71;
    }

    .btn {
      padding: 10px 20px;
      margin: 6px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .btn-primary {
      background: #27ae60;
      color: white;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-info {
      background: #3498db;
      color: white;
    }

    #waveformCanvas {
      width: 100%;
      height: 400px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      display: block;
      margin: 10px 0;
    }

    #log {
      height: 320px;
      overflow-y: auto;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      background: rgba(0, 0, 0, 0.4);
      margin-top: 20px;
    }

    .primary-side {
      color: #3498db;
      font-weight: bold;
    }

    .secondary-side {
      color: #e74c3c;
      font-weight: bold;
    }

    .resonant {
      color: #f39c12;
      font-weight: bold;
    }

    .transformer {
      color: #9b59b6;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>🔋 LLC諧振變壓器 - AkingSPICE</h1>
    <p>⚡ 完整LLC拓撲：原邊諧振槽 → 變壓器 → 副邊整流 → 輸出濾波</p>

    <div class="circuit-diagram">
      <h3>📐 LLC諧振變壓器完整電路拓撲</h3>
      <pre>
<span class="primary-side">【原邊 Primary Side】</span>                <span class="transformer">【變壓器】</span>               <span class="secondary-side">【副邊 Secondary Side】</span>
    
  Vin(400V)      Lr(諧振電感)     Cr(諧振電容)      ┌──────┐          D1(整流二極管)
     +  ────LLLLL────┤├──────┬───────┤      ├─────────────┤├────┬──── Vo+
                               │       │  T1  │                    │
                         Lm(勵磁電感)  │      │                    │
                         LLLLL        │      │                    │ Co(濾波電容)
                               │       │      │                    │ ┤├
     -  ─────────────────────────┴───────┤      ├─────────────┬─────┴──── Vo-
                                         └──────┘              │
                                                               │
                                                           D2(續流二極管)
                                                              ┤├
                                                               │
                                                              ───
    
<span class="resonant">諧振頻率:</span> fr = 1/(2π√(Lr·Cr)) ≈ 159.2 kHz
<span class="transformer">變壓比:</span> n = Np/Ns = 10:1 (400V → 40V)
<span class="secondary-side">整流模式:</span> 中心抽頭全波整流 + 同步整流
    </pre>
    </div>

    <div style="text-align: center; margin: 20px 0;">
      <button class="btn btn-primary" onclick="startLLCTransformer()">🚀 啟動LLC變壓器</button>
      <button class="btn btn-danger" onclick="stopLLC()">⏹️ 停止模擬</button>
      <button class="btn btn-info" onclick="resetLLC()">🔄 重置電路</button>
      <button class="btn btn-info" onclick="clearLog()">🧹 清除日誌</button>
    </div>

    <h3>📊 LLC變壓器參數監控</h3>
    <div class="status-grid">
      <div class="metric">
        <div class="metric-label">模擬狀態</div>
        <div id="status" class="metric-value">準備</div>
      </div>
      <div class="metric">
        <div class="metric-label">步數</div>
        <div id="steps" class="metric-value">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">時間(μs)</div>
        <div id="time" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="primary-side">原邊電流(A)</span></div>
        <div id="primary-current" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="resonant">諧振電壓(V)</span></div>
        <div id="resonant-voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="transformer">變壓器電壓(V)</span></div>
        <div id="transformer-voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="secondary-side">副邊電流(A)</span></div>
        <div id="secondary-current" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="secondary-side">輸出電壓(V)</span></div>
        <div id="output-voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">諧振頻率(kHz)</div>
        <div id="resonant-freq" class="metric-value">159.2</div>
      </div>
      <div class="metric">
        <div class="metric-label">輸出功率(W)</div>
        <div id="output-power" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">效率(%)</div>
        <div id="efficiency" class="metric-value">0.0</div>
      </div>
    </div>

    <h3>📈 LLC變壓器波形</h3>
    <canvas id="waveformCanvas" width="1200" height="400"></canvas>

    <h3>📋 LLC變壓器模擬日誌</h3>
    <div id="log">[LLC諧振變壓器準備就緒 - 包含變壓器的完整拓撲]</div>
  </div>

  <!-- 載入AkingSPICE -->
  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    // LLC變壓器全局變數
    let isRunning = false;
    let solver = null;
    let stepCount = 0;
    let startTime = 0;

    // 波形數據
    let timeData = [];
    let primaryCurrentData = [];
    let resonantVoltageData = [];
    let transformerVoltageData = [];
    let secondaryCurrentData = [];
    let outputVoltageData = [];

    // LLC變壓器參數
    const LLC_TRANSFORMER_PARAMS = {
      // 輸入參數
      Vin: 400,              // 輸入電壓 400V DC

      // 原邊諧振參數
      Lr: 50e-6,            // 諧振電感 50μH
      Cr: 100e-9,           // 諧振電容 100nF  
      Lm: 200e-6,           // 勵磁電感 200μH

      // 變壓器參數
      turnsRatio: 10,       // 變壓比 Np:Ns = 10:1
      Lp: 500e-6,          // 原邊電感 500μH
      Ls: 5e-6,            // 副邊電感 5μH (Ls = Lp/n²)

      // 副邊參數
      Co: 100e-6,          // 輸出濾波電容 100μF
      Rload: 2.0,          // 負載電阻 2Ω (目標輸出40V/20A)

      // 模擬參數
      fsw: 100e3,          // 開關頻率 100kHz
      dt: 20e-9            // 時間步長 20ns
    };

    // 計算諧振頻率
    const fr = 1 / (2 * Math.PI * Math.sqrt(LLC_TRANSFORMER_PARAMS.Lr * LLC_TRANSFORMER_PARAMS.Cr));
    document.getElementById('resonant-freq').textContent = (fr / 1000).toFixed(1);

    let canvas, ctx;

    // 初始化
    document.addEventListener('DOMContentLoaded', function () {
      log('🚀 LLC諧振變壓器系統啟動', 'success');

      canvas = document.getElementById('waveformCanvas');
      ctx = canvas.getContext('2d');

      if (window.AkingSPICE) {
        log('✅ AkingSPICE 載入成功', 'success');
        log('📊 LLC變壓器參數配置:', 'info');
        log(`   🔵 原邊: Vin=${LLC_TRANSFORMER_PARAMS.Vin}V, Lr=${LLC_TRANSFORMER_PARAMS.Lr * 1e6}μH, Cr=${LLC_TRANSFORMER_PARAMS.Cr * 1e9}nF`, 'info');
        log(`   🟣 變壓器: 變壓比=${LLC_TRANSFORMER_PARAMS.turnsRatio}:1 (${LLC_TRANSFORMER_PARAMS.Vin}V→${LLC_TRANSFORMER_PARAMS.Vin / LLC_TRANSFORMER_PARAMS.turnsRatio}V)`, 'info');
        log(`   🔴 副邊: Co=${LLC_TRANSFORMER_PARAMS.Co * 1e6}μF, Rload=${LLC_TRANSFORMER_PARAMS.Rload}Ω`, 'info');
        log(`   ⚡ 諧振頻率: ${(fr / 1000).toFixed(1)}kHz`, 'warning');
        log('🎯 點擊"啟動LLC變壓器"開始完整模擬...', 'info');

        // 立即自動啟動
        log('🔄 自動啟動LLC變壓器模擬...', 'success');
        setTimeout(startLLCTransformer, 200);
      } else {
        log('❌ AkingSPICE 載入失敗', 'error');
      }
    });

    // 日誌函數
    function log(msg, type = 'info') {
      const colors = { info: '#ecf0f1', error: '#e74c3c', success: '#2ecc71', warning: '#f39c12' };
      const time = new Date().toLocaleTimeString();

      console.log(`[${time}] ${msg}`);
      const logDiv = document.getElementById('log');
      logDiv.innerHTML += `<div style="color:${colors[type]}; margin:2px 0;">[${time}] ${msg}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // 清除日誌
    window.clearLog = function () {
      document.getElementById('log').innerHTML = '[日誌已清除]';
      log('🧹 LLC變壓器日誌已清除', 'info');
    };

    // 開始LLC變壓器模擬
    window.startLLCTransformer = function () {
      if (isRunning) {
        log('⚠️ LLC變壓器模擬已在運行中', 'warning');
        return;
      }

      try {
        log('🚀 啟動LLC諧振變壓器模擬...', 'success');
        document.getElementById('status').textContent = '啟動中';
        document.getElementById('status').style.color = '#f39c12';

        const { VoltageSource, Inductor, Capacitor, Resistor, MultiWindingTransformer, Diode, ExplicitStateSolver } = window.AkingSPICE;

        log('🔧 創建LLC變壓器電路組件...', 'info');

        // LLC變壓器完整電路拓撲
        // 節點分配：
        // 0: 接地 (GND)
        // 1: 輸入正極 (Vin+)
        // 2: 諧振電感後 (Lr輸出，變壓器原邊輸入)
        // 3: 諧振電容後 (Cr輸出)
        // 4: 變壓器原邊底端
        // 5: 變壓器副邊頂端
        // 6: 變壓器副邊中心抽頭
        // 7: 變壓器副邊底端  
        // 8: 整流後節點
        // 9: 輸出節點

        const components = [
          // 原邊電路
          new VoltageSource('Vin', [1, 0], LLC_TRANSFORMER_PARAMS.Vin),        // 400V輸入
          new Inductor('Lr', [1, 2], LLC_TRANSFORMER_PARAMS.Lr),              // 諧振電感 50μH
          new Capacitor('Cr', [2, 3], LLC_TRANSFORMER_PARAMS.Cr),             // 諧振電容 100nF
          new Inductor('Lm', [2, 4], LLC_TRANSFORMER_PARAMS.Lm),              // 勵磁電感 200μH

          // 變壓器 (使用耦合電感近似)
          new Inductor('Lp', [2, 4], LLC_TRANSFORMER_PARAMS.Lp),              // 原邊電感 500μH  
          new Inductor('Ls1', [5, 6], LLC_TRANSFORMER_PARAMS.Ls),             // 副邊電感上半部 5μH
          new Inductor('Ls2', [6, 7], LLC_TRANSFORMER_PARAMS.Ls),             // 副邊電感下半部 5μH

          // 副邊整流電路 (使用電阻近似二極管)
          new Resistor('D1', [5, 8], 0.1),                                    // 整流二極管1 (0.1Ω導通電阻)
          new Resistor('D2', [7, 8], 0.1),                                    // 整流二極管2 (0.1Ω導通電阻)

          // 輸出濾波
          new Capacitor('Co', [8, 6], LLC_TRANSFORMER_PARAMS.Co),             // 輸出電容 100μF
          new Resistor('Rload', [8, 6], LLC_TRANSFORMER_PARAMS.Rload),        // 負載電阻 2Ω

          // 接地連接
          new Resistor('Rgnd1', [4, 0], 1e-6),                               // 原邊接地 (小電阻)
          new Resistor('Rgnd2', [6, 0], 1e-6)                                // 副邊中心抽頭接地
        ];

        log(`✅ LLC變壓器電路創建完成: ${components.length} 個組件`, 'success');

        // 分類顯示組件
        log('🔵 原邊組件:', 'info');
        log(`   - 輸入電源: ${LLC_TRANSFORMER_PARAMS.Vin}V`, 'info');
        log(`   - 諧振電感 Lr: ${LLC_TRANSFORMER_PARAMS.Lr * 1e6}μH`, 'warning');
        log(`   - 諧振電容 Cr: ${LLC_TRANSFORMER_PARAMS.Cr * 1e9}nF`, 'warning');
        log(`   - 勵磁電感 Lm: ${LLC_TRANSFORMER_PARAMS.Lm * 1e6}μH`, 'info');

        log('🟣 變壓器組件:', 'info');
        log(`   - 原邊電感: ${LLC_TRANSFORMER_PARAMS.Lp * 1e6}μH`, 'info');
        log(`   - 副邊電感: 2×${LLC_TRANSFORMER_PARAMS.Ls * 1e6}μH (中心抽頭)`, 'info');
        log(`   - 變壓比: ${LLC_TRANSFORMER_PARAMS.turnsRatio}:1`, 'warning');

        log('🔴 副邊組件:', 'info');
        log(`   - 整流二極管: 2個 (0.1Ω)`, 'info');
        log(`   - 濾波電容: ${LLC_TRANSFORMER_PARAMS.Co * 1e6}μF`, 'info');
        log(`   - 負載電阻: ${LLC_TRANSFORMER_PARAMS.Rload}Ω`, 'info');

        // 初始化求解器
        log('⚙️ 初始化LLC變壓器求解器...', 'info');
        solver = new ExplicitStateSolver();

        solver.initialize(components, LLC_TRANSFORMER_PARAMS.dt, {
          debug: false,
          maxIterations: 200,
          tolerance: 1e-7,
          integrationMethod: 'forward_euler'
        });

        log('✅ LLC變壓器求解器初始化完成', 'success');

        // 開始模擬
        isRunning = true;
        stepCount = 0;
        startTime = performance.now();

        // 清空波形數據
        timeData = [];
        primaryCurrentData = [];
        resonantVoltageData = [];
        transformerVoltageData = [];
        secondaryCurrentData = [];
        outputVoltageData = [];

        document.getElementById('status').textContent = '運行中';
        document.getElementById('status').style.color = '#2ecc71';

        log('🎉 LLC變壓器模擬開始運行！', 'success');
        log('📊 監控變壓器各級電壓電流...', 'info');

        // 啟動模擬循環
        runLLCTransformerLoop();

      } catch (error) {
        log(`❌ LLC變壓器啟動失敗: ${error.message}`, 'error');
        console.error('LLC變壓器錯誤詳情:', error);
        document.getElementById('status').textContent = '錯誤';
        document.getElementById('status').style.color = '#e74c3c';
      }
    };

    // LLC變壓器模擬循環
    function runLLCTransformerLoop() {
      if (!isRunning || !solver) return;

      try {
        // 執行LLC變壓器模擬步驟
        const result = solver.step();
        stepCount++;

        // 計算時間
        const currentTime = stepCount * LLC_TRANSFORMER_PARAMS.dt;
        const timeUs = currentTime * 1e6;

        // 提取變壓器各級電壓
        const nodeVoltages = result.nodeVoltages || {};
        const v1 = nodeVoltages[1] || 0;    // 輸入電壓
        const v2 = nodeVoltages[2] || 0;    // 諧振電感後
        const v3 = nodeVoltages[3] || 0;    // 諧振電容後
        const v4 = nodeVoltages[4] || 0;    // 原邊底端
        const v5 = nodeVoltages[5] || 0;    // 副邊頂端
        const v6 = nodeVoltages[6] || 0;    // 副邊中心抽頭
        const v7 = nodeVoltages[7] || 0;    // 副邊底端
        const v8 = nodeVoltages[8] || 0;    // 整流後

        // 計算LLC變壓器特徵量
        const primaryCurrent = (v1 - v2) / (LLC_TRANSFORMER_PARAMS.Lr / LLC_TRANSFORMER_PARAMS.dt);
        const resonantVoltage = v2 - v3;
        const transformerPrimaryVoltage = v2 - v4;
        const transformerSecondaryVoltage = (v5 - v6) + (v6 - v7);  // 全副邊電壓
        const secondaryCurrent = (v8 - v6) / LLC_TRANSFORMER_PARAMS.Rload;
        const outputVoltage = v8 - v6;
        const outputPower = outputVoltage * secondaryCurrent;
        const inputPower = LLC_TRANSFORMER_PARAMS.Vin * Math.abs(primaryCurrent);
        const efficiency = inputPower > 0 ? (outputPower / inputPower) * 100 : 0;

        // 更新顯示
        document.getElementById('steps').textContent = stepCount;
        document.getElementById('time').textContent = timeUs.toFixed(2);
        document.getElementById('primary-current').textContent = Math.abs(primaryCurrent).toFixed(3);
        document.getElementById('resonant-voltage').textContent = Math.abs(resonantVoltage).toFixed(2);
        document.getElementById('transformer-voltage').textContent = Math.abs(transformerPrimaryVoltage).toFixed(2);
        document.getElementById('secondary-current').textContent = Math.abs(secondaryCurrent).toFixed(3);
        document.getElementById('output-voltage').textContent = Math.abs(outputVoltage).toFixed(2);
        document.getElementById('output-power').textContent = outputPower.toFixed(2);
        document.getElementById('efficiency').textContent = Math.min(100, Math.max(0, efficiency)).toFixed(1);

        // 記錄波形數據
        if (stepCount % 10 === 0) {
          timeData.push(timeUs);
          primaryCurrentData.push(primaryCurrent);
          resonantVoltageData.push(resonantVoltage);
          transformerVoltageData.push(transformerPrimaryVoltage);
          secondaryCurrentData.push(secondaryCurrent);
          outputVoltageData.push(outputVoltage);

          // 保持數據長度
          if (timeData.length > 800) {
            timeData.shift();
            primaryCurrentData.shift();
            resonantVoltageData.shift();
            transformerVoltageData.shift();
            secondaryCurrentData.shift();
            outputVoltageData.shift();
          }
        }

        // 每200步輸出LLC變壓器狀態
        if (stepCount % 200 === 0) {
          log(`LLC步驟 ${stepCount}: t=${timeUs.toFixed(2)}μs`);
          log(`  🔵 原邊 - 電流:${Math.abs(primaryCurrent).toFixed(3)}A, 諧振電壓:${Math.abs(resonantVoltage).toFixed(2)}V`);
          log(`  🟣 變壓器 - 原邊:${Math.abs(transformerPrimaryVoltage).toFixed(2)}V, 副邊:${Math.abs(transformerSecondaryVoltage).toFixed(2)}V`);
          log(`  🔴 副邊 - 電流:${Math.abs(secondaryCurrent).toFixed(3)}A, 輸出:${Math.abs(outputVoltage).toFixed(2)}V, 功率:${outputPower.toFixed(2)}W`);

          // 更新LLC變壓器波形
          updateLLCTransformerWaveform();
        }

        // 限制運行步數
        if (stepCount < 8000) {
          Promise.resolve().then(runLLCTransformerLoop);
        } else {
          log('🏁 LLC變壓器模擬完成（8000步）', 'success');
          stopLLC();
        }

      } catch (error) {
        log(`❌ LLC變壓器模擬步驟錯誤: ${error.message}`, 'error');
        console.error('LLC變壓器詳細錯誤:', error);
        stopLLC();
      }
    }

    // 更新LLC變壓器波形圖
    function updateLLCTransformerWaveform() {
      if (!ctx || timeData.length < 2) return;

      const width = canvas.width;
      const height = canvas.height;

      // 清除畫布
      ctx.clearRect(0, 0, width, height);

      // 背景網格
      drawGrid();

      // 繪製LLC變壓器波形 (5個子圖)
      const plotHeight = height / 5;

      // 1. 原邊電流
      drawWaveform(primaryCurrentData, 0, plotHeight, '#3498db', '原邊電流 (A)', 0);

      // 2. 諧振電壓  
      drawWaveform(resonantVoltageData, plotHeight, plotHeight, '#f39c12', '諧振電壓 (V)', 1);

      // 3. 變壓器電壓
      drawWaveform(transformerVoltageData, plotHeight * 2, plotHeight, '#9b59b6', '變壓器電壓 (V)', 2);

      // 4. 副邊電流
      drawWaveform(secondaryCurrentData, plotHeight * 3, plotHeight, '#e74c3c', '副邊電流 (A)', 3);

      // 5. 輸出電壓
      drawWaveform(outputVoltageData, plotHeight * 4, plotHeight, '#2ecc71', '輸出電壓 (V)', 4);
    }

    function drawGrid() {
      const width = canvas.width;
      const height = canvas.height;

      ctx.strokeStyle = 'rgba(255,255,255,0.1)';
      ctx.lineWidth = 1;

      // 垂直線
      for (let i = 0; i <= 12; i++) {
        const x = (width / 12) * i;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }

      // 水平線 (對應5個子圖)
      for (let i = 0; i <= 5; i++) {
        const y = (height / 5) * i;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }
    }

    function drawWaveform(data, yOffset, plotHeight, color, label, plotIndex) {
      if (data.length < 2) return;

      const width = canvas.width;
      const minVal = Math.min(...data);
      const maxVal = Math.max(...data);
      const range = Math.abs(maxVal - minVal) || 1;
      const center = (maxVal + minVal) / 2;

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();

      for (let i = 0; i < data.length; i++) {
        const x = (i / (data.length - 1)) * width;
        const y = yOffset + plotHeight / 2 - ((data[i] - center) / range) * plotHeight * 0.8;

        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }

      ctx.stroke();

      // 添加標籤
      ctx.fillStyle = color;
      ctx.font = '12px Arial';
      ctx.fillText(`${label}: ${minVal.toFixed(2)} ~ ${maxVal.toFixed(2)}`, 10, yOffset + 20);

      // 添加零線
      const zeroY = yOffset + plotHeight / 2 - ((0 - center) / range) * plotHeight * 0.8;
      ctx.strokeStyle = 'rgba(255,255,255,0.3)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, zeroY);
      ctx.lineTo(width, zeroY);
      ctx.stroke();
    }

    // 停止LLC變壓器
    window.stopLLC = function () {
      if (!isRunning) return;

      isRunning = false;
      document.getElementById('status').textContent = '已停止';
      document.getElementById('status').style.color = '#e74c3c';

      const elapsed = (performance.now() - startTime) / 1000;
      const avgSpeed = stepCount / elapsed;

      log(`⏹️ LLC變壓器模擬已停止`, 'warning');
      log(`📊 變壓器統計: ${stepCount} 步, 用時 ${elapsed.toFixed(2)}秒, 平均 ${avgSpeed.toFixed(0)} 步/秒`, 'info');
      log(`🎯 最終輸出: ${document.getElementById('output-voltage').textContent}V, ${document.getElementById('output-power').textContent}W`, 'success');
      log(`⚡ 變壓器效率: ${document.getElementById('efficiency').textContent}%`, 'warning');
    };

    // 重置LLC變壓器
    window.resetLLC = function () {
      stopLLC();
      stepCount = 0;
      timeData = [];
      primaryCurrentData = [];
      resonantVoltageData = [];
      transformerVoltageData = [];
      secondaryCurrentData = [];
      outputVoltageData = [];

      // 重置顯示
      ['steps', 'time', 'primary-current', 'resonant-voltage', 'transformer-voltage',
        'secondary-current', 'output-voltage', 'output-power', 'efficiency'].forEach(id => {
          document.getElementById(id).textContent = id === 'steps' ? '0' : '0.0';
        });

      document.getElementById('status').textContent = '準備';
      document.getElementById('status').style.color = '#2ecc71';

      if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);

      log('🔄 LLC變壓器電路已重置', 'info');
    };

  </script>
</body>

</html>