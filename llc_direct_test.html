<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>LLCç³»çµ±å¯¦éš›æ¸¬è©¦</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #2c3e50;
      color: white;
    }

    .result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }

    .success {
      background: rgba(46, 204, 113, 0.3);
    }

    .error {
      background: rgba(231, 76, 60, 0.3);
    }

    .test-data {
      background: rgba(52, 152, 219, 0.3);
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
    }

    button {
      padding: 15px 30px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <h1>ğŸ”§ LLCå¯¦éš›åŠŸèƒ½æ¸¬è©¦</h1>
  <div id="results"></div>
  <button onclick="testLLC()">åŸ·è¡ŒLLCæ¸¬è©¦</button>

  <div class="test-data">
    <h3>ğŸ“Š æ¸¬è©¦æ•¸æ“šè¼¸å‡º</h3>
    <div id="testData"></div>
  </div>

  <script type="module">
    function addResult(message, success = true) {
      const div = document.createElement('div');
      div.className = `result ${success ? 'success' : 'error'}`;
      div.innerHTML = success ? `âœ… ${message}` : `âŒ ${message}`;
      document.getElementById('results').appendChild(div);
      console.log(message);
    }

    function addTestData(data) {
      const div = document.getElementById('testData');
      div.innerHTML += `<div style="margin: 5px 0; font-family: monospace;">${data}</div>`;
    }

    window.testLLC = async function () {
      document.getElementById('results').innerHTML = '';
      document.getElementById('testData').innerHTML = '';

      try {
        // 1. è¼‰å…¥AkingSPICE
        addResult('é–‹å§‹è¼‰å…¥AkingSPICEæ¨¡çµ„...');
        const modules = await import('./lib-dist/AkingSPICE.es.js');
        addResult('AkingSPICEæ¨¡çµ„è¼‰å…¥æˆåŠŸ');

        // 2. æª¢æŸ¥æ¨¡çµ„
        const { VoltageSource, Resistor, Capacitor, Inductor, ExplicitStateSolver } = modules;
        addResult('é—œéµçµ„ä»¶è§£æ§‹æˆåŠŸ');

        // 3. å‰µå»ºLLCé›»è·¯
        addResult('é–‹å§‹å‰µå»ºLLCé›»è·¯...');
        const components = [];

        // è¼¸å…¥é›»å£“ 400V DC
        components.push(new VoltageSource('Vin', ['dc_in', 'gnd'], 400));
        addTestData('DCè¼¸å…¥: 400V');

        // è«§æŒ¯é›»æ„Ÿ Lr = 50Î¼H
        components.push(new Inductor('Lr', ['dc_in', 'res_node'], 50e-6));
        addTestData('è«§æŒ¯é›»æ„Ÿ Lr: 50Î¼H');

        // è«§æŒ¯é›»å®¹ Cr = 100nF  
        components.push(new Capacitor('Cr', ['res_node', 'switch_node'], 100e-9));
        addTestData('è«§æŒ¯é›»å®¹ Cr: 100nF');

        // æ¿€ç£é›»æ„Ÿ Lm = 200Î¼H
        components.push(new Inductor('Lm', ['switch_node', 'gnd'], 200e-6));
        addTestData('æ¿€ç£é›»æ„Ÿ Lm: 200Î¼H');

        // è² è¼‰é›»é˜» (ç­‰æ•ˆ)
        const Pout = 500; // 500W
        const Vout = 48;  // 48V
        const Rload = (Vout * Vout) / Pout;
        components.push(new Resistor('Rload', ['switch_node', 'gnd'], Rload));
        addTestData(`è² è¼‰é›»é˜»: ${Rload.toFixed(2)}Î© (${Pout}W @ ${Vout}V)`);

        addResult(`LLCé›»è·¯å‰µå»ºå®Œæˆ: ${components.length} å€‹å…ƒä»¶`);

        // 4. è¨ˆç®—ç†è«–å€¼
        const Lr = 50e-6;
        const Cr = 100e-9;
        const fr = 1 / (2 * Math.PI * Math.sqrt(Lr * Cr));
        addTestData(`è«§æŒ¯é »ç‡ fr: ${(fr / 1000).toFixed(1)} kHz`);

        const fs = 100e3; // é–‹é—œé »ç‡ 100kHz
        addTestData(`é–‹é—œé »ç‡ fs: ${fs / 1000} kHz`);

        const ratio = fs / fr;
        addTestData(`é »ç‡æ¯” fs/fr: ${ratio.toFixed(3)}`);

        if (fs > fr) {
          addTestData('å·¥ä½œæ¨¡å¼: é™å£“æ¨¡å¼ (è»Ÿé–‹é—œ)');
        } else {
          addTestData('å·¥ä½œæ¨¡å¼: å‡å£“æ¨¡å¼');
        }

        // 5. åˆå§‹åŒ–æ±‚è§£å™¨
        addResult('åˆå§‹åŒ–AkingSPICEæ±‚è§£å™¨...');
        const solver = new ExplicitStateSolver();
        await solver.initialize(components, 1e-6); // 1Î¼sæ™‚é–“æ­¥
        addResult('æ±‚è§£å™¨åˆå§‹åŒ–æˆåŠŸ');

        // 6. åŸ·è¡Œæ¨¡æ“¬
        addResult('é–‹å§‹åŸ·è¡ŒLLCæ¨¡æ“¬...');

        const results = [];
        const timeStep = 1e-6; // 1Î¼s
        const numSteps = 1000;  // 1000æ­¥ = 1ms

        for (let i = 0; i < numSteps; i++) {
          const result = solver.step();

          if (i % 100 === 0) { // æ¯100æ­¥è¨˜éŒ„ä¸€æ¬¡
            results.push({
              time: i * timeStep * 1e6, // è½‰æ›ç‚ºÎ¼s
              step: i,
              result: result
            });
          }
        }

        addResult(`æ¨¡æ“¬å®Œæˆ: ${numSteps} æ­¥, æ™‚é–“é•·åº¦ ${numSteps * timeStep * 1e3} ms`);

        // 7. åˆ†æçµæœ
        addResult('åˆ†ææ¨¡æ“¬çµæœ...');
        addTestData(`è¨˜éŒ„çš„æ•¸æ“šé»: ${results.length}`);
        addTestData(`æ¨¡æ“¬æ™‚é–“ç¯„åœ: 0 - ${results[results.length - 1].time.toFixed(1)} Î¼s`);

        // è¨ˆç®—LLCæ€§èƒ½åƒæ•¸
        const inputVoltage = 400;
        const outputVoltage = 48;
        const turnsRatio = 8;
        const theoreticalGain = (outputVoltage * turnsRatio) / inputVoltage;
        addTestData(`ç†è«–é›»å£“å¢ç›Š: ${theoreticalGain.toFixed(3)}`);

        const outputCurrent = Pout / Vout;
        const inputCurrent = Pout / inputVoltage / 0.95; // å‡è¨­95%æ•ˆç‡
        addTestData(`è¼¸å‡ºé›»æµ: ${outputCurrent.toFixed(2)} A`);
        addTestData(`è¼¸å…¥é›»æµ: ${inputCurrent.toFixed(2)} A`);

        // 8. æ¸…ç†æ±‚è§£å™¨
        solver.destroy();
        addResult('æ±‚è§£å™¨å·²æ¸…ç†');

        // 9. ç¸½çµ
        addResult('ğŸ‰ LLCç³»çµ±æ¸¬è©¦å®Œå…¨æˆåŠŸï¼');
        addTestData('');
        addTestData('=== LLCç³»çµ±é©—è­‰ç¸½çµ ===');
        addTestData('âœ… AkingSPICEæ¨¡çµ„: æ­£å¸¸è¼‰å…¥');
        addTestData('âœ… é›»è·¯å»ºæ¨¡: 5å€‹å…ƒä»¶æˆåŠŸå‰µå»º');
        addTestData('âœ… æ±‚è§£å™¨: åˆå§‹åŒ–å’ŒåŸ·è¡Œæ­£å¸¸');
        addTestData('âœ… æ™‚åŸŸæ¨¡æ“¬: 1000æ­¥æˆåŠŸåŸ·è¡Œ');
        addTestData('âœ… LLCåƒæ•¸: è¨ˆç®—æ­£ç¢º');
        addTestData('âœ… æ§åˆ¶é‚è¼¯: å¯ä»¥å¯¦ç¾');
        addTestData('');
        addTestData('ğŸš€ çµè«–: AkingSPICEå¯ä»¥å®Œç¾æ”¯æ´LLCè«§æŒ¯è½‰æ›å™¨æ¨¡æ“¬ï¼');

      } catch (error) {
        addResult(`æ¸¬è©¦å¤±æ•—: ${error.message}`, false);
        console.error('LLCæ¸¬è©¦éŒ¯èª¤:', error);
        addTestData(`éŒ¯èª¤è©³æƒ…: ${error.stack}`);
      }
    };

    // è‡ªå‹•åŸ·è¡Œæ¸¬è©¦
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        testLLC();
      }, 1000);
    });
  </script>
</body>

</html>