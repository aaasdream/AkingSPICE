<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GPU å„ªåŒ–æ¸¬è©¦çµæœ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        button { 
            padding: 12px 24px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        .metrics { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0;
        }
        .metric-card { 
            padding: 15px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            text-align: center;
        }
        .metric-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .metric-label { font-size: 14px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>ğŸš€ GPU æ±‚è§£å™¨å„ªåŒ–é©—è­‰å ±å‘Š</h1>
    
    <button onclick="runFullTest()">é‹è¡Œå®Œæ•´æ¸¬è©¦</button>
    <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
    
    <div class="metrics" id="metrics" style="display: none;">
        <div class="metric-card">
            <div class="metric-value" id="fast-path-usage">-</div>
            <div class="metric-label">å¿«é€Ÿè·¯å¾‘ä½¿ç”¨ç‡</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="avg-time">-</div>
            <div class="metric-label">å¹³å‡æ¯æ­¥æ™‚é–“ (ms)</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="accuracy">-</div>
            <div class="metric-label">é›»å®¹é›»å£“ç²¾åº¦</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="performance">-</div>
            <div class="metric-label">æ€§èƒ½æå‡</div>
        </div>
    </div>
    
    <div id="results"></div>

    <script type="module">
        import { VoltageSource, Resistor, Capacitor, ExplicitStateSolver, GPUExplicitStateSolver } from './lib-dist/AkingSPICE.es.js';

        function addResult(message, type = 'test-result') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }

        function updateMetric(id, value) {
            document.getElementById(id).textContent = value;
        }

        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('metrics').style.display = 'none';
        };

        window.runFullTest = async function() {
            clearResults();
            addResult('é–‹å§‹ GPU å„ªåŒ–é©—è­‰æ¸¬è©¦...', 'test-result');
            
            try {
                // æ¸¬è©¦ 1: é©—è­‰å°é›»è·¯å¿«é€Ÿè·¯å¾‘
                addResult('ğŸ“‹ æ¸¬è©¦ 1: å°é›»è·¯å¿«é€Ÿè·¯å¾‘æª¢æ¸¬', 'test-result');
                
                const components = [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];
                
                const gpuSolver = new GPUExplicitStateSolver({ debug: false });
                await gpuSolver.initialize(components, 1e-6);
                
                addResult(`é›»è·¯è¦æ¨¡: ${gpuSolver.circuitData.nodeCount} ç¯€é», ${gpuSolver.circuitData.stateCount} ç‹€æ…‹è®Šé‡`, 'test-result');
                
                // æ¸¬è©¦å¤šå€‹æ™‚é–“æ­¥
                const testSteps = 10;
                const times = [];
                let fastPathCount = 0;
                const voltages = [];
                
                addResult('âš¡ åŸ·è¡Œæ™‚é–“æ­¥æ¸¬è©¦...', 'test-result');
                
                for (let i = 0; i < testSteps; i++) {
                    const stepStart = performance.now();
                    const result = await gpuSolver.solveTimeStep();
                    const stepTime = performance.now() - stepStart;
                    
                    times.push(stepTime);
                    voltages.push(result.nodeVoltages.n1 || 0);
                    
                    if (result.fastPath) {
                        fastPathCount++;
                    }
                    
                    if (i < 3) { // åªé¡¯ç¤ºå‰3æ­¥çš„è©³ç´°ä¿¡æ¯
                        const pathType = result.fastPath ? 'ğŸš€ å¿«é€Ÿè·¯å¾‘' : 'ğŸŒ GPUè·¯å¾‘';
                        const voltage = (result.nodeVoltages.n1 || 0).toFixed(6);
                        addResult(`æ­¥é©Ÿ ${i+1}: ${pathType}, V_C=${voltage}V, ç”¨æ™‚=${stepTime.toFixed(2)}ms`, 
                                result.fastPath ? 'success' : 'warning');
                    }
                }
                
                // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
                const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                const fastPathPercentage = (fastPathCount / testSteps * 100).toFixed(0);
                const finalVoltage = voltages[voltages.length - 1];
                
                // æ¸¬è©¦ 2: èˆ‡ CPU æ±‚è§£å™¨å°æ¯”ç²¾åº¦
                addResult('ğŸ“Š æ¸¬è©¦ 2: ç²¾åº¦å°æ¯”æ¸¬è©¦', 'test-result');
                
                const cpuSolver = new ExplicitStateSolver({ debug: false });
                const cpuComponents = [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];
                await cpuSolver.initialize(cpuComponents, 1e-6);
                
                // é‹è¡Œç›¸åŒæ­¥æ•¸çš„CPUæ¨¡æ“¬
                for (let i = 0; i < testSteps; i++) {
                    cpuSolver.step();
                }
                
                const cpuFinalVoltage = cpuSolver.stateVector[0];
                const accuracyError = Math.abs(finalVoltage - cpuFinalVoltage) / cpuFinalVoltage * 100;
                
                // æ›´æ–°æŒ‡æ¨™
                document.getElementById('metrics').style.display = 'grid';
                updateMetric('fast-path-usage', `${fastPathPercentage}%`);
                updateMetric('avg-time', avgTime.toFixed(2));
                updateMetric('accuracy', `${accuracyError.toFixed(3)}%`);
                
                // æ€§èƒ½è©•ä¼°
                let performanceRating;
                if (fastPathPercentage >= 80 && avgTime < 5 && accuracyError < 1) {
                    performanceRating = 'å„ªç§€ âœ¨';
                    updateMetric('performance', performanceRating);
                    addResult('ğŸ‰ å„ªåŒ–æ•ˆæœå„ªç§€ï¼å¿«é€Ÿè·¯å¾‘å·¥ä½œæ­£å¸¸ï¼Œæ€§èƒ½å’Œç²¾åº¦éƒ½é”åˆ°é æœŸ', 'success');
                } else if (fastPathPercentage >= 50 && avgTime < 20 && accuracyError < 5) {
                    performanceRating = 'è‰¯å¥½ ğŸ‘';
                    updateMetric('performance', performanceRating);
                    addResult('âœ… å„ªåŒ–æ•ˆæœè‰¯å¥½ï¼Œä»æœ‰æ”¹é€²ç©ºé–“', 'success');
                } else {
                    performanceRating = 'éœ€æ”¹é€² âš ï¸';
                    updateMetric('performance', performanceRating);
                    addResult('âš ï¸ å„ªåŒ–æ•ˆæœæœ‰é™ï¼Œéœ€è¦é€²ä¸€æ­¥æ”¹é€²', 'warning');
                }
                
                // è©³ç´°çµæœå ±å‘Š
                addResult(`ğŸ“ˆ æ¸¬è©¦å®Œæˆ - è©³ç´°çµæœ:`, 'test-result');
                addResult(`   å¿«é€Ÿè·¯å¾‘ä½¿ç”¨: ${fastPathCount}/${testSteps} æ­¥ (${fastPathPercentage}%)`, 'test-result');
                addResult(`   å¹³å‡éŸ¿æ‡‰æ™‚é–“: ${avgTime.toFixed(2)}ms/æ­¥`, 'test-result');
                addResult(`   GPUæœ€çµ‚é›»å£“: ${finalVoltage.toFixed(6)}V`, 'test-result');
                addResult(`   CPUæœ€çµ‚é›»å£“: ${cpuFinalVoltage.toFixed(6)}V`, 'test-result');
                addResult(`   ç²¾åº¦èª¤å·®: ${accuracyError.toFixed(3)}%`, 'test-result');
                addResult(`   æ€§èƒ½è©•ç´š: ${performanceRating}`, 'test-result');
                
            } catch (error) {
                addResult(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        };
    </script>
</body>
</html>