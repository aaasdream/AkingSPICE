<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GPU 優化測試結果</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        button { 
            padding: 12px 24px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        .metrics { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin: 20px 0;
        }
        .metric-card { 
            padding: 15px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            text-align: center;
        }
        .metric-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .metric-label { font-size: 14px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>🚀 GPU 求解器優化驗證報告</h1>
    
    <button onclick="runFullTest()">運行完整測試</button>
    <button onclick="clearResults()">清除結果</button>
    
    <div class="metrics" id="metrics" style="display: none;">
        <div class="metric-card">
            <div class="metric-value" id="fast-path-usage">-</div>
            <div class="metric-label">快速路徑使用率</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="avg-time">-</div>
            <div class="metric-label">平均每步時間 (ms)</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="accuracy">-</div>
            <div class="metric-label">電容電壓精度</div>
        </div>
        <div class="metric-card">
            <div class="metric-value" id="performance">-</div>
            <div class="metric-label">性能提升</div>
        </div>
    </div>
    
    <div id="results"></div>

    <script type="module">
        import { VoltageSource, Resistor, Capacitor, ExplicitStateSolver, GPUExplicitStateSolver } from './lib-dist/AkingSPICE.es.js';

        function addResult(message, type = 'test-result') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }

        function updateMetric(id, value) {
            document.getElementById(id).textContent = value;
        }

        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('metrics').style.display = 'none';
        };

        window.runFullTest = async function() {
            clearResults();
            addResult('開始 GPU 優化驗證測試...', 'test-result');
            
            try {
                // 測試 1: 驗證小電路快速路徑
                addResult('📋 測試 1: 小電路快速路徑檢測', 'test-result');
                
                const components = [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];
                
                const gpuSolver = new GPUExplicitStateSolver({ debug: false });
                await gpuSolver.initialize(components, 1e-6);
                
                addResult(`電路規模: ${gpuSolver.circuitData.nodeCount} 節點, ${gpuSolver.circuitData.stateCount} 狀態變量`, 'test-result');
                
                // 測試多個時間步
                const testSteps = 10;
                const times = [];
                let fastPathCount = 0;
                const voltages = [];
                
                addResult('⚡ 執行時間步測試...', 'test-result');
                
                for (let i = 0; i < testSteps; i++) {
                    const stepStart = performance.now();
                    const result = await gpuSolver.solveTimeStep();
                    const stepTime = performance.now() - stepStart;
                    
                    times.push(stepTime);
                    voltages.push(result.nodeVoltages.n1 || 0);
                    
                    if (result.fastPath) {
                        fastPathCount++;
                    }
                    
                    if (i < 3) { // 只顯示前3步的詳細信息
                        const pathType = result.fastPath ? '🚀 快速路徑' : '🐌 GPU路徑';
                        const voltage = (result.nodeVoltages.n1 || 0).toFixed(6);
                        addResult(`步驟 ${i+1}: ${pathType}, V_C=${voltage}V, 用時=${stepTime.toFixed(2)}ms`, 
                                result.fastPath ? 'success' : 'warning');
                    }
                }
                
                // 計算統計數據
                const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                const fastPathPercentage = (fastPathCount / testSteps * 100).toFixed(0);
                const finalVoltage = voltages[voltages.length - 1];
                
                // 測試 2: 與 CPU 求解器對比精度
                addResult('📊 測試 2: 精度對比測試', 'test-result');
                
                const cpuSolver = new ExplicitStateSolver({ debug: false });
                const cpuComponents = [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];
                await cpuSolver.initialize(cpuComponents, 1e-6);
                
                // 運行相同步數的CPU模擬
                for (let i = 0; i < testSteps; i++) {
                    cpuSolver.step();
                }
                
                const cpuFinalVoltage = cpuSolver.stateVector[0];
                const accuracyError = Math.abs(finalVoltage - cpuFinalVoltage) / cpuFinalVoltage * 100;
                
                // 更新指標
                document.getElementById('metrics').style.display = 'grid';
                updateMetric('fast-path-usage', `${fastPathPercentage}%`);
                updateMetric('avg-time', avgTime.toFixed(2));
                updateMetric('accuracy', `${accuracyError.toFixed(3)}%`);
                
                // 性能評估
                let performanceRating;
                if (fastPathPercentage >= 80 && avgTime < 5 && accuracyError < 1) {
                    performanceRating = '優秀 ✨';
                    updateMetric('performance', performanceRating);
                    addResult('🎉 優化效果優秀！快速路徑工作正常，性能和精度都達到預期', 'success');
                } else if (fastPathPercentage >= 50 && avgTime < 20 && accuracyError < 5) {
                    performanceRating = '良好 👍';
                    updateMetric('performance', performanceRating);
                    addResult('✅ 優化效果良好，仍有改進空間', 'success');
                } else {
                    performanceRating = '需改進 ⚠️';
                    updateMetric('performance', performanceRating);
                    addResult('⚠️ 優化效果有限，需要進一步改進', 'warning');
                }
                
                // 詳細結果報告
                addResult(`📈 測試完成 - 詳細結果:`, 'test-result');
                addResult(`   快速路徑使用: ${fastPathCount}/${testSteps} 步 (${fastPathPercentage}%)`, 'test-result');
                addResult(`   平均響應時間: ${avgTime.toFixed(2)}ms/步`, 'test-result');
                addResult(`   GPU最終電壓: ${finalVoltage.toFixed(6)}V`, 'test-result');
                addResult(`   CPU最終電壓: ${cpuFinalVoltage.toFixed(6)}V`, 'test-result');
                addResult(`   精度誤差: ${accuracyError.toFixed(3)}%`, 'test-result');
                addResult(`   性能評級: ${performanceRating}`, 'test-result');
                
            } catch (error) {
                addResult(`❌ 測試失敗: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        };
    </script>
</body>
</html>