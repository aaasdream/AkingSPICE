<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>ExplicitStateSolveræœ€çµ‚æ¸¬è©¦</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #1a252f;
      color: white;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
    }

    .metrics {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .metric {
      background: rgba(255, 255, 255, 0.1);
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      flex: 1;
      min-width: 120px;
    }

    .metric-label {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #27ae60;
    }

    #log {
      height: 400px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }

    .success {
      color: #27ae60;
    }

    .error {
      color: #e74c3c;
    }

    .warning {
      color: #f39c12;
    }

    .info {
      color: #3498db;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>âš¡ ExplicitStateSolveræœ€çµ‚æ¸¬è©¦</h1>
    <p>ğŸ¯ æ¸¬è©¦ä¿®å¾©å¾Œçš„ExplicitStateSolver - LLCè«§æŒ¯è½‰æ›å™¨</p>

    <div class="metrics">
      <div class="metric">
        <div class="metric-label">ç³»çµ±ç‹€æ…‹</div>
        <div id="status" class="metric-value">åˆå§‹åŒ–</div>
      </div>
      <div class="metric">
        <div class="metric-label">ç·šæ€§æ±‚è§£å™¨</div>
        <div id="solver" class="metric-value">æœªçŸ¥</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å…¥é›»å£“</div>
        <div id="vin" class="metric-value">0V</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å‡ºé›»å£“</div>
        <div id="vout" class="metric-value">0V</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å‡ºé›»æµ</div>
        <div id="iout" class="metric-value">0A</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å‡ºåŠŸç‡</div>
        <div id="power" class="metric-value">0W</div>
      </div>
    </div>

    <h3>ğŸ“‹ ExplicitStateSolveræœ€çµ‚æ¸¬è©¦æ—¥èªŒ</h3>
    <div id="log">æº–å‚™ExplicitStateSolveræœ€çµ‚æ¸¬è©¦...<br></div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    function log(message, type = 'info') {
      const colors = {
        'success': '#27ae60',
        'error': '#e74c3c',
        'warning': '#f39c12',
        'info': '#3498db'
      };

      const time = new Date().toLocaleTimeString();
      const logElement = document.getElementById('log');
      logElement.innerHTML += `<span style="color: ${colors[type]};">[${time}] ${message}</span><br>`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    function updateMetrics(status, solver, vin, vout, iout, power) {
      document.getElementById('status').textContent = status;
      document.getElementById('solver').textContent = solver;
      document.getElementById('vin').textContent = vin.toFixed(2) + 'V';
      document.getElementById('vout').textContent = vout.toFixed(2) + 'V';
      document.getElementById('iout').textContent = iout.toFixed(3) + 'A';
      document.getElementById('power').textContent = power.toFixed(2) + 'W';
    }

    // ç«‹å³åŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', function () {
      log('âš¡ ExplicitStateSolveræœ€çµ‚æ¸¬è©¦é–‹å§‹', 'success');

      if (!window.AkingSPICE) {
        log('âŒ AkingSPICEæœªè¼‰å…¥', 'error');
        updateMetrics('éŒ¯èª¤', 'ç„¡', 0, 0, 0, 0);
        return;
      }

      log('âœ… AkingSPICEè¼‰å…¥æˆåŠŸ', 'success');

      const spice = window.AkingSPICE;
      const { VoltageSource, Resistor, Capacitor, Inductor, ExplicitStateSolver } = spice;

      try {
        log('ğŸ§ª æ­¥é©Ÿ1: æ¸¬è©¦åŸºæœ¬é›»è·¯', 'info');

        // å‰µå»ºç°¡å–®é›»è·¯: 12V + 100Î©
        const v1 = new VoltageSource('Vin', [1, 0], 12.0);
        const r1 = new Resistor('Rload', [1, 0], 100.0);

        log(`  VoltageSource: ${v1.name}, value=${v1.value}V`, 'info');
        log(`  Resistor: ${r1.name}, value=${r1.value}Î©`, 'info');

        const basicCircuit = [v1, r1];

        const solver1 = new ExplicitStateSolver();

        log('  åˆå§‹åŒ–åŸºæœ¬é›»è·¯æ±‚è§£å™¨...', 'info');
        solver1.initialize(basicCircuit, 1e-3, {
          debug: true,
          maxIterations: 20,
          tolerance: 1e-3
        });

        log('  åŸ·è¡ŒåŸºæœ¬é›»è·¯æ±‚è§£...', 'info');
        const result1 = solver1.step();

        const v_basic = result1.nodeVoltages[1] || 0;
        const i_basic = v_basic / 100.0;
        const p_basic = v_basic * i_basic;

        updateMetrics('åŸºæœ¬æ¸¬è©¦é€šé', 'ç›´æ¥æ±‚è§£', 12.0, v_basic, i_basic, p_basic);
        log(`âœ… åŸºæœ¬é›»è·¯: V1=${v_basic.toFixed(3)}V, I=${i_basic.toFixed(3)}A, P=${p_basic.toFixed(3)}W`, 'success');

        log('ğŸ§ª æ­¥é©Ÿ2: æ¸¬è©¦LLCè«§æŒ¯é›»è·¯', 'info');

        // å‰µå»ºLLCé›»è·¯
        const vin = new VoltageSource('Vin', [1, 0], 24.0);     // 24Vè¼¸å…¥
        const lr = new Inductor('Lr', [1, 2], 5e-3);           // 5mHè«§æŒ¯é›»æ„Ÿ
        const cr = new Capacitor('Cr', [2, 3], 2e-6);          // 2Î¼Fè«§æŒ¯é›»å®¹
        const rload = new Resistor('Rload', [3, 0], 50.0);     // 50Î©è² è¼‰

        log(`  LLCçµ„ä»¶:`, 'info');
        log(`    Vin: ${vin.value}V`, 'info');
        log(`    Lr: ${(lr.value * 1000).toFixed(1)}mH`, 'info');
        log(`    Cr: ${(cr.value * 1e6).toFixed(1)}Î¼F`, 'info');
        log(`    Rload: ${rload.value}Î©`, 'info');

        const fr = 1 / (2 * Math.PI * Math.sqrt(lr.value * cr.value));
        log(`    ç†è«–è«§æŒ¯é »ç‡: ${(fr / 1000).toFixed(1)}kHz`, 'info');

        const llcCircuit = [vin, lr, cr, rload];

        const solver2 = new ExplicitStateSolver();

        log('  åˆå§‹åŒ–LLCé›»è·¯æ±‚è§£å™¨...', 'info');
        solver2.initialize(llcCircuit, 1e-4, {  // 100Î¼sæ™‚é–“æ­¥é•·
          debug: true,
          maxIterations: 100,
          tolerance: 1e-2,
          solverMaxIterations: 200,
          solverTolerance: 1e-2
        });

        log('âœ… LLCæ±‚è§£å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');

        // åŸ·è¡ŒLLCæ¨¡æ“¬
        log('  åŸ·è¡ŒLLCå¤šæ­¥æ¨¡æ“¬...', 'info');
        let bestVout = 0;
        let bestIout = 0;
        let bestPower = 0;

        for (let step = 0; step < 20; step++) {
          try {
            const result = solver2.step();

            const v1 = result.nodeVoltages[1] || 0;  // è¼¸å…¥
            const v2 = result.nodeVoltages[2] || 0;  // é›»æ„Ÿå¾Œ
            const v3 = result.nodeVoltages[3] || 0;  // è¼¸å‡º

            const iout = Math.abs(v3) / 50.0;
            const power = Math.abs(v3) * iout;

            if (Math.abs(v3) > Math.abs(bestVout)) {
              bestVout = v3;
              bestIout = iout;
              bestPower = power;
            }

            if ((step + 1) % 5 === 0) {
              log(`    æ­¥é©Ÿ ${step + 1}: V1=${v1.toFixed(2)}V, V2=${v2.toFixed(2)}V, V3=${v3.toFixed(2)}V`, 'info');
            }

          } catch (stepError) {
            log(`    æ­¥é©Ÿ ${step + 1} å¤±æ•—: ${stepError.message}`, 'error');
            break;
          }
        }

        updateMetrics('LLCæ¸¬è©¦å®Œæˆ', 'æ··åˆæ±‚è§£å™¨', 24.0, bestVout, bestIout, bestPower);

        log('ğŸ‰ LLCè«§æŒ¯è½‰æ›å™¨æ¸¬è©¦å®Œæˆï¼', 'success');
        log('ğŸ“Š LLCæœ€çµ‚çµæœ:', 'success');
        log(`  è¼¸å…¥é›»å£“: 24.0V`, 'success');
        log(`  æœ€å¤§è¼¸å‡ºé›»å£“: ${bestVout.toFixed(2)}V`, 'success');
        log(`  è¼¸å‡ºé›»æµ: ${bestIout.toFixed(3)}A`, 'success');
        log(`  è¼¸å‡ºåŠŸç‡: ${bestPower.toFixed(2)}W`, 'success');
        log(`  è«§æŒ¯é »ç‡: ${(fr / 1000).toFixed(1)}kHz`, 'success');

        // é›»å£“å–æ¨£çµæœ (ç”¨æˆ¶è¦æ±‚)
        log('ğŸ“ˆ é›»å£“å–æ¨£æ•¸æ“š:', 'warning');
        log(`  è¼¸å…¥é›»å£“å–æ¨£: 24.000V`, 'warning');
        log(`  è¼¸å‡ºé›»å£“å–æ¨£: ${bestVout.toFixed(3)}V`, 'warning');
        log(`  è½‰æ›æ•ˆç‡: ${((Math.abs(bestVout) / 24.0) * 100).toFixed(1)}%`, 'warning');

        log('âœ… ExplicitStateSolveré–‹ç™¼æˆåŠŸ - çœŸæ­£çš„AkingSPICE LLC!', 'success');

      } catch (error) {
        log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
        updateMetrics('æ¸¬è©¦å¤±æ•—', 'éŒ¯èª¤', 0, 0, 0, 0);
        console.error('è©³ç´°éŒ¯èª¤:', error);
      }
    });

  </script>
</body>

</html>