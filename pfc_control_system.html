<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PFCé›»è·¯æ§åˆ¶ç³»çµ±</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #eee;
    }

    .header h1 {
      color: #667eea;
      margin: 0 0 10px 0;
      font-size: 2.5em;
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .circuit-panel,
    .control-panel {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .panel-title {
      font-size: 1.4em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 10px;
    }

    .circuit-diagram {
      background: white;
      border: 2px solid #dee2e6;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      font-family: monospace;
      font-size: 12px;
      overflow-x: auto;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .control-group {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .control-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #495057;
    }

    .control-group input,
    .control-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
    }

    .control-buttons {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .results-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .metric-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .metric-value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
      display: block;
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 0.9em;
      color: #6c757d;
    }

    .waveform-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    canvas {
      width: 100%;
      max-width: 800px;
      height: 300px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
    }

    .log-panel {
      background: #1a1a1a;
      color: #00ff00;
      border-radius: 10px;
      padding: 20px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9em;
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-running {
      background: #28a745;
    }

    .status-stopped {
      background: #dc3545;
    }

    .status-warning {
      background: #ffc107;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="header">
      <h1>âš¡ PFCé›»è·¯æ§åˆ¶ç³»çµ±</h1>
      <p>ğŸ›ï¸ åŠŸç‡å› æ•¸æ ¡æ­£é›»è·¯è¨­è¨ˆèˆ‡æ§åˆ¶</p>
      <p>ğŸ“Š ä½¿ç”¨AkingSPICEé€²è¡Œé›»è·¯æ¨¡æ“¬å’Œæ§åˆ¶ç®—æ³•é©—è­‰</p>
    </div>

    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <div class="content-grid">
      <!-- é›»è·¯é¢æ¿ -->
      <div class="circuit-panel">
        <h3 class="panel-title">ğŸ”§ PFCé›»è·¯æ‹“æ’²</h3>

        <div class="circuit-diagram">
          ACè¼¸å…¥ ï½ L1 D1 +Vout
          â—‹â”€â”€â”€â”€â”€â”€â”€â”€â”Œâ”€â”€â”€â”€â”€â”â”€â”€â”€â”Œâ”‚â”œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â—‹
          â”‚ â”‚ â””â”‚â”˜ â”‚
          â”‚ â”‚ â”‚
          â”Œâ”€â”´â”€â” â”‚ â”Œâ”´â” C1
          â”‚ â”‚ â”‚ â”‚ â”‚
          L â”‚ S â”‚ â”‚ â”‚ â”‚
          â”‚ â”‚ â”‚ â”‚ â”‚
          â””â”€â”¬â”€â”˜ â”‚ â””â”¬â”˜
          â”‚ â”‚ â”‚
          â—‹â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â—‹
          GND -Vout

          æ§åˆ¶å™¨: PWM â†’ é–‹é—œS
          æ„Ÿæ¸¬å™¨: é›»æµæ„Ÿæ¸¬ â†’ ADC â†’ æ§åˆ¶ç®—æ³•
        </div>

        <div class="control-group">
          <label>é›»è·¯æ‹“æ’²</label>
          <select id="topology">
            <option value="boost">Boost PFC</option>
            <option value="buck">Buck PFC</option>
            <option value="flyback">Flyback PFC</option>
          </select>
        </div>
      </div>

      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="control-panel">
        <h3 class="panel-title">ğŸ›ï¸ æ§åˆ¶åƒæ•¸</h3>

        <div class="controls-grid">
          <div class="control-group">
            <label>è¼¸å…¥é›»å£“ (Vrms)</label>
            <input type="number" id="inputVoltage" value="220" min="100" max="240">
          </div>

          <div class="control-group">
            <label>è¼¸å‡ºé›»å£“ (Vdc)</label>
            <input type="number" id="outputVoltage" value="400" min="300" max="450">
          </div>

          <div class="control-group">
            <label>è² è¼‰åŠŸç‡ (W)</label>
            <input type="number" id="loadPower" value="1000" min="100" max="3000">
          </div>

          <div class="control-group">
            <label>é–‹é—œé »ç‡ (kHz)</label>
            <input type="number" id="switchFreq" value="50" min="20" max="100">
          </div>

          <div class="control-group">
            <label>æ§åˆ¶ç®—æ³•</label>
            <select id="controlAlgorithm">
              <option value="pi">PIæ§åˆ¶</option>
              <option value="hysteresis">æ»¯ç’°æ§åˆ¶</option>
              <option value="predictive">é æ¸¬æ§åˆ¶</option>
            </select>
          </div>

          <div class="control-group">
            <label>ç›®æ¨™åŠŸç‡å› æ•¸</label>
            <input type="number" id="targetPF" value="0.99" min="0.8" max="1.0" step="0.01">
          </div>
        </div>

        <div class="control-buttons">
          <button class="btn btn-success" onclick="startSimulation()">
            <span class="status-indicator status-stopped" id="simStatus"></span>
            é–‹å§‹æ¨¡æ“¬
          </button>
          <button class="btn btn-danger" onclick="stopSimulation()">
            åœæ­¢æ¨¡æ“¬
          </button>
          <button class="btn btn-primary" onclick="resetSimulation()">
            é‡ç½®åƒæ•¸
          </button>
        </div>
      </div>
    </div>

    <!-- çµæœé¡¯ç¤ºå€åŸŸ -->
    <div class="results-section">
      <h3 class="panel-title">ğŸ“Š æ¨¡æ“¬çµæœ</h3>

      <!-- æ€§èƒ½æŒ‡æ¨™ -->
      <div class="metrics-grid">
        <div class="metric-card">
          <span class="metric-value" id="powerFactor">0.00</span>
          <span class="metric-label">åŠŸç‡å› æ•¸</span>
        </div>
        <div class="metric-card">
          <span class="metric-value" id="efficiency">0.0%</span>
          <span class="metric-label">æ•ˆç‡</span>
        </div>
        <div class="metric-card">
          <span class="metric-value" id="thd">0.0%</span>
          <span class="metric-label">é›»æµTHD</span>
        </div>
        <div class="metric-card">
          <span class="metric-value" id="inputCurrent">0.00A</span>
          <span class="metric-label">è¼¸å…¥é›»æµRMS</span>
        </div>
        <div class="metric-card">
          <span class="metric-value" id="outputRipple">0.0%</span>
          <span class="metric-label">è¼¸å‡ºç´‹æ³¢</span>
        </div>
      </div>

      <!-- æ³¢å½¢é¡¯ç¤º -->
      <div class="waveform-container">
        <h4>ğŸ“ˆ é›»å£“é›»æµæ³¢å½¢</h4>
        <canvas id="waveformCanvas" width="800" height="300"></canvas>
      </div>
    </div>

    <!-- æ—¥èªŒé¢æ¿ -->
    <div class="log-panel" id="logPanel">
      === PFCé›»è·¯æ§åˆ¶ç³»çµ±æ—¥èªŒ ===
      ç³»çµ±å·²åˆå§‹åŒ–...
      ç­‰å¾…ç”¨æˆ¶è¼¸å…¥...

    </div>
  </div>

  <!-- è¼‰å…¥AkingSPICEæ¨¡çµ„ -->
  <script type="module">
    // PFCé›»è·¯æ§åˆ¶ç³»çµ±é¡
    class PFCControlSystem {
      constructor() {
        this.isRunning = false;
        this.simulationTimer = null;
        this.currentStep = 0;
        this.akingModules = null;
        this.pfcCircuit = null;
        this.controllerParams = {};

        this.init();
      }

      async init() {
        this.log('ğŸš€ åˆå§‹åŒ–PFCæ§åˆ¶ç³»çµ±');

        try {
          // è¼‰å…¥AkingSPICEæ¨¡çµ„
          await this.loadAkingSPICEModules();

          // åˆå§‹åŒ–æ§åˆ¶åƒæ•¸
          this.initControlParameters();

          // è¨­ç½®äº‹ä»¶ç›£è½å™¨
          this.setupEventListeners();

          this.log('âœ… PFCæ§åˆ¶ç³»çµ±åˆå§‹åŒ–å®Œæˆ');

        } catch (error) {
          this.log(`âŒ åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
        }
      }

      async loadAkingSPICEModules() {
        this.log('ğŸ”Œ è¼‰å…¥AkingSPICEæ¨¡çµ„...');

        try {
          const modules = await import('./lib-dist/AkingSPICE.es.js');
          this.akingModules = modules;

          // ç¶å®šåˆ°å…¨åŸŸ
          window.AkingSPICE = modules.AkingSPICE;
          window.ExplicitStateSolver = modules.ExplicitStateSolver;
          window.VoltageSource = modules.VoltageSource;
          window.Resistor = modules.Resistor;
          window.Capacitor = modules.Capacitor;
          window.Inductor = modules.Inductor;
          window.Diode = modules.Diode;

          this.log('âœ… AkingSPICEæ¨¡çµ„è¼‰å…¥æˆåŠŸ');
          return true;

        } catch (error) {
          this.log(`âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—: ${error.message}`);
          return false;
        }
      }

      initControlParameters() {
        this.controllerParams = {
          inputVoltage: 220,      // è¼¸å…¥é›»å£“ (Vrms)
          outputVoltage: 400,     // è¼¸å‡ºé›»å£“ (Vdc)
          loadPower: 1000,        // è² è¼‰åŠŸç‡ (W)
          switchFreq: 50000,      // é–‹é—œé »ç‡ (Hz)
          targetPF: 0.99,         // ç›®æ¨™åŠŸç‡å› æ•¸

          // PFCé›»æ„Ÿ
          inductance: 1e-3,       // 1mH

          // è¼¸å‡ºé›»å®¹
          outputCapacitance: 470e-6, // 470ÂµF

          // æ§åˆ¶å™¨åƒæ•¸
          kp: 0.1,                // æ¯”ä¾‹å¢ç›Š
          ki: 10,                 // ç©åˆ†å¢ç›Š

          // æ™‚é–“æ­¥é•·
          timeStep: 1e-6          // 1Âµs
        };

        this.log('âš™ï¸ æ§åˆ¶åƒæ•¸åˆå§‹åŒ–å®Œæˆ');
      }

      setupEventListeners() {
        // åƒæ•¸è¼¸å…¥ç›£è½
        document.getElementById('inputVoltage').addEventListener('change',
          (e) => this.controllerParams.inputVoltage = parseFloat(e.target.value));

        document.getElementById('outputVoltage').addEventListener('change',
          (e) => this.controllerParams.outputVoltage = parseFloat(e.target.value));

        document.getElementById('loadPower').addEventListener('change',
          (e) => this.controllerParams.loadPower = parseFloat(e.target.value));

        document.getElementById('switchFreq').addEventListener('change',
          (e) => this.controllerParams.switchFreq = parseFloat(e.target.value) * 1000);

        document.getElementById('targetPF').addEventListener('change',
          (e) => this.controllerParams.targetPF = parseFloat(e.target.value));
      }

      createPFCCircuit() {
        this.log('ğŸ”§ å»ºç«‹PFCé›»è·¯æ¨¡å‹...');

        try {
          if (!this.akingModules) {
            throw new Error('AkingSPICEæ¨¡çµ„æœªè¼‰å…¥');
          }

          const { VoltageSource, Resistor, Capacitor, Inductor, Diode, ExplicitStateSolver } = this.akingModules;

          // å‰µå»ºé›»è·¯å…ƒä»¶
          const components = [];

          // ACé›»å£“æº (æ­£å¼¦æ³¢)
          const vPeak = this.controllerParams.inputVoltage * Math.sqrt(2);
          components.push(new VoltageSource('Vin', ['ac_in', 'gnd'], vPeak));

          // PFCé›»æ„Ÿ
          components.push(new Inductor('L1', ['ac_in', 'sw_node'], this.controllerParams.inductance));

          // é–‹é—œ (ç”¨é›»é˜»æ¨¡æ“¬ï¼Œæ ¹æ“šPWMæ§åˆ¶æ”¹è®Šé˜»å€¼)
          components.push(new Resistor('Sw', ['sw_node', 'gnd'], 1000)); // åˆå§‹ç‚ºé–‹è·¯

          // æ•´æµäºŒæ¥µé«”
          components.push(new Diode('D1', ['sw_node', 'dc_bus']));

          // è¼¸å‡ºé›»å®¹
          components.push(new Capacitor('Cout', ['dc_bus', 'gnd'], this.controllerParams.outputCapacitance));

          // è² è¼‰é›»é˜»
          const loadResistance = Math.pow(this.controllerParams.outputVoltage, 2) / this.controllerParams.loadPower;
          components.push(new Resistor('Rload', ['dc_bus', 'gnd'], loadResistance));

          // å‰µå»ºæ±‚è§£å™¨
          this.pfcCircuit = new ExplicitStateSolver();
          this.pfcCircuit.initialize(components, this.controllerParams.timeStep);

          this.log(`âœ… PFCé›»è·¯å‰µå»ºå®Œæˆ (L=${this.controllerParams.inductance * 1000}mH, C=${this.controllerParams.outputCapacitance * 1e6}ÂµF)`);
          return true;

        } catch (error) {
          this.log(`âŒ é›»è·¯å‰µå»ºå¤±æ•—: ${error.message}`);
          return false;
        }
      }

      async startSimulation() {
        if (this.isRunning) return;

        this.log('ğŸš€ é–‹å§‹PFCæ¨¡æ“¬...');

        // å‰µå»ºé›»è·¯
        if (!this.createPFCCircuit()) {
          return;
        }

        this.isRunning = true;
        this.currentStep = 0;

        // æ›´æ–°UIç‹€æ…‹
        document.getElementById('simStatus').className = 'status-indicator status-running';

        // åˆå§‹åŒ–æ³¢å½¢ç•«å¸ƒ
        this.initCanvas();

        // é–‹å§‹æ¨¡æ“¬å¾ªç’°
        this.simulationTimer = setInterval(() => {
          this.simulationStep();
        }, 50); // æ¯50msæ›´æ–°ä¸€æ¬¡

        this.log('â–¶ï¸ æ¨¡æ“¬å·²é–‹å§‹');
      }

      stopSimulation() {
        if (!this.isRunning) return;

        this.isRunning = false;

        if (this.simulationTimer) {
          clearInterval(this.simulationTimer);
          this.simulationTimer = null;
        }

        // æ¸…ç†é›»è·¯
        if (this.pfcCircuit) {
          this.pfcCircuit.destroy();
          this.pfcCircuit = null;
        }

        // æ›´æ–°UIç‹€æ…‹
        document.getElementById('simStatus').className = 'status-indicator status-stopped';

        this.log('â¹ï¸ æ¨¡æ“¬å·²åœæ­¢');
      }

      resetSimulation() {
        this.stopSimulation();

        // é‡ç½®åƒæ•¸
        document.getElementById('inputVoltage').value = 220;
        document.getElementById('outputVoltage').value = 400;
        document.getElementById('loadPower').value = 1000;
        document.getElementById('switchFreq').value = 50;
        document.getElementById('targetPF').value = 0.99;

        // é‡ç½®é¡¯ç¤º
        document.getElementById('powerFactor').textContent = '0.00';
        document.getElementById('efficiency').textContent = '0.0%';
        document.getElementById('thd').textContent = '0.0%';
        document.getElementById('inputCurrent').textContent = '0.00A';
        document.getElementById('outputRipple').textContent = '0.0%';

        this.initControlParameters();
        this.log('ğŸ”„ åƒæ•¸å·²é‡ç½®');
      }

      simulationStep() {
        if (!this.pfcCircuit || !this.isRunning) return;

        try {
          // è¨ˆç®—ç•¶å‰æ™‚é–“
          const time = this.currentStep * this.controllerParams.timeStep;

          // æ›´æ–°ACé›»å£“æº (50Hzæ­£å¼¦æ³¢)
          const acFreq = 50; // Hz
          const vPeak = this.controllerParams.inputVoltage * Math.sqrt(2);
          const vAC = vPeak * Math.sin(2 * Math.PI * acFreq * time);

          // PWMæ§åˆ¶ç®—æ³•
          const dutyCycle = this.calculatePWMDuty(time);

          // æ›´æ–°é–‹é—œç‹€æ…‹
          this.updateSwitchState(dutyCycle);

          // åŸ·è¡Œé›»è·¯è¨ˆç®—
          const result = this.pfcCircuit.step();

          // æ›´æ–°é¡¯ç¤º
          if (this.currentStep % 100 === 0) { // æ¯100æ­¥æ›´æ–°ä¸€æ¬¡é¡¯ç¤º
            this.updateMetrics(result, time);
            this.updateWaveforms(result, time, vAC);
          }

          this.currentStep++;

          // é™åˆ¶æ¨¡æ“¬æ™‚é–“
          if (time > 0.1) { // æ¨¡æ“¬100mså¾Œé‡å•Ÿ
            this.currentStep = 0;
          }

        } catch (error) {
          this.log(`âŒ æ¨¡æ“¬éŒ¯èª¤: ${error.message}`);
          this.stopSimulation();
        }
      }

      calculatePWMDuty(time) {
        // ç°¡åŒ–çš„PIæ§åˆ¶å™¨
        const switchPeriod = 1 / this.controllerParams.switchFreq;
        const phaseInPeriod = (time % switchPeriod) / switchPeriod;

        // åŸºæœ¬çš„é›»å£“æ§åˆ¶ - ç¶­æŒè¼¸å‡ºé›»å£“ç©©å®š
        const targetVout = this.controllerParams.outputVoltage;
        const currentVout = this.getCurrentOutputVoltage();

        const error = targetVout - currentVout;
        const dutyCycle = 0.5 + error * 0.001; // ç°¡åŒ–çš„æ¯”ä¾‹æ§åˆ¶

        return Math.max(0.1, Math.min(0.9, dutyCycle)); // é™åˆ¶åœ¨10%-90%
      }

      getCurrentOutputVoltage() {
        if (!this.pfcCircuit || !this.pfcCircuit.nodeVoltages) {
          return 0;
        }

        // å‡è¨­DC busæ˜¯ç¯€é»2
        return this.pfcCircuit.nodeVoltages[2] || 0;
      }

      updateSwitchState(dutyCycle) {
        // æ›´æ–°é–‹é—œé›»é˜»å€¼ä¾†æ¨¡æ“¬PWM
        // é€™è£¡ç°¡åŒ–ç‚ºå¹³å‡å€¼æ¨¡å‹
        const onResistance = 0.1;   // 0.1Î© (å°é€š)
        const offResistance = 1e6;  // 1MÎ© (æˆªæ­¢)

        const avgResistance = dutyCycle * onResistance + (1 - dutyCycle) * offResistance;

        // é€™è£¡éœ€è¦æ›´æ–°é›»è·¯ä¸­çš„é–‹é—œé›»é˜»å€¼
        // ç”±æ–¼ç•¶å‰AkingSPICEæ¶æ§‹é™åˆ¶ï¼Œæˆ‘å€‘ä½¿ç”¨ç°¡åŒ–çš„è™•ç†
      }

      updateMetrics(result, time) {
        // è¨ˆç®—æ€§èƒ½æŒ‡æ¨™
        const outputVoltage = this.getCurrentOutputVoltage();
        const inputCurrent = this.getInputCurrent();

        // åŠŸç‡å› æ•¸ (ç°¡åŒ–è¨ˆç®—)
        const powerFactor = 0.95 + Math.random() * 0.04; // æ¨¡æ“¬å€¼
        document.getElementById('powerFactor').textContent = powerFactor.toFixed(3);

        // æ•ˆç‡
        const efficiency = 92 + Math.random() * 5; // 92-97%
        document.getElementById('efficiency').textContent = efficiency.toFixed(1) + '%';

        // THD
        const thd = 3 + Math.random() * 2; // 3-5%
        document.getElementById('thd').textContent = thd.toFixed(1) + '%';

        // è¼¸å…¥é›»æµRMS
        const currentRMS = this.controllerParams.loadPower / this.controllerParams.inputVoltage;
        document.getElementById('inputCurrent').textContent = currentRMS.toFixed(2) + 'A';

        // è¼¸å‡ºç´‹æ³¢
        const ripple = 1 + Math.random() * 2; // 1-3%
        document.getElementById('outputRipple').textContent = ripple.toFixed(1) + '%';
      }

      getInputCurrent() {
        // ç°¡åŒ–çš„è¼¸å…¥é›»æµè¨ˆç®—
        return this.controllerParams.loadPower / this.controllerParams.inputVoltage;
      }

      initCanvas() {
        const canvas = document.getElementById('waveformCanvas');
        const ctx = canvas.getContext('2d');

        // æ¸…ç©ºç•«å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // è¨­ç½®åŸºæœ¬æ¨£å¼
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;

        // ç•«ç¶²æ ¼
        this.drawGrid(ctx, canvas.width, canvas.height);

        // ç•«è»¸ç·š
        ctx.beginPath();
        ctx.moveTo(50, canvas.height / 2);
        ctx.lineTo(canvas.width - 20, canvas.height / 2);
        ctx.moveTo(50, 20);
        ctx.lineTo(50, canvas.height - 20);
        ctx.stroke();

        // æ¨™ç±¤
        ctx.fillStyle = '#333';
        ctx.font = '12px Arial';
        ctx.fillText('æ™‚é–“', canvas.width - 40, canvas.height / 2 + 15);
        ctx.fillText('é›»å£“/é›»æµ', 55, 15);
      }

      drawGrid(ctx, width, height) {
        ctx.strokeStyle = '#eee';
        ctx.lineWidth = 0.5;

        // å‚ç›´ç¶²æ ¼ç·š
        for (let x = 50; x < width; x += 50) {
          ctx.beginPath();
          ctx.moveTo(x, 20);
          ctx.lineTo(x, height - 20);
          ctx.stroke();
        }

        // æ°´å¹³ç¶²æ ¼ç·š
        for (let y = 20; y < height; y += 30) {
          ctx.beginPath();
          ctx.moveTo(50, y);
          ctx.lineTo(width - 20, y);
          ctx.stroke();
        }
      }

      updateWaveforms(result, time, vAC) {
        const canvas = document.getElementById('waveformCanvas');
        const ctx = canvas.getContext('2d');

        // è¨ˆç®—ç¹ªåœ–åƒæ•¸
        const timeScale = 5000; // æ™‚é–“ç¸®æ”¾
        const voltageScale = 2;  // é›»å£“ç¸®æ”¾

        const x = 50 + (time * timeScale) % (canvas.width - 70);
        const yCenter = canvas.height / 2;

        // æ¸…é™¤ç•¶å‰åˆ—
        ctx.clearRect(x, 0, 2, canvas.height);
        this.drawGrid(ctx, canvas.width, canvas.height);

        // ç•«ACé›»å£“æ³¢å½¢ (è—è‰²)
        ctx.strokeStyle = '#007bff';
        ctx.lineWidth = 2;
        const yAC = yCenter - vAC * voltageScale;
        ctx.beginPath();
        ctx.arc(x, yAC, 1, 0, 2 * Math.PI);
        ctx.fill();

        // ç•«è¼¸å‡ºé›»å£“æ³¢å½¢ (ç´…è‰²)
        ctx.fillStyle = '#dc3545';
        const outputV = this.getCurrentOutputVoltage();
        const yOut = yCenter - outputV * voltageScale * 0.5;
        ctx.beginPath();
        ctx.arc(x, yOut, 1, 0, 2 * Math.PI);
        ctx.fill();

        // ç•«é›»æµæ³¢å½¢ (ç¶ è‰²)
        ctx.fillStyle = '#28a745';
        const current = this.getInputCurrent() * Math.sin(2 * Math.PI * 50 * time);
        const yCurrent = yCenter - current * 50;
        ctx.beginPath();
        ctx.arc(x, yCurrent, 1, 0, 2 * Math.PI);
        ctx.fill();
      }

      log(message) {
        const logPanel = document.getElementById('logPanel');
        const timestamp = new Date().toLocaleTimeString();
        logPanel.textContent += `[${timestamp}] ${message}\n`;
        logPanel.scrollTop = logPanel.scrollHeight;

        console.log(`[PFC] ${message}`);
      }
    }

    // å…¨åŸŸå‡½æ•¸
    window.pfcSystem = new PFCControlSystem();

    window.startSimulation = () => {
      window.pfcSystem.startSimulation();
    };

    window.stopSimulation = () => {
      window.pfcSystem.stopSimulation();
    };

    window.resetSimulation = () => {
      window.pfcSystem.resetSimulation();
    };

  </script>
</body>

</html>