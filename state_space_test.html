<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹€æ…‹ç©ºé–“ç·¨è­¯å™¨æ¸¬è©¦ - AkingSPICEé©å‘½æ€§æ¶æ§‹é©—è­‰</title>
    <style>
        body { 
            font-family: 'Consolas', monospace; 
            margin: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4; 
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header {
            text-align: center;
            background: linear-gradient(45deg, #007acc, #00d4aa);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-title {
            color: #569cd6;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .circuit-diagram {
            background: #2d2d30;
            border: 1px solid #464647;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-panel {
            background: #2d2d30;
            border: 1px solid #464647;
            border-radius: 5px;
            padding: 15px;
        }
        
        .success { border-left: 4px solid #4ec9b0; }
        .error { border-left: 4px solid #f44747; }
        .info { border-left: 4px solid #569cd6; }
        .warning { border-left: 4px solid #ffcc02; }
        
        .matrix-display {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre;
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        button:hover {
            background: #1177bb;
        }
        
        button:disabled {
            background: #464647;
            cursor: not-allowed;
        }
        
        .log-output {
            background: #0c0c0c;
            color: #cccccc;
            padding: 10px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .architecture-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .arch-panel {
            padding: 15px;
            border-radius: 8px;
        }
        
        .old-arch {
            background: linear-gradient(135deg, #4a4a4a, #2d2d30);
            border-left: 4px solid #ffcc02;
        }
        
        .new-arch {
            background: linear-gradient(135deg, #0f4c75, #2d2d30);
            border-left: 4px solid #4ec9b0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œå€ -->
        <div class="header">
            <h1>ğŸš€ ç‹€æ…‹ç©ºé–“ç·¨è­¯å™¨æ¸¬è©¦</h1>
            <p>AkingSPICE é©å‘½æ€§é›»è·¯æ¨¡æ“¬æ¶æ§‹é©—è­‰</p>
            <p><strong>å¾ã€Œè§£é‡‹å™¨ã€åˆ°ã€Œç·¨è­¯å™¨ã€çš„ç¯„å¼è½‰æ›</strong></p>
        </div>

        <!-- æ¶æ§‹å°æ¯”å€ -->
        <div class="test-section">
            <div class="test-title">ğŸ“Š æ¶æ§‹å°æ¯”ï¼šå‚³çµ± vs ç‹€æ…‹ç©ºé–“</div>
            <div class="architecture-comparison">
                <div class="arch-panel old-arch">
                    <h4>ğŸ”¸ å‚³çµ±é¡¯å¼æ±‚è§£å™¨ (DAE)</h4>
                    <ul>
                        <li>æ¯æ­¥æ±‚è§£ï¼šG*v = i</li>
                        <li>è¨ˆç®—é‡ï¼šO(nÂ³) ç·šæ€§æ±‚è§£</li>
                        <li>ä»£æ•¸ç´„æŸå°è‡´æ•¸å€¼ä¸ç©©å®š</li>
                        <li>å°æ™‚é–“æ­¥é•·é™åˆ¶</li>
                        <li>ä¸­ç­‰GPUé©ç”¨æ€§</li>
                    </ul>
                </div>
                <div class="arch-panel new-arch">
                    <h4>ğŸ”¹ ç‹€æ…‹ç©ºé–“ODEæ±‚è§£å™¨</h4>
                    <ul>
                        <li>æ¯æ­¥è¨ˆç®—ï¼šx' = A*x + B*u</li>
                        <li>è¨ˆç®—é‡ï¼šO(nÂ²) çŸ©é™£ä¹˜æ³•</li>
                        <li>æ¶ˆé™¤ä»£æ•¸ç´„æŸï¼Œæ•¸å€¼ç©©å®š</li>
                        <li>å¯ç”¨è¼ƒå¤§æ™‚é–“æ­¥é•·</li>
                        <li>å®Œç¾GPUä¸¦è¡ŒåŒ–</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- æ¸¬è©¦é›»è·¯1ï¼šç°¡å–®RLC -->
        <div class="test-section">
            <div class="test-title">ğŸ”‹ æ¸¬è©¦é›»è·¯1ï¼šRLCä¸²è¯é›»è·¯</div>
            <div class="circuit-diagram">
V1(10V) ---[R1:1Î©]---[L1:1mH]---[C1:1Î¼F]--- GND
                                     |
                                   Output
            </div>
            <button onclick="runBasicTest()">ğŸ”¬ é‹è¡ŒåŸºç¤æ¸¬è©¦</button>
            <button onclick="runRLCTest()">âš¡ RLCé›»è·¯æ¸¬è©¦</button>
            
            <div class="results-grid" id="testResults" style="display: none;">
                <div class="result-panel" id="testStatus">
                    <h4>ğŸ“Š æ¸¬è©¦ç‹€æ…‹</h4>
                    <div id="testStatusContent"></div>
                </div>
                <div class="result-panel info">
                    <h4>ğŸ“ˆ çµæœè©³æƒ…</h4>
                    <div id="testDetailsContent"></div>
                </div>
            </div>
        </div>

        <!-- å¯¦æ™‚æ—¥èªŒè¼¸å‡º -->
        <div class="test-section">
            <div class="test-title">ğŸ“‹ å¯¦æ™‚æ—¥èªŒ</div>
            <div class="log-output" id="logOutput">
æº–å‚™é‹è¡Œæ¸¬è©¦...
ç‹€æ…‹ç©ºé–“ç·¨è­¯å™¨è¼‰å…¥ä¸­...
            </div>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
        </div>
    </div>

    <script type="module">
        // é¦–å…ˆæª¢æŸ¥æ˜¯å¦å¯ä»¥è¼‰å…¥åŸºæœ¬æ¨¡çµ„
        let modulesLoaded = false;
        let testResults = null;

        // æ—¥èªŒå‡½æ•¸
        window.log = function(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸'
            }[type] || 'â„¹ï¸';
            
            logOutput.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        };
        
        window.clearLog = function() {
            document.getElementById('logOutput').innerHTML = 'æ—¥èªŒå·²æ¸…é™¤\n';
        };

        // åŸºç¤æ¸¬è©¦å‡½æ•¸
        window.runBasicTest = async function() {
            log('ğŸ”¬ é–‹å§‹åŸºç¤æ¨¡çµ„æ¸¬è©¦', 'info');
            
            try {
                // æ¸¬è©¦ Matrix å’Œ Vector é¡
                log('è¼‰å…¥ç·šæ€§ä»£æ•¸æ¨¡çµ„...', 'info');
                const { Matrix, Vector } = await import('./src/core/linalg.js');
                
                // æ¸¬è©¦çŸ©é™£å‰µå»º
                const testMatrix = Matrix.zeros(3, 3);
                testMatrix.set(0, 0, 1);
                testMatrix.set(1, 1, 2);
                testMatrix.set(2, 2, 3);
                
                log('âœ… Matrix é¡æ¸¬è©¦é€šé', 'success');
                
                // æ¸¬è©¦å‘é‡å‰µå»º
                const testVector = new Vector([1, 2, 3]);
                log('âœ… Vector é¡æ¸¬è©¦é€šé', 'success');
                
                // å˜—è©¦è¼‰å…¥ç‹€æ…‹ç©ºé–“ç·¨è­¯å™¨
                log('è¼‰å…¥ç‹€æ…‹ç©ºé–“ç·¨è­¯å™¨...', 'info');
                const { StateSpaceCompiler } = await import('./src/core/state-space-compiler.js');
                
                const compiler = new StateSpaceCompiler();
                log('âœ… StateSpaceCompiler è¼‰å…¥æˆåŠŸ', 'success');
                
                // å˜—è©¦è¼‰å…¥ODEæ±‚è§£å™¨
                log('è¼‰å…¥ODEæ±‚è§£å™¨...', 'info');
                const { StateSpaceODESolver } = await import('./src/core/state-space-ode-solver.js');
                
                const solver = new StateSpaceODESolver();
                log('âœ… StateSpaceODESolver è¼‰å…¥æˆåŠŸ', 'success');
                
                // é¡¯ç¤ºæˆåŠŸçµæœ
                document.getElementById('testStatusContent').innerHTML = `
                    <div class="success">
                        <strong>âœ… æ‰€æœ‰æ¨¡çµ„è¼‰å…¥æˆåŠŸï¼</strong><br>
                        â€¢ Matrix/Vector é¡ï¼šæ­£å¸¸<br>
                        â€¢ StateSpaceCompilerï¼šæ­£å¸¸<br>
                        â€¢ StateSpaceODESolverï¼šæ­£å¸¸<br>
                        <br>
                        ç‹€æ…‹ç©ºé–“æ¶æ§‹å·²æº–å‚™å°±ç·’ï¼
                    </div>
                `;
                
                document.getElementById('testDetailsContent').innerHTML = `
                    <strong>æ¨¡çµ„è©³æƒ…ï¼š</strong><br>
                    â€¢ æ¸¬è©¦çŸ©é™£ç¶­åº¦ï¼š3x3<br>
                    â€¢ æ¸¬è©¦å‘é‡é•·åº¦ï¼š3<br>
                    â€¢ ç·¨è­¯å™¨å¯¦ä¾‹ï¼šå·²å‰µå»º<br>
                    â€¢ æ±‚è§£å™¨å¯¦ä¾‹ï¼šå·²å‰µå»º<br>
                    <br>
                    <em>æº–å‚™é€²è¡ŒRLCé›»è·¯æ¸¬è©¦</em>
                `;
                
                document.getElementById('testResults').style.display = 'grid';
                document.getElementById('testStatus').className = 'result-panel success';
                
                modulesLoaded = true;
                
                log('ğŸ‰ åŸºç¤æ¸¬è©¦å®Œæˆ - æ‰€æœ‰æ¨¡çµ„æ­£å¸¸ï¼', 'success');
                
            } catch (error) {
                log(`âŒ åŸºç¤æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                console.error('åŸºç¤æ¸¬è©¦éŒ¯èª¤:', error);
                
                document.getElementById('testStatusContent').innerHTML = `
                    <div class="error">
                        <strong>âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—</strong><br>
                        éŒ¯èª¤ï¼š${error.message}<br>
                        <br>
                        è«‹æª¢æŸ¥æ¨¡çµ„è·¯å¾‘å’Œä¾è³´é—œä¿‚
                    </div>
                `;
                
                document.getElementById('testDetailsContent').innerHTML = `
                    <strong>éŒ¯èª¤è©³æƒ…ï¼š</strong><br>
                    â€¢ éŒ¯èª¤é¡å‹ï¼š${error.constructor.name}<br>
                    â€¢ éŒ¯èª¤ä¿¡æ¯ï¼š${error.message}<br>
                    â€¢ å¯èƒ½åŸå› ï¼šæ¨¡çµ„æ–‡ä»¶ä¸å­˜åœ¨æˆ–èªæ³•éŒ¯èª¤<br>
                    <br>
                    <em>è«‹æª¢æŸ¥ src/core/ ç›®éŒ„ä¸‹çš„æ–‡ä»¶</em>
                `;
                
                document.getElementById('testResults').style.display = 'grid';
                document.getElementById('testStatus').className = 'result-panel error';
            }
        };

        // RLCé›»è·¯æ¸¬è©¦
        window.runRLCTest = async function() {
            if (!modulesLoaded) {
                log('âš ï¸ è«‹å…ˆé‹è¡ŒåŸºç¤æ¸¬è©¦', 'warning');
                return;
            }

            log('ğŸ”¬ é–‹å§‹RLCé›»è·¯æ¸¬è©¦', 'info');
            
            try {
                // å‰µå»ºç°¡åŒ–çš„RLCé›»è·¯çµ„ä»¶
                class SimpleComponent {
                    constructor(type, name, node1, node2, value, ic = 0) {
                        this.type = type;
                        this.name = name;
                        this.node1 = node1;
                        this.node2 = node2;
                        this.ic = ic;
                        
                        // è¨­ç½®å…ƒä»¶åƒæ•¸
                        switch (type) {
                            case 'R': this.resistance = value; break;
                            case 'L': this.inductance = value; break;
                            case 'C': this.capacitance = value; break;
                            case 'V': this.voltage = value; break;
                            case 'I': this.current = value; break;
                        }
                    }
                    
                    getNodes() { return [this.node1, this.node2]; }
                }

                // å‰µå»ºRLCé›»è·¯
                const components = [
                    new SimpleComponent('V', 'V1', 'in', '0', 10),      // 10Vé›»å£“æº
                    new SimpleComponent('R', 'R1', 'in', 'n1', 1),      // 1Î©é›»é˜»
                    new SimpleComponent('L', 'L1', 'n1', 'n2', 1e-3),   // 1mHé›»æ„Ÿ
                    new SimpleComponent('C', 'C1', 'n2', '0', 1e-6)     // 1Î¼Fé›»å®¹
                ];
                
                log(`å‰µå»ºRLCé›»è·¯ï¼š${components.length}å€‹å…ƒä»¶`, 'info');
                
                // è¼‰å…¥æ¨¡çµ„
                const { StateSpaceCompiler } = await import('./src/core/state-space-compiler.js');
                const { StateSpaceODESolver } = await import('./src/core/state-space-ode-solver.js');
                
                // éšæ®µ1ï¼šç·¨è­¯é›»è·¯
                log('ğŸ“Š éšæ®µ1ï¼šç·¨è­¯é›»è·¯åˆ°ç‹€æ…‹ç©ºé–“', 'info');
                const compiler = new StateSpaceCompiler();
                compiler.setDebug(true);
                
                const matrices = await compiler.compile(components, {
                    includeNodeVoltages: true,
                    debug: true
                });
                
                log('âœ… é›»è·¯ç·¨è­¯å®Œæˆ', 'success');
                
                // éšæ®µ2ï¼šå‰µå»ºæ±‚è§£å™¨
                log('ğŸ¯ éšæ®µ2ï¼šå‰µå»ºODEæ±‚è§£å™¨', 'info');
                const solver = new StateSpaceODESolver();
                await solver.initialize(matrices, {
                    integrationMethod: 'rk4',
                    debug: true
                });
                
                log('ğŸƒ éšæ®µ3ï¼šåŸ·è¡Œä»¿çœŸ (0-1ms)', 'info');
                const results = await solver.run(0, 1e-3, 1e-5);  // 1ms, 10Î¼sæ­¥é•·
                
                log('âœ… RLCä»¿çœŸå®Œæˆï¼', 'success');
                
                // é¡¯ç¤ºçµæœ
                const stats = results.stats;
                document.getElementById('testStatusContent').innerHTML = `
                    <div class="success">
                        <strong>âœ… RLCæ¸¬è©¦æˆåŠŸï¼</strong><br>
                        â€¢ ç‹€æ…‹è®Šé‡ï¼š${matrices.numStates}å€‹<br>
                        â€¢ è¼¸å…¥è®Šé‡ï¼š${matrices.numInputs}å€‹<br>
                        â€¢ è¼¸å‡ºè®Šé‡ï¼š${matrices.numOutputs}å€‹<br>
                        â€¢ ä»¿çœŸæ­¥æ•¸ï¼š${stats.actualTimeSteps}<br>
                        â€¢ åŠ é€Ÿæ¯”ï¼š${stats.simulationSpeedup.toFixed(1)}x
                    </div>
                `;
                
                document.getElementById('testDetailsContent').innerHTML = `
                    <strong>æ€§èƒ½çµ±è¨ˆï¼š</strong><br>
                    â€¢ ä»¿çœŸæ™‚é–“ï¼š${stats.totalSimulationTime.toFixed(2)}ms<br>
                    â€¢ å¹³å‡æ­¥é€Ÿï¼š${stats.averageStepsPerSecond.toFixed(0)} steps/s<br>
                    â€¢ ç·¨è­¯æ™‚é–“ï¼š${compiler.getStats().compilationTime.toFixed(2)}ms<br>
                    â€¢ æ¢ä»¶æ•¸ï¼š${compiler.getStats().matrixConditionNumber.toExponential(2)}<br>
                    <br>
                    <strong>æœ€çµ‚ç‹€æ…‹ï¼š</strong><br>
                    ${Object.entries(results.stateVariables).map(([name, values]) => 
                        `â€¢ ${name}: ${values[values.length-1].toFixed(6)}`
                    ).join('<br>')}
                `;
                
                testResults = results;
                
                log(`ğŸ‰ RLCæ¸¬è©¦å®Œæˆï¼åŠ é€Ÿæ¯”: ${stats.simulationSpeedup.toFixed(1)}x`, 'success');
                
            } catch (error) {
                log(`âŒ RLCæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                console.error('RLCæ¸¬è©¦éŒ¯èª¤:', error);
                
                document.getElementById('testStatusContent').innerHTML = `
                    <div class="error">
                        <strong>âŒ RLCæ¸¬è©¦å¤±æ•—</strong><br>
                        éŒ¯èª¤ï¼š${error.message}<br>
                    </div>
                `;
                
                document.getElementById('testDetailsContent').innerHTML = `
                    <strong>éŒ¯èª¤å †æ£§ï¼š</strong><br>
                    <pre style="font-size: 10px; white-space: pre-wrap;">${error.stack}</pre>
                `;
                
                document.getElementById('testStatus').className = 'result-panel error';
            }
        };

        // åˆå§‹åŒ–
        log('ğŸš€ ç‹€æ…‹ç©ºé–“æ¸¬è©¦ç³»çµ±å·²è¼‰å…¥', 'success');
        log('é»æ“Š "é‹è¡ŒåŸºç¤æ¸¬è©¦" é–‹å§‹é©—è­‰', 'info');
    </script>
</body>
</html>