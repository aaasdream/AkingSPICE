<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>狀態空間編譯器測試 - AkingSPICE革命性架構驗證</title>
    <style>
        body { 
            font-family: 'Consolas', monospace; 
            margin: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4; 
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header {
            text-align: center;
            background: linear-gradient(45deg, #007acc, #00d4aa);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-title {
            color: #569cd6;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .circuit-diagram {
            background: #2d2d30;
            border: 1px solid #464647;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-panel {
            background: #2d2d30;
            border: 1px solid #464647;
            border-radius: 5px;
            padding: 15px;
        }
        
        .success { border-left: 4px solid #4ec9b0; }
        .error { border-left: 4px solid #f44747; }
        .info { border-left: 4px solid #569cd6; }
        .warning { border-left: 4px solid #ffcc02; }
        
        .matrix-display {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre;
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        button:hover {
            background: #1177bb;
        }
        
        button:disabled {
            background: #464647;
            cursor: not-allowed;
        }
        
        .log-output {
            background: #0c0c0c;
            color: #cccccc;
            padding: 10px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .architecture-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .arch-panel {
            padding: 15px;
            border-radius: 8px;
        }
        
        .old-arch {
            background: linear-gradient(135deg, #4a4a4a, #2d2d30);
            border-left: 4px solid #ffcc02;
        }
        
        .new-arch {
            background: linear-gradient(135deg, #0f4c75, #2d2d30);
            border-left: 4px solid #4ec9b0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 標題區 -->
        <div class="header">
            <h1>🚀 狀態空間編譯器測試</h1>
            <p>AkingSPICE 革命性電路模擬架構驗證</p>
            <p><strong>從「解釋器」到「編譯器」的範式轉換</strong></p>
        </div>

        <!-- 架構對比區 -->
        <div class="test-section">
            <div class="test-title">📊 架構對比：傳統 vs 狀態空間</div>
            <div class="architecture-comparison">
                <div class="arch-panel old-arch">
                    <h4>🔸 傳統顯式求解器 (DAE)</h4>
                    <ul>
                        <li>每步求解：G*v = i</li>
                        <li>計算量：O(n³) 線性求解</li>
                        <li>代數約束導致數值不穩定</li>
                        <li>小時間步長限制</li>
                        <li>中等GPU適用性</li>
                    </ul>
                </div>
                <div class="arch-panel new-arch">
                    <h4>🔹 狀態空間ODE求解器</h4>
                    <ul>
                        <li>每步計算：x' = A*x + B*u</li>
                        <li>計算量：O(n²) 矩陣乘法</li>
                        <li>消除代數約束，數值穩定</li>
                        <li>可用較大時間步長</li>
                        <li>完美GPU並行化</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 測試電路1：簡單RLC -->
        <div class="test-section">
            <div class="test-title">🔋 測試電路1：RLC串聯電路</div>
            <div class="circuit-diagram">
V1(10V) ---[R1:1Ω]---[L1:1mH]---[C1:1μF]--- GND
                                     |
                                   Output
            </div>
            <button onclick="runBasicTest()">🔬 運行基礎測試</button>
            <button onclick="runRLCTest()">⚡ RLC電路測試</button>
            
            <div class="results-grid" id="testResults" style="display: none;">
                <div class="result-panel" id="testStatus">
                    <h4>📊 測試狀態</h4>
                    <div id="testStatusContent"></div>
                </div>
                <div class="result-panel info">
                    <h4>📈 結果詳情</h4>
                    <div id="testDetailsContent"></div>
                </div>
            </div>
        </div>

        <!-- 實時日誌輸出 -->
        <div class="test-section">
            <div class="test-title">📋 實時日誌</div>
            <div class="log-output" id="logOutput">
準備運行測試...
狀態空間編譯器載入中...
            </div>
            <button onclick="clearLog()">🗑️ 清除日誌</button>
        </div>
    </div>

    <script type="module">
        // 首先檢查是否可以載入基本模組
        let modulesLoaded = false;
        let testResults = null;

        // 日誌函數
        window.log = function(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': 'ℹ️',
                'success': '✅',
                'error': '❌',
                'warning': '⚠️'
            }[type] || 'ℹ️';
            
            logOutput.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        };
        
        window.clearLog = function() {
            document.getElementById('logOutput').innerHTML = '日誌已清除\n';
        };

        // 基礎測試函數
        window.runBasicTest = async function() {
            log('🔬 開始基礎模組測試', 'info');
            
            try {
                // 測試 Matrix 和 Vector 類
                log('載入線性代數模組...', 'info');
                const { Matrix, Vector } = await import('./src/core/linalg.js');
                
                // 測試矩陣創建
                const testMatrix = Matrix.zeros(3, 3);
                testMatrix.set(0, 0, 1);
                testMatrix.set(1, 1, 2);
                testMatrix.set(2, 2, 3);
                
                log('✅ Matrix 類測試通過', 'success');
                
                // 測試向量創建
                const testVector = new Vector([1, 2, 3]);
                log('✅ Vector 類測試通過', 'success');
                
                // 嘗試載入狀態空間編譯器
                log('載入狀態空間編譯器...', 'info');
                const { StateSpaceCompiler } = await import('./src/core/state-space-compiler.js');
                
                const compiler = new StateSpaceCompiler();
                log('✅ StateSpaceCompiler 載入成功', 'success');
                
                // 嘗試載入ODE求解器
                log('載入ODE求解器...', 'info');
                const { StateSpaceODESolver } = await import('./src/core/state-space-ode-solver.js');
                
                const solver = new StateSpaceODESolver();
                log('✅ StateSpaceODESolver 載入成功', 'success');
                
                // 顯示成功結果
                document.getElementById('testStatusContent').innerHTML = `
                    <div class="success">
                        <strong>✅ 所有模組載入成功！</strong><br>
                        • Matrix/Vector 類：正常<br>
                        • StateSpaceCompiler：正常<br>
                        • StateSpaceODESolver：正常<br>
                        <br>
                        狀態空間架構已準備就緒！
                    </div>
                `;
                
                document.getElementById('testDetailsContent').innerHTML = `
                    <strong>模組詳情：</strong><br>
                    • 測試矩陣維度：3x3<br>
                    • 測試向量長度：3<br>
                    • 編譯器實例：已創建<br>
                    • 求解器實例：已創建<br>
                    <br>
                    <em>準備進行RLC電路測試</em>
                `;
                
                document.getElementById('testResults').style.display = 'grid';
                document.getElementById('testStatus').className = 'result-panel success';
                
                modulesLoaded = true;
                
                log('🎉 基礎測試完成 - 所有模組正常！', 'success');
                
            } catch (error) {
                log(`❌ 基礎測試失敗: ${error.message}`, 'error');
                console.error('基礎測試錯誤:', error);
                
                document.getElementById('testStatusContent').innerHTML = `
                    <div class="error">
                        <strong>❌ 模組載入失敗</strong><br>
                        錯誤：${error.message}<br>
                        <br>
                        請檢查模組路徑和依賴關係
                    </div>
                `;
                
                document.getElementById('testDetailsContent').innerHTML = `
                    <strong>錯誤詳情：</strong><br>
                    • 錯誤類型：${error.constructor.name}<br>
                    • 錯誤信息：${error.message}<br>
                    • 可能原因：模組文件不存在或語法錯誤<br>
                    <br>
                    <em>請檢查 src/core/ 目錄下的文件</em>
                `;
                
                document.getElementById('testResults').style.display = 'grid';
                document.getElementById('testStatus').className = 'result-panel error';
            }
        };

        // RLC電路測試
        window.runRLCTest = async function() {
            if (!modulesLoaded) {
                log('⚠️ 請先運行基礎測試', 'warning');
                return;
            }

            log('🔬 開始RLC電路測試', 'info');
            
            try {
                // 創建簡化的RLC電路組件
                class SimpleComponent {
                    constructor(type, name, node1, node2, value, ic = 0) {
                        this.type = type;
                        this.name = name;
                        this.node1 = node1;
                        this.node2 = node2;
                        this.ic = ic;
                        
                        // 設置元件參數
                        switch (type) {
                            case 'R': this.resistance = value; break;
                            case 'L': this.inductance = value; break;
                            case 'C': this.capacitance = value; break;
                            case 'V': this.voltage = value; break;
                            case 'I': this.current = value; break;
                        }
                    }
                    
                    getNodes() { return [this.node1, this.node2]; }
                }

                // 創建RLC電路
                const components = [
                    new SimpleComponent('V', 'V1', 'in', '0', 10),      // 10V電壓源
                    new SimpleComponent('R', 'R1', 'in', 'n1', 1),      // 1Ω電阻
                    new SimpleComponent('L', 'L1', 'n1', 'n2', 1e-3),   // 1mH電感
                    new SimpleComponent('C', 'C1', 'n2', '0', 1e-6)     // 1μF電容
                ];
                
                log(`創建RLC電路：${components.length}個元件`, 'info');
                
                // 載入模組
                const { StateSpaceCompiler } = await import('./src/core/state-space-compiler.js');
                const { StateSpaceODESolver } = await import('./src/core/state-space-ode-solver.js');
                
                // 階段1：編譯電路
                log('📊 階段1：編譯電路到狀態空間', 'info');
                const compiler = new StateSpaceCompiler();
                compiler.setDebug(true);
                
                const matrices = await compiler.compile(components, {
                    includeNodeVoltages: true,
                    debug: true
                });
                
                log('✅ 電路編譯完成', 'success');
                
                // 階段2：創建求解器
                log('🎯 階段2：創建ODE求解器', 'info');
                const solver = new StateSpaceODESolver();
                await solver.initialize(matrices, {
                    integrationMethod: 'rk4',
                    debug: true
                });
                
                log('🏃 階段3：執行仿真 (0-1ms)', 'info');
                const results = await solver.run(0, 1e-3, 1e-5);  // 1ms, 10μs步長
                
                log('✅ RLC仿真完成！', 'success');
                
                // 顯示結果
                const stats = results.stats;
                document.getElementById('testStatusContent').innerHTML = `
                    <div class="success">
                        <strong>✅ RLC測試成功！</strong><br>
                        • 狀態變量：${matrices.numStates}個<br>
                        • 輸入變量：${matrices.numInputs}個<br>
                        • 輸出變量：${matrices.numOutputs}個<br>
                        • 仿真步數：${stats.actualTimeSteps}<br>
                        • 加速比：${stats.simulationSpeedup.toFixed(1)}x
                    </div>
                `;
                
                document.getElementById('testDetailsContent').innerHTML = `
                    <strong>性能統計：</strong><br>
                    • 仿真時間：${stats.totalSimulationTime.toFixed(2)}ms<br>
                    • 平均步速：${stats.averageStepsPerSecond.toFixed(0)} steps/s<br>
                    • 編譯時間：${compiler.getStats().compilationTime.toFixed(2)}ms<br>
                    • 條件數：${compiler.getStats().matrixConditionNumber.toExponential(2)}<br>
                    <br>
                    <strong>最終狀態：</strong><br>
                    ${Object.entries(results.stateVariables).map(([name, values]) => 
                        `• ${name}: ${values[values.length-1].toFixed(6)}`
                    ).join('<br>')}
                `;
                
                testResults = results;
                
                log(`🎉 RLC測試完成！加速比: ${stats.simulationSpeedup.toFixed(1)}x`, 'success');
                
            } catch (error) {
                log(`❌ RLC測試失敗: ${error.message}`, 'error');
                console.error('RLC測試錯誤:', error);
                
                document.getElementById('testStatusContent').innerHTML = `
                    <div class="error">
                        <strong>❌ RLC測試失敗</strong><br>
                        錯誤：${error.message}<br>
                    </div>
                `;
                
                document.getElementById('testDetailsContent').innerHTML = `
                    <strong>錯誤堆棧：</strong><br>
                    <pre style="font-size: 10px; white-space: pre-wrap;">${error.stack}</pre>
                `;
                
                document.getElementById('testStatus').className = 'result-panel error';
            }
        };

        // 初始化
        log('🚀 狀態空間測試系統已載入', 'success');
        log('點擊 "運行基礎測試" 開始驗證', 'info');
    </script>
</body>
</html>