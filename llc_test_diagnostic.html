<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLCæ¸¬è©¦è¨ºæ–·</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #2c3e50;
      color: white;
    }

    .test-box {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      margin: 10px 0;
      border-radius: 10px;
    }

    .success {
      background: rgba(46, 204, 113, 0.3);
    }

    .error {
      background: rgba(231, 76, 60, 0.3);
    }

    .warning {
      background: rgba(241, 196, 15, 0.3);
    }
  </style>
</head>

<body>
  <h1>ğŸ§ª LLCç³»çµ±è¨ºæ–·æ¸¬è©¦</h1>

  <div id="test1" class="test-box">
    <h3>æ¸¬è©¦1: åŸºæœ¬JavaScriptåŠŸèƒ½</h3>
    <div id="result1">æ¸¬è©¦ä¸­...</div>
  </div>

  <div id="test2" class="test-box">
    <h3>æ¸¬è©¦2: AkingSPICEæ¨¡çµ„è¼‰å…¥</h3>
    <div id="result2">æ¸¬è©¦ä¸­...</div>
  </div>

  <div id="test3" class="test-box">
    <h3>æ¸¬è©¦3: é›»è·¯å‰µå»ºæ¸¬è©¦</h3>
    <div id="result3">æ¸¬è©¦ä¸­...</div>
  </div>

  <div id="test4" class="test-box">
    <h3>æ¸¬è©¦4: ç°¡å–®æ¨¡æ“¬æ¸¬è©¦</h3>
    <div id="result4">æ¸¬è©¦ä¸­...</div>
  </div>

  <div id="test5" class="test-box">
    <h3>æ¸¬è©¦5: LLCæ§åˆ¶ç®—æ³•æ¸¬è©¦</h3>
    <div id="result5">æ¸¬è©¦ä¸­...</div>
  </div>

  <button onclick="startLLCTest()"
    style="padding: 15px 30px; background: #3498db; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">é–‹å§‹LLCåŠŸèƒ½æ¸¬è©¦</button>

  <div id="detailedLog" class="test-box" style="margin-top: 20px;">
    <h3>ğŸ“‹ è©³ç´°æ¸¬è©¦æ—¥èªŒ</h3>
    <div id="logContent"
      style="font-family: 'Courier New', monospace; font-size: 12px; max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
    </div>
  </div>

  <script type="module">
    let testLog = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      testLog.push(logEntry);

      const logContent = document.getElementById('logContent');
      const div = document.createElement('div');
      div.textContent = logEntry;
      div.style.color = type === 'error' ? '#e74c3c' :
        type === 'success' ? '#2ecc71' :
          type === 'warning' ? '#f1c40f' : '#ecf0f1';
      logContent.appendChild(div);
      logContent.scrollTop = logContent.scrollHeight;

      console.log(logEntry);
    }

    function setTestResult(testId, success, message) {
      const testDiv = document.getElementById(testId);
      const resultDiv = document.getElementById(`result${testId.slice(-1)}`);

      if (success) {
        testDiv.className = 'test-box success';
        resultDiv.innerHTML = `âœ… ${message}`;
      } else {
        testDiv.className = 'test-box error';
        resultDiv.innerHTML = `âŒ ${message}`;
      }
    }

    async function runBasicTest() {
      log('é–‹å§‹åŸºæœ¬åŠŸèƒ½æ¸¬è©¦...', 'info');

      try {
        // æ¸¬è©¦åŸºæœ¬JavaScriptåŠŸèƒ½
        const testArray = [1, 2, 3, 4, 5];
        const sum = testArray.reduce((a, b) => a + b, 0);

        if (sum === 15) {
          setTestResult('test1', true, 'åŸºæœ¬JavaScriptåŠŸèƒ½æ­£å¸¸');
          log('âœ… åŸºæœ¬JavaScriptåŠŸèƒ½æ¸¬è©¦é€šé', 'success');
          return true;
        } else {
          throw new Error('æ•¸çµ„é‹ç®—éŒ¯èª¤');
        }
      } catch (error) {
        setTestResult('test1', false, `åŸºæœ¬åŠŸèƒ½éŒ¯èª¤: ${error.message}`);
        log(`âŒ åŸºæœ¬åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
        return false;
      }
    }

    async function runAkingSpiceTest() {
      log('é–‹å§‹AkingSPICEæ¨¡çµ„è¼‰å…¥æ¸¬è©¦...', 'info');

      try {
        const modules = await import('./lib-dist/AkingSPICE.es.js');
        log('AkingSPICEæ¨¡çµ„è¼‰å…¥æˆåŠŸ', 'info');

        const requiredModules = ['VoltageSource', 'Resistor', 'Capacitor', 'Inductor', 'Diode', 'ExplicitStateSolver'];
        const missing = [];

        for (const moduleName of requiredModules) {
          if (!modules[moduleName]) {
            missing.push(moduleName);
          } else {
            log(`âœ“ ${moduleName} æ¨¡çµ„å¯ç”¨`, 'info');
          }
        }

        if (missing.length > 0) {
          throw new Error(`ç¼ºå°‘æ¨¡çµ„: ${missing.join(', ')}`);
        }

        setTestResult('test2', true, `æˆåŠŸè¼‰å…¥ ${requiredModules.length} å€‹æ¨¡çµ„`);
        log('âœ… AkingSPICEæ¨¡çµ„æ¸¬è©¦é€šé', 'success');
        return modules;

      } catch (error) {
        setTestResult('test2', false, `æ¨¡çµ„è¼‰å…¥å¤±æ•—: ${error.message}`);
        log(`âŒ AkingSPICEæ¨¡çµ„æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
        return null;
      }
    }

    async function runCircuitCreationTest(modules) {
      log('é–‹å§‹é›»è·¯å‰µå»ºæ¸¬è©¦...', 'info');

      if (!modules) {
        setTestResult('test3', false, 'æ¨¡çµ„æœªè¼‰å…¥ï¼Œè·³éæ¸¬è©¦');
        return false;
      }

      try {
        const { VoltageSource, Resistor, Capacitor, Inductor, Diode } = modules;

        // å‰µå»ºç°¡å–®çš„LLCé›»è·¯å…ƒä»¶
        const components = [];

        log('å‰µå»ºé›»å£“æº...', 'info');
        components.push(new VoltageSource('Vin', ['dc_in', 'gnd'], 400));

        log('å‰µå»ºè«§æŒ¯é›»æ„Ÿ...', 'info');
        components.push(new Inductor('Lr', ['dc_in', 'res_node'], 50e-6));

        log('å‰µå»ºè«§æŒ¯é›»å®¹...', 'info');
        components.push(new Capacitor('Cr', ['res_node', 'switch_node'], 100e-9));

        log('å‰µå»ºæ¿€ç£é›»æ„Ÿ...', 'info');
        components.push(new Inductor('Lm', ['switch_node', 'gnd'], 200e-6));

        log('å‰µå»ºè² è¼‰é›»é˜»...', 'info');
        components.push(new Resistor('Rload', ['switch_node', 'gnd'], 100));

        setTestResult('test3', true, `æˆåŠŸå‰µå»º ${components.length} å€‹é›»è·¯å…ƒä»¶`);
        log('âœ… é›»è·¯å‰µå»ºæ¸¬è©¦é€šé', 'success');
        return components;

      } catch (error) {
        setTestResult('test3', false, `é›»è·¯å‰µå»ºå¤±æ•—: ${error.message}`);
        log(`âŒ é›»è·¯å‰µå»ºæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
        return null;
      }
    }

    async function runSimulationTest(modules, components) {
      log('é–‹å§‹æ¨¡æ“¬æ¸¬è©¦...', 'info');

      if (!modules || !components) {
        setTestResult('test4', false, 'å‰ç½®æ¢ä»¶æœªæ»¿è¶³ï¼Œè·³éæ¸¬è©¦');
        return false;
      }

      try {
        const { ExplicitStateSolver } = modules;

        log('å‰µå»ºæ±‚è§£å™¨...', 'info');
        const solver = new ExplicitStateSolver();

        log('åˆå§‹åŒ–æ±‚è§£å™¨...', 'info');
        await solver.initialize(components, 1e-6);

        log('åŸ·è¡Œæ¨¡æ“¬æ­¥é©Ÿ...', 'info');
        const result1 = solver.step();
        const result2 = solver.step();
        const result3 = solver.step();

        log('æ¸…ç†æ±‚è§£å™¨...', 'info');
        solver.destroy();

        setTestResult('test4', true, 'æ¨¡æ“¬åŸ·è¡ŒæˆåŠŸï¼Œæ±‚è§£å™¨å·¥ä½œæ­£å¸¸');
        log('âœ… æ¨¡æ“¬æ¸¬è©¦é€šé', 'success');
        return true;

      } catch (error) {
        setTestResult('test4', false, `æ¨¡æ“¬æ¸¬è©¦å¤±æ•—: ${error.message}`);
        log(`âŒ æ¨¡æ“¬æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
        return false;
      }
    }

    async function runLLCControlTest() {
      log('é–‹å§‹LLCæ§åˆ¶ç®—æ³•æ¸¬è©¦...', 'info');

      try {
        // æ¸¬è©¦è«§æŒ¯é »ç‡è¨ˆç®—
        const Lr = 50e-6;  // 50Î¼H
        const Cr = 100e-9; // 100nF
        const fr = 1 / (2 * Math.PI * Math.sqrt(Lr * Cr));

        log(`è«§æŒ¯é »ç‡è¨ˆç®—: fr = ${(fr / 1000).toFixed(1)} kHz`, 'info');

        // æ¸¬è©¦é »ç‡æ§åˆ¶å¢ç›Š
        const fs = 100000; // 100kHz
        const Q = 0.5;
        const gain = fs > fr ? Math.pow(fr / fs, 2) : 1;

        log(`é »ç‡æ§åˆ¶å¢ç›Š: ${gain.toFixed(3)}`, 'info');

        // æ¸¬è©¦PWMæ§åˆ¶
        let dutyCycle = 0.45;
        let switchPeriod = 1 / fs;

        log(`PWMåƒæ•¸: å ç©ºæ¯”=${dutyCycle}, å‘¨æœŸ=${(switchPeriod * 1e6).toFixed(1)}Î¼s`, 'info');

        // æ¸¬è©¦æ•ˆç‡è¨ˆç®—
        const efficiency = Math.max(85, 95 - Math.abs(fs / 1000 - fr / 1000) * 0.1);

        log(`æ•ˆç‡ä¼°ç®—: ${efficiency.toFixed(1)}%`, 'info');

        if (fr > 0 && gain > 0 && efficiency > 80) {
          setTestResult('test5', true, `LLCæ§åˆ¶ç®—æ³•æ­£å¸¸ï¼Œfr=${(fr / 1000).toFixed(1)}kHzï¼Œæ•ˆç‡=${efficiency.toFixed(1)}%`);
          log('âœ… LLCæ§åˆ¶ç®—æ³•æ¸¬è©¦é€šé', 'success');
          return true;
        } else {
          throw new Error('æ§åˆ¶ç®—æ³•è¨ˆç®—çµæœç•°å¸¸');
        }

      } catch (error) {
        setTestResult('test5', false, `LLCæ§åˆ¶æ¸¬è©¦å¤±æ•—: ${error.message}`);
        log(`âŒ LLCæ§åˆ¶æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
        return false;
      }
    }

    // å…¨å±€æ¸¬è©¦å‡½æ•¸
    window.startLLCTest = async function () {
      log('ğŸš€ é–‹å§‹LLCç³»çµ±å®Œæ•´æ¸¬è©¦', 'info');

      // é‡ç½®æ‰€æœ‰æ¸¬è©¦çµæœ
      for (let i = 1; i <= 5; i++) {
        document.getElementById(`test${i}`).className = 'test-box';
        document.getElementById(`result${i}`).innerHTML = 'æ¸¬è©¦ä¸­...';
      }

      document.getElementById('logContent').innerHTML = '';
      testLog = [];

      // ä¾åºåŸ·è¡Œæ¸¬è©¦
      const basicOk = await runBasicTest();
      if (!basicOk) return;

      const modules = await runAkingSpiceTest();

      const components = await runCircuitCreationTest(modules);

      const simulationOk = await runSimulationTest(modules, components);

      const controlOk = await runLLCControlTest();

      // ç¸½çµæ¸¬è©¦çµæœ
      const allPassed = basicOk && modules && components && simulationOk && controlOk;

      log('', 'info');
      log('='.repeat(50), 'info');
      log('ğŸ“Š LLCç³»çµ±æ¸¬è©¦ç¸½çµ:', 'info');
      log(`åŸºæœ¬åŠŸèƒ½: ${basicOk ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}`, basicOk ? 'success' : 'error');
      log(`æ¨¡çµ„è¼‰å…¥: ${modules ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}`, modules ? 'success' : 'error');
      log(`é›»è·¯å‰µå»º: ${components ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}`, components ? 'success' : 'error');
      log(`æ¨¡æ“¬åŸ·è¡Œ: ${simulationOk ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}`, simulationOk ? 'success' : 'error');
      log(`æ§åˆ¶ç®—æ³•: ${controlOk ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}`, controlOk ? 'success' : 'error');
      log('='.repeat(50), 'info');

      if (allPassed) {
        log('ğŸ‰ LLCç³»çµ±æ¸¬è©¦å…¨éƒ¨é€šéï¼ç³»çµ±å¯ä»¥æ­£å¸¸å·¥ä½œï¼', 'success');
      } else {
        log('âš ï¸ LLCç³»çµ±å­˜åœ¨å•é¡Œï¼Œéœ€è¦ä¿®æ­£', 'error');
      }
    };

    // é é¢è¼‰å…¥å¾Œè‡ªå‹•åŸ·è¡Œæ¸¬è©¦
    document.addEventListener('DOMContentLoaded', () => {
      log('ğŸ“‹ LLCè¨ºæ–·ç³»çµ±å·²è¼‰å…¥ï¼Œè‡ªå‹•é–‹å§‹æ¸¬è©¦...', 'info');

      // å»¶é²1ç§’å¾Œè‡ªå‹•åŸ·è¡Œæ¸¬è©¦
      setTimeout(() => {
        startLLCTest();
      }, 1000);
    });
  </script>
</body>

</html>