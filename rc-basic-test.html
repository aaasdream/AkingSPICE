<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”§ AkingSPICE åŸºæœ¬æ¸¬è©¦ - RC é›»è·¯</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #059669; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        .chart-container {
            margin-top: 20px;
            height: 400px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ”§ AkingSPICE åŸºæœ¬æ¸¬è©¦ - RC é›»è·¯</h1>
        <p>æ¸¬è©¦æœ€ç°¡å–®çš„ RC å……é›»é›»è·¯ï¼Œé©—è­‰æ±‚è§£å™¨åŸºæœ¬åŠŸèƒ½</p>
    </div>

    <div class="controls">
        <button id="testBtn">ğŸš€ æ¸¬è©¦ RC é›»è·¯</button>
        <button id="clearBtn">æ¸…é™¤æ—¥èªŒ</button>
        <span>é›»è·¯: 12V â†’ R(1kÎ©) â†’ C(1ÂµF) â†’ GND</span>
    </div>

    <div class="log" id="logOutput">æº–å‚™æ¸¬è©¦ RC é›»è·¯...</div>
    
    <div class="chart-container">
        <canvas id="testChart"></canvas>
    </div>
</div>

<script src="./lib-dist/AkingSPICE.umd.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let chart = null;
    
    // åˆå§‹åŒ–åœ–è¡¨
    const ctx = document.getElementById('testChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { title: { display: true, text: 'æ™‚é–“ (ms)' } },
                y: { title: { display: true, text: 'é›»å£“ (V)' }, beginAtZero: true }
            }
        }
    });

    function log(message) {
        const logOutput = document.getElementById('logOutput');
        const timestamp = new Date().toLocaleTimeString();
        logOutput.textContent += `[${timestamp}] ${message}\n`;
        logOutput.scrollTop = logOutput.scrollHeight;
    }

    function clearLog() {
        document.getElementById('logOutput').textContent = '';
    }

    async function testRCCircuit() {
        const testBtn = document.getElementById('testBtn');
        testBtn.disabled = true;
        testBtn.textContent = 'æ¸¬è©¦ä¸­...';
        
        try {
            log('ğŸš€ é–‹å§‹ RC é›»è·¯åŸºæœ¬æ¸¬è©¦...');
            
            // æª¢æŸ¥åº«
            if (typeof AkingSPICE === 'undefined') {
                throw new Error('AkingSPICE åº«æœªè¼‰å…¥');
            }
            log('âœ… AkingSPICE åº«è¼‰å…¥æˆåŠŸ');
            
            // å‰µå»ºæ±‚è§£å™¨
            const solver = new AkingSPICE.ExplicitStateSolver();
            log('âœ… ExplicitStateSolver å‰µå»ºæˆåŠŸ');
            
            // å‰µå»ºç°¡å–® RC é›»è·¯ - ä¿®å¾©æ¥µæ€§å’Œåˆå§‹æ¢ä»¶
            const { VoltageSource, Resistor, Capacitor } = AkingSPICE;
            
            const components = [
                new VoltageSource('V1', ['1', '0'], 12),          // 12V é›»å£“æº (ç¯€é»1 â†’ åœ°)
                new Resistor('R1', ['1', '2'], 1000),             // 1kÎ© é›»é˜» (ç¯€é»1 â†’ ç¯€é»2)
                new Capacitor('C1', ['2', '0'], 1e-6)             // 1ÂµF é›»å®¹ (ç¯€é»2 â†’ åœ°)ï¼Œé»˜èªåˆå§‹0V
            ];
            
            log('ğŸ“¦ RC é›»è·¯çµ„ä»¶å‰µå»ºå®Œæˆ');
            log('   â€¢ V1: 12V (ç¯€é»1 â†’ ç¯€é»0)');
            log('   â€¢ R1: 1kÎ© (ç¯€é»1 â†’ ç¯€é»2)');  
            log('   â€¢ C1: 1ÂµF (ç¯€é»2 â†’ ç¯€é»0), åˆå§‹ 0V');
            log('   â€¢ ç†è«–æ™‚é–“å¸¸æ•¸ Ï„ = RC = 1ms');
            log('   â€¢ ç›£æ¸¬ç¯€é»: ç¯€é»2 (é›»å®¹é›»å£“)');
            
            // æ¨¡æ“¬åƒæ•¸
            const timeStep = 10e-6;  // 10Âµs
            const simTime = 5e-3;    // 5ms (5å€‹æ™‚é–“å¸¸æ•¸)
            const totalSteps = Math.floor(simTime / timeStep);
            
            log(`âš™ï¸  æ¨¡æ“¬åƒæ•¸: æ™‚é–“æ­¥é•·=${timeStep*1e6}Âµs, ç¸½æ™‚é–“=${simTime*1000}ms, æ­¥æ•¸=${totalSteps}`);
            
            // åˆå§‹åŒ–æ±‚è§£å™¨
            await solver.initialize(components, timeStep, {
                debug: false,
                integrationMethod: 'forward_euler'
            });
            log('âœ… æ±‚è§£å™¨åˆå§‹åŒ–æˆåŠŸ');
            
            // åŸ·è¡Œæ¨¡æ“¬
            log('âš¡ é–‹å§‹æ™‚é–“æ­¥é€²...');
            const startTime = performance.now();
            
            const results = [];
            let successCount = 0;
            
            for (let step = 0; step < totalSteps; step++) {
                try {
                    const currentTime = step * timeStep;
                    
                    // ç°¡å–®æ­¥é€²ï¼Œç„¡éœ€æ§åˆ¶è¼¸å…¥
                    const result = solver.step({});
                    
                    if (result && result.nodeVoltages) {
                        // ä½¿ç”¨ç¯€é»2ä½œç‚ºè¼¸å‡ºé›»å£“ (é›»å®¹é›»å£“)
                        const vout = result.nodeVoltages['2'] || 0;
                        results.push({
                            time: currentTime * 1000,  // ms
                            vout: vout
                        });
                        successCount++;
                        
                        // æ¯100æ­¥è¼¸å‡ºä¸€æ¬¡
                        if (step % 100 === 0) {
                            log(`   æ­¥é©Ÿ ${step}: t=${(currentTime*1000).toFixed(2)}ms, V(ç¯€é»2)=${vout.toFixed(3)}V`);
                        }
                    }
                } catch (stepError) {
                    if (step < 10) {  // åªå ±å‘Šå‰10å€‹éŒ¯èª¤
                        log(`âš ï¸  æ­¥é©Ÿ ${step} å¤±æ•—: ${stepError.message}`);
                    }
                }
            }
            
            const endTime = performance.now();
            const duration = endTime - startTime;
            
            log(`âš¡ æ¨¡æ“¬å®Œæˆ! è€—æ™‚: ${duration.toFixed(1)}ms`);
            log(`ğŸ“Š æˆåŠŸæ­¥æ•¸: ${successCount} / ${totalSteps} (${(successCount/totalSteps*100).toFixed(1)}%)`);
            
            if (results.length > 0) {
                // åˆ†æçµæœ
                const finalVout = results[results.length - 1].vout;
                const theoreticalFinal = 12 * (1 - Math.exp(-simTime / (1e-3)));  // Ï„ = 1ms
                const error = Math.abs(finalVout - theoreticalFinal);
                
                log('ğŸ“ˆ çµæœåˆ†æ:');
                log(`   æœ€çµ‚é›»å£“: ${finalVout.toFixed(3)}V`);
                log(`   ç†è«–å€¼: ${theoreticalFinal.toFixed(3)}V`);
                log(`   èª¤å·®: ${error.toFixed(3)}V (${(error/theoreticalFinal*100).toFixed(1)}%)`);
                
                // ç¹ªè£½çµæœ
                const timeData = results.map(r => r.time);
                const voutData = results.map(r => r.vout);
                
                chart.data = {
                    labels: timeData,
                    datasets: [{
                        label: 'Vout (å¯¦éš›)',
                        data: voutData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0
                    }, {
                        label: 'Vout (ç†è«–)',
                        data: timeData.map(t => 12 * (1 - Math.exp(-t/1000 / 1))),  // Ï„ = 1ms
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                };
                chart.update();
                
                log('âœ… æ¸¬è©¦æˆåŠŸï¼åœ–è¡¨å·²æ›´æ–°');
            } else {
                log('âŒ æ²’æœ‰æœ‰æ•ˆçš„æ¨¡æ“¬çµæœ');
            }
            
        } catch (error) {
            log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`);
            console.error('Test error:', error);
        } finally {
            testBtn.disabled = false;
            testBtn.textContent = 'ğŸš€ æ¸¬è©¦ RC é›»è·¯';
        }
    }

    // äº‹ä»¶ç›£è½å™¨
    document.getElementById('testBtn').addEventListener('click', testRCCircuit);
    document.getElementById('clearBtn').addEventListener('click', clearLog);
});
</script>

</body>
</html>