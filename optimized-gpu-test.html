<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU 求解器優化測試</title>
    <style>
        body {
            font-family: '                      const createComponents = () => [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];     // 創建測試電路
                const createComponents = () => [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            color: #34495e;
            margin-top: 0;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .performance-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .highlight { background-color: #fff59d !important; }
        .fast-path { background-color: #c8e6c9 !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 GPU 求解器優化驗證測試</h1>
        
        <div class="test-section">
            <h3>📋 測試計劃</h3>
            <div class="info result">
✅ 驗證小電路自動使用 CPU 快速路徑
✅ 驗證 RHS 向量快取機制
✅ 比較優化前後的性能改善
✅ 驗證 largeAdmittance 修復效果
            </div>
        </div>

        <div class="test-section">
            <h3>🔧 庫載入狀態</h3>
            <div id="library-status" class="result info">載入中...</div>
            <button onclick="loadLibrary()" id="load-btn">重新載入庫</button>
        </div>

        <div class="test-section">
            <h3>⚡ 小電路快速路徑測試 (RC Circuit)</h3>
            <div id="small-circuit-result" class="result">等待測試...</div>
            <button onclick="testSmallCircuit()" id="small-test-btn" disabled>測試小電路優化</button>
        </div>

        <div class="test-section">
            <h3>📊 性能對比測試</h3>
            <div class="performance-comparison">
                <div>
                    <h4>🔵 GPU 求解器 (優化後)</h4>
                    <div id="gpu-performance" class="result">等待測試...</div>
                </div>
                <div>
                    <h4>🟢 CPU 求解器 (參考)</h4>
                    <div id="cpu-performance" class="result">等待測試...</div>
                </div>
            </div>
            <button onclick="runPerformanceComparison()" id="perf-test-btn" disabled>運行性能對比</button>
        </div>

        <div class="test-section">
            <h3>🎯 精度驗證</h3>
            <div id="accuracy-result" class="result">等待測試...</div>
            <button onclick="testAccuracy()" id="accuracy-btn" disabled>測試精度</button>
        </div>
    </div>

    <script type="module">
        import { 
            VoltageSource, 
            Resistor, 
            Capacitor, 
            ExplicitStateSolver,
            GPUExplicitStateSolver,
        } from './lib-dist/AkingSPICE.es.js';

        // 全局變量
        window.components = { VoltageSource, Resistor, Capacitor, ExplicitStateSolver, GPUExplicitStateSolver };
        window.testResults = {};

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            if (element.textContent === '等待測試...' || element.textContent === '載入中...') {
                element.textContent = logEntry;
            } else {
                element.textContent += logEntry;
            }
            
            element.className = `result ${type}`;
            console.log(`[${elementId}]`, message);
        }

        window.loadLibrary = function() {
            log('library-status', '🔄 檢查庫載入狀態...');
            
            const requiredComponents = ['VoltageSource', 'Resistor', 'Capacitor', 'ExplicitStateSolver', 'GPUExplicitStateSolver'];
            const missing = requiredComponents.filter(comp => !window.components[comp]);
            
            if (missing.length > 0) {
                log('library-status', `❌ 缺少組件: ${missing.join(', ')}`, 'error');
                return false;
            }
            
            log('library-status', '✅ 所有組件載入成功', 'success');
            
            // 啟用測試按鈕
            document.getElementById('small-test-btn').disabled = false;
            document.getElementById('perf-test-btn').disabled = false;
            document.getElementById('accuracy-btn').disabled = false;
            
            return true;
        };

        window.testSmallCircuit = async function() {
            log('small-circuit-result', '🚀 開始小電路快速路徑測試...');
            
            try {
                const { VoltageSource, Resistor, Capacitor, GPUExplicitStateSolver } = window.components;
                
                // 創建簡單RC電路 (2節點，1狀態變量)
                const components = [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];
                
                log('small-circuit-result', `📋 電路: ${components.length} 個組件 (VoltageSource, Resistor, Capacitor)`);
                
                const solver = new GPUExplicitStateSolver({ debug: true });
                await solver.initialize(components, 1e-6);
                
                log('small-circuit-result', `🔍 電路規模: ${solver.circuitData.nodeCount} 節點, ${solver.circuitData.stateCount} 狀態變量`);
                
                // 檢查是否會使用快速路徑
                const shouldUseFastPath = solver.circuitData.nodeCount <= 3 && solver.circuitData.stateCount <= 2;
                log('small-circuit-result', `🎯 預期使用快速路徑: ${shouldUseFastPath ? '是 ✅' : '否 ❌'}`, shouldUseFastPath ? 'success' : 'warning');
                
                // 測試幾個時間步
                const startTime = performance.now();
                const results = [];
                
                for (let i = 0; i < 10; i++) {
                    const result = await solver.solveTimeStep();
                    results.push(result);
                    
                    if (result.fastPath) {
                        log('small-circuit-result', `⚡ 步驟 ${i+1}: 使用快速路徑! 電容電壓 = ${result.nodeVoltages.n1?.toFixed(6)}V`, 'success');
                    } else {
                        log('small-circuit-result', `🐌 步驟 ${i+1}: 使用GPU路徑 電容電壓 = ${result.nodeVoltages.n1?.toFixed(6)}V`, 'warning');
                    }
                    
                    // 只測試前幾步
                    if (i >= 2) break;
                }
                
                const totalTime = performance.now() - startTime;
                const avgTimePerStep = totalTime / results.length;
                
                log('small-circuit-result', `📊 性能統計:`, 'info');
                log('small-circuit-result', `   總時間: ${totalTime.toFixed(2)}ms`);
                log('small-circuit-result', `   平均每步: ${avgTimePerStep.toFixed(4)}ms`);
                log('small-circuit-result', `   使用快速路徑: ${results.filter(r => r.fastPath).length}/${results.length} 步`);
                
                window.testResults.smallCircuit = {
                    avgTimePerStep,
                    usedFastPath: results.some(r => r.fastPath),
                    results
                };
                
            } catch (error) {
                log('small-circuit-result', `❌ 測試失敗: ${error.message}`, 'error');
                console.error('Small circuit test error:', error);
            }
        };

        window.runPerformanceComparison = async function() {
            log('gpu-performance', '🔄 GPU 求解器測試中...');
            log('cpu-performance', '🔄 CPU 求解器測試中...');
            
            try {
                const { VoltageSource, Resistor, Capacitor, ExplicitStateSolver, GPUExplicitStateSolver } = window.components;
                
                // 創建測試電路
                const createComponents = () => [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];
                
                const testSteps = 50;
                const timeStep = 1e-6;
                
                // GPU 測試
                const gpuStartTime = performance.now();
                const gpuSolver = new GPUExplicitStateSolver({ debug: false });
                await gpuSolver.initialize(createComponents(), timeStep);
                
                let gpuResults = [];
                for (let i = 0; i < testSteps; i++) {
                    const result = await gpuSolver.solveTimeStep();
                    gpuResults.push(result);
                }
                const gpuTime = performance.now() - gpuStartTime;
                
                log('gpu-performance', `✅ GPU 完成 ${testSteps} 步`, 'success');
                log('gpu-performance', `總時間: ${gpuTime.toFixed(2)}ms`);
                log('gpu-performance', `每步平均: ${(gpuTime/testSteps).toFixed(4)}ms`);
                log('gpu-performance', `步/秒: ${(testSteps*1000/gpuTime).toFixed(0)}`);
                log('gpu-performance', `使用快速路徑: ${gpuResults.filter(r => r.fastPath).length}/${gpuResults.length} 步`);
                
                // CPU 測試
                const cpuStartTime = performance.now();
                const cpuSolver = new ExplicitStateSolver({ debug: false });
                await cpuSolver.initialize(createComponents(), timeStep);
                
                let cpuResults = [];
                for (let i = 0; i < testSteps; i++) {
                    const result = await cpuSolver.solveTimeStep();
                    cpuResults.push(result);
                }
                const cpuTime = performance.now() - cpuStartTime;
                
                log('cpu-performance', `✅ CPU 完成 ${testSteps} 步`, 'success');
                log('cpu-performance', `總時間: ${cpuTime.toFixed(2)}ms`);
                log('cpu-performance', `每步平均: ${(cpuTime/testSteps).toFixed(4)}ms`);
                log('cpu-performance', `步/秒: ${(testSteps*1000/cpuTime).toFixed(0)}`);
                
                // 比較結果
                const speedRatio = cpuTime / gpuTime;
                const comparisonResult = speedRatio > 1 ? 
                    `🎉 GPU 快 ${speedRatio.toFixed(1)}x` : 
                    `⚠️ CPU 快 ${(1/speedRatio).toFixed(1)}x`;
                
                log('gpu-performance', `\n📊 相對性能: ${comparisonResult}`, speedRatio > 1 ? 'success' : 'warning');
                log('cpu-performance', `📊 相對性能: ${comparisonResult}`, speedRatio < 1 ? 'success' : 'warning');
                
                window.testResults.performance = { gpuTime, cpuTime, speedRatio, gpuResults, cpuResults };
                
            } catch (error) {
                log('gpu-performance', `❌ 測試失敗: ${error.message}`, 'error');
                log('cpu-performance', `❌ 測試失敗: ${error.message}`, 'error');
            }
        };

        window.testAccuracy = async function() {
            log('accuracy-result', '🔍 開始精度驗證測試...');
            
            try {
                const { VoltageSource, Resistor, Capacitor, ExplicitStateSolver, GPUExplicitStateSolver } = window.components;
                
                const createComponents = () => [
                    new VoltageSource('V1', 'vin', 'gnd', { voltage: 5 }),
                    new Resistor('R1', 'vin', 'n1', 1000),
                    new Capacitor('C1', 'n1', 'gnd', 1e-6, 0)
                ];
                
                // 初始化兩個求解器
                const gpuSolver = new GPUExplicitStateSolver({ debug: false });
                const cpuSolver = new ExplicitStateSolver({ debug: false });
                
                await gpuSolver.initialize(createComponents(), 1e-6);
                await cpuSolver.initialize(createComponents(), 1e-6);
                
                log('accuracy-result', '📋 比較 GPU vs CPU 計算結果...');
                
                const compareResults = [];
                for (let i = 0; i < 5; i++) {
                    const gpuResult = await gpuSolver.solveTimeStep();
                    const cpuResult = await cpuSolver.solveTimeStep();
                    
                    const gpuVoltage = gpuResult.nodeVoltages.n1 || 0;
                    const cpuVoltage = cpuResult.nodeVoltages.n1 || 0;
                    
                    const error = Math.abs(gpuVoltage - cpuVoltage);
                    const relativeError = cpuVoltage !== 0 ? (error / Math.abs(cpuVoltage) * 100) : 0;
                    
                    compareResults.push({ gpu: gpuVoltage, cpu: cpuVoltage, error, relativeError });
                    
                    const status = relativeError < 5 ? '✅' : relativeError < 20 ? '⚠️' : '❌';
                    log('accuracy-result', `步驟 ${i+1}: GPU=${gpuVoltage.toFixed(6)}V, CPU=${cpuVoltage.toFixed(6)}V, 誤差=${relativeError.toFixed(2)}% ${status}`);
                }
                
                const avgError = compareResults.reduce((sum, r) => sum + r.relativeError, 0) / compareResults.length;
                const maxError = Math.max(...compareResults.map(r => r.relativeError));
                
                log('accuracy-result', `\n📊 精度統計:`);
                log('accuracy-result', `平均相對誤差: ${avgError.toFixed(3)}%`);
                log('accuracy-result', `最大相對誤差: ${maxError.toFixed(3)}%`);
                
                const accuracyStatus = avgError < 1 ? 'success' : avgError < 5 ? 'warning' : 'error';
                const accuracyMessage = avgError < 1 ? '🎯 精度優秀' : avgError < 5 ? '⚠️ 精度可接受' : '❌ 精度不足';
                
                log('accuracy-result', `總體評估: ${accuracyMessage}`, accuracyStatus);
                
                window.testResults.accuracy = { avgError, maxError, compareResults };
                
            } catch (error) {
                log('accuracy-result', `❌ 精度測試失敗: ${error.message}`, 'error');
            }
        };

        // 自動載入庫
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadLibrary, 100);
        });
    </script>
</body>
</html>