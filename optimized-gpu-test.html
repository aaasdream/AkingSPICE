<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU æ±‚è§£å™¨å„ªåŒ–æ¸¬è©¦</title>
    <style>
        body {
            font-family: '                      const createComponents = () => [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];     // å‰µå»ºæ¸¬è©¦é›»è·¯
                const createComponents = () => [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-section h3 {
            color: #34495e;
            margin-top: 0;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .performance-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .highlight { background-color: #fff59d !important; }
        .fast-path { background-color: #c8e6c9 !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ GPU æ±‚è§£å™¨å„ªåŒ–é©—è­‰æ¸¬è©¦</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ æ¸¬è©¦è¨ˆåŠƒ</h3>
            <div class="info result">
âœ… é©—è­‰å°é›»è·¯è‡ªå‹•ä½¿ç”¨ CPU å¿«é€Ÿè·¯å¾‘
âœ… é©—è­‰ RHS å‘é‡å¿«å–æ©Ÿåˆ¶
âœ… æ¯”è¼ƒå„ªåŒ–å‰å¾Œçš„æ€§èƒ½æ”¹å–„
âœ… é©—è­‰ largeAdmittance ä¿®å¾©æ•ˆæœ
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ åº«è¼‰å…¥ç‹€æ…‹</h3>
            <div id="library-status" class="result info">è¼‰å…¥ä¸­...</div>
            <button onclick="loadLibrary()" id="load-btn">é‡æ–°è¼‰å…¥åº«</button>
        </div>

        <div class="test-section">
            <h3>âš¡ å°é›»è·¯å¿«é€Ÿè·¯å¾‘æ¸¬è©¦ (RC Circuit)</h3>
            <div id="small-circuit-result" class="result">ç­‰å¾…æ¸¬è©¦...</div>
            <button onclick="testSmallCircuit()" id="small-test-btn" disabled>æ¸¬è©¦å°é›»è·¯å„ªåŒ–</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æ€§èƒ½å°æ¯”æ¸¬è©¦</h3>
            <div class="performance-comparison">
                <div>
                    <h4>ğŸ”µ GPU æ±‚è§£å™¨ (å„ªåŒ–å¾Œ)</h4>
                    <div id="gpu-performance" class="result">ç­‰å¾…æ¸¬è©¦...</div>
                </div>
                <div>
                    <h4>ğŸŸ¢ CPU æ±‚è§£å™¨ (åƒè€ƒ)</h4>
                    <div id="cpu-performance" class="result">ç­‰å¾…æ¸¬è©¦...</div>
                </div>
            </div>
            <button onclick="runPerformanceComparison()" id="perf-test-btn" disabled>é‹è¡Œæ€§èƒ½å°æ¯”</button>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ ç²¾åº¦é©—è­‰</h3>
            <div id="accuracy-result" class="result">ç­‰å¾…æ¸¬è©¦...</div>
            <button onclick="testAccuracy()" id="accuracy-btn" disabled>æ¸¬è©¦ç²¾åº¦</button>
        </div>
    </div>

    <script type="module">
        import { 
            VoltageSource, 
            Resistor, 
            Capacitor, 
            ExplicitStateSolver,
            GPUExplicitStateSolver,
        } from './lib-dist/AkingSPICE.es.js';

        // å…¨å±€è®Šé‡
        window.components = { VoltageSource, Resistor, Capacitor, ExplicitStateSolver, GPUExplicitStateSolver };
        window.testResults = {};

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            if (element.textContent === 'ç­‰å¾…æ¸¬è©¦...' || element.textContent === 'è¼‰å…¥ä¸­...') {
                element.textContent = logEntry;
            } else {
                element.textContent += logEntry;
            }
            
            element.className = `result ${type}`;
            console.log(`[${elementId}]`, message);
        }

        window.loadLibrary = function() {
            log('library-status', 'ğŸ”„ æª¢æŸ¥åº«è¼‰å…¥ç‹€æ…‹...');
            
            const requiredComponents = ['VoltageSource', 'Resistor', 'Capacitor', 'ExplicitStateSolver', 'GPUExplicitStateSolver'];
            const missing = requiredComponents.filter(comp => !window.components[comp]);
            
            if (missing.length > 0) {
                log('library-status', `âŒ ç¼ºå°‘çµ„ä»¶: ${missing.join(', ')}`, 'error');
                return false;
            }
            
            log('library-status', 'âœ… æ‰€æœ‰çµ„ä»¶è¼‰å…¥æˆåŠŸ', 'success');
            
            // å•Ÿç”¨æ¸¬è©¦æŒ‰éˆ•
            document.getElementById('small-test-btn').disabled = false;
            document.getElementById('perf-test-btn').disabled = false;
            document.getElementById('accuracy-btn').disabled = false;
            
            return true;
        };

        window.testSmallCircuit = async function() {
            log('small-circuit-result', 'ğŸš€ é–‹å§‹å°é›»è·¯å¿«é€Ÿè·¯å¾‘æ¸¬è©¦...');
            
            try {
                const { VoltageSource, Resistor, Capacitor, GPUExplicitStateSolver } = window.components;
                
                // å‰µå»ºç°¡å–®RCé›»è·¯ (2ç¯€é»ï¼Œ1ç‹€æ…‹è®Šé‡)
                const components = [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];
                
                log('small-circuit-result', `ğŸ“‹ é›»è·¯: ${components.length} å€‹çµ„ä»¶ (VoltageSource, Resistor, Capacitor)`);
                
                const solver = new GPUExplicitStateSolver({ debug: true });
                await solver.initialize(components, 1e-6);
                
                log('small-circuit-result', `ğŸ” é›»è·¯è¦æ¨¡: ${solver.circuitData.nodeCount} ç¯€é», ${solver.circuitData.stateCount} ç‹€æ…‹è®Šé‡`);
                
                // æª¢æŸ¥æ˜¯å¦æœƒä½¿ç”¨å¿«é€Ÿè·¯å¾‘
                const shouldUseFastPath = solver.circuitData.nodeCount <= 3 && solver.circuitData.stateCount <= 2;
                log('small-circuit-result', `ğŸ¯ é æœŸä½¿ç”¨å¿«é€Ÿè·¯å¾‘: ${shouldUseFastPath ? 'æ˜¯ âœ…' : 'å¦ âŒ'}`, shouldUseFastPath ? 'success' : 'warning');
                
                // æ¸¬è©¦å¹¾å€‹æ™‚é–“æ­¥
                const startTime = performance.now();
                const results = [];
                
                for (let i = 0; i < 10; i++) {
                    const result = await solver.solveTimeStep();
                    results.push(result);
                    
                    if (result.fastPath) {
                        log('small-circuit-result', `âš¡ æ­¥é©Ÿ ${i+1}: ä½¿ç”¨å¿«é€Ÿè·¯å¾‘! é›»å®¹é›»å£“ = ${result.nodeVoltages.n1?.toFixed(6)}V`, 'success');
                    } else {
                        log('small-circuit-result', `ğŸŒ æ­¥é©Ÿ ${i+1}: ä½¿ç”¨GPUè·¯å¾‘ é›»å®¹é›»å£“ = ${result.nodeVoltages.n1?.toFixed(6)}V`, 'warning');
                    }
                    
                    // åªæ¸¬è©¦å‰å¹¾æ­¥
                    if (i >= 2) break;
                }
                
                const totalTime = performance.now() - startTime;
                const avgTimePerStep = totalTime / results.length;
                
                log('small-circuit-result', `ğŸ“Š æ€§èƒ½çµ±è¨ˆ:`, 'info');
                log('small-circuit-result', `   ç¸½æ™‚é–“: ${totalTime.toFixed(2)}ms`);
                log('small-circuit-result', `   å¹³å‡æ¯æ­¥: ${avgTimePerStep.toFixed(4)}ms`);
                log('small-circuit-result', `   ä½¿ç”¨å¿«é€Ÿè·¯å¾‘: ${results.filter(r => r.fastPath).length}/${results.length} æ­¥`);
                
                window.testResults.smallCircuit = {
                    avgTimePerStep,
                    usedFastPath: results.some(r => r.fastPath),
                    results
                };
                
            } catch (error) {
                log('small-circuit-result', `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                console.error('Small circuit test error:', error);
            }
        };

        window.runPerformanceComparison = async function() {
            log('gpu-performance', 'ğŸ”„ GPU æ±‚è§£å™¨æ¸¬è©¦ä¸­...');
            log('cpu-performance', 'ğŸ”„ CPU æ±‚è§£å™¨æ¸¬è©¦ä¸­...');
            
            try {
                const { VoltageSource, Resistor, Capacitor, ExplicitStateSolver, GPUExplicitStateSolver } = window.components;
                
                // å‰µå»ºæ¸¬è©¦é›»è·¯
                const createComponents = () => [
                    new VoltageSource('V1', ['vin', 'gnd'], 5),
                    new Resistor('R1', ['vin', 'n1'], 1000),
                    new Capacitor('C1', ['n1', 'gnd'], 1e-6, { ic: 0 })
                ];
                
                const testSteps = 50;
                const timeStep = 1e-6;
                
                // GPU æ¸¬è©¦
                const gpuStartTime = performance.now();
                const gpuSolver = new GPUExplicitStateSolver({ debug: false });
                await gpuSolver.initialize(createComponents(), timeStep);
                
                let gpuResults = [];
                for (let i = 0; i < testSteps; i++) {
                    const result = await gpuSolver.solveTimeStep();
                    gpuResults.push(result);
                }
                const gpuTime = performance.now() - gpuStartTime;
                
                log('gpu-performance', `âœ… GPU å®Œæˆ ${testSteps} æ­¥`, 'success');
                log('gpu-performance', `ç¸½æ™‚é–“: ${gpuTime.toFixed(2)}ms`);
                log('gpu-performance', `æ¯æ­¥å¹³å‡: ${(gpuTime/testSteps).toFixed(4)}ms`);
                log('gpu-performance', `æ­¥/ç§’: ${(testSteps*1000/gpuTime).toFixed(0)}`);
                log('gpu-performance', `ä½¿ç”¨å¿«é€Ÿè·¯å¾‘: ${gpuResults.filter(r => r.fastPath).length}/${gpuResults.length} æ­¥`);
                
                // CPU æ¸¬è©¦
                const cpuStartTime = performance.now();
                const cpuSolver = new ExplicitStateSolver({ debug: false });
                await cpuSolver.initialize(createComponents(), timeStep);
                
                let cpuResults = [];
                for (let i = 0; i < testSteps; i++) {
                    const result = await cpuSolver.solveTimeStep();
                    cpuResults.push(result);
                }
                const cpuTime = performance.now() - cpuStartTime;
                
                log('cpu-performance', `âœ… CPU å®Œæˆ ${testSteps} æ­¥`, 'success');
                log('cpu-performance', `ç¸½æ™‚é–“: ${cpuTime.toFixed(2)}ms`);
                log('cpu-performance', `æ¯æ­¥å¹³å‡: ${(cpuTime/testSteps).toFixed(4)}ms`);
                log('cpu-performance', `æ­¥/ç§’: ${(testSteps*1000/cpuTime).toFixed(0)}`);
                
                // æ¯”è¼ƒçµæœ
                const speedRatio = cpuTime / gpuTime;
                const comparisonResult = speedRatio > 1 ? 
                    `ğŸ‰ GPU å¿« ${speedRatio.toFixed(1)}x` : 
                    `âš ï¸ CPU å¿« ${(1/speedRatio).toFixed(1)}x`;
                
                log('gpu-performance', `\nğŸ“Š ç›¸å°æ€§èƒ½: ${comparisonResult}`, speedRatio > 1 ? 'success' : 'warning');
                log('cpu-performance', `ğŸ“Š ç›¸å°æ€§èƒ½: ${comparisonResult}`, speedRatio < 1 ? 'success' : 'warning');
                
                window.testResults.performance = { gpuTime, cpuTime, speedRatio, gpuResults, cpuResults };
                
            } catch (error) {
                log('gpu-performance', `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                log('cpu-performance', `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        };

        window.testAccuracy = async function() {
            log('accuracy-result', 'ğŸ” é–‹å§‹ç²¾åº¦é©—è­‰æ¸¬è©¦...');
            
            try {
                const { VoltageSource, Resistor, Capacitor, ExplicitStateSolver, GPUExplicitStateSolver } = window.components;
                
                const createComponents = () => [
                    new VoltageSource('V1', 'vin', 'gnd', { voltage: 5 }),
                    new Resistor('R1', 'vin', 'n1', 1000),
                    new Capacitor('C1', 'n1', 'gnd', 1e-6, 0)
                ];
                
                // åˆå§‹åŒ–å…©å€‹æ±‚è§£å™¨
                const gpuSolver = new GPUExplicitStateSolver({ debug: false });
                const cpuSolver = new ExplicitStateSolver({ debug: false });
                
                await gpuSolver.initialize(createComponents(), 1e-6);
                await cpuSolver.initialize(createComponents(), 1e-6);
                
                log('accuracy-result', 'ğŸ“‹ æ¯”è¼ƒ GPU vs CPU è¨ˆç®—çµæœ...');
                
                const compareResults = [];
                for (let i = 0; i < 5; i++) {
                    const gpuResult = await gpuSolver.solveTimeStep();
                    const cpuResult = await cpuSolver.solveTimeStep();
                    
                    const gpuVoltage = gpuResult.nodeVoltages.n1 || 0;
                    const cpuVoltage = cpuResult.nodeVoltages.n1 || 0;
                    
                    const error = Math.abs(gpuVoltage - cpuVoltage);
                    const relativeError = cpuVoltage !== 0 ? (error / Math.abs(cpuVoltage) * 100) : 0;
                    
                    compareResults.push({ gpu: gpuVoltage, cpu: cpuVoltage, error, relativeError });
                    
                    const status = relativeError < 5 ? 'âœ…' : relativeError < 20 ? 'âš ï¸' : 'âŒ';
                    log('accuracy-result', `æ­¥é©Ÿ ${i+1}: GPU=${gpuVoltage.toFixed(6)}V, CPU=${cpuVoltage.toFixed(6)}V, èª¤å·®=${relativeError.toFixed(2)}% ${status}`);
                }
                
                const avgError = compareResults.reduce((sum, r) => sum + r.relativeError, 0) / compareResults.length;
                const maxError = Math.max(...compareResults.map(r => r.relativeError));
                
                log('accuracy-result', `\nğŸ“Š ç²¾åº¦çµ±è¨ˆ:`);
                log('accuracy-result', `å¹³å‡ç›¸å°èª¤å·®: ${avgError.toFixed(3)}%`);
                log('accuracy-result', `æœ€å¤§ç›¸å°èª¤å·®: ${maxError.toFixed(3)}%`);
                
                const accuracyStatus = avgError < 1 ? 'success' : avgError < 5 ? 'warning' : 'error';
                const accuracyMessage = avgError < 1 ? 'ğŸ¯ ç²¾åº¦å„ªç§€' : avgError < 5 ? 'âš ï¸ ç²¾åº¦å¯æ¥å—' : 'âŒ ç²¾åº¦ä¸è¶³';
                
                log('accuracy-result', `ç¸½é«”è©•ä¼°: ${accuracyMessage}`, accuracyStatus);
                
                window.testResults.accuracy = { avgError, maxError, compareResults };
                
            } catch (error) {
                log('accuracy-result', `âŒ ç²¾åº¦æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        };

        // è‡ªå‹•è¼‰å…¥åº«
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadLibrary, 100);
        });
    </script>
</body>
</html>