<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç°¡åŒ–LLC - AkingSPICEç©©å®šç‰ˆ</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #2d3436 0%, #636e72 50%, #74b9ff 100%);
      color: white;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 25px;
      backdrop-filter: blur(10px);
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 5px;
      background: linear-gradient(45deg, #00b894, #00cec9);
      color: white;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #00cec9;
    }

    .waveform-canvas {
      width: 100%;
      height: 300px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }

    .log-area {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      font-family: 'Consolas', monospace;
      font-size: 12px;
      height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .status-ok {
      color: #00b894;
    }

    .status-error {
      color: #d63031;
    }

    .status-warning {
      color: #fdcb6e;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 0.7;
      }

      50% {
        opacity: 1;
      }
    }

    .running {
      animation: pulse 2s infinite;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <h1>ğŸ”‹ ç°¡åŒ–LLC - AkingSPICEç©©å®šç‰ˆ</h1>
      <p>âš¡ æœ€ç°¡é›»è·¯: Vin â†’ L â†’ C â†’ R è«§æŒ¯é›»è·¯</p>
      <button class="btn" onclick="startSimpleLLC()">ğŸš€ å•Ÿå‹•ç©©å®šç‰ˆLLC</button>
      <button class="btn" onclick="stopSim()" style="background: #d63031;">â¹ï¸ åœæ­¢</button>
    </div>

    <!-- ç‹€æ…‹é¡¯ç¤º -->
    <div class="card">
      <h3>ğŸ“Š AkingSPICEæ±‚è§£å™¨ç‹€æ…‹</h3>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-value" id="solverStatus">æœªå•Ÿå‹•</div>
          <div style="font-size: 12px;">æ±‚è§£å™¨ç‹€æ…‹</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="stepCount">0</div>
          <div style="font-size: 12px;">æ™‚é–“æ­¥æ•¸</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="simTime">0.0</div>
          <div style="font-size: 12px;">æ¨¡æ“¬æ™‚é–“ (Î¼s)</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="performance">0</div>
          <div style="font-size: 12px;">æ±‚è§£é€Ÿåº¦ (æ­¥/ç§’)</div>
        </div>
      </div>
    </div>

    <!-- æ³¢å½¢é¡¯ç¤º -->
    <div class="card">
      <h3>ğŸ“ˆ AkingSPICEæ³¢å½¢</h3>
      <canvas id="waveformCanvas" class="waveform-canvas"></canvas>
    </div>

    <!-- ç³»çµ±æ—¥èªŒ -->
    <div class="card">
      <h3>ğŸ“‹ ç³»çµ±æ—¥èªŒ</h3>
      <div id="systemLog" class="log-area"></div>
    </div>
  </div>

  <script type="module">
    let AkingSPICE = null;
    let solver = null;
    let components = [];
    let isRunning = false;
    let animationId = null;
    let canvas, ctx;
    let startTime = 0;
    let steps = 0;
    let waveformData = {
      time: [],
      vC: [],
      iL: [],
      vOut: []
    };

    function log(msg, type = 'info') {
      const logEl = document.getElementById('systemLog');
      const time = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'status-error' :
        type === 'warning' ? 'status-warning' : 'status-ok';
      logEl.innerHTML += `<div class="${className}">[${time}] ${msg}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(`[LLC] ${msg}`);
    }

    async function loadAkingSPICE() {
      try {
        AkingSPICE = await import('./lib-dist/AkingSPICE.es.js');
        log('âœ… AkingSPICEæ¨¡çµ„è¼‰å…¥æˆåŠŸ');
        return true;
      } catch (error) {
        log(`âŒ è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
        return false;
      }
    }

    async function createSimpleCircuit() {
      log('ğŸ”§ å‰µå»ºç°¡åŒ–LLCé›»è·¯...');

      const { VoltageSource, Inductor, Capacitor, Resistor } = AkingSPICE;

      components = [];

      try {
        // ç°¡å–®çš„è«§æŒ¯é›»è·¯: Vin -> L -> C -> R
        // ç¯€é»: 0=GND, 1=Vin+, 2=Lå¾Œ, 3=Cå¾Œ

        // é›»å£“æº 400V (ç¯€é» 0 åˆ° 1)
        const vin = new VoltageSource('Vin', [0, 1], 400);
        components.push(vin);

        // è«§æŒ¯é›»æ„Ÿ 50Î¼H (ç¯€é» 1 åˆ° 2) 
        const L = new Inductor('L', [1, 2], 50e-6);
        components.push(L);

        // è«§æŒ¯é›»å®¹ 100nF (ç¯€é» 2 åˆ° 3)
        const C = new Capacitor('C', [2, 3], 100e-9);
        components.push(C);

        // è² è¼‰é›»é˜» 4.8Î© (ç¯€é» 3 åˆ° 0)
        const R = new Resistor('R', [3, 0], 4.8);
        components.push(R);

        log(`âœ“ é›»å£“æº: 400V`);
        log(`âœ“ é›»æ„Ÿ: 50Î¼H`);
        log(`âœ“ é›»å®¹: 100nF`);
        log(`âœ“ è² è¼‰: 4.8Î©`);
        log(`âœ“ çµ„ä»¶ç¸½æ•¸: ${components.length}`);

        return true;
      } catch (error) {
        log(`âŒ é›»è·¯å‰µå»ºå¤±æ•—: ${error.message}`, 'error');
        return false;
      }
    }

    async function initializeSolver() {
      log('ğŸ”¬ åˆå§‹åŒ–ExplicitStateSolver...');

      const { ExplicitStateSolver } = AkingSPICE;

      try {
        solver = new ExplicitStateSolver();

        // ä½¿ç”¨æ›´ä¿å®ˆçš„è¨­å®š
        await solver.initialize(components, 1e-6, { // 1Î¼sæ™‚é–“æ­¥é•·
          debug: false,
          maxIterations: 10000, // å¤§å¹…å¢åŠ è¿­ä»£æ¬¡æ•¸
          tolerance: 1e-5 // æ”¾å¯¬å®¹å·®
        });

        document.getElementById('solverStatus').textContent = 'é‹è¡Œä¸­';
        document.getElementById('solverStatus').className = 'metric-value status-ok running';

        log('âœ… æ±‚è§£å™¨åˆå§‹åŒ–æˆåŠŸ');
        return true;
      } catch (error) {
        document.getElementById('solverStatus').textContent = 'å¤±æ•—';
        document.getElementById('solverStatus').className = 'metric-value status-error';
        log(`âŒ æ±‚è§£å™¨åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
        return false;
      }
    }

    async function simulationStep() {
      if (!solver || !isRunning) return;

      try {
        // åŸ·è¡Œä¸€æ­¥æ±‚è§£
        const result = await solver.step();

        steps++;
        const currentTime = steps * 1.0; // Î¼s

        // æ›´æ–°é¡¯ç¤º
        document.getElementById('stepCount').textContent = steps.toLocaleString();
        document.getElementById('simTime').textContent = currentTime.toFixed(1);

        const elapsed = (performance.now() - startTime) / 1000;
        const perf = Math.round(steps / elapsed);
        document.getElementById('performance').textContent = perf.toLocaleString();

        // æå–æ•¸æ“š
        if (result && result.nodeVoltages && result.stateVector) {
          const vOut = result.nodeVoltages[3] || 0; // è¼¸å‡ºç¯€é»é›»å£“
          const iL = result.stateVector[0] || 0;    // é›»æ„Ÿé›»æµ
          const vC = result.stateVector[1] || 0;    // é›»å®¹é›»å£“

          // å­˜å„²æ³¢å½¢æ•¸æ“š
          waveformData.time.push(currentTime);
          waveformData.vOut.push(vOut);
          waveformData.iL.push(iL);
          waveformData.vC.push(vC);

          // é™åˆ¶æ•¸æ“šé•·åº¦
          if (waveformData.time.length > 800) {
            Object.keys(waveformData).forEach(key => {
              waveformData[key] = waveformData[key].slice(-600);
            });
          }
        }

        // ç¹ªè£½æ³¢å½¢
        drawWaveforms();

        // å®šæœŸè¨˜éŒ„
        if (steps % 1000 === 0) {
          log(`æ¨¡æ“¬ä¸­: ${steps}æ­¥, ${currentTime.toFixed(1)}Î¼s, ${perf}æ­¥/ç§’`);
        }

      } catch (error) {
        log(`âŒ æ¨¡æ“¬éŒ¯èª¤: ${error.message}`, 'error');
        stopSim();
        return;
      }

      // ç¹¼çºŒä¸‹ä¸€æ­¥
      if (isRunning) {
        animationId = requestAnimationFrame(simulationStep);
      }
    }

    function drawWaveforms() {
      if (!canvas || !ctx || waveformData.time.length < 2) return;

      const width = canvas.width / window.devicePixelRatio;
      const height = canvas.height / window.devicePixelRatio;

      // æ¸…ç©º
      ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
      ctx.fillRect(0, 0, width, height);

      // ç¶²æ ¼
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 10; i++) {
        const x = (i / 10) * width;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }

      // ç¹ªè£½æ³¢å½¢
      const colors = ['#e74c3c', '#2ecc71', '#3498db'];
      const signals = ['vOut', 'iL', 'vC'];
      const labels = ['Vout', 'IL', 'VC'];

      signals.forEach((signal, index) => {
        const data = waveformData[signal];
        if (data.length < 2) return;

        ctx.strokeStyle = colors[index];
        ctx.lineWidth = 2;
        ctx.beginPath();

        const startIdx = Math.max(0, data.length - 200);
        const values = data.slice(startIdx);
        const timeValues = waveformData.time.slice(startIdx);

        if (timeValues.length === 0) return;

        const minVal = Math.min(...values);
        const maxVal = Math.max(...values);
        const range = Math.max(maxVal - minVal, 0.1);
        const timeRange = Math.max(timeValues[timeValues.length - 1] - timeValues[0], 1);

        for (let i = 0; i < values.length; i++) {
          const x = timeRange > 0 ? (timeValues[i] - timeValues[0]) / timeRange * width : 0;
          const normalizedY = range > 0 ? (values[i] - minVal) / range : 0.5;
          const y = height - (normalizedY * height / 3 + (index * height / 3));

          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.stroke();

        // æ¨™ç±¤
        ctx.fillStyle = colors[index];
        ctx.font = '14px Arial';
        ctx.fillText(labels[index], 10, 20 + index * 25);
      });
    }

    // å…¨å±€å‡½æ•¸
    window.startSimpleLLC = async function () {
      if (isRunning) {
        log('âš ï¸ å·²åœ¨é‹è¡Œä¸­', 'warning');
        return;
      }

      log('ğŸš€ å•Ÿå‹•ç°¡åŒ–LLCæ¨¡æ“¬...');

      // è¼‰å…¥æ¨¡çµ„
      const loaded = await loadAkingSPICE();
      if (!loaded) return;

      // å‰µå»ºé›»è·¯
      const circuitOk = await createSimpleCircuit();
      if (!circuitOk) return;

      // åˆå§‹åŒ–æ±‚è§£å™¨
      const solverOk = await initializeSolver();
      if (!solverOk) return;

      // é–‹å§‹æ¨¡æ“¬
      isRunning = true;
      startTime = performance.now();
      steps = 0;
      waveformData = { time: [], vOut: [], iL: [], vC: [] };

      log('âœ… æ¨¡æ“¬å·²å•Ÿå‹•ï¼');
      simulationStep();
    };

    window.stopSim = function () {
      if (!isRunning) return;

      isRunning = false;
      if (animationId) {
        cancelAnimationFrame(animationId);
      }

      document.getElementById('solverStatus').textContent = 'å·²åœæ­¢';
      document.getElementById('solverStatus').className = 'metric-value status-warning';

      log('â¹ï¸ æ¨¡æ“¬å·²åœæ­¢', 'warning');
    };

    // åˆå§‹åŒ–ç•«å¸ƒ - æ·»åŠ éŒ¯èª¤è™•ç†
    document.addEventListener('DOMContentLoaded', () => {
      try {
        console.log('ğŸ”§ é–‹å§‹DOMåˆå§‹åŒ–');
        log('ğŸ”§ é–‹å§‹ç³»çµ±åˆå§‹åŒ–...');

        canvas = document.getElementById('waveformCanvas');
        if (!canvas) {
          throw new Error('æ‰¾ä¸åˆ°ç•«å¸ƒå…ƒç´ ');
        }

        ctx = canvas.getContext('2d');
        if (!ctx) {
          throw new Error('ç„¡æ³•ç²å–2Dç•«å¸ƒä¸Šä¸‹æ–‡');
        }

        console.log('âœ… ç•«å¸ƒç²å–æˆåŠŸ');

        // å®‰å…¨çš„ç•«å¸ƒå°ºå¯¸è¨­ç½®
        try {
          const rect = canvas.getBoundingClientRect();
          const ratio = window.devicePixelRatio || 1;

          canvas.width = (rect.width || 400) * ratio;
          canvas.height = (rect.height || 300) * ratio;
          ctx.scale(ratio, ratio);
          canvas.style.width = (rect.width || 400) + 'px';
          canvas.style.height = (rect.height || 300) + 'px';

          console.log('âœ… ç•«å¸ƒå°ºå¯¸è¨­ç½®æˆåŠŸ');
        } catch (canvasError) {
          console.warn('ç•«å¸ƒå°ºå¯¸è¨­ç½®å¤±æ•—:', canvasError);
          // ä½¿ç”¨é»˜èªå°ºå¯¸
          canvas.width = 800;
          canvas.height = 400;
        }

        log('ğŸ”§ ç°¡åŒ–LLCç³»çµ±è¼‰å…¥å®Œæˆ');
        console.log('ğŸ”§ ç³»çµ±è¼‰å…¥å®Œæˆ');

        // å…¨å±€ç‹€æ…‹æ¨™è¨˜
        window.systemLoaded = true;

        // æª¢æŸ¥å‡½æ•¸å¯ç”¨æ€§
        console.log('ğŸ“‹ æª¢æŸ¥startSimpleLLCå‡½æ•¸:', typeof window.startSimpleLLC);
        log('ğŸ“‹ ç³»çµ±æº–å‚™å°±ç·’ï¼Œå¯ä»¥æ‰‹å‹•å•Ÿå‹•');
        log('ğŸ’¡ è«‹é»æ“Šä¸Šæ–¹"ğŸš€ å•Ÿå‹•ç©©å®šç‰ˆLLC"æŒ‰éˆ•é–‹å§‹æ¨¡æ“¬', 'info');

      } catch (error) {
        console.error('DOMåˆå§‹åŒ–éŒ¯èª¤:', error);
        log(`âŒ ç³»çµ±åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
        log('ğŸ’¡ è«‹å˜—è©¦åˆ·æ–°é é¢', 'warning');
      }
    });
  </script>
</body>

</html>