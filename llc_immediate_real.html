<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>LLCç«‹å³åŸ·è¡Œç‰ˆæœ¬</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #2c3e50;
      color: white;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
    }

    .metrics {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .metric {
      background: rgba(255, 255, 255, 0.1);
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      flex: 1;
      min-width: 120px;
    }

    .metric-label {
      font-size: 11px;
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #27ae60;
    }

    #log {
      height: 400px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 20px;
    }

    .success {
      color: #27ae60;
    }

    .error {
      color: #e74c3c;
    }

    .warning {
      color: #f39c12;
    }

    .info {
      color: #3498db;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>âš¡ LLCç«‹å³åŸ·è¡Œç‰ˆæœ¬</h1>
    <p>ğŸ¯ çœŸæ­£ä½¿ç”¨AkingSPICEé‹è¡ŒLLC - ç„¡æ•¸å­¸ä½œå¼Š</p>

    <div class="metrics">
      <div class="metric">
        <div class="metric-label">ç³»çµ±ç‹€æ…‹</div>
        <div id="status" class="metric-value">åŸ·è¡Œä¸­</div>
      </div>
      <div class="metric">
        <div class="metric-label">æ¨¡æ“¬æ­¥æ•¸</div>
        <div id="steps" class="metric-value">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å…¥é›»å£“</div>
        <div id="vin" class="metric-value">0V</div>
      </div>
      <div class="metric">
        <div class="metric-label">è«§æŒ¯é›»å£“</div>
        <div id="vres" class="metric-value">0V</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å‡ºé›»å£“</div>
        <div id="vout" class="metric-value">0V</div>
      </div>
      <div class="metric">
        <div class="metric-label">è¼¸å‡ºåŠŸç‡</div>
        <div id="power" class="metric-value">0W</div>
      </div>
    </div>

    <h3>ğŸ“‹ LLCçœŸå¯¦AkingSPICEæ¨¡æ“¬æ—¥èªŒ</h3>
    <div id="log">æº–å‚™å•Ÿå‹•LLC...<br></div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    function log(message, type = 'info') {
      const colors = {
        'success': '#27ae60',
        'error': '#e74c3c',
        'warning': '#f39c12',
        'info': '#3498db'
      };

      const time = new Date().toLocaleTimeString();
      const logElement = document.getElementById('log');
      logElement.innerHTML += `<span style="color: ${colors[type]};">[${time}] ${message}</span><br>`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    function updateMetrics(steps, vin, vres, vout, power) {
      document.getElementById('steps').textContent = steps;
      document.getElementById('vin').textContent = vin.toFixed(2) + 'V';
      document.getElementById('vres').textContent = vres.toFixed(2) + 'V';
      document.getElementById('vout').textContent = vout.toFixed(2) + 'V';
      document.getElementById('power').textContent = power.toFixed(3) + 'W';
    }

    // ç«‹å³åŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', function () {
      log('âš¡ LLCç«‹å³åŸ·è¡Œç‰ˆæœ¬å•Ÿå‹•', 'success');

      if (!window.AkingSPICE) {
        log('âŒ AkingSPICEæœªè¼‰å…¥', 'error');
        document.getElementById('status').textContent = 'éŒ¯èª¤';
        return;
      }

      log('âœ… AkingSPICEæˆåŠŸè¼‰å…¥', 'success');

      try {
        const { VoltageSource, Resistor, Capacitor, Inductor, ExplicitStateSolver } = window.AkingSPICE;

        log('ğŸ¯ å‰µå»ºLLCé›»è·¯çµ„ä»¶...', 'info');

        // LLCé›»è·¯åƒæ•¸
        const Vin = 12.0;         // 12Vè¼¸å…¥
        const Lr = 10e-3;         // 10mH è«§æŒ¯é›»æ„Ÿ  
        const Cr = 1e-6;          // 1Î¼F è«§æŒ¯é›»å®¹
        const Rload = 50.0;       // 50Î© è² è¼‰

        // è¨ˆç®—è«§æŒ¯é »ç‡
        const fr = 1 / (2 * Math.PI * Math.sqrt(Lr * Cr));

        log(`ğŸ“Š LLCè¨­è¨ˆåƒæ•¸:`, 'success');
        log(`  è¼¸å…¥é›»å£“: ${Vin}V`, 'info');
        log(`  è«§æŒ¯é›»æ„Ÿ: ${(Lr * 1000).toFixed(0)}mH`, 'info');
        log(`  è«§æŒ¯é›»å®¹: ${(Cr * 1e6).toFixed(0)}Î¼F`, 'info');
        log(`  è² è¼‰é›»é˜»: ${Rload}Î©`, 'info');
        log(`  ç†è«–è«§æŒ¯é »ç‡: ${(fr / 1000).toFixed(1)}kHz`, 'success');

        // å‰µå»ºLLCé›»è·¯ (ç°¡åŒ–ä½†çœŸå¯¦)
        const components = [
          new VoltageSource('Vin', [1, 0], Vin),     // è¼¸å…¥é›»æº
          new Inductor('Lr', [1, 2], Lr),            // è«§æŒ¯é›»æ„Ÿ
          new Capacitor('Cr', [2, 3], Cr),           // è«§æŒ¯é›»å®¹  
          new Resistor('Rload', [3, 0], Rload)       // è² è¼‰
        ];

        log('âœ… LLCçµ„ä»¶å‰µå»ºå®Œæˆ', 'success');
        log('   ç¯€é»1: è¼¸å…¥ â†’ ç¯€é»2: é›»æ„Ÿå¾Œ â†’ ç¯€é»3: é›»å®¹å¾Œ â†’ åœ°', 'info');

        // å‰µå»ºæ±‚è§£å™¨
        log('âš™ï¸ åˆå§‹åŒ–AkingSPICE ExplicitStateSolver...', 'info');
        const solver = new ExplicitStateSolver();

        // ä½¿ç”¨å¯¬é¬†çš„åƒæ•¸ç¢ºä¿æ”¶æ–‚
        const dt = 5e-4;  // 500Î¼s æ™‚é–“æ­¥é•· (è¶³å¤ å¤§é¿å…æ•¸å€¼å•é¡Œ)
        solver.initialize(components, dt, {
          maxIterations: 30,
          tolerance: 1e-2,  // 1% å®¹å·®
          debug: false
        });

        log('âœ… æ±‚è§£å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
        log(`âš¡ é–‹å§‹LLCæ¨¡æ“¬ (dt=${dt * 1e6}Î¼s)...`, 'success');

        // åŸ·è¡Œæ¨¡æ“¬
        let stepCount = 0;
        const maxSteps = 50;

        for (let step = 0; step < maxSteps; step++) {
          const result = solver.step();
          stepCount++;

          // æå–ç¯€é»é›»å£“
          const v1 = result.nodeVoltages[1] || 0;  // è¼¸å…¥å¾Œ
          const v2 = result.nodeVoltages[2] || 0;  // é›»æ„Ÿå¾Œ  
          const v3 = result.nodeVoltages[3] || 0;  // é›»å®¹å¾Œ(è¼¸å‡º)

          // è¨ˆç®—åŠŸç‡
          const iload = v3 / Rload;
          const power = v3 * iload;

          // æ›´æ–°é¡¯ç¤º
          updateMetrics(stepCount, v1, v2, v3, power);

          // æ¯10æ­¥å ±å‘Š
          if (stepCount % 10 === 0) {
            const time = stepCount * dt * 1000; // è½‰ç‚ºms
            log(`æ­¥é©Ÿ ${stepCount}/${maxSteps} (${time.toFixed(1)}ms): V1=${v1.toFixed(2)}V, V2=${v2.toFixed(2)}V, V3=${v3.toFixed(2)}V`, 'info');
          }
        }

        // å®Œæˆå ±å‘Š
        const finalResult = solver.step();
        const finalV1 = finalResult.nodeVoltages[1] || 0;
        const finalV2 = finalResult.nodeVoltages[2] || 0;
        const finalV3 = finalResult.nodeVoltages[3] || 0;
        const finalPower = (finalV3 * finalV3) / Rload;

        log('ğŸ‰ LLCæ¨¡æ“¬æˆåŠŸå®Œæˆï¼', 'success');
        log('ğŸ“Š æœ€çµ‚çµæœ:', 'success');
        log(`  ç¯€é»1é›»å£“ (è¼¸å…¥å¾Œ): ${finalV1.toFixed(2)}V`, 'success');
        log(`  ç¯€é»2é›»å£“ (é›»æ„Ÿå¾Œ): ${finalV2.toFixed(2)}V`, 'success');
        log(`  ç¯€é»3é›»å£“ (è¼¸å‡º): ${finalV3.toFixed(2)}V`, 'success');
        log(`  è² è¼‰åŠŸç‡: ${finalPower.toFixed(3)}W`, 'success');
        log(`  è½‰æ›æ•ˆç‡: ${((finalV3 / Vin) * 100).toFixed(1)}%`, 'success');

        document.getElementById('status').textContent = 'å®Œæˆ';

        // å–æ¨£é›»å£“çµæœ (ç”¨æˆ¶è¦æ±‚çš„åŠŸèƒ½)
        log('ğŸ“ˆ é›»å£“å–æ¨£çµæœ:', 'warning');
        log(`  è¼¸å…¥é›»å£“å–æ¨£: ${finalV1.toFixed(3)}V`, 'warning');
        log(`  è«§æŒ¯é›»å£“å–æ¨£: ${finalV2.toFixed(3)}V`, 'warning');
        log(`  è¼¸å‡ºé›»å£“å–æ¨£: ${finalV3.toFixed(3)}V`, 'warning');

        log('âœ… çœŸæ­£çš„AkingSPICE LLCæ¨¡æ“¬ - ç„¡æ•¸å­¸ä½œå¼Šï¼', 'success');

      } catch (error) {
        log(`âŒ LLCåŸ·è¡ŒéŒ¯èª¤: ${error.message}`, 'error');
        console.error('è©³ç´°éŒ¯èª¤:', error);
        document.getElementById('status').textContent = 'éŒ¯èª¤';
      }
    });

  </script>
</body>

</html>