<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AkingSPICE äº’å‹•å¼é–‰è¿´è·¯æ§åˆ¶å™¨</title>
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ Monaco Editor -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; background-color: #f0f2f5; }
        .header { background: #007bff; color: white; padding: 15px 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .main-content { display: flex; flex: 1; min-height: 0; }
        .left-panel { width: 450px; padding: 20px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; }
        .right-panel { flex: 1; padding: 20px; display: flex; flex-direction: column; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-weight: 600; margin-bottom: 5px; }
        .control-group input[type="range"] { width: 100%; }
        .editor-container { flex: 1; border: 1px solid #ccc; min-height: 300px; }
        .chart-container { position: relative; flex: 1; min-height: 0; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        #status { margin-top: 15px; font-style: italic; color: #555; }
    </style>
</head>
<body>

<div class="header">
    <h1>AkingSPICE äº’å‹•å¼é–‰è¿´è·¯æ§åˆ¶å™¨</h1>
</div>

<div class="main-content">
    <div class="left-panel">
        <h3>é›»è·¯åƒæ•¸</h3>
        <div class="control-group">
            <label for="inputVoltage">è¼¸å…¥é›»å£“ (V) [æ­£å¼¦æ³¢Offset]</label>
            <input type="range" id="inputVoltage" min="5" max="20" value="12" step="0.5">
            <span id="inputVoltageValue">12.0 V</span>
        </div>
        <div class="control-group">
            <label for="targetVoltage">ç›®æ¨™è¼¸å‡ºé›»å£“ (V)</label>
            <input type="range" id="targetVoltage" min="1" max="10" value="5" step="0.1">
            <span id="targetVoltageValue">5.0 V</span>
        </div>
        
        <h3>æ§åˆ¶å™¨ç¨‹å¼ç¢¼ (JavaScript)</h3>
        <div id="editor" class="editor-container"></div>
        
        <div style="margin-top: 20px;">
            <button id="runBtn">ğŸš€ åŸ·è¡Œæ¨¡æ“¬</button>
            <button id="stopBtn" disabled>â¹ï¸ åœæ­¢</button>
        </div>
        <div id="status">æº–å‚™å°±ç·’ã€‚</div>
    </div>
    
    <div class="right-panel">
        <h3>æ¨¡æ“¬çµæœ</h3>
        <div class="chart-container">
            <canvas id="simulationChart"></canvas>
        </div>
    </div>
</div>

<!-- å¼•å…¥ AkingSPICE Library (UMD ç‰ˆæœ¬) -->
<script src="./lib-dist/AkingSPICE.umd.js"></script>

<!-- å¼•å…¥ Monaco Editor Loader -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let editor;
    let solver = null;
    let chart = null;
    let simulationRunning = false;
    
    const initialControllerCode = `
// é€™æ˜¯ä¸€å€‹ PI (æ¯”ä¾‹-ç©åˆ†) æ§åˆ¶å™¨
// å®ƒå¯ä»¥å‹•æ…‹èª¿æ•´ PWM å ç©ºæ¯”ï¼Œä»¥ç©©å®šè¼¸å‡ºé›»å£“

class Controller {
    constructor(targetVoltage, timeStep) {
        this.target = targetVoltage;
        this.timeStep = timeStep;
        this.kp = 0.08; // æ¯”ä¾‹å¢ç›Š (Proportional Gain)
        this.ki = 15;   // ç©åˆ†å¢ç›Š (Integral Gain)
        this.integral = 0; // ç©åˆ†ç´¯åŠ å™¨
    }

    // AI, é€™æ˜¯ä½ çš„éŠæ¨‚å ´ï¼
    // ä½ å¯ä»¥ä¿®æ”¹é€™å€‹å‡½æ•¸ä¾†å¯¦ç¾ä¸åŒçš„æ§åˆ¶ç­–ç•¥
    //
    // @param {number} time - ç•¶å‰æ¨¡æ“¬æ™‚é–“ (ç§’)
    // @param {object} feedback - åŒ…å«å›æˆä¿¡è™Ÿçš„ç‰©ä»¶, e.g., { v_out: 4.95 }
    // @returns {number} - è¿”å› 0.0 åˆ° 1.0 ä¹‹é–“çš„æ–°å ç©ºæ¯”
    update(time, feedback) {
        const error = this.target - feedback.v_out;

        // ç©åˆ†é … (å¸¶æœ‰æŠ—é£½å’Œï¼Œé˜²æ­¢ç©åˆ†å¤±æ§)
        this.integral += error * this.timeStep;
        this.integral = Math.max(-0.4, Math.min(0.4, this.integral));

        // PI æ§åˆ¶å™¨è¼¸å‡º
        const output = (this.kp * error) + (this.ki * this.integral);

        // å°‡è¼¸å‡ºè½‰æ›ç‚ºå ç©ºæ¯” (é™åˆ¶åœ¨ 0.1 åˆ° 0.9 ä¹‹é–“)
        let dutyCycle = 0.5 + output;
        return Math.max(0.1, Math.min(0.9, dutyCycle));
    }
}

// **é‡è¦**: å¿…é ˆè¿”å›ä¸€å€‹ Controller å¯¦ä¾‹
return new Controller(targetVoltage, timeStep);
`;

    // 1. åˆå§‹åŒ– Monaco Editor
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }});
    require(['vs/editor/editor.main'], () => {
        editor = monaco.editor.create(document.getElementById('editor'), {
            value: initialControllerCode,
            language: 'javascript',
            theme: 'vs-dark',
            automaticLayout: true
        });
        console.log("Monaco Editor åˆå§‹åŒ–å®Œç•¢ã€‚");
    });

    // 2. åˆå§‹åŒ– Chart
    const ctx = document.getElementById('simulationChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'è¼¸å‡ºé›»å£“ (V_out)', data: [], borderColor: '#1f77b4', borderWidth: 2, pointRadius: 0 },
                { label: 'è¼¸å…¥é›»å£“ (V_in)', data: [], borderColor: '#ff7f0e', borderWidth: 2, pointRadius: 0, borderDash: [5, 5] },
                { label: 'å ç©ºæ¯” (Duty Cycle)', data: [], borderColor: '#2ca02c', borderWidth: 1.5, pointRadius: 0, yAxisID: 'y1' }
            ]
        },
        options: {
            animation: false,
            scales: {
                x: { title: { display: true, text: 'æ™‚é–“ (ms)' } },
                y: { title: { display: true, text: 'é›»å£“ (V)' }, beginAtZero: true },
                y1: { type: 'linear', position: 'right', title: { display: true, text: 'å ç©ºæ¯”' }, min: 0, max: 1, grid: { drawOnChartArea: false } }
            }
        }
    });

    // 3. åˆå§‹åŒ– AkingSPICE
    try {
        solver = new window.AkingSPICE.AkingSPICE();
        document.getElementById('status').textContent = 'AkingSPICE å·²å°±ç·’ã€‚';
    } catch (e) {
        document.getElementById('status').textContent = 'AkingSPICE è¼‰å…¥å¤±æ•—ï¼';
        console.error(e);
        return;
    }

    // 4. ç¶å®šäº‹ä»¶
    const runBtn = document.getElementById('runBtn');
    const stopBtn = document.getElementById('stopBtn');
    runBtn.addEventListener('click', runSimulation);
    stopBtn.addEventListener('click', () => { simulationRunning = false; });

    document.querySelectorAll('.control-group input').forEach(input => {
        input.addEventListener('input', (e) => {
            document.getElementById(`${e.target.id}Value`).textContent = `${parseFloat(e.target.value).toFixed(1)} ${e.target.id.includes('Voltage') ? 'V' : ''}`;
        });
    });

    async function runSimulation() {
        if (simulationRunning) return;
        simulationRunning = true;
        runBtn.disabled = true;
        stopBtn.disabled = false;
        document.getElementById('status').textContent = 'æ¨¡æ“¬ä¸­...';

        // æ¸…ç©ºåœ–è¡¨
        chart.data.labels = [];
        chart.data.datasets.forEach(ds => ds.data = []);
        chart.update();

        // ç²å–åƒæ•¸
        const vin_offset = parseFloat(document.getElementById('inputVoltage').value);
        const targetVoltage = parseFloat(document.getElementById('targetVoltage').value);

        // å»ºç«‹é›»è·¯
        solver.reset();
        const { VoltageSource, MOSFET, Inductor, Capacitor, Resistor } = window.AkingSPICE;
        solver.components = [
            new VoltageSource('VIN', ['vin', '0'], `SINE(${vin_offset} 2 60)`), // 12V DC, 2V AC, 60Hz
            new MOSFET('MSW_H', ['vin', 'sw'], {Ron: 0.01, Roff: 1e6}),
            new MOSFET('MSW_L', ['sw', '0'], {Ron: 0.01, Roff: 1e6}),
            new Inductor('L1', ['sw', 'out'], 100e-6),
            new Capacitor('C1', ['out', '0'], 220e-6),
            new Resistor('RLOAD', ['out', '0'], 5)
        ];
        solver.isInitialized = true;
        
        // æ¨¡æ“¬åƒæ•¸
        const simParams = { stopTime: 50e-3, timeStep: 1e-7 };
        const f_sw = 100e3;
        const period = 1 / f_sw;

        // *** å‹•æ…‹å»ºç«‹ä¸¦åŸ·è¡Œä½¿ç”¨è€…æ§åˆ¶å™¨ç¨‹å¼ç¢¼ ***
        let controller;
        try {
            const userCode = editor.getValue();
            // ä½¿ç”¨ Function å»ºæ§‹å‡½æ•¸ï¼Œæ¯” eval() æ›´å®‰å…¨
            const controllerFactory = new Function('targetVoltage', 'timeStep', userCode);
            controller = controllerFactory(targetVoltage, simParams.timeStep);
        } catch (e) {
            alert("æ§åˆ¶å™¨ç¨‹å¼ç¢¼éŒ¯èª¤: " + e.message);
            simulationRunning = false;
            runBtn.disabled = false;
            stopBtn.disabled = true;
            return;
        }

        await solver.initSteppedTransient(simParams);
        let lastResult = null;
        let stepCount = 0;
        const totalSteps = Math.floor(simParams.stopTime / simParams.timeStep);

        function simulationLoop() {
            if (!simulationRunning || solver.isFinished()) {
                simulationRunning = false;
                runBtn.disabled = false;
                stopBtn.disabled = true;
                document.getElementById('status').textContent = 'æ¨¡æ“¬å®Œæˆã€‚';
                return;
            }

            // æ¯æ¬¡æ¸²æŸ“ç•«é¢åŸ·è¡Œä¸€å°æ‰¹æ¨¡æ“¬ï¼Œé¿å…ç€è¦½å™¨å¡æ­»
            const stepsPerFrame = 500;
            for (let i = 0; i < stepsPerFrame && !solver.isFinished(); i++) {
                const time = solver.getCurrentTime();
                const feedback = { v_out: lastResult ? lastResult.nodeVoltages['out'] : 0 };
                
                const dutyCycle = controller.update(time, feedback);
                
                const high_on = (time % period) < (period * dutyCycle);
                const controlState = { 'MSW_H': high_on, 'MSW_L': !high_on };
                
                lastResult = solver.step(controlState);
                stepCount++;

                // æ¯ 100 æ­¥æ›´æ–°ä¸€æ¬¡åœ–è¡¨
                if (stepCount % 100 === 0 && lastResult) {
                    const timeMs = time * 1000;
                    chart.data.labels.push(timeMs.toFixed(2));
                    chart.data.datasets[0].data.push(lastResult.nodeVoltages['out']);
                    chart.data.datasets[1].data.push(lastResult.nodeVoltages['vin']);
                    chart.data.datasets[2].data.push(dutyCycle);
                }
            }
            
            chart.update();
            document.getElementById('status').textContent = `æ¨¡æ“¬ä¸­... ${((stepCount / totalSteps) * 100).toFixed(1)}%`;
            requestAnimationFrame(simulationLoop);
        }
        
        requestAnimationFrame(simulationLoop);
    }
});
</script>

</body>
</html>