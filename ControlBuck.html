<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AkingSPICE 互動式閉迴路控制器</title>
    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入 Monaco Editor -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; background-color: #f0f2f5; }
        .header { background: #007bff; color: white; padding: 15px 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .main-content { display: flex; flex: 1; min-height: 0; }
        .left-panel { width: 450px; padding: 20px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; }
        .right-panel { flex: 1; padding: 20px; display: flex; flex-direction: column; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-weight: 600; margin-bottom: 5px; }
        .control-group input[type="range"] { width: 100%; }
        .editor-container { flex: 1; border: 1px solid #ccc; min-height: 300px; }
        .chart-container { position: relative; flex: 1; min-height: 0; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        #status { margin-top: 15px; font-style: italic; color: #555; }
    </style>
</head>
<body>

<div class="header">
    <h1>AkingSPICE 互動式閉迴路控制器</h1>
</div>

<div class="main-content">
    <div class="left-panel">
        <h3>電路參數</h3>
        <div class="control-group">
            <label for="inputVoltage">輸入電壓 (V) [正弦波Offset]</label>
            <input type="range" id="inputVoltage" min="5" max="20" value="12" step="0.5">
            <span id="inputVoltageValue">12.0 V</span>
        </div>
        <div class="control-group">
            <label for="targetVoltage">目標輸出電壓 (V)</label>
            <input type="range" id="targetVoltage" min="1" max="10" value="5" step="0.1">
            <span id="targetVoltageValue">5.0 V</span>
        </div>
        
        <h3>控制器程式碼 (JavaScript)</h3>
        <div id="editor" class="editor-container"></div>
        
        <div style="margin-top: 20px;">
            <button id="runBtn">🚀 執行模擬</button>
            <button id="stopBtn" disabled>⏹️ 停止</button>
        </div>
        <div id="status">準備就緒。</div>
    </div>
    
    <div class="right-panel">
        <h3>模擬結果</h3>
        <div class="chart-container">
            <canvas id="simulationChart"></canvas>
        </div>
    </div>
</div>

<!-- 引入 AkingSPICE Library (UMD 版本) -->
<script src="./lib-dist/AkingSPICE.umd.js"></script>

<!-- 引入 Monaco Editor Loader -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let editor;
    let solver = null;
    let chart = null;
    let simulationRunning = false;
    
    const initialControllerCode = `
// 這是一個 PI (比例-積分) 控制器
// 它可以動態調整 PWM 占空比，以穩定輸出電壓

class Controller {
    constructor(targetVoltage, timeStep) {
        this.target = targetVoltage;
        this.timeStep = timeStep;
        this.kp = 0.08; // 比例增益 (Proportional Gain)
        this.ki = 15;   // 積分增益 (Integral Gain)
        this.integral = 0; // 積分累加器
    }

    // AI, 這是你的遊樂場！
    // 你可以修改這個函數來實現不同的控制策略
    //
    // @param {number} time - 當前模擬時間 (秒)
    // @param {object} feedback - 包含回授信號的物件, e.g., { v_out: 4.95 }
    // @returns {number} - 返回 0.0 到 1.0 之間的新占空比
    update(time, feedback) {
        const error = this.target - feedback.v_out;

        // 積分項 (帶有抗飽和，防止積分失控)
        this.integral += error * this.timeStep;
        this.integral = Math.max(-0.4, Math.min(0.4, this.integral));

        // PI 控制器輸出
        const output = (this.kp * error) + (this.ki * this.integral);

        // 將輸出轉換為占空比 (限制在 0.1 到 0.9 之間)
        let dutyCycle = 0.5 + output;
        return Math.max(0.1, Math.min(0.9, dutyCycle));
    }
}

// **重要**: 必須返回一個 Controller 實例
return new Controller(targetVoltage, timeStep);
`;

    // 1. 初始化 Monaco Editor
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }});
    require(['vs/editor/editor.main'], () => {
        editor = monaco.editor.create(document.getElementById('editor'), {
            value: initialControllerCode,
            language: 'javascript',
            theme: 'vs-dark',
            automaticLayout: true
        });
        console.log("Monaco Editor 初始化完畢。");
    });

    // 2. 初始化 Chart
    const ctx = document.getElementById('simulationChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: '輸出電壓 (V_out)', data: [], borderColor: '#1f77b4', borderWidth: 2, pointRadius: 0 },
                { label: '輸入電壓 (V_in)', data: [], borderColor: '#ff7f0e', borderWidth: 2, pointRadius: 0, borderDash: [5, 5] },
                { label: '占空比 (Duty Cycle)', data: [], borderColor: '#2ca02c', borderWidth: 1.5, pointRadius: 0, yAxisID: 'y1' }
            ]
        },
        options: {
            animation: false,
            scales: {
                x: { title: { display: true, text: '時間 (ms)' } },
                y: { title: { display: true, text: '電壓 (V)' }, beginAtZero: true },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '占空比' }, min: 0, max: 1, grid: { drawOnChartArea: false } }
            }
        }
    });

    // 3. 初始化 AkingSPICE
    try {
        solver = new window.AkingSPICE.AkingSPICE();
        document.getElementById('status').textContent = 'AkingSPICE 已就緒。';
    } catch (e) {
        document.getElementById('status').textContent = 'AkingSPICE 載入失敗！';
        console.error(e);
        return;
    }

    // 4. 綁定事件
    const runBtn = document.getElementById('runBtn');
    const stopBtn = document.getElementById('stopBtn');
    runBtn.addEventListener('click', runSimulation);
    stopBtn.addEventListener('click', () => { simulationRunning = false; });

    document.querySelectorAll('.control-group input').forEach(input => {
        input.addEventListener('input', (e) => {
            document.getElementById(`${e.target.id}Value`).textContent = `${parseFloat(e.target.value).toFixed(1)} ${e.target.id.includes('Voltage') ? 'V' : ''}`;
        });
    });

    async function runSimulation() {
        if (simulationRunning) return;
        simulationRunning = true;
        runBtn.disabled = true;
        stopBtn.disabled = false;
        document.getElementById('status').textContent = '模擬中...';

        // 清空圖表
        chart.data.labels = [];
        chart.data.datasets.forEach(ds => ds.data = []);
        chart.update();

        // 獲取參數
        const vin_offset = parseFloat(document.getElementById('inputVoltage').value);
        const targetVoltage = parseFloat(document.getElementById('targetVoltage').value);

        // 建立電路
        solver.reset();
        const { VoltageSource, MOSFET, Inductor, Capacitor, Resistor } = window.AkingSPICE;
        solver.components = [
            new VoltageSource('VIN', ['vin', '0'], `SINE(${vin_offset} 2 60)`), // 12V DC, 2V AC, 60Hz
            new MOSFET('MSW_H', ['vin', 'sw'], {Ron: 0.01, Roff: 1e6}),
            new MOSFET('MSW_L', ['sw', '0'], {Ron: 0.01, Roff: 1e6}),
            new Inductor('L1', ['sw', 'out'], 100e-6),
            new Capacitor('C1', ['out', '0'], 220e-6),
            new Resistor('RLOAD', ['out', '0'], 5)
        ];
        solver.isInitialized = true;
        
        // 模擬參數
        const simParams = { stopTime: 50e-3, timeStep: 1e-7 };
        const f_sw = 100e3;
        const period = 1 / f_sw;

        // *** 動態建立並執行使用者控制器程式碼 ***
        let controller;
        try {
            const userCode = editor.getValue();
            // 使用 Function 建構函數，比 eval() 更安全
            const controllerFactory = new Function('targetVoltage', 'timeStep', userCode);
            controller = controllerFactory(targetVoltage, simParams.timeStep);
        } catch (e) {
            alert("控制器程式碼錯誤: " + e.message);
            simulationRunning = false;
            runBtn.disabled = false;
            stopBtn.disabled = true;
            return;
        }

        await solver.initSteppedTransient(simParams);
        let lastResult = null;
        let stepCount = 0;
        const totalSteps = Math.floor(simParams.stopTime / simParams.timeStep);

        function simulationLoop() {
            if (!simulationRunning || solver.isFinished()) {
                simulationRunning = false;
                runBtn.disabled = false;
                stopBtn.disabled = true;
                document.getElementById('status').textContent = '模擬完成。';
                return;
            }

            // 每次渲染畫面執行一小批模擬，避免瀏覽器卡死
            const stepsPerFrame = 500;
            for (let i = 0; i < stepsPerFrame && !solver.isFinished(); i++) {
                const time = solver.getCurrentTime();
                const feedback = { v_out: lastResult ? lastResult.nodeVoltages['out'] : 0 };
                
                const dutyCycle = controller.update(time, feedback);
                
                const high_on = (time % period) < (period * dutyCycle);
                const controlState = { 'MSW_H': high_on, 'MSW_L': !high_on };
                
                lastResult = solver.step(controlState);
                stepCount++;

                // 每 100 步更新一次圖表
                if (stepCount % 100 === 0 && lastResult) {
                    const timeMs = time * 1000;
                    chart.data.labels.push(timeMs.toFixed(2));
                    chart.data.datasets[0].data.push(lastResult.nodeVoltages['out']);
                    chart.data.datasets[1].data.push(lastResult.nodeVoltages['vin']);
                    chart.data.datasets[2].data.push(dutyCycle);
                }
            }
            
            chart.update();
            document.getElementById('status').textContent = `模擬中... ${((stepCount / totalSteps) * 100).toFixed(1)}%`;
            requestAnimationFrame(simulationLoop);
        }
        
        requestAnimationFrame(simulationLoop);
    }
});
</script>

</body>
</html>