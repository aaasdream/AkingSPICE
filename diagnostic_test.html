<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>AkingSPICEè¨ºæ–·æ¸¬è©¦</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #2c3e50;
      color: white;
    }

    .test-box {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
    }

    .success {
      border-left: 4px solid #2ecc71;
    }

    .error {
      border-left: 4px solid #e74c3c;
    }

    .warning {
      border-left: 4px solid #f39c12;
    }

    #log {
      height: 400px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <h1>ğŸ”§ AkingSPICEè¨ºæ–·æ¸¬è©¦</h1>

  <div class="test-box" id="status">
    <h3>æ¸¬è©¦ç‹€æ…‹</h3>
    <div id="test-status">æº–å‚™æ¸¬è©¦...</div>
  </div>

  <div class="test-box">
    <h3>ğŸ“‹ æ¸¬è©¦æ—¥èªŒ</h3>
    <div id="log">é–‹å§‹AkingSPICEè¨ºæ–·æ¸¬è©¦...<br></div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    function log(msg, type = 'info') {
      const colors = { info: '#ecf0f1', error: '#e74c3c', success: '#2ecc71', warning: '#f39c12' };
      const time = new Date().toLocaleTimeString();

      const logDiv = document.getElementById('log');
      logDiv.innerHTML += `<span style="color:${colors[type]};">[${time}] ${msg}</span><br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${time}] ${msg}`);
    }

    function updateStatus(msg, type = 'info') {
      const statusDiv = document.getElementById('status');
      const testStatusDiv = document.getElementById('test-status');

      statusDiv.className = `test-box ${type}`;
      testStatusDiv.textContent = msg;
    }

    // é–‹å§‹è¨ºæ–·æ¸¬è©¦
    document.addEventListener('DOMContentLoaded', async function () {
      log('ğŸš€ é–‹å§‹AkingSPICEè¨ºæ–·æ¸¬è©¦', 'success');

      try {
        // æ¸¬è©¦1: æª¢æŸ¥AkingSPICEè¼‰å…¥
        log('ğŸ“¦ æ¸¬è©¦1: æª¢æŸ¥AkingSPICEè¼‰å…¥...', 'info');
        if (!window.AkingSPICE) {
          throw new Error('AkingSPICEæœªè¼‰å…¥');
        }
        log('âœ… AkingSPICEè¼‰å…¥æˆåŠŸ', 'success');
        updateStatus('AkingSPICEè¼‰å…¥æˆåŠŸ', 'success');

        // æ¸¬è©¦2: æª¢æŸ¥çµ„ä»¶é¡åˆ¥
        log('ğŸ”§ æ¸¬è©¦2: æª¢æŸ¥çµ„ä»¶é¡åˆ¥...', 'info');
        const { VoltageSource, Resistor, Capacitor, Inductor, ExplicitStateSolver } = window.AkingSPICE;

        if (!VoltageSource || !Resistor || !Capacitor || !Inductor || !ExplicitStateSolver) {
          throw new Error('çµ„ä»¶é¡åˆ¥ä¸å®Œæ•´');
        }
        log('âœ… æ‰€æœ‰åŸºæœ¬çµ„ä»¶é¡åˆ¥å¯ç”¨', 'success');

        // æ¸¬è©¦3: å‰µå»ºç°¡å–®çµ„ä»¶
        log('âš™ï¸ æ¸¬è©¦3: å‰µå»ºç°¡å–®çµ„ä»¶...', 'info');
        const v1 = new VoltageSource('V1', [1, 0], 5.0);
        const r1 = new Resistor('R1', [1, 0], 1000.0);
        log(`âœ… é›»å£“æºå‰µå»º: ${v1.name} = ${v1.value}V`, 'success');
        log(`âœ… é›»é˜»å‰µå»º: ${r1.name} = ${r1.value}Î©`, 'success');

        // æ¸¬è©¦4: å‰µå»ºæ±‚è§£å™¨
        log('ğŸ§® æ¸¬è©¦4: å‰µå»ºExplicitStateSolver...', 'info');
        const solver = new ExplicitStateSolver();
        log('âœ… æ±‚è§£å™¨å‰µå»ºæˆåŠŸ', 'success');

        // æ¸¬è©¦5: ç°¡å–®é›»è·¯åˆå§‹åŒ–
        log('ğŸ”Œ æ¸¬è©¦5: ç°¡å–®é›»è·¯åˆå§‹åŒ– (V-Ré›»è·¯)...', 'info');
        const simpleComponents = [
          new VoltageSource('V1', [1, 0], 12.0),
          new Resistor('R1', [1, 0], 1000.0)
        ];

        try {
          solver.initialize(simpleComponents, 1e-4, {
            debug: false,
            maxIterations: 100,
            tolerance: 1e-6
          });
          log('âœ… ç°¡å–®é›»è·¯åˆå§‹åŒ–æˆåŠŸ', 'success');
        } catch (error) {
          log(`âŒ ç°¡å–®é›»è·¯åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
          throw error;
        }

        // æ¸¬è©¦6: åŸ·è¡Œä¸€æ­¥æ¨¡æ“¬
        log('â–¶ï¸ æ¸¬è©¦6: åŸ·è¡Œæ¨¡æ“¬æ­¥é©Ÿ...', 'info');
        try {
          const result = solver.step();
          log('âœ… æ¨¡æ“¬æ­¥é©ŸåŸ·è¡ŒæˆåŠŸ', 'success');

          if (result.nodeVoltages) {
            const v = result.nodeVoltages[1] || 0;
            log(`ğŸ“Š ç¯€é»1é›»å£“: ${v.toFixed(3)}V`, 'info');
          }

          log('ğŸ‰ æ‰€æœ‰åŸºæœ¬æ¸¬è©¦é€šéï¼', 'success');
          updateStatus('AkingSPICEåŸºæœ¬åŠŸèƒ½æ­£å¸¸', 'success');

          // ç¾åœ¨æ¸¬è©¦è¤‡é›œé›»è·¯
          setTimeout(testComplexCircuit, 1000);

        } catch (error) {
          log(`âŒ æ¨¡æ“¬æ­¥é©Ÿå¤±æ•—: ${error.message}`, 'error');
          throw error;
        }

      } catch (error) {
        log(`âŒ è¨ºæ–·æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
        updateStatus(`æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
      }
    });

    // æ¸¬è©¦è¤‡é›œé›»è·¯
    async function testComplexCircuit() {
      log('ğŸ§ª é–‹å§‹è¤‡é›œé›»è·¯æ¸¬è©¦...', 'warning');

      try {
        const { VoltageSource, Resistor, Capacitor, Inductor, ExplicitStateSolver } = window.AkingSPICE;

        // æ¸¬è©¦7: RLCé›»è·¯
        log('ğŸ”‹ æ¸¬è©¦7: RLCé›»è·¯æ¸¬è©¦...', 'info');
        const rlcComponents = [
          new VoltageSource('Vin', [1, 0], 10.0),
          new Resistor('R1', [1, 2], 100.0),
          new Inductor('L1', [2, 3], 1e-3),  // 1mH
          new Capacitor('C1', [3, 0], 1e-6)  // 1Î¼F
        ];

        const rlcSolver = new ExplicitStateSolver();

        try {
          rlcSolver.initialize(rlcComponents, 1e-5, {  // è¼ƒå¤§æ™‚é–“æ­¥é•·
            debug: false,
            maxIterations: 50,  // é™ä½æœ€å¤§è¿­ä»£æ¬¡æ•¸
            tolerance: 1e-5     // æ”¾å¯¬å®¹å·®
          });

          log('âœ… RLCé›»è·¯åˆå§‹åŒ–æˆåŠŸ', 'success');

          // åŸ·è¡Œå¹¾æ­¥
          for (let i = 0; i < 5; i++) {
            const result = rlcSolver.step();
            const v3 = result.nodeVoltages && result.nodeVoltages[3] ? result.nodeVoltages[3] : 0;
            log(`æ­¥é©Ÿ ${i + 1}: é›»å®¹é›»å£“ = ${v3.toFixed(4)}V`, 'info');
          }

          log('ğŸ‰ RLCé›»è·¯æ¸¬è©¦æˆåŠŸï¼', 'success');
          updateStatus('RLCé›»è·¯æ¸¬è©¦é€šé - å•é¡Œå¯èƒ½åœ¨LLCåƒæ•¸', 'warning');

        } catch (error) {
          log(`âŒ RLCé›»è·¯å¤±æ•—: ${error.message}`, 'error');
          updateStatus('RLCé›»è·¯ä¹Ÿå¤±æ•— - AkingSPICEæœ‰æ•¸å€¼å•é¡Œ', 'error');
        }

        // æ¸¬è©¦8: LLCç›¸é—œå•é¡Œè¨ºæ–·
        log('ğŸ” æ¸¬è©¦8: LLCå•é¡Œè¨ºæ–·...', 'warning');
        log('å¯èƒ½çš„LLCå•é¡Œ:', 'warning');
        log('1. æ™‚é–“æ­¥é•·å¤ªå° (20nså¯èƒ½å¤ªå°)', 'warning');
        log('2. é›»è·¯ç¯€é»éå¤šä¸”è€¦åˆç·Šå¯†', 'warning');
        log('3. è®Šå£“å™¨æ¨¡å‹è¿‘ä¼¼ä¸ç•¶', 'warning');
        log('4. åˆå§‹æ¢ä»¶ä¸ç©©å®š', 'warning');
        log('5. é›»é˜»å€¼éå°å°è‡´å‰›æ€§å•é¡Œ', 'warning');

      } catch (error) {
        log(`âŒ è¤‡é›œé›»è·¯æ¸¬è©¦éŒ¯èª¤: ${error.message}`, 'error');
      }
    }
  </script>
</body>

</html>