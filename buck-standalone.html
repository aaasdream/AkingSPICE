<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSSolver-PE Buck è½‰æ›å™¨å¯¦æˆ° (äº’å‹•åœ–è¡¨ç‰ˆ)</title>
    <!-- å¼•å…¥ Plotly.js å‡½å¼åº« -->
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
    <style>
        /* [å‰ç•¥...] CSS æ¨£å¼èˆ‡ä¹‹å‰ç›¸åŒ */
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { margin: 0; font-size: 2.2em; font-weight: 300; }
        .subtitle { margin-top: 10px; opacity: 0.9; font-size: 1.1em; }
        .content { display: grid; grid-template-columns: 400px 1fr; gap: 0; min-height: 700px; }
        .controls { background: #f8f9fa; padding: 30px; border-right: 1px solid #e9ecef; }
        .results { padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #495057; font-size: 1em; }
        .control-group input { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1em; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 600; cursor: pointer; margin-bottom: 15px; }
        .btn-primary { background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; color: white; }
        .result-panel { background: #f8f9fa; border-left: 5px solid #4ECDC4; padding: 20px; border-radius: 8px; }
        .result-panel h3 { margin-top: 0; color: #495057; font-size: 1.3em; }
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .result-item { background: white; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef; }
        .result-label { font-size: 0.9em; color: #6c757d; margin-bottom: 5px; }
        .result-value { font-size: 1.4em; font-weight: 600; color: #495057; }
        .status { padding: 10px 15px; border-radius: 6px; margin-bottom: 15px; font-weight: 600; }
        .status.loading { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .log { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.9em; max-height: 150px; overflow-y: auto; white-space: pre-wrap; }
        #progress-container { width: 100%; background-color: #e9ecef; border-radius: 8px; margin-top: 15px; overflow: hidden; display: none; }
        #progress-bar { width: 0%; height: 20px; background: linear-gradient(135deg, #4ECDC4 0%, #21CBF3 100%); text-align: center; line-height: 20px; color: white; font-weight: 600; transition: width 0.2s ease-in-out; }
        #chart-container { width: 100%; height: 400px; border: 1px solid #e9ecef; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”Œ JSSolver-PE Buck è½‰æ›å™¨å¯¦æˆ°</h1>
            <div class="subtitle">äº’å‹•å¼æ³¢å½¢åˆ†æ</div>
        </div>
        <div class="content">
            <div class="controls">
                <div id="status" class="status loading">ğŸ”„ è¼‰å…¥ JSSolver-PE Library...</div>
                <div class="control-group"><label for="inputVoltage">è¼¸å…¥é›»å£“ (V)</label><input type="number" id="inputVoltage" value="12" min="1" max="50" step="0.1"></div>
                <div class="control-group"><label for="dutyCycle">å ç©ºæ¯” (%)</label><input type="number" id="dutyCycle" value="50" min="10" max="90" step="1"></div>
                <div class="control-group"><label for="frequency">é–‹é—œé »ç‡ (kHz)</label><input type="number" id="frequency" value="100" min="10" max="1000" step="10"></div>
                <div class="control-group"><label for="inductance">é›»æ„Ÿå€¼ (Î¼H)</label><input type="number" id="inductance" value="100" min="10" max="1000" step="10"></div>
                <div class="control-group"><label for="capacitance">é›»å®¹å€¼ (Î¼F)</label><input type="number" id="capacitance" value="220" min="10" max="1000" step="10"></div>
                <div class="control-group"><label for="loadResistance">è² è¼‰é›»é˜» (Î©)</label><input type="number" id="loadResistance" value="5" min="1" max="100" step="0.1"></div>
                <div class="control-group"><label for="simTime">æ¨¡æ“¬æ™‚é–“ (ms)</label><input type="number" id="simTime" value="5" min="1" max="50" step="1"></div>
                <button class="btn btn-primary" id="runBtn" disabled>è¼‰å…¥ä¸­...</button>
                <button class="btn btn-secondary" id="clearBtn">æ¸…é™¤çµæœ</button>
                <div id="progress-container"><div id="progress-bar">0%</div></div>
            </div>
            <div class="results">
                <div id="chart-container"></div>
                <div class="result-panel">
                    <h3>ğŸ¯ è§£ç®—å™¨çµæœ</h3>
                    <div class="result-grid">
                        <div class="result-item"><div class="result-label">å¹³å‡è¼¸å‡ºé›»å£“</div><div class="result-value" id="avgVoltage">-- V</div></div>
                        <div class="result-item"><div class="result-label">è¼¸å‡ºé›»æµ</div><div class="result-value" id="outputCurrent">-- A</div></div>
                        <div class="result-item"><div class="result-label">é›»å£“æ¼£æ³¢</div><div class="result-value" id="voltageRipple">-- V</div></div>
                        <div class="result-item"><div class="result-label">æ¨¡æ“¬æ­¥æ•¸</div><div class="result-value" id="stepCount">--</div></div>
                    </div>
                </div>
                 <div class="result-panel">
                    <h3>ğŸ“‹ æ¨¡æ“¬æ—¥èªŒ</h3>
                    <div class="log" id="logOutput">ç­‰å¾…é–‹å§‹æ¨¡æ“¬...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="./lib-dist/jssolver-pe.umd.js"></script>
    <script>
        let solver = null;
        let isReady = false;
        
        function log(message, type = 'info') { const logOutput = document.getElementById('logOutput'); const timestamp = new Date().toLocaleTimeString(); const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸'; logOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`; logOutput.scrollTop = logOutput.scrollHeight; }
        function updateStatus(message, type) { const status = document.getElementById('status'); status.textContent = message; status.className = `status ${type}`; }
        
        function initializeChart() {
            const layout = {
                title: 'Buck è½‰æ›å™¨æ¨¡æ“¬æ³¢å½¢',
                xaxis: { title: 'æ™‚é–“ (ms)' },
                yaxis: { title: 'è¼¸å‡ºé›»å£“ (V)', color: '#1f77b4', range: [0, parseFloat(document.getElementById('inputVoltage').value) * 1.2] },
                yaxis2: { title: 'é›»æ„Ÿé›»æµ (A)', color: '#ff7f0e', overlaying: 'y', side: 'right' },
                yaxis3: { title: 'PWM', color: '#2ca02c', overlaying: 'y', side: 'right', position: 0.95, showgrid: false, range: [-0.1, 1.1], tickvals: [0, 1] },
                legend: { x: 0, y: 1.1, orientation: 'h' },
                margin: { l: 50, r: 100, b: 50, t: 50 }
            };
            Plotly.newPlot('chart-container', [], layout, {responsive: true});
        }
        
        function updateChart(results) {
            const timeData = [], voutData = [], iLData = [], pwmData = [];
            
            results.steps.forEach(step => {
                timeData.push(step.time * 1000); // è½‰ç‚º ms
                voutData.push(step.nodeVoltages['out'] || 0);
                iLData.push(step.branchCurrents['L1'] || 0);
                const pwmState = step.componentStates['MSW_H']?.gateState === 'ON' ? 1 : 0;
                pwmData.push(pwmState);
            });

            const traces = [
                { x: timeData, y: voutData, name: 'Vout (V)', type: 'scatter', mode: 'lines', line: { color: '#1f77b4' } },
                { x: timeData, y: iLData, name: 'iL (A)', type: 'scatter', mode: 'lines', yaxis: 'y2', line: { color: '#ff7f0e' } },
                { x: timeData, y: pwmData, name: 'PWM', type: 'scatter', mode: 'lines', yaxis: 'y3', line: { color: '#2ca02c', shape: 'hv' } }
            ];
            
            // --- *** é—œéµä¿®æ­£ *** ---
            const chartDiv = document.getElementById('chart-container');
            Plotly.react(chartDiv, traces, chartDiv.layout); // ä½¿ç”¨ chartDiv.layout ä¿æŒç¸®æ”¾ç‹€æ…‹
        }

        async function initializeSolver() { try { log('é–‹å§‹åˆå§‹åŒ– JSSolver-PE...'); updateStatus('ğŸ”„ åˆå§‹åŒ–è§£ç®—å™¨...', 'loading'); if (typeof window.JSSolverPE === 'undefined') throw new Error('JSSolver-PE library æœªè¼‰å…¥'); solver = new window.JSSolverPE.JSSolverPE(); solver.setDebug(false); log('JSSolver-PE åˆå§‹åŒ–æˆåŠŸï¼'); log(`ç‰ˆæœ¬: ${window.JSSolverPE.JSSolverPE.getVersionInfo().version}`); updateStatus('âœ… è§£ç®—å™¨å°±ç·’', 'success'); const runBtn = document.getElementById('runBtn'); runBtn.disabled = false; runBtn.textContent = 'ğŸš€ é–‹å§‹æ¨¡æ“¬'; isReady = true; } catch (error) { log(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error'); updateStatus('âŒ åˆå§‹åŒ–å¤±æ•—', 'error'); console.error('JSSolver-PE initialization failed:', error); } }
        function buildBuckCircuit() { const Vin = parseFloat(document.getElementById('inputVoltage').value); const L = parseFloat(document.getElementById('inductance').value) * 1e-6; const C = parseFloat(document.getElementById('capacitance').value) * 1e-6; const Rload = parseFloat(document.getElementById('loadResistance').value); log(`å»ºç«‹åŒæ­¥ Buck é›»è·¯: Vin=${Vin}V, L=${L*1e6}Î¼H, C=${C*1e6}Î¼F, R=${Rload}Î©`); solver.reset(); const { VoltageSource, MOSFET, Inductor, Capacitor, Resistor } = window.JSSolverPE; solver.components = [ new VoltageSource('VIN', ['vin', '0'], Vin), new MOSFET('MSW_H', ['vin', 'sw'], { Ron: 0.01, Roff: 1e6 }), new MOSFET('MSW_L', ['sw', '0'], { Ron: 0.01, Roff: 1e6 }), new Inductor('L1', ['sw', 'out'], L, {ic: 0}), new Capacitor('C1', ['out', '0'], C, {ic: 0}), new Resistor('RLOAD', ['out', '0'], Rload) ]; solver.isInitialized = true; const validation = solver.validateCircuit(); if (!validation.valid) throw new Error(`é›»è·¯é©—è­‰å¤±æ•—: ${validation.issues.join(', ')}`); log('åŒæ­¥ Buck é›»è·¯å»ºç«‹ä¸¦é©—è­‰æˆåŠŸ'); }
        function updateProgress(current, total) { const progressBar = document.getElementById('progress-bar'); const progressContainer = document.getElementById('progress-container'); if (total > 0) { const percentage = Math.min(100, Math.round((current / total) * 100)); progressBar.style.width = `${percentage}%`; progressBar.textContent = `${percentage}%`; progressContainer.style.display = 'block'; } else { progressContainer.style.display = 'none'; } }
        
        async function runSimulation() {
            if (!isReady) { log('è§£ç®—å™¨å°šæœªå°±ç·’', 'error'); return; }
            const runBtn = document.getElementById('runBtn');
            runBtn.disabled = true; runBtn.textContent = 'æ¨¡æ“¬ä¸­...';
            try {
                updateStatus('ğŸ”„ æ¨¡æ“¬é€²è¡Œä¸­...', 'loading');
                log('é–‹å§‹ Buck è½‰æ›å™¨æ¨¡æ“¬...');
                initializeChart(); // æ¯æ¬¡é‹è¡Œæ™‚é‡ç½®åœ–è¡¨ä½ˆå±€
                buildBuckCircuit();
                const dutyCycle = parseFloat(document.getElementById('dutyCycle').value) / 100;
                const frequency = parseFloat(document.getElementById('frequency').value) * 1000;
                const simTime = parseFloat(document.getElementById('simTime').value) / 1000;
                const period = 1 / frequency;
                const timeStep = period / 100;
                const totalSteps = Math.floor(simTime / timeStep);
                const pwmControl = (time) => {
                    const cycleTime = time % period;
                    const highSideOn = cycleTime < (period * dutyCycle);
                    return { 'MSW_H': highSideOn, 'MSW_L': !highSideOn };
                };
                log(`PWM é€±æœŸ: ${(period*1e6).toFixed(1)}Î¼s, æ™‚é–“æ­¥é•·: ${(timeStep*1e9).toFixed(1)}ns, ç¸½æ­¥æ•¸: ${totalSteps}`);
                const startTime = performance.now();
                await solver.initSteppedTransient({ startTime: 0, stopTime: simTime, timeStep: timeStep });
                const allResults = [];
                let currentStep = 0;
                const chunkSize = Math.max(100, Math.floor(totalSteps / 100));
                
                function simulationStepLoop() {
                    for (let i = 0; i < chunkSize && !solver.isFinished(); i++) {
                        const controlInputs = pwmControl(solver.getCurrentTime());
                        const stepResult = solver.step(controlInputs);
                        if (stepResult) { allResults.push(stepResult); }
                        currentStep++;
                    }
                    updateProgress(currentStep, totalSteps);
                    if (!solver.isFinished()) {
                        setTimeout(simulationStepLoop, 0);
                    } else {
                        const endTime = performance.now();
                        log(`æ¨¡æ“¬è€—æ™‚: ${(endTime - startTime).toFixed(1)}ms`);
                        const finalResults = { steps: allResults, summary: { totalSteps: allResults.length } };
                        processResults(finalResults, dutyCycle);
                        updateChart(finalResults);
                        updateStatus('âœ… æ¨¡æ“¬å®Œæˆ', 'success');
                        log('æ¨¡æ“¬æˆåŠŸå®Œæˆï¼', 'success');
                        runBtn.disabled = false; runBtn.textContent = 'ğŸš€ é–‹å§‹æ¨¡æ“¬';
                        document.getElementById('progress-container').style.display = 'none';
                    }
                }
                simulationStepLoop();
            } catch (error) {
                log(`æ¨¡æ“¬å¤±æ•—: ${error.message}`, 'error');
                updateStatus('âŒ æ¨¡æ“¬å¤±æ•—', 'error');
                console.error('Simulation error:', error);
                runBtn.disabled = false; runBtn.textContent = 'ğŸš€ é–‹å§‹æ¨¡æ“¬';
            }
        }
        
        function processResults(results, dutyCycle) { const steps = results.steps; const stepCount = steps.length; log(`æ¨¡æ“¬å®Œæˆ: ${stepCount} å€‹æ™‚é–“æ­¥é©’`); if (stepCount === 0) { log('æ¨¡æ“¬çµæœç‚ºç©ºï¼', 'error'); return; } let avgVoltage = 0, avgCurrent = 0, validSteps = 0; const analysisStart = Math.max(0, stepCount - Math.floor(stepCount * 0.5)); let minV = Infinity, maxV = -Infinity; for (let i = analysisStart; i < stepCount; i++) { const step = steps[i]; const outputVoltage = step.nodeVoltages['out'] || 0; if (outputVoltage >= -1 && outputVoltage <= 20) { avgVoltage += outputVoltage; minV = Math.min(minV, outputVoltage); maxV = Math.max(maxV, outputVoltage); validSteps++; } } if (validSteps === 0) { log('æ²’æœ‰æœ‰æ•ˆçš„æ¨¡æ“¬æ­¥é©’ï¼', 'error'); return; } avgVoltage /= validSteps; const voltageRipple = maxV - minV; const loadResistance = parseFloat(document.getElementById('loadResistance').value); avgCurrent = avgVoltage / loadResistance; log(`=== æ¨¡æ“¬çµæœè©³ç´°åˆ†æ ===`); log(`å¹³å‡è¼¸å‡ºé›»å£“: ${avgVoltage.toFixed(4)} V`); log(`é›»å£“æ¼£æ³¢: ${voltageRipple.toFixed(4)}V (${(voltageRipple/avgVoltage*100).toFixed(1)}%)`); const Vin = parseFloat(document.getElementById('inputVoltage').value); const theoretical = Vin * dutyCycle; const error = Math.abs(avgVoltage - theoretical); document.getElementById('avgVoltage').textContent = `${avgVoltage.toFixed(3)} V`; document.getElementById('outputCurrent').textContent = `${avgCurrent.toFixed(3)} A`; document.getElementById('voltageRipple').textContent = `${voltageRipple.toFixed(3)} V`; document.getElementById('stepCount').textContent = `${validSteps}/${stepCount}`; log(`çµæœ: å¹³å‡è¼¸å‡º=${avgVoltage.toFixed(3)}V, ç†è«–=${theoretical.toFixed(2)}V, èª¤å·®=${(error/theoretical*100).toFixed(1)}%`, 'success'); }
        
        function clearResults() {
            document.getElementById('avgVoltage').textContent = '-- V';
            document.getElementById('outputCurrent').textContent = '-- A';
            document.getElementById('voltageRipple').textContent = '-- V';
            document.getElementById('stepCount').textContent = '--';
            document.getElementById('logOutput').textContent = 'ç­‰å¾…é–‹å§‹æ¨¡æ“¬...\n';
            initializeChart();
            log('çµæœå·²æ¸…é™¤');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeChart();
            document.getElementById('runBtn').addEventListener('click', runSimulation);
            document.getElementById('clearBtn').addEventListener('click', clearResults);
            initializeSolver();
        });
    </script>
</body>
</html>