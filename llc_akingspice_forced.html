<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLC AkingSPICE 強制模擬</title>
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #74b9ff 0%, #0984e3 50%, #6c5ce7 100%);
      color: white;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 25px;
      backdrop-filter: blur(10px);
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .control-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-item label {
      font-weight: bold;
      font-size: 14px;
    }

    .control-item input {
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 14px;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(45deg, #00b894, #00cec9);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(45deg, #e17055, #d63031);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #00cec9;
    }

    .metric-label {
      font-size: 12px;
      opacity: 0.8;
    }

    .waveform-canvas {
      width: 100%;
      height: 300px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }

    .sampling-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .sample-point {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .sample-value {
      font-size: 16px;
      font-weight: bold;
      color: #fdcb6e;
    }

    .log-area {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
      font-family: 'Consolas', monospace;
      font-size: 12px;
      height: 200px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .status-ok {
      color: #00b894;
    }

    .status-error {
      color: #d63031;
    }

    .status-warning {
      color: #fdcb6e;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 0.7;
      }

      50% {
        opacity: 1;
      }
    }

    .running {
      animation: pulse 2s infinite;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- 標題 -->
    <div class="header">
      <h1>⚡ LLC諧振轉換器 - AkingSPICE強制模擬</h1>
      <h3>🔬 使用ExplicitStateSolver進行真實電路模擬</h3>
      <p>📊 時間步長：1μs | 開關頻率：100kHz | 數值積分：顯式歐拉法</p>
    </div>

    <!-- 控制參數 -->
    <div class="card">
      <h3>🎛️ LLC電路參數</h3>
      <div class="control-grid">
        <div class="control-item">
          <label>輸入電壓 Vin (V)</label>
          <input type="number" id="inputVoltage" value="400" min="200" max="800" step="10">
        </div>
        <div class="control-item">
          <label>諧振電感 Lr (μH)</label>
          <input type="number" id="resonantL" value="50" min="10" max="200" step="5">
        </div>
        <div class="control-item">
          <label>諧振電容 Cr (nF)</label>
          <input type="number" id="resonantC" value="100" min="50" max="500" step="10">
        </div>
        <div class="control-item">
          <label>負載電阻 Rload (Ω)</label>
          <input type="number" id="loadResistor" value="4.8" min="1" max="50" step="0.1">
        </div>
        <div class="control-item">
          <label>開關頻率 fs (kHz)</label>
          <input type="number" id="switchFreq" value="100" min="50" max="500" step="5">
        </div>
        <div class="control-item">
          <label>時間步長 dt (μs)</label>
          <input type="number" id="timeStep" value="1.0" min="0.1" max="5.0" step="0.1">
        </div>
      </div>
      <div style="text-align: center;">
        <button class="btn btn-primary" id="startBtn" onclick="startAkingSPICESimulation()">
          🚀 開始AkingSPICE模擬
        </button>
        <button class="btn btn-danger" onclick="stopSimulation()">⏹️ 停止模擬</button>
      </div>
    </div>

    <!-- AkingSPICE狀態 -->
    <div class="card">
      <h3>🔬 AkingSPICE求解器狀態</h3>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-value" id="solverStatus">未啟動</div>
          <div class="metric-label">求解器狀態</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="timeStepCount">0</div>
          <div class="metric-label">時間步數</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="simulationTime">0.0</div>
          <div class="metric-label">模擬時間 (μs)</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="solverPerformance">0</div>
          <div class="metric-label">求解速度 (步/秒)</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="resonantFreq">0.0</div>
          <div class="metric-label">諧振頻率 (kHz)</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="frequencyRatio">0.0</div>
          <div class="metric-label">頻率比 fs/fr</div>
        </div>
      </div>
    </div>

    <!-- 波形顯示 -->
    <div class="card">
      <h3>📈 AkingSPICE波形輸出</h3>
      <canvas id="waveformCanvas" class="waveform-canvas"></canvas>
    </div>

    <!-- 取樣電壓 -->
    <div class="card">
      <h3>📍 節點電壓取樣 (AkingSPICE實時)</h3>
      <div class="sampling-grid">
        <div class="sample-point">
          <div class="sample-label">諧振電感電流</div>
          <div class="sample-value" id="sampleILr">0.0A</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">諧振電容電壓</div>
          <div class="sample-value" id="sampleVCr">0.0V</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">中間節點N1</div>
          <div class="sample-value" id="sampleVN1">0.0V</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">中間節點N2</div>
          <div class="sample-value" id="sampleVN2">0.0V</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">輸出節點Vout</div>
          <div class="sample-value" id="sampleVout">0.0V</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">開關狀態S1</div>
          <div class="sample-value" id="switchS1">OFF</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">開關狀態S2</div>
          <div class="sample-value" id="switchS2">OFF</div>
        </div>
        <div class="sample-point">
          <div class="sample-label">軟開關模式</div>
          <div class="sample-value" id="softSwitching">檢測中</div>
        </div>
      </div>
    </div>

    <!-- 系統日誌 -->
    <div class="card">
      <h3>📋 AkingSPICE系統日誌</h3>
      <div id="systemLog" class="log-area"></div>
    </div>
  </div>

  <!-- 強制載入AkingSPICE -->
  <script type="module">
    // 強制導入AkingSPICE模組
    import {
      BaseComponent,
      VoltageSource,
      Resistor,
      Capacitor,
      Inductor,
      ExplicitStateSolver
    } from './lib-dist/AkingSPICE.es.js';

    let akingSpiceSolver = null;
    let llcComponents = [];
    let isRunning = false;
    let animationId = null;
    let canvas, ctx;
    let simulationStartTime = 0;
    let stepCount = 0;
    let waveformData = {
      time: [],
      iLr: [],
      vCr: [],
      vN1: [],
      vN2: [],
      vOut: []
    };

    function logMessage(message, type = 'info') {
      const log = document.getElementById('systemLog');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'status-error' :
        type === 'warning' ? 'status-warning' : 'status-ok';
      log.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
      console.log(`[AkingSPICE] ${message}`);
    }

    async function createLLCCircuit() {
      logMessage('開始創建LLC電路拓撲...', 'info');

      const vin = parseFloat(document.getElementById('inputVoltage').value);
      const Lr = parseFloat(document.getElementById('resonantL').value) * 1e-6;
      const Cr = parseFloat(document.getElementById('resonantC').value) * 1e-9;
      const Rload = parseFloat(document.getElementById('loadResistor').value);

      // 清空組件陣列
      llcComponents = [];

      try {
        // 創建電路組件 - 真實的LLC拓撲
        // 輸入電壓源 Vin (節點 0 到 1)
        const vinSource = new VoltageSource('Vin', [0, 1], vin);
        llcComponents.push(vinSource);
        logMessage(`✓ 輸入電壓源: Vin = ${vin}V`, 'info');

        // 諧振電感 Lr (節點 1 到 2)
        const resonantInductor = new Inductor('Lr', [1, 2], Lr);
        llcComponents.push(resonantInductor);
        logMessage(`✓ 諧振電感: Lr = ${(Lr * 1e6).toFixed(1)}μH`, 'info');

        // 諧振電容 Cr (節點 2 到 3)
        const resonantCapacitor = new Capacitor('Cr', [2, 3], Cr);
        llcComponents.push(resonantCapacitor);
        logMessage(`✓ 諧振電容: Cr = ${(Cr * 1e9).toFixed(1)}nF`, 'info');

        // 負載電阻 Rload (節點 3 到 0)
        const loadResistor = new Resistor('Rload', [3, 0], Rload);
        llcComponents.push(loadResistor);
        logMessage(`✓ 負載電阻: Rload = ${Rload}Ω`, 'info');

        // 計算諧振頻率
        const fr = 1 / (2 * Math.PI * Math.sqrt(Lr * Cr));
        const fs = parseFloat(document.getElementById('switchFreq').value) * 1000;
        const k = fs / fr;

        document.getElementById('resonantFreq').textContent = (fr / 1000).toFixed(1);
        document.getElementById('frequencyRatio').textContent = k.toFixed(3);

        logMessage(`✓ 諧振頻率: fr = ${(fr / 1000).toFixed(1)}kHz`, 'info');
        logMessage(`✓ 頻率比: k = fs/fr = ${k.toFixed(3)}`, 'info');

        return true;
      } catch (error) {
        logMessage(`❌ 電路創建失敗: ${error.message}`, 'error');
        return false;
      }
    }

    async function initializeAkingSPICE() {
      logMessage('初始化AkingSPICE ExplicitStateSolver...', 'info');

      const timeStep = parseFloat(document.getElementById('timeStep').value) * 1e-6; // 轉換為秒

      try {
        akingSpiceSolver = new ExplicitStateSolver();
        await akingSpiceSolver.initialize(llcComponents, timeStep, {
          debug: true,
          maxIterations: 1000,
          tolerance: 1e-9
        });

        document.getElementById('solverStatus').textContent = '已初始化';
        document.getElementById('solverStatus').className = 'metric-value status-ok';

        logMessage(`✓ AkingSPICE初始化成功`, 'info');
        logMessage(`✓ 時間步長: ${timeStep * 1e6}μs`, 'info');
        logMessage(`✓ 求解器: ExplicitStateSolver (顯式狀態求解)`, 'info');

        return true;
      } catch (error) {
        document.getElementById('solverStatus').textContent = '初始化失敗';
        document.getElementById('solverStatus').className = 'metric-value status-error';
        logMessage(`❌ AkingSPICE初始化失敗: ${error.message}`, 'error');
        return false;
      }
    }

    async function runAkingSPICEStep() {
      if (!akingSpiceSolver || !isRunning) return;

      try {
        // 執行一個時間步的AkingSPICE求解
        const results = await akingSpiceSolver.step();

        stepCount++;
        const currentTime = stepCount * parseFloat(document.getElementById('timeStep').value);

        // 更新顯示
        document.getElementById('timeStepCount').textContent = stepCount.toLocaleString();
        document.getElementById('simulationTime').textContent = currentTime.toFixed(1);

        // 計算性能
        const elapsedTime = (performance.now() - simulationStartTime) / 1000; // 秒
        const performance_sps = Math.round(stepCount / elapsedTime);
        document.getElementById('solverPerformance').textContent = performance_sps.toLocaleString();

        // 提取波形數據
        if (results && results.nodeVoltages) {
          // 假設節點編號：0=GND, 1=Vin+, 2=Lr+, 3=Cr+/Out
          const vN1 = results.nodeVoltages[1] || 0;
          const vN2 = results.nodeVoltages[2] || 0;
          const vOut = results.nodeVoltages[3] || 0;

          // 從狀態變量中提取電感電流和電容電壓
          const iLr = results.stateVector && results.stateVector[0] !== undefined ? results.stateVector[0] : 0;
          const vCr = results.stateVector && results.stateVector[1] !== undefined ? results.stateVector[1] : 0;

          // 存儲波形數據
          waveformData.time.push(currentTime);
          waveformData.iLr.push(iLr);
          waveformData.vCr.push(vCr);
          waveformData.vN1.push(vN1);
          waveformData.vN2.push(vN2);
          waveformData.vOut.push(vOut);

          // 限制數據長度以避免記憶體溢出
          const maxDataPoints = 1000;
          if (waveformData.time.length > maxDataPoints) {
            Object.keys(waveformData).forEach(key => {
              waveformData[key] = waveformData[key].slice(-800);
            });
          }

          // 更新取樣顯示
          document.getElementById('sampleILr').textContent = iLr.toFixed(3) + 'A';
          document.getElementById('sampleVCr').textContent = vCr.toFixed(1) + 'V';
          document.getElementById('sampleVN1').textContent = vN1.toFixed(1) + 'V';
          document.getElementById('sampleVN2').textContent = vN2.toFixed(1) + 'V';
          document.getElementById('sampleVout').textContent = vOut.toFixed(1) + 'V';

          // PWM開關狀態 (基於時間的PWM)
          const fs = parseFloat(document.getElementById('switchFreq').value) * 1000;
          const switchPeriod = 1 / fs * 1e6; // μs
          const cycleTime = currentTime % switchPeriod;
          const dutyCycle = 0.45;

          const s1On = cycleTime < (switchPeriod * dutyCycle);
          const s2On = cycleTime > (switchPeriod * (dutyCycle + 0.05)) &&
            cycleTime < (switchPeriod * (1 - dutyCycle));

          document.getElementById('switchS1').textContent = s1On ? 'ON' : 'OFF';
          document.getElementById('switchS2').textContent = s2On ? 'ON' : 'OFF';

          // 軟開關檢測 (簡化)
          const k = parseFloat(document.getElementById('frequencyRatio').textContent);
          document.getElementById('softSwitching').textContent = k > 0.8 ? '軟開關' : '硬開關';
        }

        // 繪製波形
        drawWaveforms();

        // 每100步記錄一次狀態
        if (stepCount % 100 === 0) {
          logMessage(`模擬進行中: ${stepCount}步, ${currentTime.toFixed(1)}μs, ${performance_sps}步/秒`, 'info');
        }

      } catch (error) {
        logMessage(`❌ 模擬步驟錯誤: ${error.message}`, 'error');
        stopSimulation();
        return;
      }

      // 繼續下一步
      if (isRunning) {
        animationId = requestAnimationFrame(runAkingSPICEStep);
      }
    }

    function drawWaveforms() {
      if (!canvas || !ctx || waveformData.time.length < 2) return;

      const width = canvas.width / window.devicePixelRatio;
      const height = canvas.height / window.devicePixelRatio;

      // 清空畫布
      ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
      ctx.fillRect(0, 0, width, height);

      // 繪製網格
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 10; i++) {
        const x = (i / 10) * width;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }
      for (let i = 0; i <= 6; i++) {
        const y = (i / 6) * height;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }

      // 繪製波形
      const colors = ['#00cec9', '#00b894', '#74b9ff'];
      const waveforms = ['iLr', 'vCr', 'vOut'];
      const labels = ['Ir (A)', 'Vcr (V)', 'Vout (V)'];

      waveforms.forEach((waveform, index) => {
        const data = waveformData[waveform];
        if (data.length < 2) return;

        ctx.strokeStyle = colors[index];
        ctx.lineWidth = 2;
        ctx.beginPath();

        const startIdx = Math.max(0, data.length - 200);
        const values = data.slice(startIdx);
        const timeValues = waveformData.time.slice(startIdx);

        const minVal = Math.min(...values);
        const maxVal = Math.max(...values);
        const range = Math.max(maxVal - minVal, 0.1);
        const timeRange = timeValues[timeValues.length - 1] - timeValues[0];

        for (let i = 0; i < values.length; i++) {
          const x = timeRange > 0 ? (timeValues[i] - timeValues[0]) / timeRange * width : 0;
          const normalizedY = (values[i] - minVal) / range;
          const y = height - (normalizedY * height / 3 + (index * height / 3));

          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.stroke();

        // 標籤
        ctx.fillStyle = colors[index];
        ctx.font = '12px Arial';
        ctx.fillText(labels[index], 10, 20 + index * 20);
      });
    }

    // 全局函數
    window.startAkingSPICESimulation = async function () {
      if (isRunning) {
        logMessage('⚠️ 模擬已在進行中', 'warning');
        return;
      }

      logMessage('開始AkingSPICE LLC模擬...', 'info');

      // 重置數據
      stepCount = 0;
      waveformData = { time: [], iLr: [], vCr: [], vN1: [], vN2: [], vOut: [] };

      // 創建電路
      const circuitOk = await createLLCCircuit();
      if (!circuitOk) {
        logMessage('❌ 無法創建電路，模擬終止', 'error');
        return;
      }

      // 初始化求解器
      const solverOk = await initializeAkingSPICE();
      if (!solverOk) {
        logMessage('❌ 無法初始化AkingSPICE，模擬終止', 'error');
        return;
      }

      // 開始模擬
      isRunning = true;
      simulationStartTime = performance.now();
      document.getElementById('solverStatus').textContent = '運行中';
      document.getElementById('solverStatus').className = 'metric-value running status-ok';
      document.getElementById('startBtn').textContent = '🔄 AkingSPICE運行中...';

      logMessage('✅ AkingSPICE模擬已啟動！', 'info');

      // 開始執行步驟
      runAkingSPICEStep();
    };

    window.stopSimulation = function () {
      if (!isRunning) return;

      isRunning = false;
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }

      document.getElementById('solverStatus').textContent = '已停止';
      document.getElementById('solverStatus').className = 'metric-value status-warning';
      document.getElementById('startBtn').textContent = '🚀 開始AkingSPICE模擬';

      logMessage('⏹️ AkingSPICE模擬已停止', 'warning');
    };

    // 初始化畫布
    document.addEventListener('DOMContentLoaded', () => {
      canvas = document.getElementById('waveformCanvas');
      ctx = canvas.getContext('2d');

      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';

      logMessage('🔧 AkingSPICE LLC系統已載入完成', 'info');
      logMessage('⚡ 準備進行強制AkingSPICE模擬', 'info');
    });
  </script>
</body>

</html>