<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”‹ LLCè«§æŒ¯è®Šå£“å™¨ (ä¿®å¾©ç‰ˆ) - AkingSPICE</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #1a252f 0%, #2e4057 50%, #1a252f 100%);
      color: white;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 25px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .circuit-diagram {
      background: rgba(0, 0, 0, 0.4);
      padding: 20px;
      border-radius: 10px;
      text-align: left;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.4;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }

    .metric {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }

    .metric-label {
      font-size: 10px;
      opacity: 0.8;
      margin-bottom: 3px;
    }

    .metric-value {
      font-size: 16px;
      font-weight: bold;
      color: #2ecc71;
    }

    .btn {
      padding: 8px 16px;
      margin: 4px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      font-weight: bold;
    }

    .btn-primary {
      background: #27ae60;
      color: white;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-info {
      background: #3498db;
      color: white;
    }

    #waveformCanvas {
      width: 100%;
      height: 350px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
    }

    #log {
      height: 280px;
      overflow-y: auto;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      background: rgba(0, 0, 0, 0.4);
      margin-top: 15px;
    }

    .primary-side {
      color: #3498db;
    }

    .secondary-side {
      color: #e74c3c;
    }

    .resonant {
      color: #f39c12;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”‹ LLCè«§æŒ¯è®Šå£“å™¨ (æ•¸å€¼ä¿®å¾©ç‰ˆ)</h1>
    <p>âš¡ ç©©å®šçš„LLCæ‹“æ’²ï¼šå„ªåŒ–åƒæ•¸é¿å…æ•¸å€¼æ”¶æ–‚å•é¡Œ</p>

    <div class="circuit-diagram">
      <h3>ğŸ“ LLCè«§æŒ¯è®Šå£“å™¨ (ä¿®å¾©ç‰ˆé›»è·¯)</h3>
      <pre>
<span class="primary-side">ã€åŸé‚Šã€‘</span>         <span class="resonant">ã€è«§æŒ¯æ§½ã€‘</span>        ã€è®Šå£“å™¨ã€‘      <span class="secondary-side">ã€å‰¯é‚Šã€‘</span>
  
  Vin(48V)      Lr(100Î¼H)      Cr(220nF)      â”Œâ”€â”€â”€â”€â”        Vo(12V)
     +  â”€â”€â”€LLLLLâ”€â”€â”€â”¤â”œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¤ T1 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ +
                            â”‚      â””â”€â”€â”€â”€â”˜
                      Lm(300Î¼H)                   Rload(2Î©)
                       LLLLL                      
                            â”‚                      
     -  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -
  
  ğŸ”§ ä¿®å¾©è¦é»:
  - æé«˜è¼¸å…¥é›»å£“åˆ°åˆç†ç¯„åœ (48V)
  - å¢å¤§é›»æ„Ÿå€¼é¿å…éé«˜é›»æµ
  - æ”¾å¤§æ™‚é–“æ­¥é•·æ”¹å–„æ”¶æ–‚æ€§
  - ç°¡åŒ–è®Šå£“å™¨æ¨¡å‹
  - èª¿æ•´æ±‚è§£å™¨åƒæ•¸
      </pre>
    </div>

    <div style="text-align: center; margin: 15px 0;">
      <button class="btn btn-primary" onclick="startFixedLLC()">ğŸš€ å•Ÿå‹•ä¿®å¾©LLC</button>
      <button class="btn btn-danger" onclick="stopLLC()">â¹ï¸ åœæ­¢</button>
      <button class="btn btn-info" onclick="resetLLC()">ğŸ”„ é‡ç½®</button>
    </div>

    <h3>ğŸ“Š LLCä¿®å¾©ç‰ˆç›£æ§</h3>
    <div class="status-grid">
      <div class="metric">
        <div class="metric-label">ç‹€æ…‹</div>
        <div id="status" class="metric-value">æº–å‚™</div>
      </div>
      <div class="metric">
        <div class="metric-label">æ­¥æ•¸</div>
        <div id="steps" class="metric-value">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">æ™‚é–“(Î¼s)</div>
        <div id="time" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="primary-side">åŸé‚Šé›»æµ(A)</span></div>
        <div id="primary-current" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="resonant">è«§æŒ¯é›»å£“(V)</span></div>
        <div id="resonant-voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="secondary-side">è¼¸å‡ºé›»å£“(V)</span></div>
        <div id="output-voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">è«§æŒ¯é »ç‡(kHz)</div>
        <div id="resonant-freq" class="metric-value">48.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">åŠŸç‡(W)</div>
        <div id="power" class="metric-value">0.0</div>
      </div>
    </div>

    <h3>ğŸ“ˆ ä¿®å¾©ç‰ˆæ³¢å½¢</h3>
    <canvas id="waveformCanvas" width="1000" height="350"></canvas>

    <h3>ğŸ“‹ ä¿®å¾©æ—¥èªŒ</h3>
    <div id="log">[LLCæ•¸å€¼ä¿®å¾©ç‰ˆæº–å‚™å°±ç·’]</div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    // ä¿®å¾©ç‰ˆLLCåƒæ•¸
    let isRunning = false;
    let solver = null;
    let stepCount = 0;
    let startTime = 0;

    // æ³¢å½¢æ•¸æ“š
    let timeData = [];
    let primaryCurrentData = [];
    let resonantVoltageData = [];
    let outputVoltageData = [];

    // ä¿®å¾©ç‰ˆLLCåƒæ•¸ - é‡å°æ•¸å€¼ç©©å®šæ€§å„ªåŒ–
    const FIXED_LLC_PARAMS = {
      // è¼¸å…¥ - é™ä½é›»å£“é¿å…éå¤§é›»æµ
      Vin: 48,              // 48V (åŸ400Vå¤ªé«˜)

      // è«§æŒ¯åƒæ•¸ - å¢å¤§é›»æ„Ÿå€¼
      Lr: 100e-6,           // 100Î¼H (åŸ50Î¼H)
      Cr: 220e-9,           // 220nF (åŸ100nF)
      Lm: 300e-6,           // 300Î¼H (åŸ200Î¼H)

      // ç°¡åŒ–è®Šå£“å™¨ - ç”¨ç†æƒ³è®Šå£“å™¨æ¯”ä¾‹
      turnsRatio: 4,        // 4:1 (48Vâ†’12V)

      // è¼¸å‡ºè² è¼‰ - åˆç†é˜»å€¼
      Rload: 2.0,           // 2Î©è² è¼‰

      // æ•¸å€¼åƒæ•¸ - é—œéµä¿®å¾©
      dt: 1e-6,             // 1Î¼s (åŸ20nså¤ªå°!)
      maxIter: 50,          // æœ€å¤§è¿­ä»£50æ¬¡
      tolerance: 1e-4       // æ”¾å¯¬å®¹å·®
    };

    // è¨ˆç®—ä¿®å¾©ç‰ˆè«§æŒ¯é »ç‡
    const fr_fixed = 1 / (2 * Math.PI * Math.sqrt(FIXED_LLC_PARAMS.Lr * FIXED_LLC_PARAMS.Cr));
    document.getElementById('resonant-freq').textContent = (fr_fixed / 1000).toFixed(1);

    let canvas, ctx;

    document.addEventListener('DOMContentLoaded', function () {
      log('ğŸ”§ LLCæ•¸å€¼ä¿®å¾©ç‰ˆå•Ÿå‹•', 'success');

      canvas = document.getElementById('waveformCanvas');
      ctx = canvas.getContext('2d');

      if (window.AkingSPICE) {
        log('âœ… AkingSPICE è¼‰å…¥æˆåŠŸ', 'success');
        log('ğŸ”§ ä¿®å¾©ç‰ˆåƒæ•¸:', 'warning');
        log(`   - é™ä½è¼¸å…¥: ${FIXED_LLC_PARAMS.Vin}V (é¿å…éå¤§é›»æµ)`, 'warning');
        log(`   - å¢å¤§é›»æ„Ÿ: Lr=${FIXED_LLC_PARAMS.Lr * 1e6}Î¼H, Lm=${FIXED_LLC_PARAMS.Lm * 1e6}Î¼H`, 'warning');
        log(`   - æ”¾å¤§æ™‚é–“æ­¥é•·: ${FIXED_LLC_PARAMS.dt * 1e6}Î¼s (æ”¹å–„æ”¶æ–‚)`, 'warning');
        log(`   - æ”¾å¯¬å®¹å·®: ${FIXED_LLC_PARAMS.tolerance} (æ•¸å€¼ç©©å®š)`, 'warning');
        log(`   - è«§æŒ¯é »ç‡: ${(fr_fixed / 1000).toFixed(1)}kHz`, 'info');

        // ç«‹å³è‡ªå‹•å•Ÿå‹•
        setTimeout(startFixedLLC, 500);
      } else {
        log('âŒ AkingSPICE è¼‰å…¥å¤±æ•—', 'error');
      }
    });

    function log(msg, type = 'info') {
      const colors = { info: '#ecf0f1', error: '#e74c3c', success: '#2ecc71', warning: '#f39c12' };
      const time = new Date().toLocaleTimeString();

      const logDiv = document.getElementById('log');
      logDiv.innerHTML += `<div style="color:${colors[type]}; margin:1px 0;">[${time}] ${msg}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    window.startFixedLLC = function () {
      if (isRunning) {
        log('âš ï¸ ä¿®å¾©ç‰ˆLLCå·²åœ¨é‹è¡Œ', 'warning');
        return;
      }

      try {
        log('ğŸš€ å•Ÿå‹•æ•¸å€¼ä¿®å¾©ç‰ˆLLC...', 'success');
        document.getElementById('status').textContent = 'å•Ÿå‹•ä¸­';
        document.getElementById('status').style.color = '#f39c12';

        const { VoltageSource, Inductor, Capacitor, Resistor, ExplicitStateSolver } = window.AkingSPICE;

        log('ğŸ”§ å‰µå»ºä¿®å¾©ç‰ˆLLCé›»è·¯...', 'info');

        // ä¿®å¾©ç‰ˆé›»è·¯ - ç°¡åŒ–ä½†ç©©å®š
        const components = [
          // åŸé‚Š
          new VoltageSource('Vin', [1, 0], FIXED_LLC_PARAMS.Vin),          // 48V
          new Inductor('Lr', [1, 2], FIXED_LLC_PARAMS.Lr),                // 100Î¼H
          new Capacitor('Cr', [2, 3], FIXED_LLC_PARAMS.Cr),               // 220nF
          new Inductor('Lm', [2, 0], FIXED_LLC_PARAMS.Lm),                // 300Î¼Hå‹µç£é›»æ„Ÿ

          // ç°¡åŒ–è®Šå£“å™¨æ¨¡å‹ - ç”¨é›»é˜»åˆ†å£“å™¨è¿‘ä¼¼
          new Resistor('Rtx1', [3, 4], 1.0),                              // è®Šå£“å™¨åŸé‚Šç­‰æ•ˆé›»é˜»
          new VoltageSource('Vtx', [4, 5], 0),                            // ç†æƒ³è®Šå£“å™¨(æš«æ™‚ç‚º0)
          new Resistor('Rtx2', [5, 6], 0.25),                             // è®Šå£“å™¨å‰¯é‚Šç­‰æ•ˆé›»é˜» (1/4æ¯”ä¾‹)

          // å‰¯é‚Šè² è¼‰
          new Resistor('Rload', [6, 0], FIXED_LLC_PARAMS.Rload)           // 2Î©è² è¼‰
        ];

        log(`âœ… ä¿®å¾©ç‰ˆé›»è·¯å‰µå»º: ${components.length} çµ„ä»¶`, 'success');
        log('   - ç°¡åŒ–è®Šå£“å™¨æ¨¡å‹é¿å…è€¦åˆå•é¡Œ', 'info');
        log('   - ä½¿ç”¨è¼ƒå¤§é›»é˜»å€¼æé«˜æ•¸å€¼ç©©å®šæ€§', 'info');

        // ä¿®å¾©ç‰ˆæ±‚è§£å™¨è¨­å®š
        log('âš™ï¸ åˆå§‹åŒ–ä¿®å¾©ç‰ˆæ±‚è§£å™¨...', 'info');
        solver = new ExplicitStateSolver();

        solver.initialize(components, FIXED_LLC_PARAMS.dt, {
          debug: false,
          maxIterations: FIXED_LLC_PARAMS.maxIter,      // é™ä½è¿­ä»£æ¬¡æ•¸
          tolerance: FIXED_LLC_PARAMS.tolerance,        // æ”¾å¯¬å®¹å·®
          integrationMethod: 'forward_euler'
        });

        log('âœ… ä¿®å¾©ç‰ˆæ±‚è§£å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');

        // é–‹å§‹é‹è¡Œ
        isRunning = true;
        stepCount = 0;
        startTime = performance.now();

        timeData = [];
        primaryCurrentData = [];
        resonantVoltageData = [];
        outputVoltageData = [];

        document.getElementById('status').textContent = 'é‹è¡Œä¸­';
        document.getElementById('status').style.color = '#2ecc71';

        log('ğŸ‰ ä¿®å¾©ç‰ˆLLCé–‹å§‹é‹è¡Œï¼', 'success');

        runFixedLLCLoop();

      } catch (error) {
        log(`âŒ ä¿®å¾©ç‰ˆå•Ÿå‹•å¤±æ•—: ${error.message}`, 'error');
        document.getElementById('status').textContent = 'éŒ¯èª¤';
        document.getElementById('status').style.color = '#e74c3c';
      }
    };

    function runFixedLLCLoop() {
      if (!isRunning || !solver) return;

      try {
        const result = solver.step();
        stepCount++;

        const timeUs = stepCount * FIXED_LLC_PARAMS.dt * 1e6;

        // æå–é›»å£“
        const nodeVoltages = result.nodeVoltages || {};
        const v1 = nodeVoltages[1] || 0;  // è¼¸å…¥å¾Œ
        const v2 = nodeVoltages[2] || 0;  // è«§æŒ¯é›»æ„Ÿå¾Œ
        const v3 = nodeVoltages[3] || 0;  // è«§æŒ¯é›»å®¹å¾Œ
        const v6 = nodeVoltages[6] || 0;  // è¼¸å‡ºé›»å£“

        // è¨ˆç®—é›»æµå’ŒåŠŸç‡
        const primaryCurrent = (v1 - v2) / (FIXED_LLC_PARAMS.Lr / FIXED_LLC_PARAMS.dt);
        const resonantVoltage = v2 - v3;
        const outputVoltage = v6;
        const outputPower = (outputVoltage * outputVoltage) / FIXED_LLC_PARAMS.Rload;

        // æ›´æ–°é¡¯ç¤º
        document.getElementById('steps').textContent = stepCount;
        document.getElementById('time').textContent = timeUs.toFixed(1);
        document.getElementById('primary-current').textContent = Math.abs(primaryCurrent).toFixed(3);
        document.getElementById('resonant-voltage').textContent = Math.abs(resonantVoltage).toFixed(2);
        document.getElementById('output-voltage').textContent = Math.abs(outputVoltage).toFixed(2);
        document.getElementById('power').textContent = outputPower.toFixed(2);

        // è¨˜éŒ„æ³¢å½¢
        if (stepCount % 5 === 0) {
          timeData.push(timeUs);
          primaryCurrentData.push(primaryCurrent);
          resonantVoltageData.push(resonantVoltage);
          outputVoltageData.push(outputVoltage);

          if (timeData.length > 500) {
            timeData.shift();
            primaryCurrentData.shift();
            resonantVoltageData.shift();
            outputVoltageData.shift();
          }
        }

        // æ¯100æ­¥å ±å‘Š
        if (stepCount % 100 === 0) {
          log(`ä¿®å¾©æ­¥é©Ÿ ${stepCount}: t=${timeUs.toFixed(1)}Î¼s`);
          log(`  é›»æµ=${Math.abs(primaryCurrent).toFixed(3)}A, è«§æŒ¯=${Math.abs(resonantVoltage).toFixed(2)}V, è¼¸å‡º=${Math.abs(outputVoltage).toFixed(2)}V`);

          updateFixedWaveform();
        }

        if (stepCount < 3000) {
          Promise.resolve().then(runFixedLLCLoop);
        } else {
          log('ğŸ ä¿®å¾©ç‰ˆLLCå®Œæˆ (3000æ­¥)', 'success');
          stopLLC();
        }

      } catch (error) {
        log(`âŒ ä¿®å¾©ç‰ˆæ­¥é©ŸéŒ¯èª¤: ${error.message}`, 'error');
        stopLLC();
      }
    }

    function updateFixedWaveform() {
      if (!ctx || timeData.length < 2) return;

      const width = canvas.width;
      const height = canvas.height;

      ctx.clearRect(0, 0, width, height);

      // ç¹ªè£½3å€‹æ³¢å½¢
      const plotHeight = height / 3;

      drawWaveform(primaryCurrentData, 0, plotHeight, '#3498db', 'åŸé‚Šé›»æµ(A)');
      drawWaveform(resonantVoltageData, plotHeight, plotHeight, '#f39c12', 'è«§æŒ¯é›»å£“(V)');
      drawWaveform(outputVoltageData, plotHeight * 2, plotHeight, '#e74c3c', 'è¼¸å‡ºé›»å£“(V)');
    }

    function drawWaveform(data, yOffset, plotHeight, color, label) {
      if (data.length < 2) return;

      const width = canvas.width;
      const minVal = Math.min(...data);
      const maxVal = Math.max(...data);
      const range = Math.abs(maxVal - minVal) || 1;

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();

      for (let i = 0; i < data.length; i++) {
        const x = (i / (data.length - 1)) * width;
        const y = yOffset + plotHeight - ((data[i] - minVal) / range) * plotHeight * 0.8;

        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }

      ctx.stroke();

      ctx.fillStyle = color;
      ctx.font = '12px Arial';
      ctx.fillText(`${label}: ${minVal.toFixed(2)} ~ ${maxVal.toFixed(2)}`, 10, yOffset + 20);
    }

    window.stopLLC = function () {
      if (!isRunning) return;

      isRunning = false;
      document.getElementById('status').textContent = 'å·²åœæ­¢';
      document.getElementById('status').style.color = '#e74c3c';

      const elapsed = (performance.now() - startTime) / 1000;
      log(`â¹ï¸ ä¿®å¾©ç‰ˆåœæ­¢: ${stepCount} æ­¥, ${elapsed.toFixed(2)}ç§’`, 'warning');
      log(`ğŸ¯ æœ€çµ‚è¼¸å‡º: ${document.getElementById('output-voltage').textContent}V`, 'info');
    };

    window.resetLLC = function () {
      stopLLC();
      stepCount = 0;
      timeData = [];
      primaryCurrentData = [];
      resonantVoltageData = [];
      outputVoltageData = [];

      document.getElementById('steps').textContent = '0';
      document.getElementById('time').textContent = '0.0';
      document.getElementById('primary-current').textContent = '0.0';
      document.getElementById('resonant-voltage').textContent = '0.0';
      document.getElementById('output-voltage').textContent = '0.0';
      document.getElementById('power').textContent = '0.0';

      if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);

      log('ğŸ”„ ä¿®å¾©ç‰ˆLLCå·²é‡ç½®', 'info');
    };

  </script>
</body>

</html>