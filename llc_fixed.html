<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔋 LLC諧振變壓器 (修復版) - AkingSPICE</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #1a252f 0%, #2e4057 50%, #1a252f 100%);
      color: white;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      padding: 25px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .circuit-diagram {
      background: rgba(0, 0, 0, 0.4);
      padding: 20px;
      border-radius: 10px;
      text-align: left;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.4;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 20px 0;
    }

    .metric {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }

    .metric-label {
      font-size: 10px;
      opacity: 0.8;
      margin-bottom: 3px;
    }

    .metric-value {
      font-size: 16px;
      font-weight: bold;
      color: #2ecc71;
    }

    .btn {
      padding: 8px 16px;
      margin: 4px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      font-weight: bold;
    }

    .btn-primary {
      background: #27ae60;
      color: white;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-info {
      background: #3498db;
      color: white;
    }

    #waveformCanvas {
      width: 100%;
      height: 350px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
    }

    #log {
      height: 280px;
      overflow-y: auto;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      background: rgba(0, 0, 0, 0.4);
      margin-top: 15px;
    }

    .primary-side {
      color: #3498db;
    }

    .secondary-side {
      color: #e74c3c;
    }

    .resonant {
      color: #f39c12;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>🔋 LLC諧振變壓器 (數值修復版)</h1>
    <p>⚡ 穩定的LLC拓撲：優化參數避免數值收斂問題</p>

    <div class="circuit-diagram">
      <h3>📐 LLC諧振變壓器 (修復版電路)</h3>
      <pre>
<span class="primary-side">【原邊】</span>         <span class="resonant">【諧振槽】</span>        【變壓器】      <span class="secondary-side">【副邊】</span>
  
  Vin(48V)      Lr(100μH)      Cr(220nF)      ┌────┐        Vo(12V)
     +  ───LLLLL───┤├─────┬─────┤ T1 ├──────────── +
                            │      └────┘
                      Lm(300μH)                   Rload(2Ω)
                       LLLLL                      
                            │                      
     -  ─────────────────────┴─────────────────────── -
  
  🔧 修復要點:
  - 提高輸入電壓到合理範圍 (48V)
  - 增大電感值避免過高電流
  - 放大時間步長改善收斂性
  - 簡化變壓器模型
  - 調整求解器參數
      </pre>
    </div>

    <div style="text-align: center; margin: 15px 0;">
      <button class="btn btn-primary" onclick="startFixedLLC()">🚀 啟動修復LLC</button>
      <button class="btn btn-danger" onclick="stopLLC()">⏹️ 停止</button>
      <button class="btn btn-info" onclick="resetLLC()">🔄 重置</button>
    </div>

    <h3>📊 LLC修復版監控</h3>
    <div class="status-grid">
      <div class="metric">
        <div class="metric-label">狀態</div>
        <div id="status" class="metric-value">準備</div>
      </div>
      <div class="metric">
        <div class="metric-label">步數</div>
        <div id="steps" class="metric-value">0</div>
      </div>
      <div class="metric">
        <div class="metric-label">時間(μs)</div>
        <div id="time" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="primary-side">原邊電流(A)</span></div>
        <div id="primary-current" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="resonant">諧振電壓(V)</span></div>
        <div id="resonant-voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label"><span class="secondary-side">輸出電壓(V)</span></div>
        <div id="output-voltage" class="metric-value">0.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">諧振頻率(kHz)</div>
        <div id="resonant-freq" class="metric-value">48.0</div>
      </div>
      <div class="metric">
        <div class="metric-label">功率(W)</div>
        <div id="power" class="metric-value">0.0</div>
      </div>
    </div>

    <h3>📈 修復版波形</h3>
    <canvas id="waveformCanvas" width="1000" height="350"></canvas>

    <h3>📋 修復日誌</h3>
    <div id="log">[LLC數值修復版準備就緒]</div>
  </div>

  <script src="./lib-dist/AkingSPICE.umd.js"></script>

  <script>
    // 修復版LLC參數
    let isRunning = false;
    let solver = null;
    let stepCount = 0;
    let startTime = 0;

    // 波形數據
    let timeData = [];
    let primaryCurrentData = [];
    let resonantVoltageData = [];
    let outputVoltageData = [];

    // 修復版LLC參數 - 針對數值穩定性優化
    const FIXED_LLC_PARAMS = {
      // 輸入 - 降低電壓避免過大電流
      Vin: 48,              // 48V (原400V太高)

      // 諧振參數 - 增大電感值
      Lr: 100e-6,           // 100μH (原50μH)
      Cr: 220e-9,           // 220nF (原100nF)
      Lm: 300e-6,           // 300μH (原200μH)

      // 簡化變壓器 - 用理想變壓器比例
      turnsRatio: 4,        // 4:1 (48V→12V)

      // 輸出負載 - 合理阻值
      Rload: 2.0,           // 2Ω負載

      // 數值參數 - 關鍵修復
      dt: 1e-6,             // 1μs (原20ns太小!)
      maxIter: 50,          // 最大迭代50次
      tolerance: 1e-4       // 放寬容差
    };

    // 計算修復版諧振頻率
    const fr_fixed = 1 / (2 * Math.PI * Math.sqrt(FIXED_LLC_PARAMS.Lr * FIXED_LLC_PARAMS.Cr));
    document.getElementById('resonant-freq').textContent = (fr_fixed / 1000).toFixed(1);

    let canvas, ctx;

    document.addEventListener('DOMContentLoaded', function () {
      log('🔧 LLC數值修復版啟動', 'success');

      canvas = document.getElementById('waveformCanvas');
      ctx = canvas.getContext('2d');

      if (window.AkingSPICE) {
        log('✅ AkingSPICE 載入成功', 'success');
        log('🔧 修復版參數:', 'warning');
        log(`   - 降低輸入: ${FIXED_LLC_PARAMS.Vin}V (避免過大電流)`, 'warning');
        log(`   - 增大電感: Lr=${FIXED_LLC_PARAMS.Lr * 1e6}μH, Lm=${FIXED_LLC_PARAMS.Lm * 1e6}μH`, 'warning');
        log(`   - 放大時間步長: ${FIXED_LLC_PARAMS.dt * 1e6}μs (改善收斂)`, 'warning');
        log(`   - 放寬容差: ${FIXED_LLC_PARAMS.tolerance} (數值穩定)`, 'warning');
        log(`   - 諧振頻率: ${(fr_fixed / 1000).toFixed(1)}kHz`, 'info');

        // 立即自動啟動
        setTimeout(startFixedLLC, 500);
      } else {
        log('❌ AkingSPICE 載入失敗', 'error');
      }
    });

    function log(msg, type = 'info') {
      const colors = { info: '#ecf0f1', error: '#e74c3c', success: '#2ecc71', warning: '#f39c12' };
      const time = new Date().toLocaleTimeString();

      const logDiv = document.getElementById('log');
      logDiv.innerHTML += `<div style="color:${colors[type]}; margin:1px 0;">[${time}] ${msg}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    window.startFixedLLC = function () {
      if (isRunning) {
        log('⚠️ 修復版LLC已在運行', 'warning');
        return;
      }

      try {
        log('🚀 啟動數值修復版LLC...', 'success');
        document.getElementById('status').textContent = '啟動中';
        document.getElementById('status').style.color = '#f39c12';

        const { VoltageSource, Inductor, Capacitor, Resistor, ExplicitStateSolver } = window.AkingSPICE;

        log('🔧 創建修復版LLC電路...', 'info');

        // 修復版電路 - 簡化但穩定
        const components = [
          // 原邊
          new VoltageSource('Vin', [1, 0], FIXED_LLC_PARAMS.Vin),          // 48V
          new Inductor('Lr', [1, 2], FIXED_LLC_PARAMS.Lr),                // 100μH
          new Capacitor('Cr', [2, 3], FIXED_LLC_PARAMS.Cr),               // 220nF
          new Inductor('Lm', [2, 0], FIXED_LLC_PARAMS.Lm),                // 300μH勵磁電感

          // 簡化變壓器模型 - 用電阻分壓器近似
          new Resistor('Rtx1', [3, 4], 1.0),                              // 變壓器原邊等效電阻
          new VoltageSource('Vtx', [4, 5], 0),                            // 理想變壓器(暫時為0)
          new Resistor('Rtx2', [5, 6], 0.25),                             // 變壓器副邊等效電阻 (1/4比例)

          // 副邊負載
          new Resistor('Rload', [6, 0], FIXED_LLC_PARAMS.Rload)           // 2Ω負載
        ];

        log(`✅ 修復版電路創建: ${components.length} 組件`, 'success');
        log('   - 簡化變壓器模型避免耦合問題', 'info');
        log('   - 使用較大電阻值提高數值穩定性', 'info');

        // 修復版求解器設定
        log('⚙️ 初始化修復版求解器...', 'info');
        solver = new ExplicitStateSolver();

        solver.initialize(components, FIXED_LLC_PARAMS.dt, {
          debug: false,
          maxIterations: FIXED_LLC_PARAMS.maxIter,      // 降低迭代次數
          tolerance: FIXED_LLC_PARAMS.tolerance,        // 放寬容差
          integrationMethod: 'forward_euler'
        });

        log('✅ 修復版求解器初始化成功', 'success');

        // 開始運行
        isRunning = true;
        stepCount = 0;
        startTime = performance.now();

        timeData = [];
        primaryCurrentData = [];
        resonantVoltageData = [];
        outputVoltageData = [];

        document.getElementById('status').textContent = '運行中';
        document.getElementById('status').style.color = '#2ecc71';

        log('🎉 修復版LLC開始運行！', 'success');

        runFixedLLCLoop();

      } catch (error) {
        log(`❌ 修復版啟動失敗: ${error.message}`, 'error');
        document.getElementById('status').textContent = '錯誤';
        document.getElementById('status').style.color = '#e74c3c';
      }
    };

    function runFixedLLCLoop() {
      if (!isRunning || !solver) return;

      try {
        const result = solver.step();
        stepCount++;

        const timeUs = stepCount * FIXED_LLC_PARAMS.dt * 1e6;

        // 提取電壓
        const nodeVoltages = result.nodeVoltages || {};
        const v1 = nodeVoltages[1] || 0;  // 輸入後
        const v2 = nodeVoltages[2] || 0;  // 諧振電感後
        const v3 = nodeVoltages[3] || 0;  // 諧振電容後
        const v6 = nodeVoltages[6] || 0;  // 輸出電壓

        // 計算電流和功率
        const primaryCurrent = (v1 - v2) / (FIXED_LLC_PARAMS.Lr / FIXED_LLC_PARAMS.dt);
        const resonantVoltage = v2 - v3;
        const outputVoltage = v6;
        const outputPower = (outputVoltage * outputVoltage) / FIXED_LLC_PARAMS.Rload;

        // 更新顯示
        document.getElementById('steps').textContent = stepCount;
        document.getElementById('time').textContent = timeUs.toFixed(1);
        document.getElementById('primary-current').textContent = Math.abs(primaryCurrent).toFixed(3);
        document.getElementById('resonant-voltage').textContent = Math.abs(resonantVoltage).toFixed(2);
        document.getElementById('output-voltage').textContent = Math.abs(outputVoltage).toFixed(2);
        document.getElementById('power').textContent = outputPower.toFixed(2);

        // 記錄波形
        if (stepCount % 5 === 0) {
          timeData.push(timeUs);
          primaryCurrentData.push(primaryCurrent);
          resonantVoltageData.push(resonantVoltage);
          outputVoltageData.push(outputVoltage);

          if (timeData.length > 500) {
            timeData.shift();
            primaryCurrentData.shift();
            resonantVoltageData.shift();
            outputVoltageData.shift();
          }
        }

        // 每100步報告
        if (stepCount % 100 === 0) {
          log(`修復步驟 ${stepCount}: t=${timeUs.toFixed(1)}μs`);
          log(`  電流=${Math.abs(primaryCurrent).toFixed(3)}A, 諧振=${Math.abs(resonantVoltage).toFixed(2)}V, 輸出=${Math.abs(outputVoltage).toFixed(2)}V`);

          updateFixedWaveform();
        }

        if (stepCount < 3000) {
          Promise.resolve().then(runFixedLLCLoop);
        } else {
          log('🏁 修復版LLC完成 (3000步)', 'success');
          stopLLC();
        }

      } catch (error) {
        log(`❌ 修復版步驟錯誤: ${error.message}`, 'error');
        stopLLC();
      }
    }

    function updateFixedWaveform() {
      if (!ctx || timeData.length < 2) return;

      const width = canvas.width;
      const height = canvas.height;

      ctx.clearRect(0, 0, width, height);

      // 繪製3個波形
      const plotHeight = height / 3;

      drawWaveform(primaryCurrentData, 0, plotHeight, '#3498db', '原邊電流(A)');
      drawWaveform(resonantVoltageData, plotHeight, plotHeight, '#f39c12', '諧振電壓(V)');
      drawWaveform(outputVoltageData, plotHeight * 2, plotHeight, '#e74c3c', '輸出電壓(V)');
    }

    function drawWaveform(data, yOffset, plotHeight, color, label) {
      if (data.length < 2) return;

      const width = canvas.width;
      const minVal = Math.min(...data);
      const maxVal = Math.max(...data);
      const range = Math.abs(maxVal - minVal) || 1;

      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();

      for (let i = 0; i < data.length; i++) {
        const x = (i / (data.length - 1)) * width;
        const y = yOffset + plotHeight - ((data[i] - minVal) / range) * plotHeight * 0.8;

        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }

      ctx.stroke();

      ctx.fillStyle = color;
      ctx.font = '12px Arial';
      ctx.fillText(`${label}: ${minVal.toFixed(2)} ~ ${maxVal.toFixed(2)}`, 10, yOffset + 20);
    }

    window.stopLLC = function () {
      if (!isRunning) return;

      isRunning = false;
      document.getElementById('status').textContent = '已停止';
      document.getElementById('status').style.color = '#e74c3c';

      const elapsed = (performance.now() - startTime) / 1000;
      log(`⏹️ 修復版停止: ${stepCount} 步, ${elapsed.toFixed(2)}秒`, 'warning');
      log(`🎯 最終輸出: ${document.getElementById('output-voltage').textContent}V`, 'info');
    };

    window.resetLLC = function () {
      stopLLC();
      stepCount = 0;
      timeData = [];
      primaryCurrentData = [];
      resonantVoltageData = [];
      outputVoltageData = [];

      document.getElementById('steps').textContent = '0';
      document.getElementById('time').textContent = '0.0';
      document.getElementById('primary-current').textContent = '0.0';
      document.getElementById('resonant-voltage').textContent = '0.0';
      document.getElementById('output-voltage').textContent = '0.0';
      document.getElementById('power').textContent = '0.0';

      if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);

      log('🔄 修復版LLC已重置', 'info');
    };

  </script>
</body>

</html>